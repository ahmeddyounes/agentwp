id,title,spec
C01-01,"ADR 0002: Intent Handler Registration","Create `docs/adr/0002-intent-handler-registration.md` defining the single supported registration mechanism for intent handlers (recommended: `#[HandlesIntent(...)]` + container tag `intent.handler`), and document backward compatibility for `agentwp_intent_handlers` plus a deprecation path for legacy `getIntent()`/`getSupportedIntents()` discovery; include rationale, consequences, and a migration checklist; Acceptance Criteria: ADR clearly states the one true approach and how/when legacy support is removed."
C01-02,"ADR 0003: Intent Classification Strategy","Create `docs/adr/0003-intent-classification-strategy.md` deciding whether `IntentClassifier` stays or is replaced by `Intent\\Classifier\\ScorerRegistry` (and how weights/thresholds from `AgentWPConfig` apply); define extension points (filter/action to register scorers) and testing strategy; Acceptance Criteria: ADR names the primary classifier implementation and extension hook contract."
C01-03,"ADR 0004: OpenAI Client Architecture","Create `docs/adr/0004-openai-client-architecture.md` deciding whether to integrate the modular components in `src/AI/Client/*` into `OpenAIClient` or delete them, and whether HTTP + retries must go through `HttpClientInterface` + `RetryExecutor`; include migration steps and how streaming is handled; Acceptance Criteria: ADR makes an explicit choice and lists the concrete refactor steps."
C01-04,"ADR 0005: REST Rate Limiting Approach","Create `docs/adr/0005-rest-rate-limiting.md` choosing one rate limiting strategy: (A) injected `RateLimiterInterface` from container, or (B) static `RestController::check_rate_limit()` with no DI service; specify Retry-After behavior, storage keys, and how to test; Acceptance Criteria: ADR removes ambiguity so only one implementation remains after the migration."
C01-05,"Update Boot/Composition Docs","Update `docs/ARCHITECTURE.md` to include an explicit boot/composition diagram (bootstrap → Plugin → providers → route registrar/formatter → controllers → services/handlers) and link to ADRs 0001–0005 and `docs/ARCHITECTURE-IMPROVEMENT-PLAN.md`; Acceptance Criteria: A new contributor can trace runtime wiring end-to-end from docs without reading code."

C02-01,"Consolidate Plugin Bootstrap Responsibilities","Audit `src/Plugin.php` for legacy/duplicate responsibilities vs `src/Plugin/*` managers and provider wiring; remove or deprecate unused methods (menu/assets/rest formatting) while keeping activation/deactivation behavior intact; Acceptance Criteria: only one active code path exists for menu/assets/rest wiring and dead/unused code is removed or explicitly deprecated."
C02-02,"Remove Stale References and Dead Imports","Remove unused/stale imports (e.g., `HandlerServiceProvider` in `src/Plugin.php`) and resolve references to missing classes (e.g., guarded `AgentWP\\Handlers\\BulkHandler` usage): either implement the missing class or remove the references and any related cleanup logic; Acceptance Criteria: `rg \"HandlerServiceProvider|BulkHandler\"` shows no invalid references and the plugin still boots/activates cleanly."
C02-03,"Single Source of Truth for Options + Defaults","Choose one authoritative module for option keys/defaults (recommended: `src/Plugin/SettingsManager.php` + `AgentWPConfig`) and refactor `src/Plugin.php`, `src/Demo/Mode.php`, controllers, and services to use it; keep backward compatibility for stored option names; Acceptance Criteria: option keys/defaults are defined once and referenced everywhere else."
C02-04,"Introduce API Key Storage Service","Create a dedicated service (e.g., `src/Security/ApiKeyStorage.php`) that encapsulates encrypt/decrypt/rotate/last4 for both normal and demo keys, and refactor `src/Rest/SettingsController.php`, `src/Plugin/SettingsManager.php`, and `src/Demo/Mode.php` to use it; wire it via a provider; Acceptance Criteria: no controller directly instantiates `Encryption` or manually manages last4."
C02-05,"Define and Implement Demo Credential Rules","Make demo-mode credential behavior explicit (demo key vs stubbed responses) and implement it consistently in `src/AI/AIClientFactory.php` and any API key validation logic; update docs as needed; Acceptance Criteria: demo mode produces deterministic behavior and never accidentally uses a real key when demo mode is enabled."
C02-06,"Inventory and Decide Fate of Stranded Subsystems","Create a short inventory doc (e.g., `docs/architecture-inventory.md`) listing currently unused subsystems (AI client components, scorer registry, rate limiter service, retry executor, ServiceResult, EmailContextBuilder, OrderSearch pipeline) and, for each, decide: integrate now, integrate later, or delete; Acceptance Criteria: every unused subsystem has an explicit decision and owner task(s) below."
C02-07,"Order Search Consolidation (Choose + Wire)","Based on the decision inventory/ADR, consolidate order search into one implementation: either wire `src/Services/OrderSearch/*` via container and retire `src/Services/OrderSearchService.php`, or delete the unused pipeline and keep the existing service; update providers and handlers accordingly; Acceptance Criteria: only one order-search implementation remains and is used by handlers/controllers."
C02-08,"Clean Up or Integrate Remaining Unused Value Objects","Per the inventory decision, either (A) migrate code to use `src/DTO/ServiceResult.php` and `src/Context/EmailContextBuilder.php` or (B) remove them (and any related dead code) if they are not part of the target architecture; Acceptance Criteria: no unused “orphan” classes remain without a clear integration path."
C02-09,"Post-Consolidation Build and Docs Hygiene","Run/verify baseline checks (PHP + React) after consolidation and update `docs/CHANGELOG.md` / `docs/DEVELOPER.md` with any breaking changes or new conventions; Acceptance Criteria: repo is green on agreed checks and docs reflect the new single-path architecture."

C03-01,"Make Controllers Container-First (Remove Broken Fallbacks)","Refactor REST controllers to resolve dependencies from the container and remove any fallbacks that lead to incorrect runtime behavior (e.g., `new Engine()` that has no handlers); return a clear 500 error when a required dependency cannot be resolved; Acceptance Criteria: no core controller instantiates domain services directly in normal runtime."
C03-02,"Refactor SettingsController to Use Services","Update `src/Rest/SettingsController.php` to use container-resolved services for settings, API key storage, and OpenAI key validation (via an injected HTTP client/validator); remove direct `wp_remote_get` calls and direct `new Encryption()` usage; Acceptance Criteria: settings and key operations are testable without WordPress HTTP globals."
C03-03,"Refactor AnalyticsController to Interface-Only","Update `src/Rest/AnalyticsController.php` to resolve `AnalyticsServiceInterface` from the container and remove the concrete fallback instantiation; ensure provider wiring always registers the service; Acceptance Criteria: analytics endpoint never bypasses DI in production."
C03-04,"Wire Engine with Full Dependencies via Container","Update `src/Providers/IntentServiceProvider.php` to register and inject `FunctionRegistry`, `HandlerRegistry`, `ContextBuilderInterface`, `IntentClassifierInterface`, `MemoryStoreInterface`, and handlers into `Engine`; ensure `Engine` uses injected registries instead of internal defaults in production wiring; Acceptance Criteria: the provider-wired `Engine` is the one used by `/intent` at runtime."
C03-05,"Tag-Based Context Providers Wiring","Tag context providers (e.g., `intent.context_provider`) and wire `ContextBuilder` from tagged providers instead of hardcoded `new UserContextProvider()` defaults; ensure provider ordering and deterministic keys; Acceptance Criteria: adding/removing providers is done via container registration/tagging and is testable."
C03-06,"Remove Service-Level Dependency Fallbacks","Refactor services that currently create their own dependencies (e.g., `new TransientDraftStorage()`) to require injected interfaces, and update providers to always supply them; keep optional integrations (like WooCommerce) behind interface availability checks; Acceptance Criteria: domain/services layer has no hidden instantiation that bypasses providers."
C03-07,"Add Tests for Container Wiring + Resolution","Add PHPUnit tests to verify: container registers the expected bindings, `Engine` resolves with registered handlers/registries, and REST controllers resolve dependencies via `RestController::resolve()`; Acceptance Criteria: tests fail if a controller/service reintroduces DI bypass."
C03-08,"Run PHP Static/Style Checks","Run `composer run phpunit`, `composer run phpstan`, and `composer run phpcs` and fix only issues introduced by the refactor; Acceptance Criteria: PHP checks pass without regressions."

C04-01,"Add HandlesIntent Attributes to Built-in Handlers","Add `#[HandlesIntent(...)]` attributes to all built-in intent handlers in `src/Intent/Handlers/*` so each handler has explicit intent registration; Acceptance Criteria: `Engine` can register all built-in handlers without relying on legacy detection methods."
C04-02,"Deprecate Legacy Handler Discovery Methods","Implement a formal deprecation strategy for handler discovery methods (`getIntent()`/`getSupportedIntents()`), including documentation and (optional) runtime warnings/logging in dev; Acceptance Criteria: deprecation is documented and there is a clear removal date/condition."
C04-03,"Remove O(n) Fallback Handler Resolution","Once all built-in handlers are attribute-registered, simplify `src/Intent/Engine.php` to rely on `HandlerRegistry` only (remove `needs_fallback_lookup` and linear scanning) and keep a single fallback handler for unknown intents; Acceptance Criteria: handler resolution is O(1) and deterministic."
C04-04,"Implement ScorerRegistry-Based Classifier","Create an `IntentClassifierInterface` implementation backed by `src/Intent/Classifier/ScorerRegistry` and wire it in `IntentServiceProvider` (per ADR 0003); add an action/filter to register additional scorers; Acceptance Criteria: classification is extensible and covered by unit tests."
C04-05,"Align Scoring with Config Weights/Thresholds","Update scorers to incorporate `AgentWPConfig` weights/thresholds (or filtered config), and ensure tie-breaking/determinism; Acceptance Criteria: classifier behavior is deterministic and configurable via filters."
C04-06,"Configurable Memory Store Limits","Make memory store limit/ttl configurable (SettingsManager/config/filters), update provider wiring and ensure defaults are safe; Acceptance Criteria: memory behavior can be adjusted without code changes and is covered by tests."
C04-07,"Update Developer Documentation for New Extension Patterns","Update `docs/DEVELOPER.md` to document the new handler registration approach (attribute + provider/tag) and new scorer extension hook; include a working example; Acceptance Criteria: extension guide matches the actual runtime wiring."

C05-01,"Unify OpenAI Client Implementation (Per ADR)","Per ADR 0004, either integrate `src/AI/Client/*` into `src/AI/OpenAIClient.php` (preferred) or delete the unused path; ensure there is only one implementation for request building, tool normalization, response parsing, and streaming; Acceptance Criteria: no duplicated OpenAI logic remains in parallel modules."
C05-02,"Move OpenAI HTTP to HttpClientInterface","Refactor `OpenAIClient` to use injected `HttpClientInterface` (and any WordPress/VIP safe wrappers in `WordPressHttpClient`) rather than direct `wp_remote_*` calls; update factory/provider wiring accordingly; Acceptance Criteria: OpenAI client can be tested with fake HTTP without WordPress globals."
C05-03,"Centralize Retry via RetryExecutor","Replace custom retry/backoff logic in `OpenAIClient` with `RetryExecutor` + `RetryPolicyInterface` and `SleeperInterface`; ensure retry-after and 429 handling are consistent; Acceptance Criteria: retry behavior is centrally configured and unit-testable."
C05-04,"Centralize OpenAI Configuration","Ensure base URL, timeouts, retry limits, and model selection are pulled from SettingsManager/config + filter overrides (and not hardcoded across multiple places); Acceptance Criteria: OpenAI configuration is defined once and applied consistently."
C05-05,"Implement Demo-Mode OpenAI Behavior End-to-End","Ensure demo mode consistently uses the chosen strategy (demo key or stubs) across AI client creation and API key validation; add docs and tests; Acceptance Criteria: demo mode behavior is deterministic and cannot leak real-key behavior."
C05-06,"Add OpenAI Client Unit Tests","Add PHPUnit tests for request building, tool normalization, response parsing, error categorization, and retry behavior using existing fakes in `tests/Fakes/*`; Acceptance Criteria: tests cover success + common failure modes without network access."
C05-07,"Validate Usage Tracking After Refactor","Ensure `Billing\\UsageTracker` still receives correct model/token usage metadata after the OpenAI refactor (including streaming + fallback estimation); add a regression test or targeted assertions; Acceptance Criteria: usage stats remain accurate and stable."

C06-01,"Single Rate Limiting Implementation in REST Layer","Implement the single rate limiting approach chosen in ADR 0005: either inject `RateLimiterInterface` into `RestController` (and remove static limiting) or remove the DI rate limiter and keep static; ensure Retry-After is surfaced in responses; Acceptance Criteria: only one rate limiting mechanism exists and is covered by tests."
C06-02,"Tag-Based REST Controller Registration","Refactor `src/Plugin/RestRouteRegistrar.php` and `src/Providers/RestServiceProvider.php` so controller discovery prefers container tag `rest.controller` (with a safe fallback list only when needed); Acceptance Criteria: adding a controller does not require editing a hard-coded list."
C06-03,"Introduce Request Validation/DTO Helpers (Minimum Viable)","Create minimal request DTO/validator helpers to reduce controller boilerplate (start with `/intent` and `/settings`), while keeping WP REST schema validation; Acceptance Criteria: controllers become thinner without changing API behavior."
C06-04,"REST Endpoint Smoke Tests","Add/update PHPUnit tests to assert the standard response envelope shape and key error codes for core endpoints (`/intent`, `/settings`, `/settings/api-key`, `/analytics`, `/history`, `/theme`); Acceptance Criteria: envelope regressions are caught by tests."
C06-05,"Deterministic OpenAPI Maintenance Workflow","Add a repeatable workflow to keep `docs/openapi.json` in sync (script + documented command) or at minimum a validation step that fails if annotations drift; Acceptance Criteria: contributors have a single documented way to update OpenAPI and CI/dev checks catch drift."
C06-06,"Update Public API Documentation","Update `docs/API.md` for any changed behaviors, new error codes, or updated schemas resulting from the refactors; Acceptance Criteria: API docs match runtime responses and frontend expectations."

C07-01,"Introduce a Capability/Policy Layer","Create a small policy layer (e.g., `src/Security/Policy/*` or `src/Application/Policy/*`) so capability checks live outside domain services; refactor refund/status/stock/email flows accordingly; Acceptance Criteria: domain services no longer call `current_user_can()` directly."
C07-02,"Standardize Service Results","Adopt `src/DTO/ServiceResult.php` (or a replacement decided earlier) as the standard return type for application/domain services and migrate core services incrementally (start with refund/status/stock); update handlers/controllers to map to API envelopes; Acceptance Criteria: service outcomes are uniform and include codes/messages consistently."
C07-03,"Abstract WooCommerce Side Effects Behind Interfaces","Introduce/extend interfaces + infrastructure adapters for WooCommerce write operations (refund creation, status updates, stock updates) so services do not call `wc_*` globals directly; Acceptance Criteria: services are unit-testable using fakes/mocks for side effects."
C07-04,"Unify Draft/Confirm Lifecycle","Implement a shared draft manager/use-case layer that standardizes draft id generation, storage payload shape, TTL, claim semantics, and error handling; refactor refund/status/stock flows to use it; Acceptance Criteria: all draft-based flows behave consistently and share storage logic."
C07-05,"Align Draft Payloads with Frontend Needs","Ensure draft/preview payload structures returned by handlers match frontend expectations (cards, previews, statuses) and are documented; Acceptance Criteria: frontend does not need per-intent special casing for common fields."
C07-06,"Add Unit Tests for Use-Cases","Add PHPUnit tests for each core use-case (refund draft/confirm, status update draft/confirm, stock update draft/confirm, email draft context) using fakes for storage/repositories/adapters; Acceptance Criteria: use-cases are covered without WooCommerce runtime."
C07-07,"Migrate Remaining Services to DI + Contracts","Incrementally refactor remaining services to use DI and contracts (and remove remaining hidden instantiation paths); Acceptance Criteria: non-infrastructure code does not directly call WordPress/WooCommerce globals."
C07-08,"Docs + Changelog for Service Layer Changes","Update `docs/ARCHITECTURE.md`, `docs/DEVELOPER.md`, and `docs/CHANGELOG.md` to reflect policy layer, ServiceResult standard, and draft lifecycle conventions; Acceptance Criteria: developer docs match the new architecture and call out any breaking changes."

C08-01,"ADR 0006: Search Index Architecture","Create `docs/adr/0006-search-index-architecture.md` deciding whether `src/Search/Index.php` stays static or becomes a container-managed service; include schema migration/versioning strategy and performance guardrails; Acceptance Criteria: ADR defines the one approved approach."
C08-02,"Implement Search Architecture Decision","Implement the chosen search approach (static hardening or DI-managed service), ensuring table creation/backfill is not done unnecessarily and hooks are well-scoped; Acceptance Criteria: search index lifecycle is predictable and does not add unexpected overhead."
C08-03,"Search Tests + Documentation","Add tests around schema versioning/backfill throttling/search results (as feasible) and update docs to explain how search indexing works and how to troubleshoot; Acceptance Criteria: search behavior is documented and validated by tests."

C09-01,"Generate TypeScript Types from OpenAPI","Add a type generation step in `react/` that generates TS types from `docs/openapi.json` (e.g., into `react/src/types/api.ts`) and document the command; Acceptance Criteria: type generation is repeatable and committed or generated deterministically in CI/dev."
C09-02,"Type AgentWPClient with Generated Types","Update `react/src/api/AgentWPClient.ts` to use the generated request/response types for all endpoints and reduce `unknown` casts; Acceptance Criteria: TypeScript catches mismatched API payloads at compile time."
C09-03,"Propagate Types into Features/Stores","Refactor React hooks/stores/features to use the typed API client responses and remove duplicated type definitions; Acceptance Criteria: feature code relies on shared API types rather than ad-hoc shapes."
C09-04,"Backend/Frontend Error Code Alignment Test","Add a small test/validation ensuring frontend error-code mapping covers backend `AgentWPConfig` error codes used by the API, and update mapping as needed; Acceptance Criteria: introducing a new backend error code requires updating frontend mapping or tests fail."
C09-05,"Expand Playwright E2E Coverage for Core Flows","Add/extend Playwright tests (root `playwright.config.cjs` + `tests/`) to cover settings save, intent prompt, analytics load, and basic error handling; Acceptance Criteria: e2e tests provide regression coverage for the primary admin workflows."

C10-01,"Full Repo Validation Pass","Run full validation: `composer run phpunit`, `composer run phpstan`, `composer run phpcs`, `cd react && npm test && npm run typecheck && npm run lint`, and root e2e if configured; fix regressions introduced by the plan implementation; Acceptance Criteria: all agreed checks pass."
C10-02,"Final Documentation and Migration Notes","Do a final documentation pass to ensure `docs/ARCHITECTURE-IMPROVEMENT-PLAN.md`, ADRs, `docs/ARCHITECTURE.md`, and `docs/DEVELOPER.md` are consistent; add migration notes for extension developers and summarize changes in `docs/CHANGELOG.md`; Acceptance Criteria: documentation is coherent and reflects the final architecture."
