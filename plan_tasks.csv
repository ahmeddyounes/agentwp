id,title,spec
C00-01,"Reconcile or archive stale architecture inventory doc","Review `docs/architecture-inventory.md` for accuracy vs current runtime wiring (e.g., ScorerRegistry/RateLimiter/RetryExecutor/ServiceResult usage). Either update it to match reality (with concrete file references) or move it to `docs/archive/` and remove/replace any references. Acceptance: docs no longer contradict codebase and all referenced paths exist."
C00-02,"Update ARCHITECTURE.md 'Where Things Live' and link hygiene","Update `docs/ARCHITECTURE.md` with a short 'Where things live' section listing key folders/files (entrypoint, providers, controllers, intent handlers, services, infrastructure, React UI). Ensure it links to `docs/ARCHITECTURE-IMPROVEMENT-PLAN.md` and all other relative links resolve. Acceptance: a new contributor can locate major subsystems in <5 minutes."
C00-03,"Add lightweight docs path/link check script","Add a simple script (e.g., `scripts/check-doc-links.php`) that scans `docs/**/*.md` for relative markdown links and fails if targets are missing/renamed; document usage in `docs/DEVELOPER.md` and optionally add a Composer script entry. Acceptance: running the script locally catches broken doc links deterministically."
C01-01,"Decide canonical REST controller location and naming","Confirm the canonical location/namespace for REST controllers (recommended: all controllers under `src/Rest/` in `AgentWP\\Rest`). Document the decision in `docs/ARCHITECTURE.md` and `docs/DEVELOPER.md` (how to add a new endpoint). Acceptance: there is exactly one 'blessed' place to add controllers and it is documented."
C01-02,"Move base REST controller to src/Rest and update namespaces","Move `src/API/RestController.php` to the canonical controller namespace/path (e.g., `src/Rest/RestController.php`) and update all references/imports across controllers, providers, and tests. Keep behavior identical (permissions, nonce, rate limit, response_error, logging). Acceptance: PHPUnit passes and REST endpoints behave unchanged."
C01-03,"Move HistoryController under Rest namespace","Move `src/API/HistoryController.php` into the canonical controller directory/namespace and update `src/Plugin/RestRouteRegistrar.php#getDefaultControllers()`, `src/Providers/RestServiceProvider.php` tagging/bindings, and tests referencing the old class. Acceptance: `/agentwp/v1/history` works and controller is discoverable via container tags."
C01-04,"Move ThemeController under Rest namespace","Move `src/API/ThemeController.php` into the canonical controller directory/namespace and update registrar/provider wiring and any tests/imports. Acceptance: `/agentwp/v1/theme` works and controller is discoverable via container tags."
C01-05,"Clarify API vs infrastructure for RateLimiter implementation","Decide where the rate limiter implementation should live (keep in `src/API/` with clear naming or move to an infrastructure-focused namespace like `src/Infrastructure/RateLimiting/`). Apply the move/rename (including namespaces) and update `src/Providers/RestServiceProvider.php` bindings and any imports. Acceptance: no functional changes; all tests pass."
C01-06,"Strengthen controller boundary tests to cover all controllers","Update `tests/Integration/Architecture/BoundariesTest.php` so REST controller scanning covers the canonical controller directory (and/or both old/new during transition). Ensure tests enforce 'controllers extend the base controller' and 'controllers do not instantiate services directly'. Acceptance: adding a new controller outside the canonical location fails tests."
C01-07,"Update container wiring and registrar tests after REST refactor","Update `tests/Integration/Container/ContainerWiringTest.php` (and any other tests) for new namespaces/paths. Verify `RestRouteRegistrar` still registers tagged controllers first and falls back to defaults. Acceptance: container wiring tests pass and default controller list is correct."
C02-01,"Introduce AtomicRateLimiterInterface contract","Add `src/Contracts/AtomicRateLimiterInterface.php` extending `RateLimiterInterface` with `checkAndIncrement(int $userId): bool`. Implement it in the real limiter class and keep backwards compatibility for `RateLimiterInterface` consumers. Acceptance: both interfaces compile and existing code continues to work."
C02-02,"Prefer atomic rate limiting in RestController permissions_check","Update the base REST controller rate limiting logic to call `checkAndIncrement()` when the resolved limiter implements `AtomicRateLimiterInterface`; otherwise fall back to `check()` + `increment()` (preserve fail-open semantics). Acceptance: rate limiting remains enforced and atomic path is used when available."
C02-03,"Update FakeRateLimiter and tests for atomic path","Implement `checkAndIncrement()` in `tests/Fakes/FakeRateLimiter.php` and add/update unit tests to cover atomic behavior and fallback behavior (including `retry_after` propagation). Acceptance: tests validate correct 429 behavior and consistent retry-after values."
C03-01,"Remove direct apply_filters/do_action calls from Intent Engine","Refactor `src/Intent/Engine.php` to use an injected hook adapter (`src/Infrastructure/WPFunctions.php` or a dedicated `HooksInterface`) instead of calling `apply_filters()` / `do_action()` directly. Update `src/Providers/IntentServiceProvider.php` wiring and tests (use `tests/Fakes/FakeWPFunctions.php`). Acceptance: Engine remains behavior-compatible and is unit-testable without WordPress globals."
C03-02,"Add current-user context abstraction for services (optional but recommended)","Introduce a small abstraction for runtime user context (e.g., `CurrentUserInterface` or a `WPFunctions::getCurrentUserId()` helper) and update services that call `get_current_user_id()` directly (audit logging/draft confirmation) to use injected context or explicit parameters. Acceptance: services no longer depend on WP globals for user identity and tests cover both paths."
C03-03,"Deprecate legacy IntentClassifier and document migration","Add explicit deprecation markers for `src/Intent/IntentClassifier.php` (DocBlock `@deprecated` and/or `_doing_it_wrong` on construction) and ensure production code does not use it. Update ADR 0003 and `docs/ARCHITECTURE-IMPROVEMENT-PLAN.md` notes to reflect deprecation/removal timing. Acceptance: no runtime behavior change and deprecation is clearly communicated."
C04-01,"Decide tool execution architecture and document it","Pick a single approach for tools: (A) executable tool classes (schema + execute) with a dispatcher, or (B) central argument normalizers/executors. Document the chosen approach (short ADR in `docs/adr/` + update `docs/ARCHITECTURE.md`). Acceptance: contributors have one clear recipe for adding a tool."
C04-02,"Add server-side tool argument validation","Implement server-side validation for tool-call arguments against each tool's JSON schema (reuse `rest_validate_value_from_schema()` or equivalent). Define a consistent error result shape for invalid args. Acceptance: invalid tool args never reach domain services and tests cover validation failures."
C04-03,"Introduce ToolDispatcher service and integrate with AbstractAgenticHandler","Create a dispatcher (e.g., `src/Intent/ToolDispatcher.php` + contract) that resolves tools by name, validates args, executes, and returns JSON-safe results. Refactor `src/Intent/Handlers/AbstractAgenticHandler.php` to delegate tool execution to the dispatcher instead of requiring per-handler `execute_tool()` implementations. Acceptance: agentic loop still functions and tool execution is centralized."
C04-04,"Convert order-related functions into executable tools","Implement executable tools for order operations (`search_orders`, `prepare_refund`, `confirm_refund`, `prepare_status_update`, `prepare_bulk_status_update`, `confirm_status_update`, `bulk_update`) that call the appropriate domain services and return stable result payloads. Register tools via container/registry and update handlers to only declare required tool names. Acceptance: existing intent flows still work end-to-end."
C04-05,"Convert product/email/analytics/customer functions into executable tools","Implement executable tools for the remaining functions (`search_product`, `prepare_stock_update`, `confirm_stock_update`, `draft_email`, `get_sales_report`, `get_customer_profile`) with DI wiring and stable result shapes. Acceptance: all built-in tool names resolve and execute through the dispatcher."
C04-06,"Remove handler-specific execute_tool overrides after tool migration","After tools are centralized, remove redundant `execute_tool()` overrides from handlers in `src/Intent/Handlers/*` and rely on dispatcher execution. Ensure handlers still provide system prompts, tool lists, and defaults only. Acceptance: less duplicated mapping logic and full test suite passes."
C04-07,"Add integration tests for tool execution path","Add tests that cover Engine → handler → tool dispatcher execution using a fake AI client that returns tool calls. Validate schema validation, execution dispatch, and JSON serialization. Acceptance: at least one full intent scenario is covered and fails if tool wiring regresses."
C05-01,"Refactor AnalyticsService to use ClockInterface consistently","Update `src/Services/AnalyticsService.php` to use its injected `ClockInterface` for time computations and timezone handling (remove direct `new DateTime('now', UTC)` usage). Update unit tests to use `tests/Fakes/FakeClock.php` for deterministic behavior. Acceptance: analytics is deterministic under test and respects WordPress timezone rules."
C05-02,"Centralize REST namespace across PHP and React","Create a single source of truth for the REST namespace (e.g., `AgentWPConfig::REST_NAMESPACE`), update `RestController` and `ResponseFormatter` to use it, and pass it to the frontend via `window.agentwpSettings` so `react/src/api/AgentWPClient.ts` does not hardcode it. Acceptance: API calls still work and namespace changes are one-line."
C05-03,"Standardize transient prefixes and cache key conventions","Audit uses of `Plugin::TRANSIENT_PREFIX`, `AgentWPConfig::CACHE_PREFIX_*`, and ad-hoc transient keys (REST log, caches). Standardize on one convention and refactor accordingly; ensure uninstall/deactivation cleanup still removes all plugin transients. Acceptance: cache keys are predictable and cleanup remains complete."
C05-04,"Expose frontend runtime config via agentwpSettings","Extend `src/Plugin/AssetManager.php#getScriptLocalization()` to expose `apiNamespace` and any other runtime constants the frontend should not hardcode (optionally max turns / limits). Update React to consume these values. Acceptance: React does not duplicate critical server constants."
C06-01,"Automate OpenAPI → TypeScript generation verification","Ensure `react/src/types/api.ts` is generated from `docs/openapi.json` deterministically; add/verify a `react` script (e.g., `npm run generate:types`) and add a verification step (CI or local script) that fails when generated types are stale. Document in `docs/DEVELOPER.md`. Acceptance: type generation drift is caught automatically."
C06-02,"Add contributor checklists for endpoints/intents/tools","Update `docs/DEVELOPER.md` with short checklists for adding a REST endpoint (ADR 0001 + DTO validation ADR 0007), adding an intent handler (ADR 0002), and adding a tool (Phase 4 decision). Include reminders to update `docs/EXTENSIONS.md` when introducing hooks. Acceptance: contributor docs provide step-by-step recipes."
C06-03,"Document and enforce Definition of Done for architecture changes","Add an 'Architecture change DoD' section to `docs/DEVELOPER.md` requiring relevant checks (PHPUnit, PHPCS, PHPStan, React tests where applicable) and documentation updates. Optionally add a convenience script to run the full suite. Acceptance: architecture work has a consistent quality gate."
