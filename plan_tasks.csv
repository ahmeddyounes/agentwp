id,title,spec
P01-01,"Confirm single supported frontend","Decide whether the shipped admin UI is (A) legacy wp-element bundle in `assets/agentwp-admin.*` or (B) the Vite React app in `react/` (preferred). Record the decision in `docs/ARCHITECTURE-IMPROVEMENT-PLAN.md` under Phase 1, including migration strategy, fallback behavior (if any), and the date/version the old path will be removed. Acceptance: the repo has one clearly documented UI source of truth."
P01-02,"Align WordPress mount node with React app","Make the WordPress-rendered admin page and the React app agree on a single mount element ID. Update either `src/Plugin/AdminMenuManager.php` to render `#agentwp-root` (or `#agentwp-admin-root`) and/or `react/src/main.tsx` to mount to the chosen node. Keep compatibility during migration if both IDs are temporarily present. Acceptance: the chosen mount node exists on the AgentWP admin page and React mounts reliably."
P01-03,"Configure Vite build for WordPress plugin delivery","Update `react/vite.config.ts` to emit a `manifest.json` and output assets into a plugin-owned directory intended for runtime enqueueing (e.g., `assets/build/`). Ensure `base` is compatible with plugin-relative URLs and chunk loading. Acceptance: `npm run build` produces deterministic output + manifest at the expected path."
P01-04,"Add manifest-based enqueueing in AssetManager","Update `src/Plugin/AssetManager.php` to prefer enqueuing the React build using the Vite `manifest.json` (entry JS + CSS + required chunks) when present. Keep a temporary fallback to `assets/agentwp-admin.*` while migrating. Acceptance: WordPress enqueues the React entry + CSS and the UI boots without manual script tags."
P01-05,"Plumb runtime config into the React app","Ensure the React app consumes `window.agentwpSettings` (nonce, REST root, version, demoMode, theme). If needed, expand `AssetManager::getScriptLocalization()` and update React API client/config initialization so it uses the localized REST root + nonce consistently. Acceptance: API calls succeed via WP nonce middleware, and demo/theme flags reflect server settings."
P01-06,"Fix chunk/static asset URL correctness","Verify that all React chunks load from the plugin URL (including hashed chunk files). Adjust Vite `base` and/or WordPress enqueue URLs until chunk requests resolve correctly on typical installs (subdir installs, multisite). Acceptance: no 404s for JS/CSS chunks in browser network tab."
P01-07,"Decide Command Deck surfaces and implement hooks","Decide whether the UI should load only on the AgentWP page or also on WooCommerce screens. Implement the chosen behavior in `src/Plugin/AssetManager.php` (enqueue rules) and `src/Plugin/AdminMenuManager.php` (mount node placement). Acceptance: assets load only where intended, and UI is accessible from the intended screens."
P01-08,"Update release workflow to package the real UI artifacts","Update `.github/workflows/release.yml` so the packaged zip includes the React build artifacts actually used by `AssetManager` (e.g., `assets/build/*` and manifest) and excludes unused build outputs. Remove/adjust the existing `rsync -a react/dist/ assets/` step if it is no longer correct. Acceptance: release zip contains the required UI assets and the plugin works when installed from the zip."
P01-09,"Update local developer workflow for UI builds","Add or update a script (e.g., `scripts/build-assets.sh`) and update `docs/DEVELOPER.md` so developers can build the React UI and produce the exact assets WordPress will enqueue. Acceptance: a single documented command builds UI assets into the correct runtime location."
P01-10,"Add/adjust E2E tests for the chosen UI path","Update Playwright tests under `tests/e2e/` to ensure the UI loads and core flows work with the new enqueue path (mount + settings fetch + intent submit). Acceptance: E2E passes using the packaged assets path."
P01-11,"Deprecate legacy wp-element UI bundle","If React becomes the supported UI, mark `assets/agentwp-admin.*` and any legacy-only code paths as deprecated, add an explicit removal milestone, and stop evolving the legacy UI. Acceptance: docs and code clearly communicate the deprecation and the default runtime uses React."
P01-12,"Remove legacy UI after migration window","After the migration window, delete the legacy bundle (`assets/agentwp-admin.*`) and remove fallback logic from `AssetManager`. Update docs and tests accordingly. Acceptance: repo ships only one UI implementation and all tests pass."
P02-01,"Inventory and document supported extension points","Create a single source of truth doc (e.g., `docs/EXTENSIONS.md`) listing supported actions/filters and their signatures (intent handlers, scorers, providers, REST controllers). Link it from `docs/DEVELOPER.md`. Acceptance: extension developers have an explicit, maintained list of supported hooks."
P02-02,"Document extension patterns with examples","Add examples for (1) registering a custom intent handler (tagged `intent.handler` + `#[HandlesIntent]`), (2) adding custom scorers via `agentwp_intent_scorers`, and (3) registering a custom REST controller via `rest.controller`. Put examples in `docs/DEVELOPER.md` or a dedicated doc. Acceptance: examples are copy/pasteable and match the container/provider patterns used in `src/Providers/*`."
P02-03,"Enforce module boundaries via static analysis","Add PHPStan rules (or a custom CI script) to prevent `src/Services/**` from calling WordPress/WooCommerce globals directly (e.g., `current_user_can`, `wc_*`, direct option/meta access). Prefer gateways/policy (`src/Infrastructure/*`, `src/Security/Policy/*`). Acceptance: violations fail CI and existing code passes (or is refactored)."
P02-04,"Refactor any boundary violations to use adapters","If static analysis finds violations, refactor the offending code to use existing interfaces (policy, gateways, options/cache). Add new interfaces/adapters only when needed, registered via providers. Acceptance: domain/services code no longer depends on WP/WC globals."
P02-05,"Add architecture tests for boundaries","Add a PHPUnit test (e.g., `tests/Integration/Architecture/BoundariesTest.php`) that guards key architectural boundaries (no forbidden function calls in service layer, controllers resolve via container, etc.). Acceptance: tests prevent regressions without being flaky."
P02-06,"Standardize DI usage in controllers/handlers","Audit controllers (`src/Rest/*`, `src/API/*`) and handlers (`src/Intent/Handlers/*`) to ensure dependencies are resolved via interfaces and container, not `new` or static access (except approved static subsystems). Acceptance: consistent DI pattern across request handling."
P03-01,"Pick one canonical REST error mechanism","Decide whether controllers should return `WP_Error` and rely on `src/Plugin/ResponseFormatter.php`, or return normalized `WP_REST_Response` errors via `RestController::response_error()`. Update controllers and/or formatter to eliminate duplicated error formatting logic. Acceptance: every endpoint follows one predictable error path."
P03-02,"Normalize analytics service results","Convert analytics to a consistent result type (prefer `ServiceResult` or a typed DTO) and update `src/Rest/AnalyticsController.php` to map it to responses consistently. Update `src/Contracts/AnalyticsServiceInterface.php` accordingly. Acceptance: analytics endpoints have uniform success/failure handling and clear types."
P03-03,"Normalize customer service results","Convert `CustomerServiceInterface` and implementation (`src/Services/CustomerService.php`) to return a consistent result type (prefer `ServiceResult`). Update `src/Intent/Handlers/CustomerLookupHandler.php` to consume it. Acceptance: customer lookups have uniform error handling and HTTP mapping."
P03-04,"Normalize order search service results","Convert `OrderSearchServiceInterface` and pipeline implementation (`src/Services/OrderSearch/*`) to return a consistent result type (prefer `ServiceResult`). Update `src/Intent/Handlers/OrderSearchHandler.php` accordingly. Acceptance: order search errors are structured and consistently mapped."
P03-05,"Introduce DTOs for complex response payloads","For endpoints/handlers that return large structured payloads (analytics charts, customer profile, search results), introduce DTOs (in `src/DTO/`) and use them internally before final REST serialization. Acceptance: response shapes are explicitly represented and easier to validate/test."
P03-06,"Make request validation consistent across controllers","Ensure all controllers use either (A) request DTOs with validation or (B) `RestController::validate_request()` schema validation, consistently. Refactor out ad-hoc validation patterns. Acceptance: adding a new endpoint follows a single validation recipe."
P03-07,"Sync OpenAPI and TypeScript types with implementation","Update `docs/openapi.json` to reflect the final request/response formats after Phase 3 changes. Ensure `react/src/types/api.ts` can be regenerated via `npm run generate:types`. Add a CI check to prevent drift. Acceptance: OpenAPI validates and generated types compile."
P04-01,"Implement UsageTrackerInterface adapter","Create an implementation of `src/Contracts/UsageTrackerInterface.php` that wraps `src/Billing/UsageTracker.php` (or refactor `UsageTracker` to support an instance API). Register it in `src/Providers/InfrastructureServiceProvider.php`. Acceptance: usage tracking can be injected/mocked in tests."
P04-02,"Remove remaining static usage tracking calls","Update callers (notably `src/AI/OpenAIClient.php` and `src/Rest/SettingsController.php`) to use the injected/resolved `UsageTrackerInterface` instead of calling `UsageTracker` statically where feasible. Acceptance: cross-cutting usage tracking is DI-friendly."
P04-03,"Add SearchIndexInterface adapter for static subsystem","Add a small interface + adapter layer for search index access (wrapping `src/Search/Index.php`) so consumers can depend on an interface. Update `src/Rest/SearchController.php` (and any other callers) to use it. Acceptance: search can be mocked and swapped without touching controllers."
P04-04,"Replace raw string container IDs where safe","Audit providers for string IDs (e.g., `'AgentWP\\Intent\\Engine'`) and replace with `::class` identifiers where safe. Ensure backward compatibility only where required. Acceptance: container registrations are consistent and less error-prone."
P04-05,"Expand container wiring tests for new adapters","Update/add integration tests (e.g., `tests/Integration/Container/ContainerWiringTest.php`) to ensure new adapters (usage tracker, search index) resolve correctly and controllers can `resolveRequired()` them. Acceptance: wiring failures are caught by tests."
P05-01,"Define and document deprecation versioning policy","Align `@deprecated` annotations with real plugin versions (currently some annotations reference versions not matching `AGENTWP_VERSION`). Update the policy in `docs/DEVELOPER.md` and adjust code annotations accordingly. Acceptance: deprecation metadata is credible and actionable."
P05-02,"Add installed-version tracking and upgrade runner","Add an installed-version option (e.g., `agentwp_installed_version`) and run upgrade steps on version change early in boot (e.g., `plugins_loaded`). Centralize in a small upgrader class (e.g., `src/Plugin/Upgrader.php`). Acceptance: upgrades are idempotent, testable, and documented."
P05-03,"Implement option migrations and cleanup via upgrader","Move option migrations (renamed keys, default values, deprecated options) into the upgrader. Ensure multisite behavior is correct where needed. Acceptance: upgrading preserves settings and removes obsolete keys safely."
P05-04,"Implement schema migrations via upgrader","Ensure billing/search tables (and any future schema) upgrades run via the upgrader rather than scattered calls. Keep `activate()` for first-install creation only. Acceptance: schema version bumps have a single entry point and tests."
P05-05,"Add tests for upgrader behavior","Add PHPUnit tests covering: fresh install, upgrade from older version, repeated boot (idempotency), and multisite path where applicable. Acceptance: upgrade logic is covered and stable."
P05-06,"Remove deprecated shims after migration window","After the upgrader migrates callers, remove deprecated constants/methods and update docs/changelog. Acceptance: the codebase does not keep dead compatibility paths indefinitely."
P06-01,"Introduce LoggerInterface and WP/WC adapters","Add a minimal logger contract (e.g., `src/Contracts/LoggerInterface.php`) with an implementation that uses WooCommerce logger when available (or `error_log` fallback). Register it in `InfrastructureServiceProvider`. Acceptance: core code logs through an interface without leaking secrets."
P06-02,"Add structured logging around AI calls","Add structured logs in `OpenAIClient`/factory around request timing, retry count, status codes, and error codes, explicitly excluding prompt content and API keys. Acceptance: useful operational logs exist without sensitive data exposure."
P06-03,"Add audit events for sensitive actions","Emit audit events/logs for API key updates (`src/Rest/SettingsController.php`) and draft confirmations (services/controllers handling confirmations). Decide audit sink (logger vs dedicated table) and document it. Acceptance: sensitive actions are traceable."
P06-04,"Move heavy search backfill work to scheduled execution","If search backfill still runs on `init`, refactor to run via scheduled tasks with lock + time slicing. Ensure it never blocks normal admin requests beyond a small budget. Acceptance: heavy work is bounded and predictable."
P06-05,"Move usage purging to scheduled execution","If usage row purges occur on every usage log/read, move them to a scheduled job with retention enforcement. Acceptance: usage tracking is cheap on the hot path."
P06-06,"Review and harden rate limiter performance","Validate `src/API/RateLimiter.php` locking and cache usage under concurrency. Add tests for lock contention and ensure it fails open safely when storage is unavailable. Acceptance: rate limiting is robust and low overhead."
P06-07,"Centralize operational knobs and document them","Ensure timeouts, retry limits, rate limits, memory limits/TTLs, and other knobs are consistently configurable via `SettingsManager` and/or filters (documented). Acceptance: operators can tune behavior without code edits."
P07-01,"Run PHPStan in CI","Update `.github/workflows/ci.yml` to run `composer run phpstan` (with appropriate PHP memory limits already defined in composer script). Acceptance: static analysis runs on PRs and blocks regressions."
P07-02,"Add release artifact validation job","Add a CI job that validates release-critical artifacts: UI build manifest exists, expected asset directories exist, and no forbidden folders (e.g., `node_modules`) are included in packaging paths. Acceptance: release breaks are caught before tagging."
P07-03,"Add OpenAPI type generation drift check","In CI (React job), run `npm run generate:types` and fail if it changes `react/src/types/api.ts` (or generate to a temp path and diff). Acceptance: OpenAPI and generated TS types stay in sync."
P07-04,"Ensure OpenAPI validation runs in CI for PRs","Confirm `scripts/openapi-validate.php` runs in CI and fails the build on spec errors. If it only logs, adjust to enforce failure. Acceptance: invalid OpenAPI cannot merge."
P07-05,"Add a single-command local validation script","Add a repo-root script (e.g., `scripts/validate.sh`) that runs PHP unit/static checks and React lint/test/build (and OpenAPI validation) in the same way CI does. Document in `docs/DEVELOPER.md`. Acceptance: contributors can reproduce CI locally with one command."
