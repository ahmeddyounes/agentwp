# Handoff: C07-07

Created: 2026-01-17T21:22:51.377524Z

Spec: .plans/C07-07.md

## Implementation Summary

Migrated remaining services to use DI and contracts, removing direct WordPress/WooCommerce global calls from non-infrastructure code.

### New Contracts Created
- `WooCommerceConfigGatewayInterface` - Abstracts `wc_get_is_paid_statuses()`, `is_woocommerce_available()`, `apply_filters()`
- `WooCommerceUserGatewayInterface` - Abstracts `get_userdata()`, user meta operations
- `WooCommerceProductCategoryGatewayInterface` - Abstracts `wc_get_product_terms()` with caching
- `WooCommercePriceFormatterInterface` - Abstracts `wc_price()`, `wc_format_decimal()`

### New Infrastructure Implementations
- `WooCommerceConfigGateway`
- `WooCommerceUserGateway`
- `WooCommerceProductCategoryGateway`
- `WooCommercePriceFormatter`

### Services Refactored
1. **CustomerService** - Now uses 6 injected dependencies instead of direct WP/WC calls
2. **AnalyticsService** - Now uses `OrderRepositoryInterface`, `WooCommerceOrderGatewayInterface`, `ClockInterface`
3. **OrderQueryService** - Now uses `OptionsInterface` instead of `get_option()`/`update_option()`

### ServiceProvider Updates
- `InfrastructureServiceProvider` - Registers new gateways
- `ServicesServiceProvider` - Wires up dependencies for CustomerService, AnalyticsService, OrderQueryService


## 2026-01-17T21:38:09.896068Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C07-07 in this git repository.

1) Read the spec: .plans/C07-07.md
2) Read handoff/context: .t2/handoff/C07-07.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: ab8c2fd5-66a0-49df-b6d0-44ac45aac6a1

Agent final message (file: C07-07.claude.impl.last.md):

---

## Status: DONE

## Summary of Changes

### New Contracts (4 files)
- `src/Contracts/WooCommerceConfigGatewayInterface.php` - Abstracts `wc_get_is_paid_statuses()`, WooCommerce availability checks, and `apply_filters()`
- `src/Contracts/WooCommerceUserGatewayInterface.php` - Abstracts `get_userdata()` and user operations
- `src/Contracts/WooCommerceProductCategoryGatewayInterface.php` - Abstracts `wc_get_product_terms()` with caching
- `src/Contracts/WooCommercePriceFormatterInterface.php` - Abstracts `wc_price()` and `wc_format_decimal()`

### New Infrastructure Implementations (4 files)
- `src/Infrastructure/WooCommerceConfigGateway.php`
- `src/Infrastructure/WooCommerceUserGateway.php`
- `src/Infrastructure/WooCommerceProductCategoryGateway.php`
- `src/Infrastructure/WooCommercePriceFormatter.php`

### Refactored Services (3 files)
- `src/Services/CustomerService.php` - Now uses 6 injected dependencies
- `src/Services/AnalyticsService.php` - Now uses `OrderRepositoryInterface`, `WooCommerceOrderGatewayInterface`, `ClockInterface`
- `src/Services/OrderSearch/OrderQueryService.php` - Now uses `OptionsInterface`

### Updated ServiceProviders (2 files)
- `src/Providers/InfrastructureServiceProvider.php` - Registers new gateway interfaces
- `src/Providers/ServicesServiceProvider.php` - Wires up dependencies for refactored services

## How to Verify

```bash
# Check PHP syntax
find src -name "*.php" -exec php -l {} \;

# Run static analysis (if available)
./vendor/bin/phpstan analyse src

# Run tests
./vendor/bin/phpunit
```

## Risks / Follow-ups

1. **DateRangeParser static factory**: `DateRangeParser::withWordPressTimezone()` still calls `wp_timezone_string()` and `get_option()` directly. This is acceptable as it's a named factory method for production wiring, similar to `SystemClock::withWordPressTimezone()`.

2. **Sanitization functions**: Services still use WordPress sanitization utilities (`sanitize_text_field`, `sanitize_email`, `absint`). These are stateless utility functions and are acceptable per WordPress plugin security best practices.

3. **Test coverage**: The new gateway interfaces should have unit tests with mock implementations to verify the services work correctly with different configurations.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Providers/InfrastructureServiceProvider.php
 M src/Providers/ServicesServiceProvider.php
 M src/Services/AnalyticsService.php
 M src/Services/CustomerService.php
 M src/Services/OrderSearch/OrderQueryService.php
?? .logs/C07-06.gitcommit.txt
?? .logs/C07-07.claude.impl.last.md
?? .logs/C07-07.claude.impl.raw.txt
?? .plans/C07-07.md
?? .t2/handoff/C07-07.md
?? src/Contracts/WooCommerceConfigGatewayInterface.php
?? src/Contracts/WooCommercePriceFormatterInterface.php
?? src/Contracts/WooCommerceProductCategoryGatewayInterface.php
?? src/Contracts/WooCommerceUserGatewayInterface.php
?? src/Infrastructure/WooCommerceConfigGateway.php
?? src/Infrastructure/WooCommercePriceFormatter.php
?? src/Infrastructure/WooCommerceProductCategoryGateway.php
?? src/Infrastructure/WooCommerceUserGateway.php

diff --stat:
.t2/state.json                                  |   5 +-
 src/Providers/InfrastructureServiceProvider.php |  40 +++
 src/Providers/ServicesServiceProvider.php       |  23 +-
 src/Services/AnalyticsService.php               | 118 ++++--
 src/Services/CustomerService.php                | 453 +++++++++++-------------
 src/Services/OrderSearch/OrderQueryService.php  |  31 +-
 6 files changed, 380 insertions(+), 290 deletions(-)

```
