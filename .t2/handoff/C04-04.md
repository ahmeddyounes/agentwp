# Handoff: C04-04

Created: 2026-01-17T18:08:15.147878Z

Spec: .plans/C04-04.md


## 2026-01-17T18:16:44.920327Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C04-04 in this git repository.

1) Read the spec: .plans/C04-04.md
2) Read handoff/context: .t2/handoff/C04-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 6d2051b6-eb4e-4a06-8a86-4e78ed878ad1

Agent final message (file: C04-04.claude.impl.last.md):

All the changes are complete. Let me provide a summary of the implementation.

---

**Status: DONE**

## Summary of Changes

### 1. `src/Intent/Classifier/ScorerRegistry.php`
- Added `implements IntentClassifierInterface` to make ScorerRegistry the canonical classifier per ADR 0003
- Added constructor accepting `WPFunctions` (or any object with `doAction()` for testability)
- Added `fireClassifiedAction()` private method that fires `agentwp_intent_classified` action after classification
- Updated class docblock to document its role as the canonical implementation

### 2. `src/Providers/IntentServiceProvider.php`
- Added imports for `ScorerRegistry`, `Scorers`, and `WPFunctions`
- Updated `registerIntentClassifier()` to:
  - Wire `ScorerRegistry` as `IntentClassifierInterface` instead of legacy `IntentClassifier`
  - Apply `agentwp_intent_scorers` filter for third-party scorer registration
  - Pass `WPFunctions` to `ScorerRegistry` for action hook support
  - Validate filter returns an array (fallback to defaults if not)

### 3. `tests/Unit/Intent/Classifier/ScorerRegistryTest.php` (new)
- 20 unit tests covering:
  - Interface implementation
  - Scorer registration (single, many, replacement)
  - Classification (highest score, unknown, empty, alphabetical tiebreaker)
  - Context override handling
  - Input truncation (DoS protection)
  - Action hook firing
  - Case insensitivity
  - `withDefaults()` factory method

### 4. `tests/Fakes/FakeWPFunctions.php` (new)
- Test double for `WPFunctions` that captures action/filter calls for assertions

### 5. `tests/Integration/Container/ContainerWiringTest.php`
- Added 2 integration tests:
  - `test_intent_classifier_interface_wired_to_scorer_registry()` - verifies ADR 0003 wiring
  - `test_scorer_registry_has_all_default_scorers()` - verifies all 7 default scorers registered

## How to Verify

```bash
# Run all tests
./vendor/bin/phpunit --no-coverage

# Run specific ScorerRegistry tests
./vendor/bin/phpunit tests/Unit/Intent/Classifier/ScorerRegistryTest.php --no-coverage

# Run container wiring tests
./vendor/bin/phpunit tests/Integration/Container/ContainerWiringTest.php --no-coverage
```

## Risks / Follow-ups

1. **Backward Compatibility**: The legacy `IntentClassifier` class still exists but is no longer wired to the container. Code explicitly instantiating `IntentClassifier` will work but won't benefit from the new extensibility. Per ADR 0003, deprecation notices should be added in v2.0.

2. **Filter Validation**: The `agentwp_intent_scorers` filter validates that an array is returned, but doesn't validate individual scorer types. Malformed scorers could cause runtime errors. Consider adding type validation in a follow-up.

3. **Deferred ADR items**: Per ADR 0003, the following are deferred:
   - `WeightedScorerDecorator` for weight support
   - Confidence threshold integration
   - `@deprecated` annotation on legacy `IntentClassifier`


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Intent/Classifier/ScorerRegistry.php
 M src/Providers/IntentServiceProvider.php
 M tests/Integration/Container/ContainerWiringTest.php
?? .logs/C04-03.gitcommit.txt
?? .logs/C04-04.claude.impl.last.md
?? .logs/C04-04.claude.impl.raw.txt
?? .plans/C04-04.md
?? .t2/handoff/C04-04.md
?? tests/Fakes/FakeWPFunctions.php
?? tests/Unit/Intent/Classifier/

diff --stat:
.t2/state.json                                     |  5 ++-
 src/Intent/Classifier/ScorerRegistry.php           | 52 +++++++++++++++++++++-
 src/Providers/IntentServiceProvider.php            | 42 +++++++++++++++--
 .../Integration/Container/ContainerWiringTest.php  | 37 +++++++++++++++
 4 files changed, 128 insertions(+), 8 deletions(-)

```


## 2026-01-18T13:04:14.012624Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C04-04 in this git repository.

1) Read the spec: .plans/C04-04.md
2) Read handoff/context: .t2/handoff/C04-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 91fbf68a-1cfb-4e5d-9d93-f8cfdbcd943a

Agent final message (file: C04-04.claude.impl.last.md):

---

## Status: DONE

## Summary of Changes

Implemented executable tools for order operations following the spec in C04-04.md. The key changes:

### New Files Created:

1. **`src/Contracts/ExecutableToolInterface.php`** - Contract defining `getName()` and `execute(array $arguments): array` methods for self-contained tools

2. **`src/Intent/Tools/SearchOrdersTool.php`** - Executable tool calling `OrderSearchServiceInterface::handle()`

3. **`src/Intent/Tools/PrepareRefundTool.php`** - Executable tool calling `OrderRefundServiceInterface::prepare_refund()`

4. **`src/Intent/Tools/ConfirmRefundTool.php`** - Executable tool calling `OrderRefundServiceInterface::confirm_refund()`

5. **`src/Intent/Tools/PrepareStatusUpdateTool.php`** - Executable tool calling `OrderStatusServiceInterface::prepare_status_update()`

6. **`src/Intent/Tools/PrepareBulkStatusUpdateTool.php`** - Executable tool calling `OrderStatusServiceInterface::prepare_bulk_status_update()`

7. **`src/Intent/Tools/ConfirmStatusUpdateTool.php`** - Executable tool calling `OrderStatusServiceInterface::confirm_status_update()`

8. **`tests/Fakes/FakeToolDispatcher.php`** - Test double for `ToolDispatcherInterface` with tool registration support

### Modified Files:

1. **`src/Contracts/ToolDispatcherInterface.php`** - Added `registerTool()` and `registerTools()` methods

2. **`src/Intent/ToolDispatcher.php`** - Implemented new interface methods for registering `ExecutableToolInterface` instances

3. **`src/Providers/IntentServiceProvider.php`** - Added `registerToolDispatcher()` to centrally wire all tools and updated handler registrations

4. **`src/Intent/Handlers/OrderSearchHandler.php`** - Updated constructor to accept `ToolDispatcherInterface` instead of service; `registerToolExecutors()` now no-op

5. **`src/Intent/Handlers/OrderRefundHandler.php`** - Same pattern as above

6. **`src/Intent/Handlers/OrderStatusHandler.php`** - Same pattern as above

7. **`tests/Unit/OrderRefundHandlerTest.php`** - Updated to use new constructor signature with `FakeToolDispatcher`

8. **`tests/Unit/Intent/Handlers/OrderSearchHandlerTest.php`** - Updated to use new constructor signature

9. **`tests/Unit/Intent/Handlers/SimpleHandlersTest.php`** - Updated to use new constructor signatures with pre-registered tools

10. **`tests/Unit/Validation/ToolArgumentValidationIntegrationTest.php`** - Updated to use new constructor signature

## How to Verify

```bash
# Run all intent-related tests
./vendor/bin/phpunit --filter "Intent"

# Run handler tests specifically
./vendor/bin/phpunit --filter "OrderRefundHandlerTest|OrderSearchHandlerTest|SimpleHandlersTest|ToolArgumentValidationIntegrationTest"

# Run full test suite (excluding pre-existing Search module issues)
./vendor/bin/phpunit --filter "^(?!.*Search)"
```

Expected: All tests pass (109 intent tests, 715 non-search tests)

## Risks / Follow-ups

1. **Pre-existing Search module test failures** - 8 tests in `tests/Unit/Search/` fail due to undefined constants (`DEFAULT_LIMIT`, `BACKFILL_LIMIT`, `BACKFILL_WINDOW`). These are unrelated to this task.

2. **Deprecation warnings** - `IntentClassifier` shows deprecation warnings during tests. This is expected per ADR-0003.

3. **FakeToolDispatcher doesn't validate** - The test double bypasses argument validation. For validation-specific tests, we simulate validation failure by not registering tools. This is a conscious test design choice.


Repo snapshot:
```
branch: main

status:
M .logs/C04-03.gitcommit.txt
 M .logs/C04-04.claude.impl.last.md
 M .logs/C04-04.claude.impl.raw.txt
 M .plans/C04-04.md
 M .t2/state.json
 M src/Contracts/ToolDispatcherInterface.php
 M src/Intent/Handlers/OrderRefundHandler.php
 M src/Intent/Handlers/OrderSearchHandler.php
 M src/Intent/Handlers/OrderStatusHandler.php
 M src/Intent/ToolDispatcher.php
 M src/Providers/IntentServiceProvider.php
 M tests/Unit/Intent/Handlers/OrderSearchHandlerTest.php
 M tests/Unit/Intent/Handlers/SimpleHandlersTest.php
 M tests/Unit/OrderRefundHandlerTest.php
 M tests/Unit/Validation/ToolArgumentValidationIntegrationTest.php
?? src/Contracts/ExecutableToolInterface.php
?? src/Intent/Tools/
?? tests/Fakes/FakeToolDispatcher.php

diff --stat:
.logs/C04-03.gitcommit.txt                         |  12 ++-
 .logs/C04-04.claude.impl.last.md                   | 100 +++++++++++----------
 .logs/C04-04.claude.impl.raw.txt                   |   2 +-
 .plans/C04-04.md                                   |   4 +-
 .t2/state.json                                     |   5 +-
 src/Contracts/ToolDispatcherInterface.php          |  18 +++-
 src/Intent/Handlers/OrderRefundHandler.php         |  38 ++------
 src/Intent/Handlers/OrderSearchHandler.php         |  58 ++----------
 src/Intent/Handlers/OrderStatusHandler.php         |  44 +++------
 src/Intent/ToolDispatcher.php                      |  28 +++++-
 src/Providers/IntentServiceProvider.php            |  58 ++++++++++--
 .../Intent/Handlers/OrderSearchHandlerTest.php     |  20 +++--
 tests/Unit/Intent/Handlers/SimpleHandlersTest.php  |  39 ++++++--
 tests/Unit/OrderRefundHandlerTest.php              |  16 +++-
 .../ToolArgumentValidationIntegrationTest.php      |  36 ++++++--
 15 files changed, 279 insertions(+), 199 deletions(-)

```
