# Handoff: C04-02

Created: 2026-01-17T18:00:02.603564Z

Spec: .plans/C04-02.md


## 2026-01-17T18:03:42.494724Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C04-02 in this git repository.

1) Read the spec: .plans/C04-02.md
2) Read handoff/context: .t2/handoff/C04-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: bd3fb342-3365-4048-a5c7-69ac2c7e2c48

Agent final message (file: C04-02.claude.impl.last.md):

All tests pass. Let me provide a summary of the implementation:

---

**Status: DONE**

## Summary of Changes

### 1. `src/Intent/Handlers/BaseHandler.php`
- Added `@deprecated 2.0.0` annotation to `getIntent()` method with migration instructions
- Added `@see` reference to `\AgentWP\Intent\Attributes\HandlesIntent`
- Added `triggerDeprecationWarning()` private helper method that:
  - Only triggers in WP_DEBUG mode
  - Uses static tracking to avoid duplicate warnings per handler class
  - Uses WordPress `_doing_it_wrong()` when available, falls back to `trigger_error()`
  - Includes migration suggestions

### 2. `src/Intent/Engine.php`
- Added `triggerLegacyMethodWarning()` private helper method for legacy discovery detection
- Added deprecation comment annotations to both fallback paths (`getSupportedIntents()` and `getIntent()`)
- Warnings are triggered when Engine falls back to legacy methods (only in WP_DEBUG mode)
- Warning messages reference the ADR document for migration instructions

### 3. `docs/adr/0002-intent-handler-registration.md`
- Marked Phase 1 (Soft Deprecation) as ✅ IMPLEMENTED
- Added details about how deprecation warnings work
- Updated migration checklist to mark "Add deprecation logging for legacy discovery paths" as complete

## How to Verify

```bash
# Run PHP syntax check
php -l src/Intent/Handlers/BaseHandler.php
php -l src/Intent/Engine.php

# Run tests
php vendor/bin/phpunit --no-coverage

# To test deprecation warnings manually (in WP_DEBUG mode):
# 1. Create a handler without #[HandlesIntent] attribute
# 2. Register it via the agentwp_intent_handlers filter
# 3. Check debug.log for deprecation notices
```

## Risks / Follow-ups

1. **Handlers using legacy methods will see warnings in WP_DEBUG mode** - This is intentional to encourage migration, but could generate log noise during development.

2. **The `getIntent()` method in BaseHandler will trigger a deprecation warning every time it's called** - The warning is deduplicated per-class, but if handlers that already use `#[HandlesIntent]` also call `getIntent()` internally, they'll see warnings. The current core handlers (e.g., `OrderSearchHandler`) use attributes, so they won't trigger warnings during intent discovery.

3. **Follow-up tasks documented in ADR:**
   - Update DEVELOPER.md with new handler registration guide
   - Create migration script for custom handlers (optional tooling)
   - Migrate all core handlers to use attributes (some already do)


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M docs/adr/0002-intent-handler-registration.md
 M src/Intent/Engine.php
 M src/Intent/Handlers/BaseHandler.php
?? .logs/C04-01.gitcommit.txt
?? .logs/C04-02.claude.impl.last.md
?? .logs/C04-02.claude.impl.raw.txt
?? .plans/C04-02.md
?? .t2/handoff/C04-02.md

diff --stat:
.t2/state.json                               |  5 ++--
 docs/adr/0002-intent-handler-registration.md | 13 ++++----
 src/Intent/Engine.php                        | 42 ++++++++++++++++++++++++++
 src/Intent/Handlers/BaseHandler.php          | 45 ++++++++++++++++++++++++++++
 4 files changed, 98 insertions(+), 7 deletions(-)

```
