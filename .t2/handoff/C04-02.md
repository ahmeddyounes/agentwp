# Handoff: C04-02

Created: 2026-01-17T18:00:02.603564Z

Spec: .plans/C04-02.md


## 2026-01-17T18:03:42.494724Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C04-02 in this git repository.

1) Read the spec: .plans/C04-02.md
2) Read handoff/context: .t2/handoff/C04-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: bd3fb342-3365-4048-a5c7-69ac2c7e2c48

Agent final message (file: C04-02.claude.impl.last.md):

All tests pass. Let me provide a summary of the implementation:

---

**Status: DONE**

## Summary of Changes

### 1. `src/Intent/Handlers/BaseHandler.php`
- Added `@deprecated 2.0.0` annotation to `getIntent()` method with migration instructions
- Added `@see` reference to `\AgentWP\Intent\Attributes\HandlesIntent`
- Added `triggerDeprecationWarning()` private helper method that:
  - Only triggers in WP_DEBUG mode
  - Uses static tracking to avoid duplicate warnings per handler class
  - Uses WordPress `_doing_it_wrong()` when available, falls back to `trigger_error()`
  - Includes migration suggestions

### 2. `src/Intent/Engine.php`
- Added `triggerLegacyMethodWarning()` private helper method for legacy discovery detection
- Added deprecation comment annotations to both fallback paths (`getSupportedIntents()` and `getIntent()`)
- Warnings are triggered when Engine falls back to legacy methods (only in WP_DEBUG mode)
- Warning messages reference the ADR document for migration instructions

### 3. `docs/adr/0002-intent-handler-registration.md`
- Marked Phase 1 (Soft Deprecation) as ✅ IMPLEMENTED
- Added details about how deprecation warnings work
- Updated migration checklist to mark "Add deprecation logging for legacy discovery paths" as complete

## How to Verify

```bash
# Run PHP syntax check
php -l src/Intent/Handlers/BaseHandler.php
php -l src/Intent/Engine.php

# Run tests
php vendor/bin/phpunit --no-coverage

# To test deprecation warnings manually (in WP_DEBUG mode):
# 1. Create a handler without #[HandlesIntent] attribute
# 2. Register it via the agentwp_intent_handlers filter
# 3. Check debug.log for deprecation notices
```

## Risks / Follow-ups

1. **Handlers using legacy methods will see warnings in WP_DEBUG mode** - This is intentional to encourage migration, but could generate log noise during development.

2. **The `getIntent()` method in BaseHandler will trigger a deprecation warning every time it's called** - The warning is deduplicated per-class, but if handlers that already use `#[HandlesIntent]` also call `getIntent()` internally, they'll see warnings. The current core handlers (e.g., `OrderSearchHandler`) use attributes, so they won't trigger warnings during intent discovery.

3. **Follow-up tasks documented in ADR:**
   - Update DEVELOPER.md with new handler registration guide
   - Create migration script for custom handlers (optional tooling)
   - Migrate all core handlers to use attributes (some already do)


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M docs/adr/0002-intent-handler-registration.md
 M src/Intent/Engine.php
 M src/Intent/Handlers/BaseHandler.php
?? .logs/C04-01.gitcommit.txt
?? .logs/C04-02.claude.impl.last.md
?? .logs/C04-02.claude.impl.raw.txt
?? .plans/C04-02.md
?? .t2/handoff/C04-02.md

diff --stat:
.t2/state.json                               |  5 ++--
 docs/adr/0002-intent-handler-registration.md | 13 ++++----
 src/Intent/Engine.php                        | 42 ++++++++++++++++++++++++++
 src/Intent/Handlers/BaseHandler.php          | 45 ++++++++++++++++++++++++++++
 4 files changed, 98 insertions(+), 7 deletions(-)

```


## 2026-01-18T12:46:25.232765Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C04-02 in this git repository.

1) Read the spec: .plans/C04-02.md
2) Read handoff/context: .t2/handoff/C04-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: eebe6c29-5aa3-4776-9f97-14b175eb7424

Agent final message (file: C04-02.claude.impl.last.md):

---

**Status: DONE**

## Summary of Changes

### New Files Created
1. **`src/Validation/ToolArgumentValidator.php`** - Validates tool arguments against JSON schemas using `rest_validate_value_from_schema()`
2. **`src/Validation/ToolArgumentValidationResult.php`** - Value object for validation results with consistent error shape
3. **`tests/Unit/Validation/ToolArgumentValidatorTest.php`** - 10 unit tests covering type errors, required fields, enums, min/max values, nested objects, additional properties
4. **`tests/Unit/Validation/ToolArgumentValidationIntegrationTest.php`** - 4 integration tests proving invalid args never reach domain services
5. **`tests/Support/rest-validation-functions.php`** - Test stubs for WordPress REST API validation functions

### Modified Files
1. **`src/Intent/Handlers/AbstractAgenticHandler.php`** - Added validation in `executeToolCalls()` before calling `execute_tool()`
2. **`tests/bootstrap.php`** - Enhanced `WP_Error` stub with all required methods, added rest-validation-functions.php include

### Consistent Error Shape
```php
[
    'success' => false,
    'error' => 'Invalid arguments for tool "tool_name": error message',
    'code' => 'invalid_tool_arguments',
    'validation_errors' => [...]
]
```

## How to Verify

```bash
# Run validation tests only
php vendor/bin/phpunit --no-coverage tests/Unit/Validation/

# Run handler tests (includes validation integration)
php vendor/bin/phpunit --no-coverage tests/Unit/Intent/Handlers/

# Syntax check new files
php -l src/Validation/ToolArgumentValidator.php
php -l src/Validation/ToolArgumentValidationResult.php
php -l src/Intent/Handlers/AbstractAgenticHandler.php
```

## Risks / Follow-ups

1. **Backward compatibility**: The `AbstractAgenticHandler` constructor now has an optional 4th parameter. Existing handlers that extend it will continue to work since the validator defaults to a new instance.

2. **Pre-existing test failures**: 8 test failures exist in `tests/Unit/Search/` related to missing constants (`BACKFILL_LIMIT`, `BACKFILL_WINDOW`, `DEFAULT_LIMIT`). These are unrelated to this change.

3. **Performance**: Schema validation adds minimal overhead per tool call. The validation is lightweight since it uses WordPress's built-in `rest_validate_value_from_schema()`.

4. **Test stub completeness**: The `rest_validate_value_from_schema()` stub in tests/Support covers common validation scenarios but may not cover all edge cases of the real WordPress function. If more complex validation is needed, the stub may need extension.


Repo snapshot:
```
branch: main

status:
M .logs/C04-01.gitcommit.txt
 M .logs/C04-02.claude.impl.last.md
 M .logs/C04-02.claude.impl.raw.txt
 M .plans/C04-02.md
 M .t2/state.json
 M src/Intent/Handlers/AbstractAgenticHandler.php
 M tests/bootstrap.php
?? src/Validation/
?? tests/Support/rest-validation-functions.php
?? tests/Unit/Validation/

diff --stat:
.logs/C04-01.gitcommit.txt                     | 10 ++--
 .logs/C04-02.claude.impl.last.md               | 69 ++++++++++++--------------
 .logs/C04-02.claude.impl.raw.txt               |  2 +-
 .plans/C04-02.md                               | 62 ++++++++++++++++++++++-
 .t2/state.json                                 |  5 +-
 src/Intent/Handlers/AbstractAgenticHandler.php | 57 ++++++++++++++++++---
 tests/bootstrap.php                            | 56 ++++++++++++++++++---
 7 files changed, 198 insertions(+), 63 deletions(-)

```
