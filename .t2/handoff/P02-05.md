# Handoff: P02-05

Created: 2026-01-18T08:34:37.954486Z

Spec: .plans/P02-05.md


## 2026-01-18T08:39:39.700526Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P02-05 in this git repository.

1) Read the spec: .plans/P02-05.md
2) Read handoff/context: .t2/handoff/P02-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: a428b2c9-0f3f-4cdb-a1e1-ec7e3ae940da

Agent final message (file: P02-05.claude.impl.last.md):

---

## Status: DONE

## Summary of changes

Created `tests/Integration/Architecture/BoundariesTest.php` with **82 architecture boundary tests** that guard key architectural patterns:

### Test Categories:

1. **Services Layer Boundaries (26 tests)**
   - `test_services_do_not_call_forbidden_functions` - Verifies services in `src/Services/` don't call 38 forbidden WordPress/WooCommerce globals (uses AST analysis)
   - `test_services_depend_only_on_interfaces` - Verifies services depend on interfaces from `src/Contracts/`, not concrete classes

2. **Controller Layer Boundaries (10 tests)**
   - `test_rest_controllers_extend_base_controller` - Verifies REST controllers extend `RestController` for DI access
   - `test_controllers_do_not_directly_instantiate_services` - Verifies controllers use `$this->resolve()` / `$this->resolveRequired()` instead of `new Service()`

3. **Infrastructure Layer Boundaries (19 tests)**
   - `test_infrastructure_classes_implement_contracts` - Verifies gateways/repositories implement their contract interfaces

4. **Intent Handler Boundaries (22 tests)**
   - `test_intent_handlers_implement_handler_interface` - Verifies handlers implement the `Handler` interface
   - `test_intent_handlers_depend_only_on_interfaces` - Verifies handlers use dependency injection

5. **Provider Layer Boundaries (5 tests)**
   - `test_providers_do_not_call_forbidden_functions_at_registration` - Verifies providers defer WordPress/WooCommerce calls

### Key Features:
- Uses PhpParser for AST analysis (doesn't require WordPress to be loaded)
- Uses reflection for class analysis where possible
- Data providers ensure tests scale with new files
- Complements existing PHPStan `ForbiddenServicesGlobalsRule`
- Not flaky (verified with multiple runs)

## How to verify

```bash
# Run architecture boundary tests
./vendor/bin/phpunit tests/Integration/Architecture/BoundariesTest.php --testdox

# Run all integration tests
./vendor/bin/phpunit tests/Integration/

# Run full test suite
./vendor/bin/phpunit
```

## Risks / Follow-ups

1. **Internal sub-services in OrderSearch** - Currently allows `OrderSearch/` classes to depend on each other as they form a pipeline. Consider adding interfaces if these need to be testable independently.

2. **SettingsManager concrete dependency** - `DraftManager` depends on `SettingsManager` (concrete class). Consider adding a `SettingsManagerInterface` in the future.

3. **Test maintenance** - The allowed patterns lists (`isAllowedServiceDependency`, `isAllowedHandlerDependency`) may need updates as the architecture evolves. These are clearly documented with comments explaining why each pattern is allowed.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
?? .logs/P02-04.gitcommit.txt
?? .logs/P02-05.claude.impl.last.md
?? .logs/P02-05.claude.impl.raw.txt
?? .plans/P02-05.md
?? .t2/handoff/P02-05.md
?? tests/Integration/Architecture/

diff --stat:
.t2/state.json | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

```
