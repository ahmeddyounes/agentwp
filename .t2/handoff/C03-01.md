# Handoff: C03-01

Created: 2026-01-17T16:59:10.548342Z

Spec: .plans/C03-01.md


## 2026-01-17T17:02:51.931959Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C03-01 in this git repository.

1) Read the spec: .plans/C03-01.md
2) Read handoff/context: .t2/handoff/C03-01.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 310402d5-12c7-49fe-8829-48f9dfda334f

Agent final message (file: C03-01.claude.impl.last.md):

All changes are complete. Let me provide a summary:

---

**Status: DONE**

## Summary of Changes

### Files Modified:

1. **`src/Config/AgentWPConfig.php`**
   - Added `ERROR_CODE_SERVICE_UNAVAILABLE = 'agentwp_service_unavailable'` constant for 500 error responses when required dependencies cannot be resolved

2. **`src/API/RestController.php`**
   - Added new `resolveRequired()` method that returns a 500 error response when a required dependency cannot be resolved from the container
   - Provides clear error messages indicating why the service is unavailable (container not initialized, not registered, resolved to null, or exception thrown)

3. **`src/Rest/IntentController.php`** (lines 69-72)
   - Replaced broken fallback pattern `$engine = $this->resolve(Engine::class); if (!$engine) { $engine = new Engine(); }` 
   - Now uses `resolveRequired(Engine::class, 'Intent engine')` which returns 500 error if Engine cannot be resolved
   - Removed broken fallback that would create an Engine with no handlers

4. **`src/Rest/AnalyticsController.php`** (lines 52-56)
   - Replaced fallback pattern `$service = $this->resolve(AnalyticsServiceInterface::class); if (!$service) { $service = new AnalyticsService(); }`
   - Now uses `resolveRequired(AnalyticsServiceInterface::class, 'Analytics service')`
   - Removed unused `AnalyticsService` import

## How to Verify

```bash
# Check PHP syntax
php -l src/Config/AgentWPConfig.php
php -l src/API/RestController.php
php -l src/Rest/IntentController.php
php -l src/Rest/AnalyticsController.php

# Run tests (if available)
./vendor/bin/phpunit

# Manual verification:
# 1. When container is properly initialized, /intent and /analytics endpoints work normally
# 2. If Engine or AnalyticsService is not registered in container, endpoints return 500 with clear error message
```

## Acceptance Criteria Verification

- **No core controller instantiates domain services directly in normal runtime**: Verified by grep for `new [A-Z]` patterns - only `WP_Error` instantiations remain (WordPress core types, not domain services)
- **Clear 500 error when required dependency cannot be resolved**: `resolveRequired()` returns structured error response with `agentwp_service_unavailable` code

## Risks / Follow-ups

1. **Risk**: If the container is not properly bootstrapped (e.g., service providers not registered), the `/intent` and `/analytics` endpoints will now return 500 errors instead of silently working with broken fallbacks. This is the intended behavior.

2. **Follow-up consideration**: Static utility classes like `Index` (search) and `UsageTracker` (billing) remain as static method calls. These are infrastructure/data access classes, not domain services, so they don't need container injection. However, if testing requirements change, consider refactoring them to interfaces.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/API/RestController.php
 M src/Config/AgentWPConfig.php
 M src/Rest/AnalyticsController.php
 M src/Rest/IntentController.php
?? .logs/C02-09.gitcommit.txt
?? .logs/C03-01.claude.impl.last.md
?? .logs/C03-01.claude.impl.raw.txt
?? .plans/C03-01.md
?? .t2/handoff/C03-01.md

diff --stat:
.t2/state.json                   |  5 ++--
 src/API/RestController.php       | 52 ++++++++++++++++++++++++++++++++++++++++
 src/Config/AgentWPConfig.php     | 15 ++++++------
 src/Rest/AnalyticsController.php |  7 +++---
 src/Rest/IntentController.php    |  6 ++---
 5 files changed, 69 insertions(+), 16 deletions(-)

```


## 2026-01-17T17:03:09.891298Z — claude — after1

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions --resume 310402d5-12c7-49fe-8829-48f9dfda334f We just completed/updated task C03-01.

Spec: .plans/C03-01.md
Handoff/context: .t2/handoff/C03-01.md

Run this follow-up instruction:
Self review all your uncommited changes

If you modify code, keep changes minimal and consistent with the task.
Summarize what you did.

```

Return code: 0

Session: 310402d5-12c7-49fe-8829-48f9dfda334f

Agent final message (file: C03-01.claude.after1.last.md):

The changes look correct. Let me review each change:

1. **`.t2/state.json`** - Tracking file update, not part of the implementation

2. **`src/API/RestController.php`** - Added `resolveRequired()` method with:
   - Proper PHPDoc with `@param` and `@return` types
   - Handles 4 failure modes: no container, not registered, resolved to null, exception
   - Uses WordPress i18n with translator comments
   - Returns 500 status code for all failures

3. **`src/Config/AgentWPConfig.php`** - Added `ERROR_CODE_SERVICE_UNAVAILABLE` constant, aligned with existing spacing

4. **`src/Rest/AnalyticsController.php`** - 
   - Removed unused `AnalyticsService` import
   - Replaced broken fallback with `resolveRequired()`
   - Proper early return on error response

5. **`src/Rest/IntentController.php`** - 
   - Replaced broken fallback (`new Engine()` with no handlers) with `resolveRequired()`
   - Proper early return on error response

All changes are minimal, focused, and consistent with the task requirements. No unnecessary modifications.

## Summary

Self-review complete. Changes are correct and minimal:

- **4 files modified** (excluding `.t2/state.json` tracking file)
- Added `resolveRequired()` helper in base `RestController` for required dependencies
- Added `ERROR_CODE_SERVICE_UNAVAILABLE` error code
- Removed 2 broken fallbacks in `IntentController` and `AnalyticsController`
- Removed 1 unused import in `AnalyticsController`


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/API/RestController.php
 M src/Config/AgentWPConfig.php
 M src/Rest/AnalyticsController.php
 M src/Rest/IntentController.php
?? .logs/C02-09.gitcommit.txt
?? .logs/C03-01.claude.after1.last.md
?? .logs/C03-01.claude.after1.raw.txt
?? .logs/C03-01.claude.impl.last.md
?? .logs/C03-01.claude.impl.raw.txt
?? .plans/C03-01.md
?? .t2/handoff/C03-01.md

diff --stat:
.t2/state.json                   |  8 ++++---
 src/API/RestController.php       | 52 ++++++++++++++++++++++++++++++++++++++++
 src/Config/AgentWPConfig.php     | 15 ++++++------
 src/Rest/AnalyticsController.php |  7 +++---
 src/Rest/IntentController.php    |  6 ++---
 5 files changed, 71 insertions(+), 17 deletions(-)

```


## 2026-01-18T12:21:30.021259Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C03-01 in this git repository.

1) Read the spec: .plans/C03-01.md
2) Read handoff/context: .t2/handoff/C03-01.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: ccf314ed-d751-45f2-bf03-7ac5d7eeb4a5

Agent final message (file: C03-01.claude.impl.last.md):

The implementation is complete. Let me provide the final summary.

---

**Status: DONE**

## Summary of Changes

### Files Created:

1. **`src/Contracts/HooksInterface.php`** (new)
   - Defines contract for WordPress filter and action hooks
   - Methods: `applyFilters()` and `doAction()`
   - Enables testability by abstracting WordPress globals

2. **`tests/Unit/Intent/EngineHooksTest.php`** (new)
   - 6 unit tests verifying Engine uses injected hooks
   - Tests: filter application, action firing, filter modification, backward compatibility

### Files Modified:

3. **`src/Infrastructure/WPFunctions.php`**
   - Added `implements HooksInterface` clause
   - Already had `applyFilters()` and `doAction()` methods - no changes needed to method implementations

4. **`src/Intent/Engine.php`**
   - Added `HooksInterface` import and private `$hooks` property
   - Constructor now accepts optional `?HooksInterface $hooks = null` parameter (8th argument)
   - Replaced 3 direct `apply_filters()`/`do_action()` calls with `$this->hooks->applyFilters()`/`doAction()`:
     - Line 84-86: `agentwp_intent_handlers` filter
     - Line 91-93: `agentwp_register_intent_functions` action
     - Line 258-260: `agentwp_default_function_mapping` filter
   - Null-safe: hooks are only invoked if `$this->hooks` is set

5. **`src/Providers/IntentServiceProvider.php`**
   - Added `HooksInterface` import
   - Updated `registerEngine()` to resolve and inject hooks adapter into Engine constructor

6. **`tests/Fakes/FakeWPFunctions.php`**
   - Changed from standalone class to `implements HooksInterface`
   - Removed unused `WPFunctions` import

## How to Verify

```bash
# Check PHP syntax
php -l src/Contracts/HooksInterface.php
php -l src/Infrastructure/WPFunctions.php
php -l src/Intent/Engine.php
php -l src/Providers/IntentServiceProvider.php
php -l tests/Fakes/FakeWPFunctions.php
php -l tests/Unit/Intent/EngineHooksTest.php

# Run new unit tests (6 tests)
./vendor/bin/phpunit tests/Unit/Intent/EngineHooksTest.php --no-coverage

# Run all Intent tests (62 tests)
./vendor/bin/phpunit tests/Unit/Intent/ tests/Integration/Intent/ --no-coverage
```

## Acceptance Criteria Verification

- **Engine uses injected hook adapter**: All 3 direct `apply_filters()`/`do_action()` calls in Engine.php are now replaced with `$this->hooks->applyFilters()` / `$this->hooks->doAction()`
- **Behavior-compatible**: Hooks parameter is optional with null default - existing code calling Engine without the 8th argument continues to work
- **Unit-testable without WordPress globals**: Tests pass using `FakeWPFunctions` to capture and assert hook calls

## Risks / Follow-ups

1. **Backward compatibility**: The hooks parameter is optional (`?HooksInterface $hooks = null`), so existing code creating Engine directly will work. When hooks is null, filters return unmodified values and actions are no-ops.

2. **Production behavior**: In production with proper DI wiring, `WPFunctions` is injected and WordPress hooks work as expected via the adapter.


Repo snapshot:
```
branch: main

status:
M .logs/C02-03.gitcommit.txt
 M .logs/C03-01.claude.impl.last.md
 M .logs/C03-01.claude.impl.raw.txt
 M .plans/C03-01.md
 M .t2/state.json
 M src/Infrastructure/WPFunctions.php
 M src/Intent/Engine.php
 M src/Providers/IntentServiceProvider.php
 M tests/Fakes/FakeWPFunctions.php
?? src/Contracts/HooksInterface.php
?? tests/Unit/Intent/EngineHooksTest.php

diff --stat:
.logs/C02-03.gitcommit.txt              | 11 +----
 .logs/C03-01.claude.impl.last.md        | 75 ++++++++++++++++++++-------------
 .logs/C03-01.claude.impl.raw.txt        |  2 +-
 .plans/C03-01.md                        |  4 +-
 .t2/state.json                          |  5 ++-
 src/Infrastructure/WPFunctions.php      |  3 +-
 src/Intent/Engine.php                   | 29 +++++++++----
 src/Providers/IntentServiceProvider.php | 12 +++++-
 tests/Fakes/FakeWPFunctions.php         |  6 +--
 9 files changed, 90 insertions(+), 57 deletions(-)

```
