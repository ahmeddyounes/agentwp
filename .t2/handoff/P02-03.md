# Handoff: P02-03

Created: 2026-01-18T08:23:53.402786Z

Spec: .plans/P02-03.md

## Implementation Summary

Added PHPStan static analysis rules to enforce module boundaries by preventing `src/Services/**` from calling WordPress/WooCommerce globals directly.

## Changes Made

### 1. Created Custom PHPStan Rule
- **File**: `phpstan/ForbiddenServicesGlobalsRule.php`
- Implements `PHPStan\Rules\Rule` to detect forbidden function calls
- Covers 40+ WordPress/WooCommerce functions including:
  - Capability: `current_user_can`, `user_can`, `wp_get_current_user`
  - Options: `get_option`, `update_option`, `delete_option`
  - Meta: `get_post_meta`, `update_post_meta`, `get_user_meta`
  - Cache: `get_transient`, `set_transient`, `wp_cache_get`, `wp_cache_set`
  - Hooks: `apply_filters`, `do_action`, `add_filter`, `add_action`
  - WooCommerce: `wc_get_order`, `wc_get_orders`, `wc_get_product`, `wc_create_refund`, etc.
- Each violation includes a helpful message explaining which interface to use instead

### 2. Created PHPStan Configuration
- **File**: `phpstan/services-boundaries.neon`
- Registers the custom rule with PHPStan
- Included in `phpstan.neon` via includes directive

### 3. Updated composer.json
- Added autoload-dev entry: `"AgentWP\\PHPStan\\": "phpstan/"`
- Allows PHPStan to find the custom rule class

### 4. Refactored DateRangeParser
- **File**: `src/Services/OrderSearch/DateRangeParser.php`
- Removed `withWordPressTimezone()` static factory method that called WordPress globals
- The factory logic was moved to the ServiceProvider

### 5. Updated ServicesServiceProvider
- **File**: `src/Providers/ServicesServiceProvider.php`
- DateRangeParser now receives timezone from `ClockInterface->now()->getTimezone()`
- Removes direct WordPress function calls from Services layer

## Verification

```bash
# PHPStan passes with no errors
composer run-script phpstan

# All 519 tests pass
composer run-script phpunit

# Violations are properly detected (tested with temporary violation file)
# Example output for violations:
#   Function get_option() is forbidden in src/Services to enforce module boundaries.
#   Use OptionsInterface from dependency injection.
```

## Architecture Enforcement

The rule enforces this layered architecture:

```
src/Services/**     (Domain logic - NO WordPress/WooCommerce globals)
       ↓ uses
src/Contracts/**    (Interface definitions)
       ↑ implements
src/Infrastructure/** (WordPress/WooCommerce wrappers - globals OK here)
src/Security/Policy/** (Capability checks - globals OK here)
```

## Files Changed

- `phpstan/ForbiddenServicesGlobalsRule.php` (new)
- `phpstan/services-boundaries.neon` (new)
- `phpstan.neon` (modified - added include)
- `composer.json` (modified - added autoload-dev)
- `src/Services/OrderSearch/DateRangeParser.php` (modified - removed static factory)
- `src/Providers/ServicesServiceProvider.php` (modified - updated DateRangeParser registration)


## 2026-01-18T08:30:21.561520Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P02-03 in this git repository.

1) Read the spec: .plans/P02-03.md
2) Read handoff/context: .t2/handoff/P02-03.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: db8bd1a8-f787-4f43-917d-98420d66c033

Agent final message (file: P02-03.claude.impl.last.md):

---

## Status: DONE

## Summary of Changes

1. **Created custom PHPStan rule** (`phpstan/ForbiddenServicesGlobalsRule.php`) that detects and forbids 40+ WordPress/WooCommerce global function calls in `src/Services/**`

2. **Created PHPStan configuration** (`phpstan/services-boundaries.neon`) to register the rule

3. **Updated `phpstan.neon`** to include the new rules configuration

4. **Updated `composer.json`** with autoload-dev entry for the PHPStan namespace

5. **Refactored `DateRangeParser`** - removed `withWordPressTimezone()` static factory that was the only violation in Services

6. **Updated `ServicesServiceProvider`** to construct DateRangeParser using timezone from ClockInterface

## How to Verify

```bash
# PHPStan passes with zero errors
composer run-script phpstan

# All tests pass (519 tests)
composer run-script phpunit

# Test violation detection (create a test file with forbidden calls):
# echo '<?php namespace AgentWP\Services; class X { function f() { get_option("x"); } }' > src/Services/Test.php
# composer run-script phpstan  # Should fail with helpful error
# rm src/Services/Test.php
```

## Risks / Follow-ups

- **Low risk**: The DateRangeParser refactor is minimal and timezone is now obtained from the already-injected ClockInterface
- **Extensible**: New forbidden functions can be easily added to the `FORBIDDEN_FUNCTIONS` constant in the rule class
- **CI integration**: The rule runs as part of normal `composer run-script phpstan` so it will fail CI if violations are introduced


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M composer.json
 M phpstan.neon
 M src/Providers/ServicesServiceProvider.php
 M src/Services/OrderSearch/DateRangeParser.php
?? .logs/P02-02.gitcommit.txt
?? .logs/P02-03.claude.impl.last.md
?? .logs/P02-03.claude.impl.raw.txt
?? .plans/P02-03.md
?? .t2/handoff/P02-03.md
?? phpstan/

diff --stat:
.t2/state.json                               |  5 ++--
 composer.json                                |  3 +-
 phpstan.neon                                 |  1 +
 src/Providers/ServicesServiceProvider.php    | 10 ++++---
 src/Services/OrderSearch/DateRangeParser.php | 42 ----------------------------
 5 files changed, 12 insertions(+), 49 deletions(-)

```
