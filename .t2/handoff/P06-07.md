# Handoff: P06-07

Created: 2026-01-18T10:48:31.146517Z

Spec: .plans/P06-07.md

## Summary

Centralized operational knobs (timeouts, retry limits, rate limits, memory limits/TTLs) to be configurable via WordPress filters through `AgentWPConfig::get()`. Created comprehensive documentation in `docs/OPERATIONAL-KNOBS.md`.

## Changes Made

### AgentWPConfig.php
- Already had constants and filter support via `get()` method
- Added mappings for all operational knobs

### Files Updated to Use Centralized Config

1. **RestServiceProvider.php** - Rate limiter now uses AgentWPConfig for `rate_limit.requests` and `rate_limit.window`

2. **RateLimiter.php** - Lock settings now loaded from AgentWPConfig: `rate_limit.lock_timeout`, `rate_limit.lock_attempts`, `rate_limit.lock_delay_us`

3. **WordPressTransientCache.php** - Cache lock settings now configurable: `cache.lock_timeout`, `cache.lock_attempts`, `cache.lock_delay_us`, `cache.ttl_minimum`

4. **Search/Index.php** - Search settings now configurable: `search.default_limit`, `search.backfill_limit`, `search.backfill_window`

5. **UsageTracker.php** - Usage settings now configurable: `usage.retention_days`, `usage.query_max_rows`

6. **RestController.php** - Log limit now configurable: `rest.log_limit`

7. **AbstractAgenticHandler.php** - Max agentic turns now configurable: `agentic.max_turns`

8. **HistoryRequestDTO.php** - History/favorites limits now configurable: `history.limit`, `favorites.limit`

9. **CustomerService.php** - Customer settings now configurable: `customer.recent_limit`, `customer.top_limit`, `customer.order_batch`, `customer.max_order_ids`

10. **OrderStatusService.php** - Max bulk updates now configurable: `order_status.max_bulk`

11. **ArgumentNormalizer.php** - Order search limits now configurable: `order_search.default_limit`, `order_search.max_limit`

### Documentation Created

- **docs/OPERATIONAL-KNOBS.md** - Comprehensive documentation of all operational knobs including:
  - Filter naming convention
  - All available filters with defaults
  - Usage examples
  - Best practices

## How to Verify

1. All PHP files have valid syntax (verified via `php -l`)
2. Operators can now tune any operational knob via WordPress filters
3. Example usage:
```php
// Increase rate limits
add_filter( 'agentwp_config_rate_limit_requests', fn() => 100 );

// Increase cache lock timeout
add_filter( 'agentwp_config_cache_lock_timeout', fn() => 60 );

// Retain usage data longer
add_filter( 'agentwp_config_usage_retention_days', fn() => 180 );
```


## 2026-01-18T10:58:11.432440Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P06-07 in this git repository.

1) Read the spec: .plans/P06-07.md
2) Read handoff/context: .t2/handoff/P06-07.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 8e2e89f2-4654-4cda-a7a0-c3442d641ad8

Agent final message (file: P06-07.claude.impl.last.md):

All changes are complete.

---

**Status: DONE**

## Summary of Changes

Centralized operational knobs to be configurable via WordPress filters through the existing `AgentWPConfig::get()` system. The following files were updated:

### Core Configuration
- **src/Config/AgentWPConfig.php** - Already had constants and filter support; all operational knobs were already mapped

### Files Updated to Use Centralized Config
1. **src/Providers/RestServiceProvider.php** - Rate limiter uses `rate_limit.requests`, `rate_limit.window`
2. **src/API/RateLimiter.php** - Lock settings: `rate_limit.lock_timeout`, `rate_limit.lock_attempts`, `rate_limit.lock_delay_us`
3. **src/Infrastructure/WordPressTransientCache.php** - Cache locks: `cache.lock_timeout`, `cache.lock_attempts`, `cache.lock_delay_us`, `cache.ttl_minimum`
4. **src/Search/Index.php** - Search settings: `search.default_limit`, `search.backfill_limit`, `search.backfill_window`
5. **src/Billing/UsageTracker.php** - Usage settings: `usage.retention_days`, `usage.query_max_rows`
6. **src/API/RestController.php** - Log limit: `rest.log_limit`
7. **src/Intent/Handlers/AbstractAgenticHandler.php** - Agentic loop: `agentic.max_turns`
8. **src/DTO/HistoryRequestDTO.php** - History/favorites: `history.limit`, `favorites.limit`
9. **src/Services/CustomerService.php** - Customer settings: `customer.recent_limit`, `customer.top_limit`, `customer.order_batch`, `customer.max_order_ids`
10. **src/Services/OrderStatusService.php** - Bulk updates: `order_status.max_bulk`
11. **src/Services/OrderSearch/ArgumentNormalizer.php** - Order search: `order_search.default_limit`, `order_search.max_limit`

### Documentation
- **docs/OPERATIONAL-KNOBS.md** - Comprehensive documentation of all 50+ configurable operational knobs with filter names, defaults, and usage examples

## How to Verify

```bash
# Check all PHP files have valid syntax
find src -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"

# Verify operators can tune behavior via filters (example)
# Add to functions.php or custom plugin:
add_filter( 'agentwp_config_rate_limit_requests', fn() => 100 );
add_filter( 'agentwp_config_cache_lock_timeout', fn() => 60 );
```

## Risks / Follow-ups

- **Low risk**: All changes maintain backward compatibility by using the same default values
- **Follow-up**: Some classes still have hardcoded validation limits (MAX_QUERY_LENGTH, MAX_EMAIL_LENGTH, etc.) that could be centralized if needed, but these are less likely to need operator tuning
- **Testing**: Consider adding integration tests that verify filter hooks work correctly


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/API/RateLimiter.php
 M src/API/RestController.php
 M src/Billing/UsageTracker.php
 M src/Config/AgentWPConfig.php
 M src/DTO/HistoryRequestDTO.php
 M src/Infrastructure/WordPressTransientCache.php
 M src/Intent/Handlers/AbstractAgenticHandler.php
 M src/Providers/RestServiceProvider.php
 M src/Search/Index.php
 M src/Services/CustomerService.php
 M src/Services/OrderSearch/ArgumentNormalizer.php
 M src/Services/OrderStatusService.php
?? .logs/P06-06.gitcommit.txt
?? .logs/P06-07.claude.impl.last.md
?? .logs/P06-07.claude.impl.raw.txt
?? .plans/P06-07.md
?? .t2/handoff/P06-07.md
?? docs/OPERATIONAL-KNOBS.md

diff --stat:
.t2/state.json                                  |  5 +-
 src/API/RateLimiter.php                         | 39 +++++++++--
 src/API/RestController.php                      |  6 +-
 src/Billing/UsageTracker.php                    | 35 ++++++++--
 src/Config/AgentWPConfig.php                    | 64 ++++++++++++++++++
 src/DTO/HistoryRequestDTO.php                   | 30 ++++++---
 src/Infrastructure/WordPressTransientCache.php  | 90 +++++++++++++++++--------
 src/Intent/Handlers/AbstractAgenticHandler.php  | 14 +++-
 src/Providers/RestServiceProvider.php           | 10 ++-
 src/Search/Index.php                            | 50 ++++++++++++--
 src/Services/CustomerService.php                | 69 +++++++++++++++----
 src/Services/OrderSearch/ArgumentNormalizer.php | 38 ++++++++---
 src/Services/OrderStatusService.php             | 17 ++++-
 13 files changed, 374 insertions(+), 93 deletions(-)

```
