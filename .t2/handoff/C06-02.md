# Handoff: C06-02

Created: 2026-01-17T19:44:49.010902Z

Spec: .plans/C06-02.md


## 2026-01-17T19:47:47.264655Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C06-02 in this git repository.

1) Read the spec: .plans/C06-02.md
2) Read handoff/context: .t2/handoff/C06-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 45179f3f-b50d-4d02-a477-f16e2e8c765a

Agent final message (file: C06-02.claude.impl.last.md):

---

**Status: DONE**

## Summary of Changes

### `src/Plugin/RestRouteRegistrar.php`
1. Added `$taggedControllers` property to hold pre-resolved controller instances from container tags
2. Updated constructor to accept `$taggedControllers` array as third parameter
3. Modified `registerRoutes()` to prefer tagged controllers, falling back to class-based registration only when no tagged controllers exist
4. Added `addTaggedController()` method to add pre-resolved controller instances
5. Extracted `registerControllerInstance()` private method to avoid code duplication
6. Added `fromContainer()` static factory method that:
   - Discovers controllers via `container->tagged('rest.controller')`
   - Falls back to `withDefaults()` if no tagged controllers found
7. Updated docblocks to clarify fallback behavior

### `src/Providers/RestServiceProvider.php`
1. Changed `registerRouteRegistrar()` to use `RestRouteRegistrar::fromContainer()` instead of `::withDefaults()`
2. Updated docblocks to explain tag-based discovery pattern

## How to Verify

```bash
# Syntax check
php -l src/Plugin/RestRouteRegistrar.php
php -l src/Providers/RestServiceProvider.php

# Run related tests
php vendor/bin/phpunit tests/Integration/Container/ContainerWiringTest.php
```

## Acceptance Criteria Met

**Adding a controller does not require editing a hard-coded list:**
- New controllers can be added by any provider by simply:
  1. Binding the controller: `$container->bind(MyController::class, MyController::class);`
  2. Tagging it: `$container->tag(MyController::class, 'rest.controller');`
- The `RestRouteRegistrar::fromContainer()` method discovers all tagged controllers automatically
- The hardcoded list in `getDefaultControllers()` is only used as a fallback when no tagged controllers exist (backward compatibility)

## Risks / Follow-ups

1. **Low Risk**: The fallback mechanism ensures backward compatibility - if no controllers are tagged, the default list is used
2. **Follow-up**: Consider deprecating `getDefaultControllers()` and `withDefaults()` in favor of tag-based discovery in a future release
3. **Follow-up**: Other service providers adding custom REST controllers should document the tagging pattern for their controllers


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Plugin/RestRouteRegistrar.php
 M src/Providers/RestServiceProvider.php
?? .logs/C06-01.gitcommit.txt
?? .logs/C06-02.claude.impl.last.md
?? .logs/C06-02.claude.impl.raw.txt
?? .plans/C06-02.md
?? .t2/handoff/C06-02.md

diff --stat:
.t2/state.json                        |  5 ++-
 src/Plugin/RestRouteRegistrar.php     | 84 ++++++++++++++++++++++++++++++-----
 src/Providers/RestServiceProvider.php | 11 ++++-
 3 files changed, 85 insertions(+), 15 deletions(-)

```
