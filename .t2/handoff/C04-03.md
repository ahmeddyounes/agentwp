# Handoff: C04-03

Created: 2026-01-17T18:03:44.521569Z

Spec: .plans/C04-03.md


## 2026-01-17T18:08:13.424585Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C04-03 in this git repository.

1) Read the spec: .plans/C04-03.md
2) Read handoff/context: .t2/handoff/C04-03.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 5329c8b2-c686-450a-a1c3-e00eddc6ed4a

Agent final message (file: C04-03.claude.impl.last.md):

---

**Status: DONE**

## Summary of changes

1. **`src/Intent/Engine.php`** - Simplified to rely solely on `HandlerRegistry` for O(1) handler resolution:
   - Removed `$handlers` array property (was used for O(n) fallback lookup)
   - Removed `$needs_fallback_lookup` flag property
   - Removed `triggerLegacyMethodWarning()` method (no longer needed)
   - Simplified `get_handler_intents()` to only read `#[HandlesIntent]` attributes (removed fallback to `getSupportedIntents()` and `getIntent()` methods)
   - Simplified `register_handlers()` to only register handlers with `#[HandlesIntent]` attribute (issues warning in WP_DEBUG mode for handlers without it)
   - Simplified `resolve_handler()` from 15 lines to 1 line using `getOrFallback()`
   - Updated `register_default_functions()` to use `$handler_registry->has()` instead of `canHandle()`

2. **`tests/Integration/Intent/EngineTest.php`** - Updated tests for the new O(1-only lookup:
   - Modified existing test to pre-register handler in `HandlerRegistry` instead of relying on O(n) fallback
   - Added `test_engine_uses_fallback_for_unknown_intent()` to verify fallback handler is used for unregistered intents
   - Added `test_handler_resolution_is_deterministic()` to verify handler resolution is deterministic

## How to verify

```bash
# Run all tests
./vendor/bin/phpunit

# Run only Engine tests
./vendor/bin/phpunit tests/Integration/Intent/EngineTest.php

# Check PHP syntax
php -l src/Intent/Engine.php
```

## Risks / follow-ups

1. **Third-party handlers**: Any third-party code that registers handlers without the `#[HandlesIntent]` attribute will no longer be discovered. A warning is now emitted in WP_DEBUG mode to help identify such handlers.

2. **The `canHandle()` method on `Handler` interface**: This method is still required by the interface but is no longer used by the Engine for routing. Consider deprecating it in a future task, or keeping it for external code that might use it for validation purposes.

3. **Determinism behavior**: When multiple handlers are registered for the same intent, the last one wins (simple hashmap overwrite). This is deterministic but may be surprising. Consider whether we should warn or prevent duplicate registrations.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Intent/Engine.php
 M tests/Integration/Intent/EngineTest.php
?? .logs/C04-02.gitcommit.txt
?? .logs/C04-03.claude.impl.last.md
?? .logs/C04-03.claude.impl.raw.txt
?? .plans/C04-03.md
?? .t2/handoff/C04-03.md

diff --stat:
.t2/state.json                          |   5 +-
 src/Intent/Engine.php                   | 145 ++++++++------------------------
 tests/Integration/Intent/EngineTest.php | 103 ++++++++++++++++++++++-
 3 files changed, 141 insertions(+), 112 deletions(-)

```
