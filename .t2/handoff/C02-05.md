# Handoff: C02-05

Created: 2026-01-17T16:35:37.554854Z

Spec: .plans/C02-05.md


## 2026-01-17T16:41:31.976635Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C02-05 in this git repository.

1) Read the spec: .plans/C02-05.md
2) Read handoff/context: .t2/handoff/C02-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 1a689594-c0d3-4409-b6ca-8edf7ed7a2a4

Agent final message (file: C02-05.claude.impl.last.md):

The implementation is complete. Let me provide the final summary.

---

**Status: DONE**

## Summary of Changes

### New Files
1. **`src/Demo/DemoCredentials.php`** - New class that defines explicit rules for demo mode credential handling:
   - Determines whether to use demo API key or stubbed responses
   - Enforces the rule that real API keys are NEVER used when demo mode is enabled
   - Priority for demo API key: constant > env variable > stored option

2. **`src/Demo/DemoClient.php`** - New client that implements `OpenAIClientInterface` and returns stubbed/deterministic responses:
   - Used when demo mode is enabled but no demo API key is configured
   - Returns context-aware demo responses based on keywords
   - Includes simulated token usage metrics
   - Always marks responses with `demo_mode: true` in metadata

3. **`tests/Unit/Demo/DemoCredentialsTest.php`** - Unit tests for `DemoCredentials`
4. **`tests/Unit/Demo/DemoClientTest.php`** - Unit tests for `DemoClient`

### Modified Files
1. **`src/AI/AIClientFactory.php`** - Updated to use `DemoCredentials` and enforce demo mode rules:
   - Demo mode ON + demo key: creates `OpenAIClient` with demo key
   - Demo mode ON + no demo key: creates `DemoClient` with stubbed responses
   - Demo mode OFF: creates `OpenAIClient` with real API key
   - Added `isDemoMode()` and `getCredentialInfo()` methods

2. **`src/Providers/InfrastructureServiceProvider.php`** - Updated to register `DemoCredentials` in the DI container

3. **`docs/DEMO.md`** - Updated with comprehensive documentation of demo mode credential rules

## How to Verify

```bash
# Run unit tests for demo functionality
vendor/bin/phpunit tests/Unit/Demo/

# Run all tests
vendor/bin/phpunit

# Check code standards
composer run phpcs -- src/Demo/ src/AI/AIClientFactory.php
```

## Acceptance Criteria Verification

1. **Demo mode produces deterministic behavior**: When no demo API key is configured, `DemoClient` returns predictable, context-aware responses based on input keywords.

2. **Never accidentally uses a real key when demo mode is enabled**: The `DemoCredentials.getEffectiveApiKey()` method enforces this rule - in demo mode, it only returns the demo API key (or empty string), never the real key. This is also tested in `DemoCredentialsTest::test_demo_mode_never_returns_real_key()`.

## Risks / Follow-ups

1. **None identified** - The changes are backward compatible. The `AIClientFactory` constructor still accepts the old signature (just SettingsManager) since `DemoCredentials` has a default value of `null` and is created internally if not provided.

2. **Potential enhancement**: The `DemoClient` could be extended to support function/tool call stubbing in the future if needed for more realistic demo scenarios.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M docs/DEMO.md
 M src/AI/AIClientFactory.php
 M src/Providers/InfrastructureServiceProvider.php
?? .logs/C02-04.gitcommit.txt
?? .logs/C02-05.claude.impl.last.md
?? .logs/C02-05.claude.impl.raw.txt
?? .plans/C02-05.md
?? .t2/handoff/C02-05.md
?? src/Demo/DemoClient.php
?? src/Demo/DemoCredentials.php
?? tests/Unit/Demo/

diff --stat:
.t2/state.json                                  |   5 +-
 docs/DEMO.md                                    |  40 ++++++++-
 src/AI/AIClientFactory.php                      | 108 +++++++++++++++++++++---
 src/Providers/InfrastructureServiceProvider.php |  20 ++++-
 4 files changed, 159 insertions(+), 14 deletions(-)

```


## 2026-01-17T16:42:25.504841Z — claude — after1

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions --resume 1a689594-c0d3-4409-b6ca-8edf7ed7a2a4 We just completed/updated task C02-05.

Spec: .plans/C02-05.md
Handoff/context: .t2/handoff/C02-05.md

Run this follow-up instruction:
Self review all your uncommited changes

If you modify code, keep changes minimal and consistent with the task.
Summarize what you did.

```

Return code: 0

Session: 1a689594-c0d3-4409-b6ca-8edf7ed7a2a4

Agent final message (file: C02-05.claude.after1.last.md):

## Self-Review Summary

All changes look correct and consistent with task C02-05. Here's what was implemented:

### New Files
1. **`src/Demo/DemoCredentials.php`** - Defines explicit credential rules for demo mode with security guarantee that real API keys are never used when demo mode is enabled
2. **`src/Demo/DemoClient.php`** - Implements `OpenAIClientInterface` with stubbed responses for use when no demo API key is configured
3. **`tests/Unit/Demo/DemoCredentialsTest.php`** - 7 tests covering credential selection logic
4. **`tests/Unit/Demo/DemoClientTest.php`** - 7 tests covering stubbed response behavior

### Modified Files
1. **`src/AI/AIClientFactory.php`** - Updated to use `DemoCredentials` for deterministic client selection based on demo mode state
2. **`src/Providers/InfrastructureServiceProvider.php`** - Registered `DemoCredentials` in DI container and updated factory instantiation
3. **`docs/DEMO.md`** - Added comprehensive documentation of demo mode credential rules

### Verification
- All 55 tests pass
- PHPCS shows no errors or warnings
- PHP syntax is valid


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M docs/DEMO.md
 M src/AI/AIClientFactory.php
 M src/Providers/InfrastructureServiceProvider.php
?? .logs/C02-04.gitcommit.txt
?? .logs/C02-05.claude.after1.last.md
?? .logs/C02-05.claude.after1.raw.txt
?? .logs/C02-05.claude.impl.last.md
?? .logs/C02-05.claude.impl.raw.txt
?? .plans/C02-05.md
?? .t2/handoff/C02-05.md
?? src/Demo/DemoClient.php
?? src/Demo/DemoCredentials.php
?? tests/Unit/Demo/

diff --stat:
.t2/state.json                                  |   8 +-
 docs/DEMO.md                                    |  40 ++++++++-
 src/AI/AIClientFactory.php                      | 108 +++++++++++++++++++++---
 src/Providers/InfrastructureServiceProvider.php |  20 ++++-
 4 files changed, 161 insertions(+), 15 deletions(-)

```
