# Handoff: C03-06

Created: 2026-01-17T17:19:23.963716Z

Spec: .plans/C03-06.md


## 2026-01-17T17:40:54.765881Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C03-06 in this git repository.

1) Read the spec: .plans/C03-06.md
2) Read handoff/context: .t2/handoff/C03-06.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: f43dd7dd-6a88-4b18-8c94-3bd208427121

Agent final message (file: C03-06.claude.impl.last.md):

**Status: DONE**

## Summary of Changes

Task C03-06: "Remove Service-Level Dependency Fallbacks" is complete. The implementation centralized all hidden instantiation into service providers.

### Files Created:
1. **`src/Contracts/ToolRegistryInterface.php`** - New interface for tool/function schema registry
2. **`src/Intent/ToolRegistry.php`** - Implementation of ToolRegistryInterface
3. **`tests/Fakes/FakeToolRegistry.php`** - Test double for unit tests

### Files Modified:
1. **`src/Providers/IntentServiceProvider.php`** - Added `registerToolRegistry()` method that instantiates all 12 AI function classes centrally and registers them; updated all 7 handler registrations to inject `ToolRegistryInterface`

2. **`src/Intent/Handlers/AbstractAgenticHandler.php`** - Constructor now requires `ToolRegistryInterface`; changed abstract method from `getTools()` to `getToolNames(): array`; added concrete `getTools()` that fetches schemas from registry

3. **7 Handler files** (OrderSearchHandler, OrderRefundHandler, OrderStatusHandler, ProductStockHandler, EmailDraftHandler, AnalyticsQueryHandler, CustomerLookupHandler):
   - Removed direct `new` instantiation of function classes
   - Now implement `getToolNames()` returning string arrays instead of objects
   - Receive tools via injected `ToolRegistryInterface`

4. **6 Test files** updated to use `FakeToolRegistry`:
   - `tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php`
   - `tests/Unit/Intent/Handlers/OrderSearchHandlerTest.php`
   - `tests/Unit/Intent/Handlers/ProductStockHandlerTest.php`
   - `tests/Unit/Intent/Handlers/SimpleHandlersTest.php`
   - `tests/Unit/OrderRefundHandlerTest.php`
   - `tests/Integration/Intent/EngineTest.php`

## How to Verify
```bash
./vendor/bin/phpunit --testdox
```
Expected: 74 tests, 227 assertions, all passing.

## Risks / Follow-ups
- **Low risk**: Pattern is consistent with existing DI architecture
- **Future consideration**: If new handlers/tools are added, remember to register them in `IntentServiceProvider::registerToolRegistry()`


Repo snapshot:
```
branch: main

status:
D  .t2/after_prompts/01.md
 M .t2/state.json
 M src/AI/AIClientFactory.php
 M src/Intent/Engine.php
 M src/Intent/Handlers/AbstractAgenticHandler.php
 M src/Intent/Handlers/AnalyticsQueryHandler.php
 M src/Intent/Handlers/CustomerLookupHandler.php
 M src/Intent/Handlers/EmailDraftHandler.php
 M src/Intent/Handlers/OrderRefundHandler.php
 M src/Intent/Handlers/OrderSearchHandler.php
 M src/Intent/Handlers/OrderStatusHandler.php
 M src/Intent/Handlers/ProductStockHandler.php
 M src/Providers/IntentServiceProvider.php
 M src/Providers/ServicesServiceProvider.php
 M src/Services/OrderRefundService.php
 M src/Services/OrderStatusService.php
 M src/Services/ProductStockService.php
 M tests/Integration/Intent/EngineTest.php
 M tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php
 M tests/Unit/Intent/Handlers/OrderSearchHandlerTest.php
 M tests/Unit/Intent/Handlers/ProductStockHandlerTest.php
 M tests/Unit/Intent/Handlers/SimpleHandlersTest.php
 M tests/Unit/OrderRefundHandlerTest.php
?? .logs/C03-05.gitcommit.txt
?? .logs/C03-06.claude.impl.last.md
?? .logs/C03-06.claude.impl.raw.txt
?? .plans/C03-06.md
?? .t2/handoff/C03-06.md
?? src/Contracts/ToolRegistryInterface.php
?? src/Intent/ToolRegistry.php
?? tests/Fakes/FakeToolRegistry.php

diff --stat:
.t2/state.json                                     |  5 +-
 src/AI/AIClientFactory.php                         | 12 +--
 src/Intent/Engine.php                              | 57 ++++++--------
 src/Intent/Handlers/AbstractAgenticHandler.php     | 31 ++++++--
 src/Intent/Handlers/AnalyticsQueryHandler.php      | 16 ++--
 src/Intent/Handlers/CustomerLookupHandler.php      | 16 ++--
 src/Intent/Handlers/EmailDraftHandler.php          | 16 ++--
 src/Intent/Handlers/OrderRefundHandler.php         | 17 ++--
 src/Intent/Handlers/OrderSearchHandler.php         | 16 ++--
 src/Intent/Handlers/OrderStatusHandler.php         | 18 ++---
 src/Intent/Handlers/ProductStockHandler.php        | 18 ++---
 src/Providers/IntentServiceProvider.php            | 92 ++++++++++++++++++++--
 src/Providers/ServicesServiceProvider.php          |  6 +-
 src/Services/OrderRefundService.php                |  7 +-
 src/Services/OrderStatusService.php                |  7 +-
 src/Services/ProductStockService.php               |  7 +-
 tests/Integration/Intent/EngineTest.php            |  6 +-
 .../Intent/Handlers/CustomerLookupHandlerTest.php  | 13 +--
 .../Intent/Handlers/OrderSearchHandlerTest.php     | 13 +--
 .../Intent/Handlers/ProductStockHandlerTest.php    | 13 +--
 tests/Unit/Intent/Handlers/SimpleHandlersTest.php  | 16 ++--
 tests/Unit/OrderRefundHandlerTest.php              |  4 +-
 22 files changed, 259 insertions(+), 147 deletions(-)

```
