# Handoff: P05-02

Created: 2026-01-18T09:46:15.562823Z

Spec: .plans/P05-02.md


## 2026-01-18T09:51:12.435858Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P05-02 in this git repository.

1) Read the spec: .plans/P05-02.md
2) Read handoff/context: .t2/handoff/P05-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: dfa87b79-e110-4b74-8a8c-b309d3394ca3

Agent final message (file: P05-02.claude.impl.last.md):

Let me provide a summary of what was implemented:

---

**Status: DONE**

## Summary of Changes

### New Files Created:

1. **`src/Plugin/Upgrader.php`** - Centralized upgrader class that:
   - Tracks installed version via `agentwp_installed_version` option
   - Runs upgrade steps on version change during `plugins_loaded`
   - Supports idempotent, versioned upgrade steps
   - Provides hooks (`agentwp_upgraded`, `agentwp_before_upgrade_step`, `agentwp_after_upgrade_step`) for extensibility
   - Includes `reset()` method for testing
   - Includes `get_pending_steps()` for debugging upgrade paths

2. **`tests/Unit/Plugin/UpgraderTest.php`** - 31 unit tests covering:
   - Option naming conventions
   - Version comparison logic
   - Upgrade step ordering and filtering
   - Static state management
   - Return type verification
   - Public/private API boundaries

### Modified Files:

1. **`agentwp.php`** - Added `Upgrader::init()` call early in `plugins_loaded`, before main plugin initialization

2. **`src/Plugin.php`** - Added version initialization during plugin activation via `Upgrader::update_installed_version()`

3. **`uninstall.php`** - Added `agentwp_installed_version` to the option cleanup list

## How to Verify

```bash
# Run all tests
./vendor/bin/phpunit

# Run only Upgrader tests
./vendor/bin/phpunit tests/Unit/Plugin/UpgraderTest.php

# Check PHP syntax
php -l src/Plugin/Upgrader.php
```

## Adding Future Upgrade Steps

To add an upgrade step when releasing a new version:

```php
// In Upgrader::get_upgrade_steps()
private static function get_upgrade_steps(): array {
    $steps = array(
        '0.2.0' => array( __CLASS__, 'upgrade_to_0_2_0' ),
    );
    // ...
}

private static function upgrade_to_0_2_0(): void {
    // Idempotent migration logic here
}
```

## Risks / Follow-ups

- **Fresh installs** correctly set the version without running upgrade steps
- **Existing installs** without the option will have it set to current version on next load (treated as fresh install to avoid running all historical upgrades on existing sites)
- **Idempotency** is the responsibility of each upgrade step implementation - document this clearly when adding steps
- Consider adding a **CLI command** (WP-CLI) to manually trigger upgrades or check status in the future


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M agentwp.php
 M src/Plugin.php
 M uninstall.php
?? .logs/P05-01.gitcommit.txt
?? .logs/P05-02.claude.impl.last.md
?? .logs/P05-02.claude.impl.raw.txt
?? .plans/P05-02.md
?? .t2/handoff/P05-02.md
?? src/Plugin/Upgrader.php
?? tests/Unit/Plugin/UpgraderTest.php

diff --stat:
.t2/state.json | 5 +++--
 agentwp.php    | 5 +++++
 src/Plugin.php | 5 +++++
 uninstall.php  | 1 +
 4 files changed, 14 insertions(+), 2 deletions(-)

```
