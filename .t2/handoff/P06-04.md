# Handoff: P06-04

Created: 2026-01-18T10:35:18.971548Z

Spec: .plans/P06-04.md


## 2026-01-18T10:40:52.685296Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P06-04 in this git repository.

1) Read the spec: .plans/P06-04.md
2) Read handoff/context: .t2/handoff/P06-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: ec99a824-a38e-46fc-8ead-5663d3cf483b

Agent final message (file: P06-04.claude.impl.last.md):

Let me create a summary of all the changes made:

## Summary

**Status: DONE**

### Summary of Changes

Refactored the search backfill system from running on every `init` hook (blocking admin requests) to using WordPress Cron scheduled tasks with proper locking and time slicing.

**Files Modified:**

1. **`src/Search/Index.php`**
   - Added new constants `BACKFILL_HOOK` and `BACKFILL_LOCK` for the cron event and transient lock names
   - Removed the `init` hook for `maybe_backfill()` that ran on every admin request
   - Added `schedule_backfill()` - schedules a WP Cron event every 60 seconds (only if backfill is incomplete)
   - Added `add_cron_interval()` - registers the custom `agentwp_one_minute` cron schedule
   - Added `unschedule_backfill()` - removes the cron event when backfill is complete or plugin deactivates
   - Added `acquire_backfill_lock()` - transient-based lock with 60-second TTL to prevent concurrent runs
   - Added `release_backfill_lock()` - releases the lock after backfill completes
   - Added `run_scheduled_backfill()` - the cron callback that acquires lock, runs backfill, and releases lock
   - Added `deactivate()` - cleanup method called on plugin deactivation
   - Updated `maybe_backfill()` - removed `is_admin()` check since it now runs via cron

2. **`src/Plugin.php`**
   - Added call to `Search\Index::deactivate()` in the plugin deactivation handler

3. **`tests/Unit/Search/BackfillTest.php`**
   - Added tests for the new constants (`BACKFILL_HOOK`, `BACKFILL_LOCK`)
   - Added tests for `add_cron_interval()` behavior
   - Added tests for lock acquisition and release using WP_Mock
   - Added test verifying `run_scheduled_backfill()` skips when already locked

### How to Verify

```bash
# Run all tests
./vendor/bin/phpunit

# Run backfill-specific tests
./vendor/bin/phpunit --filter BackfillTest

# Check PHP syntax
php -l src/Search/Index.php src/Plugin.php
```

### Key Design Decisions

1. **60-second cron interval**: Balances quick backfill completion with low resource usage
2. **Transient-based lock**: 60-second TTL ensures auto-release if process crashes
3. **350ms time window preserved**: Same bounded execution budget per run
4. **Auto-unschedule on completion**: Cron event automatically removed when backfill finishes
5. **Cleanup on deactivation**: Cron event and lock cleaned up properly

### Risks / Follow-ups

1. **WP-Cron reliability**: If `DISABLE_WP_CRON` is set, backfill won't run automatically. Consider documenting that sites with disabled cron need to set up an external cron job.

2. **Initial delay**: New installations will wait 30 seconds before first backfill run. The fallback search (`search_source()`) ensures users still get results during this window.

3. **High-traffic sites**: The 60-second interval and 350ms window are conservative. For very large catalogs, backfill may take longer to complete. The incremental nature ensures it never blocks requests.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Plugin.php
 M src/Search/Index.php
 M tests/Unit/Search/BackfillTest.php
?? .logs/P06-03.gitcommit.txt
?? .logs/P06-04.claude.impl.last.md
?? .logs/P06-04.claude.impl.raw.txt
?? .plans/P06-04.md
?? .t2/handoff/P06-04.md

diff --stat:
.t2/state.json                     |   5 +-
 src/Plugin.php                     |   4 +
 src/Search/Index.php               | 171 ++++++++++++++++++++++++++++++++++---
 tests/Unit/Search/BackfillTest.php | 139 ++++++++++++++++++++++++++++++
 4 files changed, 307 insertions(+), 12 deletions(-)

```
