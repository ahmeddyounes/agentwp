# Handoff: P03-03

Created: 2026-01-18T08:51:55.101785Z

Spec: .plans/P03-03.md


## 2026-01-18T08:55:24.782518Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P03-03 in this git repository.

1) Read the spec: .plans/P03-03.md
2) Read handoff/context: .t2/handoff/P03-03.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 4cbe7498-8df5-4b88-9f6a-51faa3a75040

Agent final message (file: P03-03.claude.impl.last.md):

---

## Status: DONE

## Summary of changes

Normalized `CustomerServiceInterface` and `CustomerService` to return `ServiceResult` instead of raw arrays, following the established pattern used by other services like `OrderStatusService`, `OrderRefundService`, etc.

### Files modified:

1. **`src/Contracts/CustomerServiceInterface.php`**
   - Added `use AgentWP\DTO\ServiceResult` import
   - Updated `handle()` method return type from `array` to `ServiceResult`

2. **`src/Services/CustomerService.php`**
   - Added `use AgentWP\DTO\ServiceResult` import
   - Updated `handle()` method to return `ServiceResult`
   - Changed error responses to use `ServiceResult::invalidInput()` for:
     - Missing WooCommerce: `ServiceResult::invalidInput('WooCommerce is required.')`
     - Missing identifier: `ServiceResult::invalidInput('Provide a customer ID or email.')`
   - Changed success response to use `ServiceResult::success()` with a descriptive message including the customer name/email

3. **`src/Intent/Handlers/CustomerLookupHandler.php`**
   - Updated `execute_tool()` to call `->toLegacyArray()` on the `ServiceResult` for backwards-compatible response format

4. **`tests/Unit/CustomerServiceTest.php`**
   - Updated existing test to work with `ServiceResult` instead of array
   - Added two new test cases for error handling:
     - `test_handle_returns_error_when_woocommerce_unavailable()`
     - `test_handle_returns_error_when_no_identifier_provided()`

5. **`tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php`**
   - Added `use AgentWP\DTO\ServiceResult` import
   - Updated mock to return `ServiceResult::success()` instead of raw array

## How to verify

```bash
# Run PHPStan on changed files
./vendor/bin/phpstan analyze --memory-limit=512M src/Contracts/CustomerServiceInterface.php src/Services/CustomerService.php src/Intent/Handlers/CustomerLookupHandler.php

# Run unit tests
./vendor/bin/phpunit tests/Unit/CustomerServiceTest.php
./vendor/bin/phpunit tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php

# Run all unit tests
./vendor/bin/phpunit tests/Unit/
```

## Risks / follow-ups

- **Low risk**: The `toLegacyArray()` method in `CustomerLookupHandler` maintains backwards compatibility with the existing tool execution format, so consumers should not notice any difference.
- **HTTP status codes**: Error responses now have proper HTTP status codes (400 for invalid input) mapped through `ServiceResult.httpStatus`, enabling uniform HTTP mapping across all services.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Contracts/CustomerServiceInterface.php
 M src/Intent/Handlers/CustomerLookupHandler.php
 M src/Services/CustomerService.php
 M tests/Unit/CustomerServiceTest.php
 M tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php
?? .logs/P03-02.gitcommit.txt
?? .logs/P03-03.claude.impl.last.md
?? .logs/P03-03.claude.impl.raw.txt
?? .plans/P03-03.md
?? .t2/handoff/P03-03.md

diff --stat:
.t2/state.json                                     |  5 +-
 src/Contracts/CustomerServiceInterface.php         |  6 +-
 src/Intent/Handlers/CustomerLookupHandler.php      |  4 +-
 src/Services/CustomerService.php                   | 41 +++++++++-----
 tests/Unit/CustomerServiceTest.php                 | 64 ++++++++++++++++++++--
 .../Intent/Handlers/CustomerLookupHandlerTest.php  |  6 +-
 6 files changed, 100 insertions(+), 26 deletions(-)

```
