# Handoff: C05-05

Created: 2026-01-17T19:12:43.184229Z

Spec: .plans/C05-05.md


## 2026-01-17T19:23:16.711955Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C05-05 in this git repository.

1) Read the spec: .plans/C05-05.md
2) Read handoff/context: .t2/handoff/C05-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 34c822df-2982-469d-b8d0-8ab30a759a8c

Agent final message (file: C05-05.claude.impl.last.md):

All 216 tests pass.

---

## Status: DONE

## Summary of Changes

### New Files Created
1. **`src/Demo/DemoAwareKeyValidator.php`** - A decorator/wrapper for the `OpenAIKeyValidator` that adds demo-mode awareness:
   - In demo stubbed mode: Always returns valid (no API calls made)
   - In demo key mode: Only validates the demo API key (ignores user-provided keys)
   - In normal mode: Delegates to the real `OpenAIKeyValidator`
   - Includes helper methods: `isDemoMode()` and `getValidationInfo()`

2. **`tests/Unit/Demo/DemoAwareKeyValidatorTest.php`** - Comprehensive tests for the new validator:
   - Normal mode delegation tests
   - Demo stubbed mode tests (no API calls)
   - Demo key mode tests (validates demo key only)
   - Security tests (ensures real keys are never leaked)
   - Helper method tests

3. **`tests/Unit/AI/AIClientFactoryTest.php`** - Comprehensive tests for AIClientFactory demo behavior:
   - Normal mode creates OpenAIClient
   - Demo stubbed mode creates DemoClient
   - Demo key mode creates OpenAIClient with demo key
   - Security tests for credential handling
   - Determinism tests

### Modified Files
1. **`src/Providers/InfrastructureServiceProvider.php`** - Updated service container wiring:
   - Registers `OpenAIKeyValidator` as a concrete class
   - Registers `DemoAwareKeyValidator` as the `OpenAIKeyValidatorInterface` implementation
   - Added documentation comments explaining demo-mode behavior

2. **`docs/DEMO.md`** - Added documentation section:
   - Validation Behavior Matrix
   - Security Guarantees
   - Implementation Details

## How to Verify

```bash
# Run all unit tests
composer phpunit

# Run specific demo-mode tests
vendor/bin/phpunit tests/Unit/Demo/DemoAwareKeyValidatorTest.php
vendor/bin/phpunit tests/Unit/AI/AIClientFactoryTest.php

# Check code style
composer phpcs -- src/Demo/DemoAwareKeyValidator.php

# Run static analysis on new code
php -d memory_limit=1G vendor/bin/phpstan analyse --no-progress src/Demo/DemoAwareKeyValidator.php
```

## Risks / Follow-ups

1. **Pre-existing PHPStan warnings**: The `OpenAIKeyValidator` has 2 pre-existing warnings about deprecated constants (`OPENAI_MODELS_URL` and `VALIDATION_TIMEOUT`). These are marked with `@deprecated` and are not related to this implementation.

2. **Behavioral Change**: The `SettingsController::update_api_key()` endpoint now respects demo mode. In demo stubbed mode, API key validation will always succeed. This is the intended behavior but should be noted for any monitoring that may rely on validation failures.

3. **Test Coverage**: The new tests cover the critical security invariant that real keys are never used/validated in demo mode. This ensures deterministic behavior and prevents accidental cost incursion.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M docs/DEMO.md
 M src/Providers/InfrastructureServiceProvider.php
?? .logs/C05-04.gitcommit.txt
?? .logs/C05-05.claude.impl.last.md
?? .logs/C05-05.claude.impl.raw.txt
?? .plans/C05-05.md
?? .t2/handoff/C05-05.md
?? src/Demo/DemoAwareKeyValidator.php
?? tests/Unit/AI/AIClientFactoryTest.php
?? tests/Unit/Demo/DemoAwareKeyValidatorTest.php

diff --stat:
.t2/state.json                                  |  5 ++--
 docs/DEMO.md                                    | 34 +++++++++++++++++++++++++
 src/Providers/InfrastructureServiceProvider.php | 18 ++++++++++++-
 3 files changed, 54 insertions(+), 3 deletions(-)

```
