# Handoff: P06-05

Created: 2026-01-18T10:40:54.483313Z

Spec: .plans/P06-05.md


## 2026-01-18T10:45:22.737062Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P06-05 in this git repository.

1) Read the spec: .plans/P06-05.md
2) Read handoff/context: .t2/handoff/P06-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: aa48937f-c99a-4b7d-9422-399a6f61ab56

Agent final message (file: P06-05.claude.impl.last.md):

All changes look correct. The implementation is complete. Let me provide the summary.

---

## Status: DONE

## Summary of Changes

### Files Modified:
1. **`src/Billing/UsageTracker.php`**
   - Added `PURGE_HOOK` constant (`agentwp_usage_purge`) for the cron hook name
   - Registered the purge hook action in `init()` method
   - Added `activate()` method to schedule purge cron on activation
   - Added `deactivate()` method to unschedule purge cron on deactivation
   - Added `schedule_purge()` method to schedule daily cron event (first run 1 hour after activation)
   - Added `unschedule_purge()` method to remove all scheduled purge events
   - **Removed** `self::purge_old_rows()` calls from `log_usage()` (line 80)
   - **Removed** `self::purge_old_rows()` call from `get_usage_summary()` (line 141)
   - Changed `purge_old_rows()` visibility from `private` to `public` for cron callback

2. **`src/Plugin.php`**
   - Added call to `UsageTracker::deactivate()` in the plugin deactivation handler

3. **`src/Plugin/SchemaManager.php`**
   - Added call to `UsageTracker::schedule_purge()` in `create_tables()` to ensure cron is scheduled on first installation

## How to Verify

1. **PHP Syntax Check:**
   ```bash
   php -l src/Billing/UsageTracker.php
   php -l src/Plugin.php
   php -l src/Plugin/SchemaManager.php
   ```

2. **Functional Verification (in WordPress):**
   - Deactivate and reactivate the plugin
   - Check cron is scheduled: `wp cron event list | grep agentwp_usage_purge`
   - Verify usage logging still works without purge overhead
   - Deactivate plugin and verify cron is unscheduled

3. **Manual Code Review:**
   - Confirm `log_usage()` no longer calls `purge_old_rows()` 
   - Confirm `get_usage_summary()` no longer calls `purge_old_rows()`
   - Confirm purge runs on daily schedule via WordPress cron

## Risks / Follow-ups

1. **Existing Installations**: Sites that already have the plugin installed won't get the cron scheduled until they reactivate the plugin or a future upgrader step is added. Consider adding an upgrader step that calls `UsageTracker::schedule_purge()` for existing installations.

2. **Retention Window**: If the daily cron fails to run for an extended period (e.g., site goes offline), old rows may accumulate. The 90-day retention is still enforced when purge runs, just not on every request.

3. **WP-Cron Dependency**: This relies on WordPress cron which requires traffic to trigger. High-traffic sites will be fine. Low-traffic sites may want to set up a real cron job calling `wp-cron.php`.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Billing/UsageTracker.php
 M src/Plugin.php
 M src/Plugin/SchemaManager.php
?? .logs/P06-04.gitcommit.txt
?? .logs/P06-05.claude.impl.last.md
?? .logs/P06-05.claude.impl.raw.txt
?? .plans/P06-05.md
?? .t2/handoff/P06-05.md

diff --stat:
.t2/state.json               |  5 +++--
 src/Billing/UsageTracker.php | 52 +++++++++++++++++++++++++++++++++++++++-----
 src/Plugin.php               |  4 ++++
 src/Plugin/SchemaManager.php |  3 ++-
 4 files changed, 56 insertions(+), 8 deletions(-)

```
