# Handoff: P07-02

Created: 2026-01-18T10:58:57.222261Z

Spec: .plans/P07-02.md


## 2026-01-18T11:00:31.012537Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task P07-02 in this git repository.

1) Read the spec: .plans/P07-02.md
2) Read handoff/context: .t2/handoff/P07-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 913f39f7-9a6d-4817-8762-1c36dadce6a1

Agent final message (file: P07-02.claude.impl.last.md):

---

**Status: DONE**

## Summary of changes

Added a new `release-artifacts` job to `.github/workflows/ci.yml` that validates release-critical artifacts on every PR. The job:

1. **Sets up the build environment** - Installs PHP dependencies (production mode) and builds frontend assets exactly like the release workflow
2. **Creates a dry-run release package** - Uses the same rsync command with all exclusions as the release workflow
3. **Validates UI build manifest** - Checks that `assets/build/.vite/manifest.json` exists (proves frontend build succeeded)
4. **Validates asset directories** - Ensures:
   - Built assets directory exists at `assets/build/assets/`
   - At least one JavaScript file is present
   - Build entry point `index.html` exists
5. **Checks for forbidden folders** - Fails if any of these are found in the package:
   - `node_modules` (anywhere in the tree)
   - `.git`
   - `tests`
   - `react` (source directory)
   - `.github`

## How to verify

1. Push a PR to trigger the CI workflow and observe the `release-artifacts` job
2. Locally simulate validation:
   ```bash
   # Build frontend
   npm ci --prefix react && npm --prefix react run build
   
   # Create test package
   mkdir -p dist/package/agentwp
   rsync -a --exclude '.git' --exclude 'react' --exclude 'node_modules' --exclude '**/node_modules' --exclude 'tests' --exclude '.github' ./ dist/package/agentwp/
   
   # Check manifest exists
   test -f dist/package/agentwp/assets/build/.vite/manifest.json && echo "✓ Manifest exists"
   
   # Check for forbidden folders
   find dist/package/agentwp -type d -name "node_modules" | grep -q . && echo "✗ node_modules found" || echo "✓ No node_modules"
   ```

## Risks / follow-ups

- **Risk**: The job mirrors the release workflow's rsync excludes. If the release workflow changes its excludes, this job should be updated to match.
- **Follow-up**: Consider extracting the rsync excludes into a shared script or file to keep them in sync between CI and release workflows.
- **Note**: The job runs independently from the `php` and `node` jobs, so all three run in parallel on PRs.


Repo snapshot:
```
branch: main

status:
M .github/workflows/ci.yml
 M .t2/state.json
?? .logs/P07-01.gitcommit.txt
?? .logs/P07-02.claude.impl.last.md
?? .logs/P07-02.claude.impl.raw.txt
?? .plans/P07-02.md
?? .t2/handoff/P07-02.md

diff --stat:
.github/workflows/ci.yml | 162 +++++++++++++++++++++++++++++++++++++++++++++++
 .t2/state.json           |   5 +-
 2 files changed, 165 insertions(+), 2 deletions(-)

```
