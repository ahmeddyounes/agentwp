# Handoff: C02-04

Created: 2026-01-17T16:28:28.559453Z

Spec: .plans/C02-04.md


## 2026-01-17T16:34:53.514641Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C02-04 in this git repository.

1) Read the spec: .plans/C02-04.md
2) Read handoff/context: .t2/handoff/C02-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 6de66efb-0f88-4d4a-9acc-4c8df85eab5a

Agent final message (file: C02-04.claude.impl.last.md):

---

## Status: DONE

## Summary of Changes

Created a new `ApiKeyStorage` service in `src/Security/ApiKeyStorage.php` that encapsulates all encrypt/decrypt/rotate/last4 operations for API keys. Refactored the following files to use the new service:

### New Files:
- **`src/Security/ApiKeyStorage.php`** - Dedicated service class with methods:
  - `store()` / `storePrimary()` / `storeDemo()` - Store encrypted API keys with last4
  - `retrieve()` / `retrievePrimary()` / `retrieveDemo()` - Retrieve and decrypt API keys
  - `delete()` / `deletePrimary()` / `deleteDemo()` - Delete stored keys
  - `rotate()` / `rotatePrimary()` / `rotateDemo()` - Re-encrypt with current salts
  - `getLast4()` / `getPrimaryLast4()` / `getDemoLast4()` - Get last 4 chars
  - `hasKey()` / `hasPrimaryKey()` / `hasDemoKey()` - Check if key exists
  - `extractLast4()` - Utility to extract last 4 characters

### Modified Files:
1. **`src/Providers/InfrastructureServiceProvider.php`** - Added registration for `Encryption` and `ApiKeyStorage` as singletons
2. **`src/Providers/CoreServiceProvider.php`** - Updated `SettingsManager` registration to optionally inject `ApiKeyStorage`
3. **`src/Rest/SettingsController.php`** - Removed direct `Encryption` instantiation, now uses `ApiKeyStorage` for all API key operations
4. **`src/Plugin/SettingsManager.php`** - Added optional `ApiKeyStorage` dependency, `getApiKey()`, `setApiKey()`, and `getDemoApiKey()` now use the service
5. **`src/Demo/Mode.php`** - Refactored to use `ApiKeyStorage` instead of direct `Encryption` instantiation
6. **`src/Demo/Resetter.php`** - Updated to use `ApiKeyStorage` with fallback for when container is unavailable

### Acceptance Criteria Met:
- ✅ No controller directly instantiates `Encryption` (only `InfrastructureServiceProvider` does)
- ✅ No controller manually manages last4 (delegated to `ApiKeyStorage`)
- ✅ `ApiKeyStorage` is wired via provider (registered in `InfrastructureServiceProvider`)

## How to Verify

```bash
# Run PHP syntax check
php -l src/Security/ApiKeyStorage.php

# Run unit tests
./vendor/bin/phpunit

# Run static analysis
./vendor/bin/phpstan analyse src/Security/ApiKeyStorage.php src/Rest/SettingsController.php src/Demo/Mode.php src/Plugin/SettingsManager.php --memory-limit=512M

# Verify no direct Encryption instantiation in controllers
grep -r "new Encryption()" src/ --include="*.php"
# Should only show: src/Providers/InfrastructureServiceProvider.php

# Verify Encryption import is only in provider
grep -r "use AgentWP\\\\Security\\\\Encryption" src/ --include="*.php"
# Should only show: src/Providers/InfrastructureServiceProvider.php
```

## Risks / Follow-ups

1. **Backward compatibility**: The `SettingsManager::setApiKey()` now encrypts the key before storing. If any code was passing pre-encrypted keys, it would double-encrypt. However, reviewing the codebase shows this method wasn't called anywhere, so risk is minimal.

2. **Container availability**: The `Demo/Mode`, `Demo/Resetter`, and `SettingsManager` have fallback behavior when the container/`ApiKeyStorage` is not available, ensuring they work during early bootstrap or in edge cases.

3. **No new tests added**: Consider adding unit tests for `ApiKeyStorage` to ensure encryption/decryption/rotation work correctly through the service abstraction.


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Demo/Mode.php
 M src/Demo/Resetter.php
 M src/Plugin/SettingsManager.php
 M src/Providers/CoreServiceProvider.php
 M src/Providers/InfrastructureServiceProvider.php
 M src/Rest/SettingsController.php
?? .logs/C02-03.gitcommit.txt
?? .logs/C02-04.claude.impl.last.md
?? .logs/C02-04.claude.impl.raw.txt
?? .plans/C02-04.md
?? .t2/handoff/C02-04.md
?? src/Security/ApiKeyStorage.php

diff --stat:
.t2/state.json                                  |  5 +-
 src/Demo/Mode.php                               | 59 ++++++++++---------
 src/Demo/Resetter.php                           | 32 +++++++++-
 src/Plugin/SettingsManager.php                  | 38 +++++++++---
 src/Providers/CoreServiceProvider.php           |  6 +-
 src/Providers/InfrastructureServiceProvider.php | 24 ++++++++
 src/Rest/SettingsController.php                 | 78 +++++++++----------------
 7 files changed, 150 insertions(+), 92 deletions(-)

```


## 2026-01-17T16:35:35.739356Z — claude — after1

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions --resume 6de66efb-0f88-4d4a-9acc-4c8df85eab5a We just completed/updated task C02-04.

Spec: .plans/C02-04.md
Handoff/context: .t2/handoff/C02-04.md

Run this follow-up instruction:
Self review all your uncommited changes

If you modify code, keep changes minimal and consistent with the task.
Summarize what you did.

```

Return code: 0

Session: 6de66efb-0f88-4d4a-9acc-4c8df85eab5a

Agent final message (file: C02-04.claude.after1.last.md):

All tests pass and static analysis shows no errors.

## Self-Review Summary

All changes are consistent with the C02-04 spec. The implementation:

1. **New `ApiKeyStorage` service** (`src/Security/ApiKeyStorage.php`) - Encapsulates encrypt/decrypt/rotate/last4 for both primary and demo API keys with proper DI through constructor injection of `Encryption` and `OptionsInterface`.

2. **Provider wiring** (`src/Providers/InfrastructureServiceProvider.php`) - Registers `Encryption` and `ApiKeyStorage` as singletons.

3. **Refactored consumers**:
   - `SettingsController` - Uses `ApiKeyStorage` via container resolution; removed `encrypt_api_key()` and `maybe_rotate_api_key()` methods
   - `SettingsManager` - Optional `ApiKeyStorage` injection with fallback for backward compatibility
   - `Demo/Mode` - Uses `ApiKeyStorage` for demo key operations
   - `Demo/Resetter` - Uses `ApiKeyStorage` with fallback when container unavailable

4. **Acceptance criteria met**:
   - No controller directly instantiates `Encryption` (only `InfrastructureServiceProvider`)
   - No controller manually manages last4 (delegated to `ApiKeyStorage`)


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M src/Demo/Mode.php
 M src/Demo/Resetter.php
 M src/Plugin/SettingsManager.php
 M src/Providers/CoreServiceProvider.php
 M src/Providers/InfrastructureServiceProvider.php
 M src/Rest/SettingsController.php
?? .logs/C02-03.gitcommit.txt
?? .logs/C02-04.claude.after1.last.md
?? .logs/C02-04.claude.after1.raw.txt
?? .logs/C02-04.claude.impl.last.md
?? .logs/C02-04.claude.impl.raw.txt
?? .plans/C02-04.md
?? .t2/handoff/C02-04.md
?? src/Security/ApiKeyStorage.php

diff --stat:
.t2/state.json                                  |  8 ++-
 src/Demo/Mode.php                               | 59 ++++++++++---------
 src/Demo/Resetter.php                           | 32 +++++++++-
 src/Plugin/SettingsManager.php                  | 38 +++++++++---
 src/Providers/CoreServiceProvider.php           |  6 +-
 src/Providers/InfrastructureServiceProvider.php | 24 ++++++++
 src/Rest/SettingsController.php                 | 78 +++++++++----------------
 7 files changed, 152 insertions(+), 93 deletions(-)

```
