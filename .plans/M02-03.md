# M02-03 â€” Refund Processing - Draft Mode

Implement the refund workflow with Draft-Confirm protocol: 1) Create AgentWP\Handlers\RefundHandler class. 2) OpenAI function schema: prepare_refund(order_id: int, amount?: float, reason?: string, restock_items?: bool). 3) NEVER execute refund on first call - return draft object only. 4) Draft object contains: order_id, order_total, refund_amount, reason, items_to_restock, customer_email, payment_method, requires_manual_refund (bool). 5) Create separate confirm_refund(draft_id: string) function that executes wc_create_refund(). 6) Generate unique draft_id, store in transient with 10-minute expiry. 7) Handle partial refunds, full refunds, and refund+restock scenarios. 8) After confirmation, optionally trigger customer notification email. Acceptance Criteria: No refund ever processed without explicit confirm_refund call, draft expires after 10 minutes, partial refund calculates correctly, payment gateway refund triggered for supported gateways, audit log entry created.
