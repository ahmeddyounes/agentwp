version: "3.9"

services:
  db:
    image: mysql:8.0
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: ${WORDPRESS_DB_NAME:-agentwp}
      MYSQL_USER: ${WORDPRESS_DB_USER:-agentwp}
      MYSQL_PASSWORD: ${WORDPRESS_DB_PASSWORD:-agentwp}
      MYSQL_ROOT_PASSWORD: ${WORDPRESS_DB_ROOT_PASSWORD:-agentwp_root}
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${WORDPRESS_DB_ROOT_PASSWORD:-agentwp_root}"]
      interval: 5s
      timeout: 5s
      retries: 20

  wordpress:
    build:
      context: ./docker/wordpress
      args:
        WOOCOMMERCE_VERSION: ${WOOCOMMERCE_VERSION:-8.4.0}
    depends_on:
      - db
    ports:
      - "${WORDPRESS_PORT:-8080}:80"
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: ${WORDPRESS_DB_USER:-agentwp}
      WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD:-agentwp}
      WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME:-agentwp}
      WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX:-wp_}
      WORDPRESS_SITE_URL: ${WORDPRESS_SITE_URL:-http://localhost:8080}
      WORDPRESS_SITE_TITLE: ${WORDPRESS_SITE_TITLE:-AgentWP Dev Store}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      WC_STORE_ADDRESS: ${WC_STORE_ADDRESS:-100 Market St}
      WC_STORE_CITY: ${WC_STORE_CITY:-San Francisco}
      WC_STORE_STATE: ${WC_STORE_STATE:-CA}
      WC_STORE_POSTCODE: ${WC_STORE_POSTCODE:-94105}
      WC_DEFAULT_COUNTRY: ${WC_DEFAULT_COUNTRY:-US:CA}
      WC_CURRENCY: ${WC_CURRENCY:-USD}
      SEED_PRODUCTS: ${SEED_PRODUCTS:-60}
      SEED_ORDERS: ${SEED_ORDERS:-120}
      WOOCOMMERCE_VERSION: ${WOOCOMMERCE_VERSION:-8.4.0}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG', ${WORDPRESS_DEBUG:-false});
        define('WP_DEBUG_LOG', ${WORDPRESS_DEBUG_LOG:-true});
        define('WP_DEBUG_DISPLAY', ${WORDPRESS_DEBUG_DISPLAY:-false});
        define('WP_ENVIRONMENT_TYPE', 'development');
        define('WP_HOME', '${WORDPRESS_SITE_URL:-http://localhost:8080}');
        define('WP_SITEURL', '${WORDPRESS_SITE_URL:-http://localhost:8080}');
        define('FS_METHOD', 'direct');
    volumes:
      - ./wp:/var/www/html
      - ./scripts:/scripts

  wp_setup:
    build:
      context: ./docker/wordpress
      args:
        WOOCOMMERCE_VERSION: ${WOOCOMMERCE_VERSION:-8.4.0}
    depends_on:
      - db
      - wordpress
    environment:
      WORDPRESS_SITE_URL: ${WORDPRESS_SITE_URL:-http://localhost:8080}
      WORDPRESS_SITE_TITLE: ${WORDPRESS_SITE_TITLE:-AgentWP Dev Store}
      WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
      WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-admin123}
      WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
      WC_STORE_ADDRESS: ${WC_STORE_ADDRESS:-100 Market St}
      WC_STORE_CITY: ${WC_STORE_CITY:-San Francisco}
      WC_STORE_STATE: ${WC_STORE_STATE:-CA}
      WC_STORE_POSTCODE: ${WC_STORE_POSTCODE:-94105}
      WC_DEFAULT_COUNTRY: ${WC_DEFAULT_COUNTRY:-US:CA}
      WC_CURRENCY: ${WC_CURRENCY:-USD}
      SEED_PRODUCTS: ${SEED_PRODUCTS:-60}
      SEED_ORDERS: ${SEED_ORDERS:-120}
      WOOCOMMERCE_VERSION: ${WOOCOMMERCE_VERSION:-8.4.0}
    volumes:
      - ./wp:/var/www/html
      - ./scripts:/scripts
    entrypoint: ["/bin/bash", "/scripts/wp-setup.sh"]

  node:
    image: node:20-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port ${REACT_DEV_PORT:-5173}"
    environment:
      CHOKIDAR_USEPOLLING: "true"
      REACT_DEV_PORT: ${REACT_DEV_PORT:-5173}
    ports:
      - "${REACT_DEV_PORT:-5173}:${REACT_DEV_PORT:-5173}"
    volumes:
      - ./react:/app

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports:
      - "${MAILHOG_UI_PORT:-8025}:8025"
      - "${MAILHOG_SMTP_PORT:-1025}:1025"

volumes:
  db_data:
