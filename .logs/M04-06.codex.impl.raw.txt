Status: NEEDS-REVIEW

Implemented shadow-root mounting and scoped styling for the command deck, with the modal now portaled into the shadow root and theme/hotkey handling adapted for shadow DOM.
- `react/src/main.jsx`: attach to `#agentwp-root`, inject inline Tailwind CSS into the shadow root, and pass `shadowRoot`/`portalRoot`/`themeTarget` into the app.
- `react/src/App.jsx`: apply theme to the host, use composed-path targets for the hotkey guard, trap focus using the shadow-root active element, and portal the modal via `createPortal`.
- `react/src/index.css`: scope theme variables to `:host`, move base background to `.agentwp-app`, remove Google font import, and add a system font stack plus shadow-root theme-transition selectors.
- `react/tailwind.config.js`, `react/index.html`: update font stacks and dev root id to `agentwp-root`.

How to verify (exact commands):
- None (no automated verification commands provided).

Risks / follow-ups:
- Manual QA still needed across the listed themes and admin customization plugins.
- Confirm `#agentwp-root` is rendered on target admin pages so the shadow mount always occurs.

OpenAI Codex v0.79.0 (research preview)
--------
workdir: /Users/ahmedyounis/Documents/Projects/agentwp
model: gpt-5.2-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019b979c-df16-79b3-9b0e-30cffb34c064
--------
user
You are implementing task M04-06 in this git repository.

1) Read the spec: .plans/M04-06.md
2) Read handoff/context: .t2/handoff/M04-06.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

mcp startup: no servers

thinking
**Considering file reading methods**
exec
/bin/zsh -lc ls in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 62ms:
agentwp.php
assets
composer.json
docker
docker-compose.yml
docs
includes
languages
react
README.md
scripts
setup.sh
src
tasks.csv
uninstall.php

thinking
**Reviewing specification details**
exec
/bin/zsh -lc 'cat .plans/M04-06.md' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
# M04-06 — Shadow DOM Encapsulation

Isolate Command Deck CSS using Shadow DOM: 1) Mount React app inside Shadow DOM container attached to #agentwp-root. 2) Inject TailwindCSS (scoped build) into shadow root. 3) Handle font loading: embed critical fonts as base64 or use system font stack. 4) Ensure hotkey listener works outside shadow DOM. 5) Portal modals (confirmation dialogs) to shadow root. 6) Test against 10 popular themes: Storefront, Astra, OceanWP, Flatsome, Divi, Avada, GeneratePress, Neve, Kadence, flavor of the month. 7) Test against admin customization plugins: White Label CMS, Admin Menu Editor. 8) Prevent !important overrides from themes leaking in. Acceptance Criteria: No visual differences across tested themes, no CSS leaking from plugin to theme or vice versa, all interactive elements remain functional, modal focus trap works correctly.

thinking
**Preparing handoff**
exec
/bin/zsh -lc 'cat .t2/handoff/M04-06.md' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
# Handoff: M04-06

Created: 2026-01-07T08:39:58.954993Z

Spec: .plans/M04-06.md

thinking
**Searching for React app root element**
exec
/bin/zsh -lc 'rg -n "agentwp-root|shadow" -S src react includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 83ms:
react/src/App.jsx:2295:          <div className="rounded-2xl border border-deck-border bg-deck-surface/80 p-6 shadow-deck">
react/src/App.jsx:2316:          <div className="rounded-2xl border border-deck-border bg-deck-surface/60 p-6 text-sm text-slate-300 shadow-deck">
react/src/App.jsx:2327:          <div className="rounded-2xl border border-deck-border bg-deck-surface/70 p-6 shadow-deck">
react/src/App.jsx:2411:            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
react/src/App.jsx:2491:                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
react/tailwind.config.js:53:      boxShadow: {
react/tailwind.config.js:54:        deck: 'var(--awp-shadow-deck)',
react/src/index.css:53:  --awp-shadow-deck: 0 30px 80px rgba(15, 23, 42, 0.18);
react/src/index.css:74:  --awp-card-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
react/src/index.css:89:  --awp-card-bar-shadow: rgba(15, 23, 42, 0.12);
react/src/index.css:171:  --awp-shadow-deck: 0 30px 80px rgba(15, 23, 42, 0.55);
react/src/index.css:192:  --awp-card-shadow: 0 24px 50px rgba(15, 23, 42, 0.4);
react/src/index.css:207:  --awp-card-bar-shadow: rgba(15, 23, 42, 0.2);
react/src/index.css:289:    --awp-shadow-deck: 0 30px 80px rgba(15, 23, 42, 0.55);
react/src/index.css:310:    --awp-card-shadow: 0 24px 50px rgba(15, 23, 42, 0.4);
react/src/index.css:325:    --awp-card-bar-shadow: rgba(15, 23, 42, 0.2);
react/src/index.css:402:    box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
react/components/cards/cards.css:9:  --card-shadow: var(--awp-card-shadow);
react/components/cards/cards.css:25:  box-shadow: var(--card-shadow);
react/components/cards/cards.css:265:  background: linear-gradient(180deg, var(--card-accent), var(--awp-card-bar-shadow));

thinking
**Checking frontend entry point**
exec
/bin/zsh -lc 'rg -n "createRoot|ReactDOM|agentwp" react/src -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 74ms:
react/src/App.jsx:14:const OPEN_STATE_KEY = 'agentwp-command-deck-open';
react/src/App.jsx:15:const DRAFT_HISTORY_KEY = 'agentwp-draft-history';
react/src/App.jsx:17:const COMMAND_HISTORY_KEY = 'agentwp-command-history';
react/src/App.jsx:18:const COMMAND_FAVORITES_KEY = 'agentwp-command-favorites';
react/src/App.jsx:19:const COMMAND_USAGE_KEY = 'agentwp-command-usage';
react/src/App.jsx:25:  '#wp-admin-bar-agentwp',
react/src/App.jsx:26:  '[data-agentwp-command-deck]',
react/src/App.jsx:27:  '#agentwp-command-deck',
react/src/App.jsx:29:const REST_PATH = '/agentwp/v1/intent';
react/src/App.jsx:30:const SEARCH_PATH = '/agentwp/v1/search';
react/src/App.jsx:31:const USAGE_PATH = '/agentwp/v1/usage';
react/src/App.jsx:32:const SETTINGS_PATH = '/agentwp/v1/settings';
react/src/App.jsx:33:const THEME_PATH = '/agentwp/v1/theme';
react/src/App.jsx:34:const HEALTH_PATH = '/agentwp/v1/health';
react/src/App.jsx:162:  agentwp_rate_limited: 'Too many requests. Please wait and retry.',
react/src/App.jsx:163:  agentwp_invalid_key: 'The OpenAI API key is invalid. Update it in settings.',
react/src/App.jsx:164:  agentwp_invalid_request: 'Please check your request and try again.',
react/src/App.jsx:165:  agentwp_missing_prompt: 'Please enter a prompt to continue.',
react/src/App.jsx:166:  agentwp_forbidden: 'You do not have permission to use AgentWP.',
react/src/App.jsx:356:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;

thinking
**Investigating root mounting approach**
exec
/bin/zsh -lc 'rg -n "agentwp-root|root" -S includes src react | head -n 200' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 78ms:
react/index.html:9:    <div id="root"></div>
react/src/App.jsx:356:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
react/src/App.jsx:357:  if (!root) {
react/src/App.jsx:360:  return `${root.replace(/\/$/, '')}${REST_PATH}`;
react/src/App.jsx:367:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
react/src/App.jsx:368:  if (!root) {
react/src/App.jsx:371:  return `${root.replace(/\/$/, '')}${SEARCH_PATH}`;
react/src/App.jsx:378:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
react/src/App.jsx:379:  if (!root) {
react/src/App.jsx:382:  return `${root.replace(/\/$/, '')}${USAGE_PATH}`;
react/src/App.jsx:389:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
react/src/App.jsx:390:  if (!root) {
react/src/App.jsx:393:  return `${root.replace(/\/$/, '')}${SETTINGS_PATH}`;
react/src/App.jsx:400:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
react/src/App.jsx:401:  if (!root) {
react/src/App.jsx:404:  return `${root.replace(/\/$/, '')}${THEME_PATH}`;
react/src/App.jsx:411:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
react/src/App.jsx:412:  if (!root) {
react/src/App.jsx:415:  return `${root.replace(/\/$/, '')}${HEALTH_PATH}`;
react/src/App.jsx:936:    const root = document.documentElement;

thinking
**Checking plugin front-end mounting point**
exec
/bin/zsh -lc 'rg -n "agentwp-admin-root|agentwp" -S src includes | head -n 200' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
src/Billing/UsageTracker.php:5: * @package AgentWP
src/Billing/UsageTracker.php:8:namespace AgentWP\Billing;
src/Billing/UsageTracker.php:10:use AgentWP\AI\Model;
src/Billing/UsageTracker.php:16:	const TABLE          = 'agentwp_usage';
src/Billing/UsageTracker.php:18:	const VERSION_OPTION = 'agentwp_usage_version';
src/Error/Handler.php:5: * @package AgentWP
src/Error/Handler.php:8:namespace AgentWP\Error;
src/Context/EmailContextBuilder.php:5: * @package AgentWP
src/Context/EmailContextBuilder.php:8:namespace AgentWP\Context;
src/AI/Functions/GetSalesReport.php:5: * @package AgentWP
src/AI/Functions/GetSalesReport.php:8:namespace AgentWP\AI\Functions;
src/Rest/HealthController.php:5: * @package AgentWP
src/Rest/HealthController.php:8:namespace AgentWP\Rest;
src/Rest/HealthController.php:10:use AgentWP\API\RestController;
src/Rest/HealthController.php:42:				'version' => defined( 'AGENTWP_VERSION' ) ? AGENTWP_VERSION : '',
src/API/HistoryController.php:5: * @package AgentWP
src/API/HistoryController.php:8:namespace AgentWP\API;
src/API/HistoryController.php:13:	const HISTORY_META_KEY   = 'agentwp_command_history';
src/API/HistoryController.php:14:	const FAVORITES_META_KEY = 'agentwp_command_favorites';
src/API/HistoryController.php:73:			return $this->response_error( 'agentwp_invalid_request', $validation->get_error_message(), 400 );

thinking
**Opening src/Plugin.php**
exec
/bin/zsh -lc "sed -n '1,260p' src/Plugin.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
<?php
/**
 * Core plugin bootstrap.
 *
 * @package AgentWP
 */

namespace AgentWP;

class Plugin {
	const OPTION_SETTINGS     = 'agentwp_settings';
	const OPTION_API_KEY      = 'agentwp_api_key';
	const OPTION_API_KEY_LAST4 = 'agentwp_api_key_last4';
	const OPTION_BUDGET_LIMIT = 'agentwp_budget_limit';
	const OPTION_DRAFT_TTL    = 'agentwp_draft_ttl_minutes';
	const OPTION_USAGE_STATS  = 'agentwp_usage_stats';
	const TRANSIENT_PREFIX    = 'agentwp_';

	/**
	 * @var Plugin|null

thinking
**Searching for agentwp-root in repo**
exec
/bin/zsh -lc 'rg -n "agentwp-root" -S .' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
./tasks.csv:28:M04-06,"Shadow DOM Encapsulation","Isolate Command Deck CSS using Shadow DOM: 1) Mount React app inside Shadow DOM container attached to #agentwp-root. 2) Inject TailwindCSS (scoped build) into shadow root. 3) Handle font loading: embed critical fonts as base64 or use system font stack. 4) Ensure hotkey listener works outside shadow DOM. 5) Portal modals (confirmation dialogs) to shadow root. 6) Test against 10 popular themes: Storefront, Astra, OceanWP, Flatsome, Divi, Avada, GeneratePress, Neve, Kadence, flavor of the month. 7) Test against admin customization plugins: White Label CMS, Admin Menu Editor. 8) Prevent !important overrides from themes leaking in. Acceptance Criteria: No visual differences across tested themes, no CSS leaking from plugin to theme or vice versa, all interactive elements remain functional, modal focus trap works correctly."

thinking
**Searching for command deck references**
exec
/bin/zsh -lc 'rg -n "command deck|command-deck|deck" -S react/src src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
react/src/App.jsx:14:const OPEN_STATE_KEY = 'agentwp-command-deck-open';
react/src/App.jsx:26:  '[data-agentwp-command-deck]',
react/src/App.jsx:27:  '#agentwp-command-deck',
react/src/App.jsx:1059:      // Usage fetch failures should not block the command deck.
react/src/App.jsx:2286:            Command Deck: instant actions for your store.
react/src/App.jsx:2289:            Invoke the Command Deck with Cmd+K / Ctrl+K or the admin bar button. Responses render
react/src/App.jsx:2295:          <div className="rounded-2xl border border-deck-border bg-deck-surface/80 p-6 shadow-deck">
react/src/App.jsx:2306:              Open Command Deck
react/src/App.jsx:2316:          <div className="rounded-2xl border border-deck-border bg-deck-surface/60 p-6 text-sm text-slate-300 shadow-deck">
react/src/App.jsx:2317:            <h2 className="text-lg font-semibold text-white">Command Deck status</h2>
react/src/App.jsx:2327:          <div className="rounded-2xl border border-deck-border bg-deck-surface/70 p-6 shadow-deck">
react/src/App.jsx:2410:            aria-labelledby="agentwp-command-deck-title"
react/src/App.jsx:2411:            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
react/src/App.jsx:2418:                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
react/src/App.jsx:2419:                  Command Deck
react/src/App.jsx:2437:                  aria-label="Close Command Deck"
react/src/App.jsx:2745:                      Visualize revenue trends and period performance inside the Command Deck.
react/src/index.css:51:  --awp-deck-surface: 255 255 255;
react/src/index.css:52:  --awp-deck-border: 148 163 184;
react/src/index.css:53:  --awp-shadow-deck: 0 30px 80px rgba(15, 23, 42, 0.18);

thinking
**Inspecting React app entry points**
exec
/bin/zsh -lc "sed -n '1,200p' react/src/main.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import ErrorBoundary from '../components/ErrorBoundary.jsx';
import './index.css';
import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';

const initialPreference = getInitialThemePreference();
const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
applyTheme(resolvedTheme);

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <ErrorBoundary>
      <App />
    </ErrorBoundary>
  </React.StrictMode>
);

thinking
**Checking portal usage for modals**
exec
/bin/zsh -lc "sed -n '2300,2550p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
            </p>
            <button
              type="button"
              onClick={openModal}
              className="mt-6 inline-flex items-center justify-center gap-2 rounded-full border border-slate-600/60 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-white transition hover:border-slate-400/80 hover:bg-slate-900/80 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
            >
              Open Command Deck
              <span className="rounded-full border border-slate-600/80 bg-slate-950/70 px-2 py-1 text-[11px] text-slate-300">
                {typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform)
                  ? 'Cmd'
                  : 'Ctrl'}
                +K
              </span>
            </button>
          </div>

          <div className="rounded-2xl border border-deck-border bg-deck-surface/60 p-6 text-sm text-slate-300 shadow-deck">
            <h2 className="text-lg font-semibold text-white">Command Deck status</h2>
            <ul className="mt-3 space-y-2 text-sm">
              <li>Modal state is persisted in session storage.</li>

thinking
**Investigating modal and Shadow DOM integration**
exec
/bin/zsh -lc 'rg -n "createPortal|portal" -S react/src react/components' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 71ms:


thinking
**Investigating modal portal and shadow root integration**
exec
/bin/zsh -lc 'ls assets' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
agentwp-admin.css
agentwp-admin.js
index.php

thinking
**Checking build setup for React source**
exec
/bin/zsh -lc 'ls react' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
components
index.html
package.json
postcss.config.js
src
tailwind.config.js
vite.config.js

thinking
**Evaluating asset update strategy**
exec
/bin/zsh -lc 'wc -c assets/agentwp-admin.js && head -n 5 assets/agentwp-admin.js' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
   22634 assets/agentwp-admin.js
(function () {
	'use strict';

	if (!window.wp || !wp.element || !wp.components || !wp.apiFetch) {
		return;

thinking
**Analyzing admin UI assets**
exec
/bin/zsh -lc "sed -n '1,200p' assets/agentwp-admin.js" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
(function () {
	'use strict';

	if (!window.wp || !wp.element || !wp.components || !wp.apiFetch) {
		return;
	}

	var apiFetch = wp.apiFetch;
	var config = window.agentwpSettings || {};

	if (config.nonce && apiFetch.createNonceMiddleware) {
		apiFetch.use(apiFetch.createNonceMiddleware(config.nonce));
	}

	if (config.root && apiFetch.createRootURLMiddleware) {
		apiFetch.use(apiFetch.createRootURLMiddleware(config.root));
	}

	var el = wp.element.createElement;
	var render = wp.element.render;

thinking
**Investigating React app structure**
exec
/bin/zsh -lc 'head -n 40 assets/agentwp-admin.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
.agentwp-admin {
	margin-top: 16px;
	padding: 16px;
	background: #fff;
	border: 1px solid #dcdcde;
	border-radius: 4px;
}

.agentwp-settings {
	max-width: 1080px;
}

.agentwp-settings__header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 16px;
	margin: 8px 0 16px;
}


thinking
**Analyzing command deck CSS location**
exec
/bin/zsh -lc 'rg -n "Command Deck|deck" -S assets' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
assets/agentwp-admin.js:649:							label: __('Command Deck Hotkey', 'agentwp'),

thinking
**Investigating React app integration points**
exec
/bin/zsh -lc 'rg -n "command" -S src | head -n 200' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
src/API/HistoryController.php:13:	const HISTORY_META_KEY   = 'agentwp_command_history';
src/API/HistoryController.php:14:	const FAVORITES_META_KEY = 'agentwp_command_favorites';

thinking
**Planning shadow DOM and scoped CSS integration**

I'm figuring out how to mount the React app inside a shadow root attached to `#agentwp-root` while keeping dev fallback on `#root`. I’m also sorting out how to stop global CSS leaking by importing CSS as an inline string and injecting it into the shadow root’s style tag, plus checking font usage to avoid external dependencies.
exec
/bin/zsh -lc "sed -n '1,160p' react/src/index.css" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  color-scheme: light;
  --awp-bg-primary: #f8fafc;
  --awp-bg-secondary: #f1f5f9;
  --awp-text-primary: #0f172a;
  --awp-text-secondary: #475569;
  --awp-accent: #0ea5e9;
  --awp-danger: #e11d48;
  --awp-success: #16a34a;
  --awp-border: rgba(148, 163, 184, 0.6);

  --awp-slate-950: 248 250 252;
  --awp-slate-900: 241 245 249;
  --awp-slate-800: 226 232 240;

thinking
**Removing Google Fonts import**
exec
/bin/zsh -lc "sed -n '1,120p' react/tailwind.config.js" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
/** @type {import('tailwindcss').Config} */
const withAlpha = (variable) => `rgb(var(${variable}) / <alpha-value>)`;

export default {
  content: ['./index.html', './src/**/*.{js,jsx}'],
  theme: {
    extend: {
      fontFamily: {
        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
      },
      colors: {
        white: withAlpha('--awp-white'),
        black: withAlpha('--awp-black'),
        slate: {
          100: withAlpha('--awp-slate-100'),
          200: withAlpha('--awp-slate-200'),
          300: withAlpha('--awp-slate-300'),
          400: withAlpha('--awp-slate-400'),
          500: withAlpha('--awp-slate-500'),

thinking
**Evaluating font usage and CSS imports**
exec
/bin/zsh -lc 'rg -n "#root|agentwp" -n react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 73ms:
423:#root {
427:.agentwp-markdown {
433:.agentwp-markdown p {
437:.agentwp-markdown ul,
438:.agentwp-markdown ol {
442:.agentwp-markdown li {
446:.agentwp-markdown a {
451:.agentwp-markdown code {
459:.agentwp-markdown pre {
468:.agentwp-markdown pre code {
exec
/bin/zsh -lc "sed -n '400,520p' react/src/index.css" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
:root.awp-theme-transition * {
  transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
    box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
}

@media (prefers-reduced-motion: reduce) {
  :root.awp-theme-transition,
  :root.awp-theme-transition * {
    transition: none;
  }
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
  background-color: var(--awp-body-bg);
  background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
    var(--awp-body-gradient-3), var(--awp-body-gradient-4);
  background-attachment: fixed;

thinking
**Analyzing CSS scope for shadow DOM**
exec
/bin/zsh -lc "sed -n '1,200p' react/src/theme.js" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
const THEME_STORAGE_KEY = 'agentwp-theme-preference';
const VALID_THEMES = new Set(['light', 'dark']);

const normalizeTheme = (value) => (VALID_THEMES.has(value) ? value : null);

export const isValidTheme = (value) => VALID_THEMES.has(value);

export const getStoredTheme = () => {
  if (typeof window === 'undefined') {
    return null;
  }
  try {
    return normalizeTheme(window.localStorage.getItem(THEME_STORAGE_KEY));
  } catch (error) {
    return null;
  }
};

export const getServerTheme = () => {
  if (typeof window === 'undefined') {

thinking
**Planning theme application to shadow DOM**
exec
/bin/zsh -lc "sed -n '880,1020p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
  const [exportStatus, setExportStatus] = useState('idle');
  const [selectedPeriod, setSelectedPeriod] = useState('7d');
  const [themePreference, setThemePreference] = useState(getInitialThemePreference);
  const inputRef = useRef(null);
  const modalRef = useRef(null);
  const responseHtmlRef = useRef(null);
  const lastActiveRef = useRef(null);
  const requestControllerRef = useRef(null);
  const searchControllerRef = useRef(null);
  const healthControllerRef = useRef(null);
  const searchTimeoutRef = useRef(null);
  const promptBlurTimeoutRef = useRef(null);
  const suppressSearchRef = useRef(false);
  const lastPromptRef = useRef('');
  const chartRef = useRef(null);
  const exportTimerRef = useRef(null);
  const themeTransitionRef = useRef(null);
  const hasAppliedThemeRef = useRef(false);
  const serverThemeRef = useRef(getServerTheme());
  const prefersDark = usePrefersDark();

thinking
**Adjusting theme application and focus management**
exec
/bin/zsh -lc "rg -n \"keydown|hotkey|Cmd\\+K|Ctrl\\+K\" -S react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
1685:    window.addEventListener('keydown', handleHotkey);
1686:    return () => window.removeEventListener('keydown', handleHotkey);
1747:    document.addEventListener('keydown', handleKeydown);
1748:    return () => document.removeEventListener('keydown', handleKeydown);
2289:            Invoke the Command Deck with Cmd+K / Ctrl+K or the admin bar button. Responses render
exec
/bin/zsh -lc "sed -n '1620,1785p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
    }
    try {
      window.localStorage.setItem(COMMAND_USAGE_KEY, JSON.stringify(commandUsage));
    } catch (error) {
      // Ignore storage failures (private mode, strict policies).
    }
  }, [commandUsage]);

  useEffect(() => {
    if (!isOpen) {
      return undefined;
    }
    const previousOverflow = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = previousOverflow;
    };
  }, [isOpen]);

  useEffect(() => {

thinking
**Analyzing event and focus handling with shadow DOM**
exec
/bin/zsh -lc 'rg -n "dialog|confirm|modal" -S react/src/App.jsx react/components' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 74ms:
react/src/App.jsx:884:  const modalRef = useRef(null);
react/src/App.jsx:1394:  const openModal = useCallback(() => {
react/src/App.jsx:1401:  const closeModal = useCallback(() => {
react/src/App.jsx:1679:        closeModal();
react/src/App.jsx:1681:        openModal();
react/src/App.jsx:1687:  }, [closeModal, isOpen, openModal]);
react/src/App.jsx:1700:      openModal();
react/src/App.jsx:1705:  }, [openModal]);
react/src/App.jsx:1714:        closeModal();
react/src/App.jsx:1720:      const focusable = getFocusableElements(modalRef.current);
react/src/App.jsx:1727:      if (!modalRef.current?.contains(activeElement)) {
react/src/App.jsx:1749:  }, [closeModal, isOpen]);
react/src/App.jsx:2303:              onClick={openModal}
react/src/App.jsx:2319:              <li>Modal state is persisted in session storage.</li>
react/src/App.jsx:2402:              closeModal();
react/src/App.jsx:2407:            ref={modalRef}
react/src/App.jsx:2408:            role="dialog"
react/src/App.jsx:2409:            aria-modal="true"
react/src/App.jsx:2435:                  onClick={closeModal}
react/components/cards/DangerousActionCard.jsx:19:  title = 'Confirm action',
exec
/bin/zsh -lc "sed -n '1,200p' react/components/cards/DangerousActionCard.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
import BaseCard from './BaseCard.jsx';

const WarningIcon = () => (
  <svg
    viewBox="0 0 24 24"
    width="20"
    height="20"
    aria-hidden="true"
    focusable="false"
  >
    <path
      fill="currentColor"
      d="M12 3.2c.4 0 .8.2 1 .6l8.4 14.2c.4.7-.1 1.5-1 1.5H3.6c-.8 0-1.3-.8-.9-1.5L11 3.8c.2-.4.6-.6 1-.6zm0 5.1a.9.9 0 0 0-.9.9v5.1a.9.9 0 0 0 1.8 0V9.2a.9.9 0 0 0-.9-.9zm0 9.1a1.2 1.2 0 1 0 0 2.4 1.2 1.2 0 0 0 0-2.4z"
    />
  </svg>
);

export default function DangerousActionCard({
  title = 'Confirm action',
  details,

thinking
**Analyzing modal, shadow DOM, and event handling details**

I'm sorting through how confirmation modals should portal into the shadow root per spec, considering how to use `createPortal` for overlays inside shadow DOM. I'll also adjust font usage to system stacks and embed Tailwind CSS scoped within shadow root, carefully handling style isolation to prevent theme leaks. On the event side, I'm tackling how shadow DOM retargeting affects hotkey detection and focus traps, thinking about using `event.composedPath()` and `shadowRoot.activeElement` for accurate targets and focus management inside shadow boundaries. This is quite an intricate setup!
exec
/bin/zsh -lc 'rg -n "getFocusableElements|isEditableTarget" -n react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
338:const isEditableTarget = (target) => {
432:const getFocusableElements = (container) => {
1674:      if (event.defaultPrevented || isEditableTarget(event.target)) {
1720:      const focusable = getFocusableElements(modalRef.current);
exec
/bin/zsh -lc "sed -n '300,460p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
  });

  useEffect(() => {
    if (!window.matchMedia) {
      return undefined;
    }
    const media = window.matchMedia('(prefers-color-scheme: dark)');
    const handleChange = (event) => {
      setPrefersDark(event.matches);
    };
    if (media.addEventListener) {
      media.addEventListener('change', handleChange);
    } else {
      media.addListener(handleChange);
    }
    return () => {
      if (media.removeEventListener) {
        media.removeEventListener('change', handleChange);
      } else {
        media.removeListener(handleChange);

thinking
**Enhancing event target handling and shadow root focus**
exec
/bin/zsh -lc "sed -n '1,120p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
import html2canvas from 'html2canvas';
import ReactMarkdown from 'react-markdown';
import HistoryPanel from '../components/HistoryPanel.jsx';
import { ChartCard, ErrorCard } from '../components/cards';
import {
  applyTheme,
  getInitialThemePreference,
  getServerTheme,
  resolveTheme,
  THEME_STORAGE_KEY,
} from './theme.js';

const OPEN_STATE_KEY = 'agentwp-command-deck-open';
const DRAFT_HISTORY_KEY = 'agentwp-draft-history';
const MAX_DRAFT_HISTORY = 10;
const COMMAND_HISTORY_KEY = 'agentwp-command-history';
const COMMAND_FAVORITES_KEY = 'agentwp-command-favorites';
const COMMAND_USAGE_KEY = 'agentwp-command-usage';
const MAX_COMMAND_HISTORY = 50;

thinking
**Preparing React app for Shadow DOM integration**

I'm mapping out how to add a shadow root and portal root elements for mounting the React app inside a shadow DOM, including safeguards against duplicates. I also need to confirm the root element presence in admin pages, considering WordPress plugin constraints, and rethink CSS to avoid leaking styles outside the shadow boundary by using `:host` and scoped wrappers.
exec
/bin/zsh -lc "rg -n \"return \\(\" -n react/src/App.jsx | head -n 5" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
315:    return () => {
706:      return (
803:    return () => {
837:  return (
948:    return () => {
exec
/bin/zsh -lc "sed -n '800,940p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
  const timerRef = useRef(null);

  useEffect(() => {
    return () => {
      if (timerRef.current) {
        window.clearTimeout(timerRef.current);
      }
    };
  }, []);

  const handleCopy = async () => {
    if (disabled) {
      return;
    }
    const payload = await getPayload();
    if (!payload) {
      return;
    }
    try {
      const success = await copyToClipboard(payload);

thinking
**Investigating top-level render structure**
exec
/bin/zsh -lc 'rg -n "min-h-screen|agentwp" -n react/src/App.jsx | head -n 40' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 62ms:
14:const OPEN_STATE_KEY = 'agentwp-command-deck-open';
15:const DRAFT_HISTORY_KEY = 'agentwp-draft-history';
17:const COMMAND_HISTORY_KEY = 'agentwp-command-history';
18:const COMMAND_FAVORITES_KEY = 'agentwp-command-favorites';
19:const COMMAND_USAGE_KEY = 'agentwp-command-usage';
25:  '#wp-admin-bar-agentwp',
26:  '[data-agentwp-command-deck]',
27:  '#agentwp-command-deck',
29:const REST_PATH = '/agentwp/v1/intent';
30:const SEARCH_PATH = '/agentwp/v1/search';
31:const USAGE_PATH = '/agentwp/v1/usage';
32:const SETTINGS_PATH = '/agentwp/v1/settings';
33:const THEME_PATH = '/agentwp/v1/theme';
34:const HEALTH_PATH = '/agentwp/v1/health';
162:  agentwp_rate_limited: 'Too many requests. Please wait and retry.',
163:  agentwp_invalid_key: 'The OpenAI API key is invalid. Update it in settings.',
164:  agentwp_invalid_request: 'Please check your request and try again.',
165:  agentwp_missing_prompt: 'Please enter a prompt to continue.',
166:  agentwp_forbidden: 'You do not have permission to use AgentWP.',
356:  const root = window.agentwpSettings?.root || window.wpApiSettings?.root;
exec
/bin/zsh -lc "sed -n '2260,2325p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 74ms:
  const budgetFillTone =
    budgetStatus.level === 'limit'
      ? 'bg-rose-400'
      : budgetStatus.level === 'warning'
        ? 'bg-amber-400'
        : 'bg-emerald-400';
  const budgetMessage =
    budgetLimit && budgetStatus.level === 'limit'
      ? 'Monthly budget limit reached. Consider pausing drafts or raising the limit.'
      : budgetLimit && budgetStatus.level === 'warning'
        ? 'Approaching monthly budget limit. Usage is above 80%.'
        : '';
  const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
  const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);

  return (
    <div className="min-h-screen text-slate-100">
      <main
        className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
        aria-hidden={isOpen}

thinking
**Adjusting CSS selectors for theming**

I’m planning to shift CSS from targeting `:root` and `body` to using `:host` and a new container class like `.agentwp-app` to better encapsulate styles and theming. This involves updating backgrounds, text colors, CSS variables, and theme-related selectors for dark/light modes while preserving existing markdown styles and transitions. I want to make sure the theme data attributes and classes are managed properly on the host element for consistent styling.
exec
/bin/zsh -lc "sed -n '160,380p' react/src/index.css" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 66ms:
  --awp-amber-400: 251 191 36;
  --awp-amber-500: 245 158 11;

  --awp-rose-300: 253 164 175;
  --awp-rose-400: 251 113 133;

  --awp-white: 255 255 255;
  --awp-black: 0 0 0;

  --awp-deck-surface: 12 17 28;
  --awp-deck-border: 148 163 184;
  --awp-shadow-deck: 0 30px 80px rgba(15, 23, 42, 0.55);

  --awp-body-bg: #05070c;
  --awp-body-bg-secondary: #0a1120;
  --awp-body-gradient-1: radial-gradient(circle at 12% 18%, rgba(56, 189, 248, 0.12), transparent 45%);
  --awp-body-gradient-2: radial-gradient(circle at 80% 10%, rgba(99, 102, 241, 0.12), transparent 35%);
  --awp-body-gradient-3: radial-gradient(circle at 20% 90%, rgba(14, 116, 144, 0.2), transparent 40%);
  --awp-body-gradient-4: linear-gradient(160deg, #05070c 0%, #0a1120 50%, #05070c 100%);

exec
/bin/zsh -lc "sed -n '380,520p' react/src/index.css" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
    --awp-card-button-border: rgba(226, 232, 240, 0.5);
    --awp-card-ring: rgba(125, 211, 252, 0.8);
    --awp-chart-grid: rgba(226, 232, 240, 0.35);
  }
}

@media (prefers-contrast: more) and (prefers-color-scheme: dark) {
  :root:not([data-theme]) {
    --awp-text-primary: #f8fafc;
    --awp-text-secondary: #e2e8f0;
    --awp-border: rgba(226, 232, 240, 0.6);
    --awp-card-border: rgba(226, 232, 240, 0.45);
    --awp-card-muted: #e2e8f0;
    --awp-card-button-border: rgba(226, 232, 240, 0.5);
    --awp-card-ring: rgba(125, 211, 252, 0.8);
    --awp-chart-grid: rgba(226, 232, 240, 0.35);
  }
}

:root.awp-theme-transition,

thinking
**Updating CSS selectors and theming**
exec
/bin/zsh -lc "sed -n '1,120p' react/vite.config.js" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    host: true,
    port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
    strictPort: true,
  },
});

thinking
**Planning shadow DOM styling and portal integration**

I'm thinking through how to isolate styles inside the shadow root without heavy resets like `all: initial`, since that could break defaults. I'll prioritize setting key properties like `font-family` and `color` on `:host` with careful use of `!important` to handle theme overrides while recognizing some external styles might still leak in. I'll also handle React portals by importing `createPortal` from `react-dom` and conditionally rendering modals into a portal root. Focus management will consider shadow DOM's retargeting, using `document.activeElement` and shadow root active elements to restore focus properly after modal interactions. This should keep styling consistent and modals layered correctly.
exec
/bin/zsh -lc 'rg -n "openModal" -n react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
1394:  const openModal = useCallback(() => {
1681:        openModal();
1687:  }, [closeModal, isOpen, openModal]);
1700:      openModal();
1705:  }, [openModal]);
2303:              onClick={openModal}
exec
/bin/zsh -lc "sed -n '1360,1425p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
    }
    setCommandUsage((prev) => ({
      ...prev,
      [rawInput]: (prev[rawInput] || 0) + 1,
    }));
  }, []);

  const toggleFavoriteCommand = useCallback((entry) => {
    const normalized = normalizeCommandEntry(entry);
    if (!normalized) {
      return;
    }
    setFavoriteCommands((prev) => {
      const key = buildCommandKey(normalized);
      const exists = prev.some((item) => buildCommandKey(item) === key);
      if (exists) {
        return prev.filter((item) => buildCommandKey(item) !== key);
      }
      return [normalized, ...prev].slice(0, MAX_COMMAND_FAVORITES);
    });

thinking
**Analyzing focus behavior with shadow DOM**
exec
/bin/zsh -lc 'rg -n "Confirm|confirmation" -S react' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
react/components/cards/DangerousActionCard.jsx:19:  title = 'Confirm action',


thinking
**Planning Shadow DOM integration and CSS updates**

I'm working through detailed steps to mount the React app inside a shadow root attached to `#agentwp-root`, injecting scoped Tailwind CSS, updating theme application to target the shadow host, and refactoring CSS selectors from `:root` and `body` to `:host` and scoped classes to ensure styles apply correctly within the shadow DOM environment. This involves careful updates to `main.jsx`, `App.jsx`, `theme.js`, `index.css`, `tailwind.config.js`, and `index.html` to handle theming, portals, focus management, and host element styling consistently, while ensuring fallbacks and dev compatibility.
thinking
**Refining CSS and main.jsx shadow root setup**

I'm defining `.agentwp-app` styles to replace body styling inside the shadow DOM, setting up the shadow root container with style injection and portal wrappers in `main.jsx`, and preparing to update the App component to use these new props for theme targeting and modals. This includes careful handling of theming, focus, and event delegation to work smoothly within the shadow DOM environment.
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/main.jsx
@@ -4,15 +4,57 @@
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    style.textContent = styles;
+    return style;
+  });
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
apply_patch(auto_approved=true) exited 0 in 33ms:
Success. Updated the following files:
M react/src/main.jsx
file update:
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..f02c758fb83ac5a9c8506d3e736ca408ea8913cf
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    style.textContent = styles;
+    return style;
+  });
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}

file update:
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..f02c758fb83ac5a9c8506d3e736ca408ea8913cf
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    style.textContent = styles;
+    return style;
+  });
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}


thinking
**Adjusting style update for hot reload**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/main.jsx
@@ -26,8 +26,8 @@
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
-  ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
     style.setAttribute('data-agentwp-shadow', 'true');
-    style.textContent = styles;
     return style;
   });
+  styleNode.textContent = styles;
   const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
apply_patch(auto_approved=true) exited 0 in 44ms:
Success. Updated the following files:
M react/src/main.jsx
file update:
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}

file update:
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}


thinking
**Updating theme.js to accept target**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/theme.js
@@ -52,7 +52,8 @@
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
apply_patch(auto_approved=true) exited 0 in 40ms:
Success. Updated the following files:
M react/src/theme.js
file update:
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating App.jsx with portal and focus helpers**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1,2 +1,3 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
apply_patch(auto_approved=true) exited 0 in 41ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..95b9b1e008681163ac40a42831154e7075bfbfcb
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..95b9b1e008681163ac40a42831154e7075bfbfcb
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Adding helper functions near isEditableTarget**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -352,2 +352,25 @@
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
apply_patch(auto_approved=true) exited 0 in 62ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..671d4c2f1177f5c9a8bbed9dfef504e9c97126dd
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..671d4c2f1177f5c9a8bbed9dfef504e9c97126dd
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating App component and theme root**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -876,3 +876,3 @@
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
@@ -927,2 +927,6 @@
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
apply_patch(auto_approved=true) exited 0 in 63ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..0b41e0b70eb9f3cc7e8d169af2f5aeec30ac3ae0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..0b41e0b70eb9f3cc7e8d169af2f5aeec30ac3ae0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating useLayoutEffect to use themeRoot**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -960,8 +960,7 @@
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
@@ -970,6 +969,6 @@
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
@@ -980,3 +979,3 @@
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
apply_patch(auto_approved=true) exited 0 in 49ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..8a73bf8c86437e2d179df155b46d0a48471b4271
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..8a73bf8c86437e2d179df155b46d0a48471b4271
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating openModal with getActiveElement**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1421,7 +1421,8 @@
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
apply_patch(auto_approved=true) exited 0 in 66ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..f719990b12b7b8baf865df08a0617b0d9888a1c8
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..f719990b12b7b8baf865df08a0617b0d9888a1c8
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating hotkey handler with composed target**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1701,3 +1701,4 @@
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
apply_patch(auto_approved=true) exited 0 in 64ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..497ac1dcd09bc49482faa67cdba1acccf5a01059
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..497ac1dcd09bc49482faa67cdba1acccf5a01059
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating focus trap to use getActiveElement**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1754,4 +1754,4 @@
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
apply_patch(auto_approved=true) exited 0 in 64ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..9311041f3261b8d1c75e9282b00ac6c1859c419c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..9311041f3261b8d1c75e9282b00ac6c1859c419c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating useEffect dependencies**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1777,3 +1777,3 @@
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
apply_patch(auto_approved=true) exited 0 in 62ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..22b1d40b52cd8ee04e9890723e0f02a7a79a05d2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..22b1d40b52cd8ee04e9890723e0f02a7a79a05d2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Refactoring modal rendering with portal**

I'm reorganizing the modal rendering by extracting the modal JSX into a separate variable `modalMarkup` and then conditionally wrapping it with a portal if `portalRoot` exists. This means removing the inline `{isOpen && (...)}` from the return and replacing it with `{modalPortal}`, adding a dedicated CSS class to the main container, and placing the new variables just before the return statement around line 2270. I'll carefully apply this patch to keep the component structure clean and support portal usage.
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2302,2 +2302,157 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
apply_patch(auto_approved=true) exited 0 in 64ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Verifying modal markup integration**
exec
/bin/zsh -lc "sed -n '2240,2520p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 73ms:
  );
  const comparisonChartOptions = useMemo(
    () => ({
      plugins: {
        legend: {
          position: 'bottom',
        },
      },
      scales: {
        x: {
          grid: {
            display: false,
          },
        },
      },
    }),
    []
  );
  const categoryChartOptions = useMemo(
    () => ({
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Analyzing modal markup insertion issues**
exec
/bin/zsh -lc "sed -n '2520,2900p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
                </p>
              </div>
              <button
                type="button"
                onClick={handleExportChart}
                disabled={exportStatus === 'exporting'}
                className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
                  exportStatus === 'exporting'
                    ? 'cursor-not-allowed border-slate-700/60 bg-slate-900/50 text-slate-500'
                    : 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
                } ${exportStatus === 'exported' ? 'copy-feedback border-emerald-400/70 bg-emerald-500/20 text-emerald-100' : ''}`}
              >
                {exportLabel}
              </button>
            </div>

            <div
              ref={chartRef}
              className="mt-6 rounded-2xl border border-slate-800/80 bg-slate-950/50 p-5"
            >
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Planning modal markup restructuring**
exec
/bin/zsh -lc 'rg -n "const modalMarkup" -n react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 73ms:
2303:  const modalMarkup = isOpen ? (
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Identifying block to remove**
exec
/bin/zsh -lc "rg -n \"return \\(\" -n react/src/App.jsx | sed -n '6,12p'" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 73ms:
1007:    return () => {
1188:    return () => {
1527:    return () => {
1662:    return () => {
1674:    return () => window.clearTimeout(focusTimer);
1715:    return () => window.removeEventListener('keydown', handleHotkey);
1733:    return () => document.removeEventListener('click', handleAdminTrigger);
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Investigating multiple return statements**
exec
/bin/zsh -lc "rg -n \"return \\(\" react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 74ms:
316:    return () => {
730:      return (
827:    return () => {
861:  return (
975:    return () => {
1007:    return () => {
1188:    return () => {
1527:    return () => {
1662:    return () => {
1674:    return () => window.clearTimeout(focusTimer);
1715:    return () => window.removeEventListener('keydown', handleHotkey);
1733:    return () => document.removeEventListener('click', handleAdminTrigger);
1777:    return () => document.removeEventListener('keydown', handleKeydown);
1781:    return () => {
1787:    return () => {
1799:    return () => {
2410:                    return (
2418:                            return (
2459:  return (
2687:                        return (
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Reworking modal rendering logic**
exec
/bin/zsh -lc "sed -n '2295,2465p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 34ms:
  const budgetMessage =
    budgetLimit && budgetStatus.level === 'limit'
      ? 'Monthly budget limit reached. Consider pausing drafts or raising the limit.'
      : budgetLimit && budgetStatus.level === 'warning'
        ? 'Approaching monthly budget limit. Usage is above 80%.'
        : '';
  const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
  const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
  const modalMarkup = isOpen ? (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
      role="presentation"
      onMouseDown={(event) => {
        if (event.target === event.currentTarget) {
          closeModal();
        }
      }}
    >
      <div
        ref={modalRef}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..405d9696abc53d444867aa8181a0bd9f669d81b7
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2271,6 +2300,161 @@
         : '';
   const budgetMessageTone = budgetStatus.level === 'limit' ? 'text-rose-200' : 'text-amber-200';
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
+  const modalMarkup = isOpen ? (
+    <div
+      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+      role="presentation"
+      onMouseDown={(event) => {
+        if (event.target === event.currentTarget) {
+          closeModal();
+        }
+      }}
+    >
+      <div
+        ref={modalRef}
+        role="dialog"
+        aria-modal="true"
+        aria-labelledby="agentwp-command-deck-title"
+        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+      >
+        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+          <div>
+            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+              AgentWP
+            </p>
+            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+              Command Deck
+            </h2>
+          </div>
+          <div className="flex items-center gap-2">
+            <button
+              type="button"
+              onClick={toggleTheme}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label={themeToggleLabel}
+              aria-pressed={isDarkTheme}
+              title={themeToggleLabel}
+            >
+              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+            </button>
+            <button
+              type="button"
+              onClick={closeModal}
+              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+              aria-label="Close Command Deck"
+            >
+              <span aria-hidden="true">&times;</span>
+            </button>
+          </div>
+        </div>
+
+        <div className="space-y-4 px-6 py-5">
+          {isOffline && (
+            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                {OFFLINE_BANNER_TEXT}
+              </div>
+              <p className="mt-1 text-xs text-amber-200/80">
+                AgentWP will reconnect automatically. Cached results are available below.
+              </p>
+            </div>
+          )}
+          <form onSubmit={handleSubmit}>
+            <label htmlFor="agentwp-prompt" className="sr-only">
+              Ask AgentWP anything
+            </label>
+            <div className="relative">
+              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                <input
+                  id="agentwp-prompt"
+                  ref={inputRef}
+                  type="text"
+                  value={prompt}
+                  onChange={handlePromptChange}
+                  onKeyDown={handlePromptKeyDown}
+                  onFocus={handlePromptFocus}
+                  onBlur={handlePromptBlur}
+                  aria-expanded={showTypeahead}
+                  aria-controls="agentwp-typeahead"
+                  aria-activedescendant={activeSuggestionId}
+                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                  disabled={isOffline}
+                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                />
+                <button
+                  type="submit"
+                  disabled={loading || isOffline || !prompt.trim()}
+                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                >
+                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                </button>
+              </div>
+
+              {showTypeahead && (
+                <div
+                  id="agentwp-typeahead"
+                  role="listbox"
+                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                >
+                  {isTypeaheadLoading && (
+                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                      Searching...
+                    </div>
+                  )}
+                  {suggestionGroups.map(({ type, items }) => {
+                    if (!items.length) {
+                      return null;
+                    }
+                    const config = TYPEAHEAD_CONFIG[type];
+                    return (
+                      <div key={type} className="pb-3 last:pb-0">
+                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          <span className="text-slate-400">{config?.label || type}</span>
+                        </div>
+                        <div className="mt-2 space-y-1">
+                          {items.map((item) => {
+                            const isActive = item._index === activeSuggestionIndex;
+                            return (
+                              <button
+                                key={`${item.type}-${item.id}-${item._index}`}
+                                id={`agentwp-suggestion-${item._index}`}
+                                type="button"
+                                role="option"
+                                aria-selected={isActive}
+                                onMouseDown={(event) => event.preventDefault()}
+                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                onClick={() => handleSuggestionSelect(item)}
+                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                  isActive
+                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                }`}
+                              >
+                                <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                <span className="flex-1">
+                                  <span className="block text-sm font-semibold text-slate-100">
+                                    {renderHighlightedText(item.primary || '', prompt)}
+                                  </span>
+                                  {item.secondary ? (
+                                    <span className="block text-xs text-slate-400">
+                                      {renderHighlightedText(item.secondary, prompt)}
+                                    </span>
+                                  ) : null}
+                                </span>
+                              </button>
+                            );
+                          })}
+                        </div>
+                      </div>
+                    );
+                  })}
+                </div>
+              )}
+            </div>
+          </form>
+
+          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
   return (
     <div className="min-h-screen text-slate-100">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Refactoring modal rendering**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2302,157 +2302,2 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
-  const modalMarkup = isOpen ? (
-    <div
-      className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-      role="presentation"
-      onMouseDown={(event) => {
-        if (event.target === event.currentTarget) {
-          closeModal();
-        }
-      }}
-    >
-      <div
-        ref={modalRef}
-        role="dialog"
-        aria-modal="true"
-        aria-labelledby="agentwp-command-deck-title"
-        className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-      >
-        <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-          <div>
-            <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-              AgentWP
-            </p>
-            <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-              Command Deck
-            </h2>
-          </div>
-          <div className="flex items-center gap-2">
-            <button
-              type="button"
-              onClick={toggleTheme}
-              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-              aria-label={themeToggleLabel}
-              aria-pressed={isDarkTheme}
-              title={themeToggleLabel}
-            >
-              {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-            </button>
-            <button
-              type="button"
-              onClick={closeModal}
-              className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-              aria-label="Close Command Deck"
-            >
-              <span aria-hidden="true">&times;</span>
-            </button>
-          </div>
-        </div>
-
-        <div className="space-y-4 px-6 py-5">
-          {isOffline && (
-            <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-              <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                {OFFLINE_BANNER_TEXT}
-              </div>
-              <p className="mt-1 text-xs text-amber-200/80">
-                AgentWP will reconnect automatically. Cached results are available below.
-              </p>
-            </div>
-          )}
-          <form onSubmit={handleSubmit}>
-            <label htmlFor="agentwp-prompt" className="sr-only">
-              Ask AgentWP anything
-            </label>
-            <div className="relative">
-              <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                <input
-                  id="agentwp-prompt"
-                  ref={inputRef}
-                  type="text"
-                  value={prompt}
-                  onChange={handlePromptChange}
-                  onKeyDown={handlePromptKeyDown}
-                  onFocus={handlePromptFocus}
-                  onBlur={handlePromptBlur}
-                  aria-expanded={showTypeahead}
-                  aria-controls="agentwp-typeahead"
-                  aria-activedescendant={activeSuggestionId}
-                  placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                  disabled={isOffline}
-                  className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                />
-                <button
-                  type="submit"
-                  disabled={loading || isOffline || !prompt.trim()}
-                  className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                >
-                  {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
-                </button>
-              </div>
-
-              {showTypeahead && (
-                <div
-                  id="agentwp-typeahead"
-                  role="listbox"
-                  className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
-                >
-                  {isTypeaheadLoading && (
-                    <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                      Searching...
-                    </div>
-                  )}
-                  {suggestionGroups.map(({ type, items }) => {
-                    if (!items.length) {
-                      return null;
-                    }
-                    const config = TYPEAHEAD_CONFIG[type];
-                    return (
-                      <div key={type} className="pb-3 last:pb-0">
-                        <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                          <span className="text-slate-400">{config?.label || type}</span>
-                        </div>
-                        <div className="mt-2 space-y-1">
-                          {items.map((item) => {
-                            const isActive = item._index === activeSuggestionIndex;
-                            return (
-                              <button
-                                key={`${item.type}-${item.id}-${item._index}`}
-                                id={`agentwp-suggestion-${item._index}`}
-                                type="button"
-                                role="option"
-                                aria-selected={isActive}
-                                onMouseDown={(event) => event.preventDefault()}
-                                onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                onClick={() => handleSuggestionSelect(item)}
-                                className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                  isActive
-                                    ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                    : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                }`}
-                              >
-                                <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                <span className="flex-1">
-                                  <span className="block text-sm font-semibold text-slate-100">
-                                    {renderHighlightedText(item.primary || '', prompt)}
-                                  </span>
-                                  {item.secondary ? (
-                                    <span className="block text-xs text-slate-400">
-                                      {renderHighlightedText(item.secondary, prompt)}
-                                    </span>
-                                  ) : null}
-                                </span>
-                              </button>
-                            );
-                          })}
-                        </div>
-                      </div>
-                    );
-                  })}
-                </div>
-              )}
-            </div>
-          </form>
-
-          <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
 
apply_patch(auto_approved=true) exited 0 in 32ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..22b1d40b52cd8ee04e9890723e0f02a7a79a05d2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..22b1d40b52cd8ee04e9890723e0f02a7a79a05d2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Modifying top-level component and portal usage**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2304,3 +2304,3 @@
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
apply_patch(auto_approved=true) exited 0 in 55ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Reworking modal rendering logic**
exec
/bin/zsh -lc "sed -n '2740,2860p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
                    })}
                  />
                  <ClipboardButton
                    label="Copy Markdown"
                    disabled={!hasDraft}
                    getPayload={() => ({ text: response })}
                  />
                  <a
                    href={mailtoHref}
                    onClick={(event) => {
                      if (!hasDraft) {
                        event.preventDefault();
                      }
                    }}
                    aria-disabled={!hasDraft}
                    tabIndex={hasDraft ? 0 : -1}
                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
                      hasDraft
                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Searching for closing main tag**
exec
/bin/zsh -lc "sed -n '2860,3060p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
                  Draft history (last 10)
                </summary>
                <div className="mt-3 space-y-2">
                  {draftHistory.length ? (
                    draftHistory.map((draft) => {
                      const title = draft.subject || draft.prompt || 'Untitled draft';
                      const timestamp = draft.createdAt
                        ? new Date(draft.createdAt).toLocaleString()
                        : '';
                      return (
                        <button
                          key={draft.id}
                          type="button"
                          onClick={() => handleRestoreDraft(draft)}
                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
                        >
                          <span className="font-semibold">{title}</span>
                          <span className="text-xs text-slate-500">{timestamp}</span>
                        </button>
                      );
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Preparing patch to wrap modal in portal**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2424,144 +2424,240 @@
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
+                    <button
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
+                    >
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
 
-                  {showTypeahead && (
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
-                                      </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
                                     </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
+                                      </span>
+                                    ) : null}
                                   </button>
@@ -2570,97 +2666,223 @@
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
@@ -2668,97 +2890,113 @@
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
-                    </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
+                  </details>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
+                    </div>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
@@ -2766,176 +3004,473 @@
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
@@ -2944,3 +3479,3 @@
         </div>
-      )}
+        ))}
     </div>
apply_patch(auto_approved=true) exited 0 in 51ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };



thinking
**Refactoring modal markup duplication**
thinking
**Evaluating approach to reduce modal markup duplication**

I'm weighing options to remove the duplicated modal markup: either extract it into a variable or component, or simplify the return block to keep only the portal branch assuming `portalRoot` always exists. Removing the fallback branch seems like the cleanest way to reduce duplication with minimal risk, since `portalRoot` should be present when rendering, so I’m leaning towards that.
exec
/bin/zsh -lc 'rg -n "portalRoot" -n react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 79ms:
877:export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
2426:        (portalRoot ? (
2955:            portalRoot
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Examining portalRoot usage**
exec
/bin/zsh -lc "sed -n '2410,2445p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
                  <p className="text-xs text-slate-400">Drafts sent</p>
                  <p className="text-lg font-semibold text-white">42</p>
                  <p className="text-xs text-sky-300">Avg. 3.2 hrs response</p>
                </div>
                <div className="rounded-xl border border-slate-800/80 bg-slate-950/40 px-3 py-3">
                  <p className="text-xs text-slate-400">Refund rate</p>
                  <p className="text-lg font-semibold text-white">1.4%</p>
                  <p className="text-xs text-amber-300">-0.3% from last week</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      {isOpen &&
        (portalRoot ? (
          createPortal(
            <div
              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Preparing portal rendering update**
exec
/bin/zsh -lc "sed -n '2945,2985p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 74ms:
                    <span>
                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
                    </span>
                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>,
            portalRoot
          )
        ) : (
          <div
            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
            role="presentation"
            onMouseDown={(event) => {
              if (event.target === event.currentTarget) {
                closeModal();
              }
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Planning removal of fallback markup**
exec
/bin/zsh -lc 'tail -n 20 react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 77ms:
                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
                      ) : null}
                    </div>
                  ) : null}
                </div>

                <div className="flex items-center justify-between text-xs text-slate-400">
                  <span>
                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
                  </span>
                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        ))}
    </div>
  );
}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Preparing to refactor fallback branch removal**

I’m planning a cautious approach to remove a complex fallback branch in a React component by using a Python script with a regex to replace the entire conditional fallback block with a simpler expression. Since the block is large and tricky to patch manually, I’ll carefully identify the portal creation part and replace the fallback with null, making sure to handle indentation and avoid unintended matches.
exec
/bin/zsh -lc "python - <<'PY'
from pathlib import Path
import re
path = Path('react/src/App.jsx')
text = path.read_text()
pattern = re.compile(
    r\"\\{isOpen &&\\s+\\(portalRoot \\? \\(\\s+createPortal\\((?P<content>[\\s\\S]*?)\\),\\s+portalRoot\\s+\\)\\s+\\) : \\([\\s\\S]*?\\n\\s+\\)\\)\\}\\)\\}\\}\",
    re.M,
)
match = pattern.search(text)
if not match:
    raise SystemExit('Pattern not found')
content = match.group('content')
replacement = '{isOpen && portalRoot ? createPortal(' + content + ',\\n            portalRoot\\n          ) : null}'
text = text[:match.start()] + replacement + text[match.end():]
path.write_text(text)
PY" in /Users/ahmedyounis/Documents/Projects/agentwp exited 127 in 72ms:
zsh:1: command not found: python
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Switching to python3 command**
exec
/bin/zsh -lc "python3 - <<'PY'
from pathlib import Path
import re
path = Path('react/src/App.jsx')
text = path.read_text()
pattern = re.compile(
    r\"\\{isOpen &&\\s+\\(portalRoot \\? \\(\\s+createPortal\\((?P<content>[\\s\\S]*?)\\),\\s+portalRoot\\s+\\)\\s+\\) : \\([\\s\\S]*?\\n\\s+\\)\\)\\}\\)\\}\\}\",
    re.M,
)
match = pattern.search(text)
if not match:
    raise SystemExit('Pattern not found')
content = match.group('content')
replacement = '{isOpen && portalRoot ? createPortal(' + content + ',\\n            portalRoot\\n          ) : null}'
text = text[:match.start()] + replacement + text[match.end():]
path.write_text(text)
PY" in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 89ms:
Pattern not found
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Planning manual patch application**
exec
/bin/zsh -lc "rg -n \"\\) : \\(\" react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
2667:                          ) : (
2693:                      ) : (
2885:                      ) : (
2957:        ) : (
3197:                        ) : (
3221:                    ) : (
3413:                    ) : (
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Determining line range for removal**
exec
/bin/zsh -lc "rg -n \"\\)\\)\\}\" react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
510:  return `${trimmed.slice(0, Math.max(1, limit - 3))}...`;
2401:                ))}
2798:                          ))}
3326:                        ))}
3480:        ))}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Planning precise deletion by line numbers**
exec
/bin/zsh -lc "nl -ba react/src/App.jsx | sed -n '2935,3505p'" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
  2935	                          />
  2936	                        </div>
  2937	                        {budgetMessage ? (
  2938	                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
  2939	                        ) : null}
  2940	                      </div>
  2941	                    ) : null}
  2942	                  </div>
  2943	
  2944	                  <div className="flex items-center justify-between text-xs text-slate-400">
  2945	                    <span>
  2946	                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
  2947	                    </span>
  2948	                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
  2949	                  </div>
  2950	                </div>
  2951	              </div>
  2952	            </div>
  2953	          </div>
  2954	        </div>,
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a86a1e12fd846099b06b576819b34860fdd095a0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,1062 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen &&
+        (portalRoot ? (
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
                     </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
+                    </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+                          ) : (
+                            <p className="text-xs text-amber-200/80">
+                              No cached responses yet. Try again when you are back online.
+                            </p>
+                          )}
+                        </div>
+                      ) : errorState ? (
+                        <ErrorCard
+                          title="We hit a snag"
+                          message={errorMessage}
+                          retryLabel={retryLabel}
+                          onRetry={errorState.retryable ? handleRetry : undefined}
+                          onReport={handleReportIssue}
+                        />
+                      ) : response ? (
+                        <div ref={responseHtmlRef} className="agentwp-markdown">
+                          <ReactMarkdown
+                            components={{
+                              a: ({ ...props }) => (
+                                <a {...props} target="_blank" rel="noreferrer" />
+                              ),
+                            }}
+                          >
+                            {response}
+                          </ReactMarkdown>
+                        </div>
+                      ) : (
+                        <div className="space-y-2 text-sm text-slate-400">
+                          <p>Describe a task and AgentWP will coordinate the next action.</p>
+                          <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                        </div>
+                      )}
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Draft actions
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Copy the latest draft or open it in your email client.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-draft-subject"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Email subject
+                        </label>
+                        <input
+                          id="agentwp-draft-subject"
+                          type="text"
+                          value={draftSubject}
+                          onChange={(event) => setDraftSubject(event.target.value)}
+                          disabled={!hasDraft}
+                          placeholder="Subject line"
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                      </div>
+                    </div>
+                    <div className="mt-4 flex flex-wrap gap-2">
+                      <ClipboardButton
+                        label="Copy plain text"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: resolvedBody })}
+                      />
+                      <ClipboardButton
+                        label="Copy HTML"
+                        disabled={!hasDraft}
+                        getPayload={() => ({
+                          text: resolvedBody,
+                          html:
+                            responseHtmlRef.current?.innerHTML ||
+                            formatPlainTextAsHtml(resolvedBody),
+                        })}
+                      />
+                      <ClipboardButton
+                        label="Copy Markdown"
+                        disabled={!hasDraft}
+                        getPayload={() => ({ text: response })}
+                      />
+                      <a
+                        href={mailtoHref}
+                        onClick={(event) => {
+                          if (!hasDraft) {
+                            event.preventDefault();
+                          }
+                        }}
+                        aria-disabled={!hasDraft}
+                        tabIndex={hasDraft ? 0 : -1}
+                        className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                          hasDraft
+                            ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                            : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
                         }`}
                       >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
+                        Open in Mail
+                      </a>
+                    </div>
                   </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    <div className="flex flex-wrap items-center justify-between gap-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Analytics charts
+                        </p>
+                        <p className="text-sm text-slate-300">
+                          Visualize revenue trends and period performance inside the Command Deck.
+                        </p>
+                      </div>
+                      <div className="min-w-[200px]">
+                        <label
+                          htmlFor="agentwp-analytics-period"
+                          className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                        >
+                          Period
+                        </label>
+                        <select
+                          id="agentwp-analytics-period"
+                          value={selectedPeriod}
+                          onChange={(event) => setSelectedPeriod(event.target.value)}
+                          className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                        >
+                          {PERIOD_OPTIONS.map((option) => (
+                            <option key={option.value} value={option.value}>
+                              {option.label}
+                            </option>
+                          ))}
+                        </select>
+                      </div>
                     </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
+                    </div>
+                  </div>
+
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
-                </div>
-              </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                   </div>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+              </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
+                </div>
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
                   >
-                    Open in Mail
-                  </a>
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
+                  >
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
+                    </div>
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Planning line-based code edit**
exec
/bin/zsh -lc "python3 - <<'PY'
from pathlib import Path
path = Path('react/src/App.jsx')
lines = path.read_text().splitlines()
start = None
for i, line in enumerate(lines):
    if '{isOpen &&' in line and 'portalRoot' in lines[i + 1]:
        start = i
        break
if start is None:
    raise SystemExit('start not found')
lines[start] = '      {isOpen && portalRoot ?'
if '(portalRoot ?' in lines[start + 1]:
    del lines[start + 1]
# find the line with ') : (' after start
colon_idx = None
for i in range(start, len(lines)):
    if ') : (' in lines[i]:
        colon_idx = i
        break
if colon_idx is None:
    raise SystemExit('colon not found')
lines[colon_idx] = '        : null}'
# remove fallback block lines after colon_idx until closing '))}'
end_idx = None
for i in range(colon_idx + 1, len(lines)):
    if lines[i].strip() == '))}':
        end_idx = i
        break
if end_idx is None:
    raise SystemExit('end not found')
# delete lines from colon_idx+1 to end_idx inclusive
for _ in range(end_idx - colon_idx):
    del lines[colon_idx + 1]
path.write_text('\\n'.join(lines) + '\\n')
PY" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 80ms:

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Confirming script success**
exec
/bin/zsh -lc "sed -n '2415,2465p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
                  <p className="text-xs text-slate-400">Refund rate</p>
                  <p className="text-lg font-semibold text-white">1.4%</p>
                  <p className="text-xs text-amber-300">-0.3% from last week</p>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      {isOpen && portalRoot ?
          createPortal(
            <div
              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
              role="presentation"
              onMouseDown={(event) => {
                if (event.target === event.currentTarget) {
                  closeModal();
                }
              }}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking conditional portal rendering**
exec
/bin/zsh -lc "sed -n '2935,2975p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
                                <span className="text-slate-400">{config?.label || type}</span>
                              </div>
                              <div className="mt-2 space-y-1">
                                {items.map((item) => {
                                  const isActive = item._index === activeSuggestionIndex;
                                  return (
                                    <button
                                      key={`${item.type}-${item.id}-${item._index}`}
                                      id={`agentwp-suggestion-${item._index}`}
                                      type="button"
                                      role="option"
                                      aria-selected={isActive}
                                      onMouseDown={(event) => event.preventDefault()}
                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
                                      onClick={() => handleSuggestionSelect(item)}
                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
                                        isActive
                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
                                      }`}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Verifying block ending syntax**
exec
/bin/zsh -lc "rg -n \"portalRoot\\s*\\)\\s*\\)\" -n react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 81ms:

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Searching for closing portalRoot**
exec
/bin/zsh -lc 'rg -n "portalRoot" -n react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 81ms:
877:export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
2425:      {isOpen && portalRoot ?
2823:            portalRoot
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking createPortal usage boundary**
exec
/bin/zsh -lc "sed -n '2810,2840p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
                  </div>

                  <div className="flex items-center justify-between text-xs text-slate-400">
                    <span>
                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
                    </span>
                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>,
            portalRoot
          )
        ) : (
          <div
            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
            role="presentation"
            onMouseDown={(event) => {
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Analyzing fallback removal issue**
exec
/bin/zsh -lc "rg -n \": null\\}\" react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 36ms:
2566:                                          ) : null}
2608:                        ) : null}
2661:                                    ) : null}
2666:        : null}
2807:                        ) : null}
2809:                    ) : null}
2965:                                        ) : null}
3007:                      ) : null}
3060:                                  ) : null}
3333:                      ) : null}
3335:                  ) : null}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking code around line 2660**
exec
/bin/zsh -lc "sed -n '2645,2680p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
                                  160
                                );
                                return (
                                  <button
                                    key={draft.id}
                                    type="button"
                                    onClick={() => handleRestoreDraft(draft)}
                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                  >
                                    <span className="text-sm font-semibold text-amber-50">
                                      {title}
                                    </span>
                                    {snippet ? (
                                      <span className="mt-1 text-xs text-amber-200/80">
                                        {snippet}
                                      </span>
                                    ) : null}
                                  </button>
                                );
                              })}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Correcting incorrect markup insertion**
exec
/bin/zsh -lc "sed -n '2590,2705p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
                            aria-pressed={isLastCommandFavorited}
                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
                              isLastCommandFavorited
                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
                            }`}
                          >
                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
                              <path
                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
                                stroke="currentColor"
                                strokeWidth="1.6"
                                strokeLinejoin="round"
                              />
                            </svg>
                            {isLastCommandFavorited ? 'Starred' : 'Star'}
                          </button>
                        ) : null}
                      </div>
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Analyzing broken conditional block in modal markup**

I'm unraveling how a malformed `: null}` replaced the proper conditional fallback in the offlineDrafts section inside the modal. It looks like a script removal went too far, deleting the fallback branch and scrambling the markup order. I’m thinking the best move is to reconstruct this conditional accurately by restoring the missing fallback paragraph from an earlier known-good snippet or from version control if available. This should fix the misordered JSX structure and bring back the lost UI fallback for no cached responses.
exec
/bin/zsh -lc 'git status -sb' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 96ms:
## main...origin/main
 M .t2/state.json
 M react/src/App.jsx
 M react/src/main.jsx
 M react/src/theme.js
?? .logs/M04-05.gitcommit.txt
?? .plans/M04-06.md
?? .t2/handoff/M04-06.md
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Evaluating safe restoration methods for App.jsx**
exec
/bin/zsh -lc "git show HEAD:react/src/App.jsx | sed -n '2240,3060p'" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
  const totalRevenue = useMemo(
    () => periodData.current.reduce((sum, value) => sum + value, 0),
    [periodData]
  );
  const previousRevenue = useMemo(
    () => periodData.previous.reduce((sum, value) => sum + value, 0),
    [periodData]
  );
  const revenueDelta = previousRevenue
    ? (totalRevenue - previousRevenue) / previousRevenue
    : 0;
  const trendLabel = `${revenueDelta >= 0 ? '+' : ''}${(revenueDelta * 100).toFixed(1)}% vs last period`;
  const chartBars = [72, 98, 84, 124, 96, 112, 78];
  const chartLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const usageTone =
    budgetStatus.level === 'limit'
      ? 'border-rose-500/70 bg-rose-500/10'
      : budgetStatus.level === 'warning'
        ? 'border-amber-400/70 bg-amber-400/10'
        : 'border-slate-800/80 bg-slate-950/40';
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Rebuilding modal return block**
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..e8cb9d71da44d2a02e7992394c31b90d034090e2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,527 +2422,930 @@
         </section>
       </main>
 
-      {isOpen && (
-        <div
-          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
-          role="presentation"
-          onMouseDown={(event) => {
-            if (event.target === event.currentTarget) {
-              closeModal();
-            }
-          }}
-        >
-          <div
-            ref={modalRef}
-            role="dialog"
-            aria-modal="true"
-            aria-labelledby="agentwp-command-deck-title"
-            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
-          >
-            <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
-              <div>
-                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
-                  AgentWP
-                </p>
-                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
-                  Command Deck
-                </h2>
-              </div>
-              <div className="flex items-center gap-2">
-                <button
-                  type="button"
-                  onClick={toggleTheme}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label={themeToggleLabel}
-                  aria-pressed={isDarkTheme}
-                  title={themeToggleLabel}
-                >
-                  {isDarkTheme ? <SunIcon /> : <MoonIcon />}
-                </button>
-                <button
-                  type="button"
-                  onClick={closeModal}
-                  className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                  aria-label="Close Command Deck"
-                >
-                  <span aria-hidden="true">&times;</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="space-y-4 px-6 py-5">
-              {isOffline && (
-                <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
-                  <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
-                    <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
-                    {OFFLINE_BANNER_TEXT}
+      {isOpen && portalRoot ?
+          createPortal(
+            <div
+              className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+              role="presentation"
+              onMouseDown={(event) => {
+                if (event.target === event.currentTarget) {
+                  closeModal();
+                }
+              }}
+            >
+              <div
+                ref={modalRef}
+                role="dialog"
+                aria-modal="true"
+                aria-labelledby="agentwp-command-deck-title"
+                className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+              >
+                <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                  <div>
+                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                      AgentWP
+                    </p>
+                    <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                      Command Deck
+                    </h2>
                   </div>
-                  <p className="mt-1 text-xs text-amber-200/80">
-                    AgentWP will reconnect automatically. Cached results are available below.
-                  </p>
-                </div>
-              )}
-              <form onSubmit={handleSubmit}>
-                <label htmlFor="agentwp-prompt" className="sr-only">
-                  Ask AgentWP anything
-                </label>
-                <div className="relative">
-                  <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
-                    <input
-                      id="agentwp-prompt"
-                      ref={inputRef}
-                      type="text"
-                      value={prompt}
-                      onChange={handlePromptChange}
-                      onKeyDown={handlePromptKeyDown}
-                      onFocus={handlePromptFocus}
-                      onBlur={handlePromptBlur}
-                      aria-expanded={showTypeahead}
-                      aria-controls="agentwp-typeahead"
-                      aria-activedescendant={activeSuggestionId}
-                      placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
-                      disabled={isOffline}
-                      className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
-                    />
+                  <div className="flex items-center gap-2">
                     <button
-                      type="submit"
-                      disabled={loading || isOffline || !prompt.trim()}
-                      className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      type="button"
+                      onClick={toggleTheme}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label={themeToggleLabel}
+                      aria-pressed={isDarkTheme}
+                      title={themeToggleLabel}
                     >
-                      {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                    </button>
+                    <button
+                      type="button"
+                      onClick={closeModal}
+                      className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      aria-label="Close Command Deck"
+                    >
+                      <span aria-hidden="true">&times;</span>
                     </button>
                   </div>
+                </div>
+
+                <div className="space-y-4 px-6 py-5">
+                  {isOffline && (
+                    <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                        <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                        {OFFLINE_BANNER_TEXT}
+                      </div>
+                      <p className="mt-1 text-xs text-amber-200/80">
+                        AgentWP will reconnect automatically. Cached results are available below.
+                      </p>
+                    </div>
+                  )}
+                  <form onSubmit={handleSubmit}>
+                    <label htmlFor="agentwp-prompt" className="sr-only">
+                      Ask AgentWP anything
+                    </label>
+                    <div className="relative">
+                      <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                        <input
+                          id="agentwp-prompt"
+                          ref={inputRef}
+                          type="text"
+                          value={prompt}
+                          onChange={handlePromptChange}
+                          onKeyDown={handlePromptKeyDown}
+                          onFocus={handlePromptFocus}
+                          onBlur={handlePromptBlur}
+                          aria-expanded={showTypeahead}
+                          aria-controls="agentwp-typeahead"
+                          aria-activedescendant={activeSuggestionId}
+                          placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                          disabled={isOffline}
+                          className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                        />
+                        <button
+                          type="submit"
+                          disabled={loading || isOffline || !prompt.trim()}
+                          className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                        >
+                          {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                        </button>
+                      </div>
+
+                      {showTypeahead && (
+                        <div
+                          id="agentwp-typeahead"
+                          role="listbox"
+                          className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                        >
+                          {isTypeaheadLoading && (
+                            <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                              Searching...
+                            </div>
+                          )}
+                          {suggestionGroups.map(({ type, items }) => {
+                            if (!items.length) {
+                              return null;
+                            }
+                            const config = TYPEAHEAD_CONFIG[type];
+                            return (
+                              <div key={type} className="pb-3 last:pb-0">
+                                <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                  <span className="text-slate-400">{config?.label || type}</span>
+                                </div>
+                                <div className="mt-2 space-y-1">
+                                  {items.map((item) => {
+                                    const isActive = item._index === activeSuggestionIndex;
+                                    return (
+                                      <button
+                                        key={`${item.type}-${item.id}-${item._index}`}
+                                        id={`agentwp-suggestion-${item._index}`}
+                                        type="button"
+                                        role="option"
+                                        aria-selected={isActive}
+                                        onMouseDown={(event) => event.preventDefault()}
+                                        onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                        onClick={() => handleSuggestionSelect(item)}
+                                        className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                          isActive
+                                            ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                            : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                        }`}
+                                      >
+                                        <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                        <span className="flex-1">
+                                          <span className="block text-sm font-semibold text-slate-100">
+                                            {renderHighlightedText(item.primary || '', prompt)}
+                                          </span>
+                                          {item.secondary ? (
+                                            <span className="block text-xs text-slate-400">
+                                              {renderHighlightedText(item.secondary, prompt)}
+                                            </span>
+                                          ) : null}
+                                        </span>
+                                      </button>
+                                    );
+                                  })}
+                                </div>
+                              </div>
+                            );
+                          })}
+                        </div>
+                      )}
+                    </div>
+                  </form>
 
-                  {showTypeahead && (
+                  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                    {!showHistoryPanel && (
+                      <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Latest response
+                        </p>
+                        {hasDraft && lastSuccessfulCommand ? (
+                          <button
+                            type="button"
+                            onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                            aria-pressed={isLastCommandFavorited}
+                            className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                              isLastCommandFavorited
+                                ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                                : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                            }`}
+                          >
+                            <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                              <path
+                                d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                                fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                                stroke="currentColor"
+                                strokeWidth="1.6"
+                                strokeLinejoin="round"
+                              />
+                            </svg>
+                            {isLastCommandFavorited ? 'Starred' : 'Star'}
+                          </button>
+                        ) : null}
+                      </div>
+                    )}
                     <div
-                      id="agentwp-typeahead"
-                      role="listbox"
-                      className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                      aria-live="polite"
+                      aria-busy={loading ? 'true' : 'false'}
                     >
-                      {isTypeaheadLoading && (
-                        <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
-                          Searching...
+                      {showHistoryPanel ? (
+                        <HistoryPanel
+                          history={visibleHistory}
+                          historyCount={commandHistory.length}
+                          favorites={favoriteCommands}
+                          mostUsed={mostUsedCommands}
+                          onRun={executeCommand}
+                          onDelete={removeHistoryEntry}
+                          onToggleFavorite={toggleFavoriteCommand}
+                          onClearHistory={clearCommandHistory}
+                          isFavorited={isCommandFavorited}
+                        />
+                      ) : loading ? (
+                        <div className="space-y-3 animate-pulse">
+                          <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                          <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                          <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
                         </div>
-                      )}
-                      {suggestionGroups.map(({ type, items }) => {
-                        if (!items.length) {
-                          return null;
-                        }
-                        const config = TYPEAHEAD_CONFIG[type];
-                        return (
-                          <div key={type} className="pb-3 last:pb-0">
-                            <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
-                              <span className="text-slate-400">{config?.label || type}</span>
-                            </div>
-                            <div className="mt-2 space-y-1">
-                              {items.map((item) => {
-                                const isActive = item._index === activeSuggestionIndex;
+                      ) : isOffline ? (
+                        <div className="space-y-3 text-sm text-amber-100">
+                          <p className="text-amber-200">
+                            {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                          </p>
+                          {offlineDrafts.length ? (
+                            <div className="space-y-2">
+                              {offlineDrafts.map((draft) => {
+                                const title = draft.subject || draft.prompt || 'Cached response';
+                                const snippet = truncateText(
+                                  draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                  160
+                                );
                                 return (
                                   <button
-                                    key={`${item.type}-${item.id}-${item._index}`}
-                                    id={`agentwp-suggestion-${item._index}`}
+                                    key={draft.id}
                                     type="button"
-                                    role="option"
-                                    aria-selected={isActive}
-                                    onMouseDown={(event) => event.preventDefault()}
-                                    onMouseEnter={() => setActiveSuggestionIndex(item._index)}
-                                    onClick={() => handleSuggestionSelect(item)}
-                                    className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                                      isActive
-                                        ? 'border-sky-400/70 bg-slate-900/80 text-white'
-                                        : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
-                                    }`}
+                                    onClick={() => handleRestoreDraft(draft)}
+                                    className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
                                   >
-                                    <span className="mt-1 text-slate-400">{config?.icon}</span>
-                                    <span className="flex-1">
-                                      <span className="block text-sm font-semibold text-slate-100">
-                                        {renderHighlightedText(item.primary || '', prompt)}
+                                    <span className="text-sm font-semibold text-amber-50">
+                                      {title}
+                                    </span>
+                                    {snippet ? (
+                                      <span className="mt-1 text-xs text-amber-200/80">
+                                        {snippet}
                                       </span>
-                                      {item.secondary ? (
-                                        <span className="block text-xs text-slate-400">
-                                          {renderHighlightedText(item.secondary, prompt)}
-                                        </span>
-                                      ) : null}
-                                    </span>
+                                    ) : null}
                                   </button>
                                 );
                               })}
                             </div>
-                          </div>
-                        );
-                      })}
+        : null}
+                        </select>
+                      </div>
+                    </div>
+                    <div className="mt-4 grid gap-4">
+                      <ChartCard
+                        title="Sales trend"
+                        subtitle="Daily revenue with previous period overlay"
+                        metric={formatCurrencyValue(totalRevenue)}
+                        trend={trendLabel}
+                        theme={resolvedTheme}
+                        type="line"
+                        data={trendChartData}
+                        options={trendChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={trendTable}
+                        exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={240}
+                      />
+                      <ChartCard
+                        title="Period comparison"
+                        subtitle="This period vs last period metrics"
+                        theme={resolvedTheme}
+                        type="bar"
+                        data={comparisonChartData}
+                        options={comparisonChartOptions}
+                        meta={
+                          <>
+                            <span>Totals</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={comparisonTable}
+                        exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={200}
+                      />
+                      <ChartCard
+                        title="Category breakdown"
+                        subtitle="Revenue by product category"
+                        theme={resolvedTheme}
+                        type="doughnut"
+                        data={categoryChartData}
+                        options={categoryChartOptions}
+                        meta={
+                          <>
+                            <span>Revenue mix</span>
+                            <span>{periodData.label}</span>
+                          </>
+                        }
+                        table={categoryTable}
+                        exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                        valueFormatter={formatCurrencyValue}
+                        height={220}
+                      />
                     </div>
-                  )}
-                </div>
-              </form>
+                  </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                {!showHistoryPanel && (
-                  <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Latest response
-                    </p>
-                    {hasDraft && lastSuccessfulCommand ? (
-                      <button
-                        type="button"
-                        onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
-                        aria-pressed={isLastCommandFavorited}
-                        className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
-                          isLastCommandFavorited
-                            ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
-                            : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
-                        }`}
-                      >
-                        <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
-                          <path
-                            d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
-                            fill={isLastCommandFavorited ? 'currentColor' : 'none'}
-                            stroke="currentColor"
-                            strokeWidth="1.6"
-                            strokeLinejoin="round"
-                          />
-                        </svg>
-                        {isLastCommandFavorited ? 'Starred' : 'Star'}
-                      </button>
-                    ) : null}
-                  </div>
-                )}
-                <div
-                  className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
-                  aria-live="polite"
-                  aria-busy={loading ? 'true' : 'false'}
-                >
-                  {showHistoryPanel ? (
-                    <HistoryPanel
-                      history={visibleHistory}
-                      historyCount={commandHistory.length}
-                      favorites={favoriteCommands}
-                      mostUsed={mostUsedCommands}
-                      onRun={executeCommand}
-                      onDelete={removeHistoryEntry}
-                      onToggleFavorite={toggleFavoriteCommand}
-                      onClearHistory={clearCommandHistory}
-                      isFavorited={isCommandFavorited}
-                    />
-                  ) : loading ? (
-                    <div className="space-y-3 animate-pulse">
-                      <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
-                      <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
-                      <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
-                    </div>
-                  ) : isOffline ? (
-                    <div className="space-y-3 text-sm text-amber-100">
-                      <p className="text-amber-200">
-                        {OFFLINE_BANNER_TEXT}. Cached results are available below.
-                      </p>
-                      {offlineDrafts.length ? (
-                        <div className="space-y-2">
-                          {offlineDrafts.map((draft) => {
-                            const title = draft.subject || draft.prompt || 'Cached response';
-                            const snippet = truncateText(
-                              draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
-                              160
-                            );
-                            return (
-                              <button
-                                key={draft.id}
-                                type="button"
-                                onClick={() => handleRestoreDraft(draft)}
-                                className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
-                              >
-                                <span className="text-sm font-semibold text-amber-50">{title}</span>
-                                {snippet ? (
-                                  <span className="mt-1 text-xs text-amber-200/80">
-                                    {snippet}
-                                  </span>
-                                ) : null}
-                              </button>
-                            );
-                          })}
-                        </div>
+                  <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                    <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                      Draft history (last 10)
+                    </summary>
+                    <div className="mt-3 space-y-2">
+                      {draftHistory.length ? (
+                        draftHistory.map((draft) => {
+                          const title = draft.subject || draft.prompt || 'Untitled draft';
+                          const timestamp = draft.createdAt
+                            ? new Date(draft.createdAt).toLocaleString()
+                            : '';
+                          return (
+                            <button
+                              key={draft.id}
+                              type="button"
+                              onClick={() => handleRestoreDraft(draft)}
+                              className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                            >
+                              <span className="font-semibold">{title}</span>
+                              <span className="text-xs text-slate-500">{timestamp}</span>
+                            </button>
+                          );
+                        })
                       ) : (
-                        <p className="text-xs text-amber-200/80">
-                          No cached responses yet. Try again when you are back online.
+                        <p className="text-xs text-slate-500">
+                          No drafts yet. Send a prompt to save one.
                         </p>
                       )}
                     </div>
-                  ) : errorState ? (
-                    <ErrorCard
-                      title="We hit a snag"
-                      message={errorMessage}
-                      retryLabel={retryLabel}
-                      onRetry={errorState.retryable ? handleRetry : undefined}
-                      onReport={handleReportIssue}
-                    />
-                  ) : response ? (
-                    <div ref={responseHtmlRef} className="agentwp-markdown">
-                      <ReactMarkdown
-                        components={{
-                          a: ({ ...props }) => (
-                            <a {...props} target="_blank" rel="noreferrer" />
-                          ),
-                        }}
-                      >
-                        {response}
-                      </ReactMarkdown>
+                  </details>
+
+                  <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                    <div className="grid gap-4 sm:grid-cols-3">
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session tokens
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatTokenCount(sessionUsage.tokens)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Session cost
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {formatUsageCost(sessionUsage.cost)}
+                        </p>
+                      </div>
+                      <div>
+                        <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                          Monthly total
+                        </p>
+                        <p className="mt-2 text-lg font-semibold text-white">
+                          {monthlyUsageLabel}
+                        </p>
+                        <p className="text-xs text-slate-500">
+                          {formatTokenCount(usageSummary.totalTokens)} tokens
+                        </p>
+                      </div>
                     </div>
-                  ) : (
-                    <div className="space-y-2 text-sm text-slate-400">
-                      <p>Describe a task and AgentWP will coordinate the next action.</p>
-                      <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
-                    </div>
-                  )}
+                    {budgetLimit > 0 ? (
+                      <div className="mt-4">
+                        <div className="flex items-center justify-between text-xs text-slate-400">
+                          <span>Budget usage</span>
+                          <span>
+                            {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                          </span>
+                        </div>
+                        <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                          <div
+                            className={`h-full ${budgetFillTone}`}
+                            style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                          />
+                        </div>
+                        {budgetMessage ? (
+                          <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                        ) : null}
+                      </div>
+                    ) : null}
+                  </div>
+
+                  <div className="flex items-center justify-between text-xs text-slate-400">
+                    <span>
+                      Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                    </span>
+                    <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                  </div>
                 </div>
               </div>
-
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Draft actions
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Copy the latest draft or open it in your email client.
-                    </p>
-                  </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-draft-subject"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Email subject
-                    </label>
-                    <input
-                      id="agentwp-draft-subject"
-                      type="text"
-                      value={draftSubject}
-                      onChange={(event) => setDraftSubject(event.target.value)}
-                      disabled={!hasDraft}
-                      placeholder="Subject line"
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
-                    />
-                  </div>
+            </div>
+          </div>
+        </div>,
+            portalRoot
+          )
+        ) : (
+          <div
+            className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
+            role="presentation"
+            onMouseDown={(event) => {
+              if (event.target === event.currentTarget) {
+                closeModal();
+              }
+            }}
+          >
+            <div
+              ref={modalRef}
+              role="dialog"
+              aria-modal="true"
+              aria-labelledby="agentwp-command-deck-title"
+              className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
+            >
+              <div className="flex items-center justify-between border-b border-slate-700/50 px-6 py-5">
+                <div>
+                  <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400">
+                    AgentWP
+                  </p>
+                  <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
+                    Command Deck
+                  </h2>
                 </div>
-                <div className="mt-4 flex flex-wrap gap-2">
-                  <ClipboardButton
-                    label="Copy plain text"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: resolvedBody })}
-                  />
-                  <ClipboardButton
-                    label="Copy HTML"
-                    disabled={!hasDraft}
-                    getPayload={() => ({
-                      text: resolvedBody,
-                      html:
-                        responseHtmlRef.current?.innerHTML ||
-                        formatPlainTextAsHtml(resolvedBody),
-                    })}
-                  />
-                  <ClipboardButton
-                    label="Copy Markdown"
-                    disabled={!hasDraft}
-                    getPayload={() => ({ text: response })}
-                  />
-                  <a
-                    href={mailtoHref}
-                    onClick={(event) => {
-                      if (!hasDraft) {
-                        event.preventDefault();
-                      }
-                    }}
-                    aria-disabled={!hasDraft}
-                    tabIndex={hasDraft ? 0 : -1}
-                    className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
-                      hasDraft
-                        ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
-                        : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
-                    }`}
+                <div className="flex items-center gap-2">
+                  <button
+                    type="button"
+                    onClick={toggleTheme}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label={themeToggleLabel}
+                    aria-pressed={isDarkTheme}
+                    title={themeToggleLabel}
+                  >
+                    {isDarkTheme ? <SunIcon /> : <MoonIcon />}
+                  </button>
+                  <button
+                    type="button"
+                    onClick={closeModal}
+                    className="inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700/70 text-slate-200 transition hover:border-slate-500/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                    aria-label="Close Command Deck"
                   >
-                    Open in Mail
-                  </a>
+                    <span aria-hidden="true">&times;</span>
+                  </button>
                 </div>
               </div>
 
-              <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
-                <div className="flex flex-wrap items-center justify-between gap-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Analytics charts
-                    </p>
-                    <p className="text-sm text-slate-300">
-                      Visualize revenue trends and period performance inside the Command Deck.
+              <div className="space-y-4 px-6 py-5">
+                {isOffline && (
+                  <div className="rounded-2xl border border-amber-400/60 bg-amber-500/10 px-4 py-3 text-sm text-amber-100">
+                    <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-200">
+                      <span className="inline-flex h-2 w-2 rounded-full bg-amber-400" aria-hidden="true" />
+                      {OFFLINE_BANNER_TEXT}
+                    </div>
+                    <p className="mt-1 text-xs text-amber-200/80">
+                      AgentWP will reconnect automatically. Cached results are available below.
                     </p>
                   </div>
-                  <div className="min-w-[200px]">
-                    <label
-                      htmlFor="agentwp-analytics-period"
-                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
-                    >
-                      Period
-                    </label>
-                    <select
-                      id="agentwp-analytics-period"
-                      value={selectedPeriod}
-                      onChange={(event) => setSelectedPeriod(event.target.value)}
-                      className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
-                    >
-                      {PERIOD_OPTIONS.map((option) => (
-                        <option key={option.value} value={option.value}>
-                          {option.label}
-                        </option>
-                      ))}
-                    </select>
+                )}
+                <form onSubmit={handleSubmit}>
+                  <label htmlFor="agentwp-prompt" className="sr-only">
+                    Ask AgentWP anything
+                  </label>
+                  <div className="relative">
+                    <div className="flex items-center gap-3 rounded-2xl border border-slate-700/70 bg-slate-950/40 px-4 py-3 focus-within:border-sky-400/80">
+                      <input
+                        id="agentwp-prompt"
+                        ref={inputRef}
+                        type="text"
+                        value={prompt}
+                        onChange={handlePromptChange}
+                        onKeyDown={handlePromptKeyDown}
+                        onFocus={handlePromptFocus}
+                        onBlur={handlePromptBlur}
+                        aria-expanded={showTypeahead}
+                        aria-controls="agentwp-typeahead"
+                        aria-activedescendant={activeSuggestionId}
+                        placeholder={isOffline ? 'Agent Offline' : 'Ask AgentWP anything...'}
+                        disabled={isOffline}
+                        className="flex-1 bg-transparent text-sm text-slate-100 placeholder:text-slate-500 focus:outline-none disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                      <button
+                        type="submit"
+                        disabled={loading || isOffline || !prompt.trim()}
+                        className="inline-flex items-center justify-center rounded-full border border-slate-600/70 bg-slate-900/80 px-4 py-2 text-xs font-semibold uppercase tracking-widest text-white transition hover:border-slate-400/80 hover:bg-slate-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      >
+                        {loading ? 'Sending' : isOffline ? 'Offline' : 'Send'}
+                      </button>
+                    </div>
+
+                    {showTypeahead && (
+                      <div
+                        id="agentwp-typeahead"
+                        role="listbox"
+                        className="absolute left-0 right-0 z-30 mt-2 max-h-80 overflow-y-auto rounded-2xl border border-slate-700/70 bg-slate-950/95 p-3 shadow-xl backdrop-blur"
+                      >
+                        {isTypeaheadLoading && (
+                          <div className="px-2 pb-2 text-xs uppercase tracking-[0.3em] text-slate-500">
+                            Searching...
+                          </div>
+                        )}
+                        {suggestionGroups.map(({ type, items }) => {
+                          if (!items.length) {
+                            return null;
+                          }
+                          const config = TYPEAHEAD_CONFIG[type];
+                          return (
+                            <div key={type} className="pb-3 last:pb-0">
+                              <div className="flex items-center gap-2 px-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500">
+                                <span className="text-slate-400">{config?.label || type}</span>
+                              </div>
+                              <div className="mt-2 space-y-1">
+                                {items.map((item) => {
+                                  const isActive = item._index === activeSuggestionIndex;
+                                  return (
+                                    <button
+                                      key={`${item.type}-${item.id}-${item._index}`}
+                                      id={`agentwp-suggestion-${item._index}`}
+                                      type="button"
+                                      role="option"
+                                      aria-selected={isActive}
+                                      onMouseDown={(event) => event.preventDefault()}
+                                      onMouseEnter={() => setActiveSuggestionIndex(item._index)}
+                                      onClick={() => handleSuggestionSelect(item)}
+                                      className={`flex w-full items-start gap-3 rounded-xl border px-3 py-2 text-left transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                                        isActive
+                                          ? 'border-sky-400/70 bg-slate-900/80 text-white'
+                                          : 'border-transparent bg-slate-950/30 text-slate-200 hover:border-slate-600/60 hover:bg-slate-900/70'
+                                      }`}
+                                    >
+                                      <span className="mt-1 text-slate-400">{config?.icon}</span>
+                                      <span className="flex-1">
+                                        <span className="block text-sm font-semibold text-slate-100">
+                                          {renderHighlightedText(item.primary || '', prompt)}
+                                        </span>
+                                        {item.secondary ? (
+                                          <span className="block text-xs text-slate-400">
+                                            {renderHighlightedText(item.secondary, prompt)}
+                                          </span>
+                                        ) : null}
+                                      </span>
+                                    </button>
+                                  );
+                                })}
+                              </div>
+                            </div>
+                          );
+                        })}
+                      </div>
+                    )}
                   </div>
-                </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
-              </div>
+                </form>
 
-              <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
-                <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                  Draft history (last 10)
-                </summary>
-                <div className="mt-3 space-y-2">
-                  {draftHistory.length ? (
-                    draftHistory.map((draft) => {
-                      const title = draft.subject || draft.prompt || 'Untitled draft';
-                      const timestamp = draft.createdAt
-                        ? new Date(draft.createdAt).toLocaleString()
-                        : '';
-                      return (
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  {!showHistoryPanel && (
+                    <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Latest response
+                      </p>
+                      {hasDraft && lastSuccessfulCommand ? (
                         <button
-                          key={draft.id}
                           type="button"
-                          onClick={() => handleRestoreDraft(draft)}
-                          className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          onClick={() => toggleFavoriteCommand(lastSuccessfulCommand)}
+                          aria-pressed={isLastCommandFavorited}
+                          className={`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300 ${
+                            isLastCommandFavorited
+                              ? 'border-amber-400/70 bg-amber-500/10 text-amber-200'
+                              : 'border-slate-700/70 text-slate-200 hover:border-slate-500/80 hover:text-white'
+                          }`}
                         >
-                          <span className="font-semibold">{title}</span>
-                          <span className="text-xs text-slate-500">{timestamp}</span>
+                          <svg viewBox="0 0 24 24" aria-hidden="true" className="h-4 w-4">
+                            <path
+                              d="M12 3.4l2.4 4.9 5.4.8-3.9 3.8.9 5.3-4.8-2.5-4.8 2.5.9-5.3-3.9-3.8 5.4-.8L12 3.4z"
+                              fill={isLastCommandFavorited ? 'currentColor' : 'none'}
+                              stroke="currentColor"
+                              strokeWidth="1.6"
+                              strokeLinejoin="round"
+                            />
+                          </svg>
+                          {isLastCommandFavorited ? 'Starred' : 'Star'}
                         </button>
-                      );
-                    })
-                  ) : (
-                    <p className="text-xs text-slate-500">No drafts yet. Send a prompt to save one.</p>
+                      ) : null}
+                    </div>
                   )}
+                  <div
+                    className="min-h-[140px] max-h-64 overflow-y-auto pr-1"
+                    aria-live="polite"
+                    aria-busy={loading ? 'true' : 'false'}
+                  >
+                    {showHistoryPanel ? (
+                      <HistoryPanel
+                        history={visibleHistory}
+                        historyCount={commandHistory.length}
+                        favorites={favoriteCommands}
+                        mostUsed={mostUsedCommands}
+                        onRun={executeCommand}
+                        onDelete={removeHistoryEntry}
+                        onToggleFavorite={toggleFavoriteCommand}
+                        onClearHistory={clearCommandHistory}
+                        isFavorited={isCommandFavorited}
+                      />
+                    ) : loading ? (
+                      <div className="space-y-3 animate-pulse">
+                        <div className="h-3 w-3/4 rounded-full bg-slate-700/60" />
+                        <div className="h-3 w-5/6 rounded-full bg-slate-700/50" />
+                        <div className="h-3 w-2/3 rounded-full bg-slate-700/40" />
+                      </div>
+                    ) : isOffline ? (
+                      <div className="space-y-3 text-sm text-amber-100">
+                        <p className="text-amber-200">
+                          {OFFLINE_BANNER_TEXT}. Cached results are available below.
+                        </p>
+                        {offlineDrafts.length ? (
+                          <div className="space-y-2">
+                            {offlineDrafts.map((draft) => {
+                              const title = draft.subject || draft.prompt || 'Cached response';
+                              const snippet = truncateText(
+                                draft.plainText || stripMarkdownToPlainText(draft.markdown || ''),
+                                160
+                              );
+                              return (
+                                <button
+                                  key={draft.id}
+                                  type="button"
+                                  onClick={() => handleRestoreDraft(draft)}
+                                  className="flex w-full flex-col rounded-xl border border-amber-400/30 bg-amber-500/10 px-3 py-2 text-left text-xs text-amber-100 transition hover:border-amber-300/60 hover:bg-amber-500/20 focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-300"
+                                >
+                                  <span className="text-sm font-semibold text-amber-50">
+                                    {title}
+                                  </span>
+                                  {snippet ? (
+                                    <span className="mt-1 text-xs text-amber-200/80">
+                                      {snippet}
+                                    </span>
+                                  ) : null}
+                                </button>
+                              );
+                            })}
+                          </div>
+                        ) : (
+                          <p className="text-xs text-amber-200/80">
+                            No cached responses yet. Try again when you are back online.
+                          </p>
+                        )}
+                      </div>
+                    ) : errorState ? (
+                      <ErrorCard
+                        title="We hit a snag"
+                        message={errorMessage}
+                        retryLabel={retryLabel}
+                        onRetry={errorState.retryable ? handleRetry : undefined}
+                        onReport={handleReportIssue}
+                      />
+                    ) : response ? (
+                      <div ref={responseHtmlRef} className="agentwp-markdown">
+                        <ReactMarkdown
+                          components={{
+                            a: ({ ...props }) => <a {...props} target="_blank" rel="noreferrer" />,
+                          }}
+                        >
+                          {response}
+                        </ReactMarkdown>
+                      </div>
+                    ) : (
+                      <div className="space-y-2 text-sm text-slate-400">
+                        <p>Describe a task and AgentWP will coordinate the next action.</p>
+                        <p className="text-xs text-slate-500">Press Enter to send. Esc to close.</p>
+                      </div>
+                    )}
+                  </div>
                 </div>
-              </details>
 
-              <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
-                <div className="grid gap-4 sm:grid-cols-3">
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session tokens
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatTokenCount(sessionUsage.tokens)}
-                    </p>
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Draft actions
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Copy the latest draft or open it in your email client.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-draft-subject"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Email subject
+                      </label>
+                      <input
+                        id="agentwp-draft-subject"
+                        type="text"
+                        value={draftSubject}
+                        onChange={(event) => setDraftSubject(event.target.value)}
+                        disabled={!hasDraft}
+                        placeholder="Subject line"
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 placeholder:text-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 disabled:cursor-not-allowed disabled:opacity-60"
+                      />
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Session cost
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">
-                      {formatUsageCost(sessionUsage.cost)}
-                    </p>
+                  <div className="mt-4 flex flex-wrap gap-2">
+                    <ClipboardButton
+                      label="Copy plain text"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: resolvedBody })}
+                    />
+                    <ClipboardButton
+                      label="Copy HTML"
+                      disabled={!hasDraft}
+                      getPayload={() => ({
+                        text: resolvedBody,
+                        html:
+                          responseHtmlRef.current?.innerHTML ||
+                          formatPlainTextAsHtml(resolvedBody),
+                      })}
+                    />
+                    <ClipboardButton
+                      label="Copy Markdown"
+                      disabled={!hasDraft}
+                      getPayload={() => ({ text: response })}
+                    />
+                    <a
+                      href={mailtoHref}
+                      onClick={(event) => {
+                        if (!hasDraft) {
+                          event.preventDefault();
+                        }
+                      }}
+                      aria-disabled={!hasDraft}
+                      tabIndex={hasDraft ? 0 : -1}
+                      className={`inline-flex items-center justify-center rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-widest transition focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 ${
+                        hasDraft
+                          ? 'border-slate-600/70 bg-slate-900/80 text-white hover:border-slate-400/80 hover:bg-slate-900'
+                          : 'pointer-events-none border-slate-700/60 bg-slate-900/50 text-slate-500'
+                      }`}
+                    >
+                      Open in Mail
+                    </a>
+                  </div>
+                </div>
+
+                <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+                  <div className="flex flex-wrap items-center justify-between gap-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Analytics charts
+                      </p>
+                      <p className="text-sm text-slate-300">
+                        Visualize revenue trends and period performance inside the Command Deck.
+                      </p>
+                    </div>
+                    <div className="min-w-[200px]">
+                      <label
+                        htmlFor="agentwp-analytics-period"
+                        className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
+                      >
+                        Period
+                      </label>
+                      <select
+                        id="agentwp-analytics-period"
+                        value={selectedPeriod}
+                        onChange={(event) => setSelectedPeriod(event.target.value)}
+                        className="mt-2 w-full rounded-xl border border-slate-700/70 bg-slate-950/40 px-3 py-2 text-sm text-slate-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                      >
+                        {PERIOD_OPTIONS.map((option) => (
+                          <option key={option.value} value={option.value}>
+                            {option.label}
+                          </option>
+                        ))}
+                      </select>
+                    </div>
                   </div>
-                  <div>
-                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
-                      Monthly total
-                    </p>
-                    <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
-                    <p className="text-xs text-slate-500">
-                      {formatTokenCount(usageSummary.totalTokens)} tokens
-                    </p>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
                   </div>
                 </div>
-                {budgetLimit > 0 ? (
-                  <div className="mt-4">
-                    <div className="flex items-center justify-between text-xs text-slate-400">
-                      <span>Budget usage</span>
-                      <span>
-                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
-                      </span>
+
+                <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
+                  <summary className="cursor-pointer text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                    Draft history (last 10)
+                  </summary>
+                  <div className="mt-3 space-y-2">
+                    {draftHistory.length ? (
+                      draftHistory.map((draft) => {
+                        const title = draft.subject || draft.prompt || 'Untitled draft';
+                        const timestamp = draft.createdAt
+                          ? new Date(draft.createdAt).toLocaleString()
+                          : '';
+                        return (
+                          <button
+                            key={draft.id}
+                            type="button"
+                            onClick={() => handleRestoreDraft(draft)}
+                            className="flex w-full flex-col rounded-xl border border-slate-800/80 bg-slate-950/30 px-3 py-2 text-left text-sm text-slate-200 transition hover:border-slate-600/80 hover:text-white focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400"
+                          >
+                            <span className="font-semibold">{title}</span>
+                            <span className="text-xs text-slate-500">{timestamp}</span>
+                          </button>
+                        );
+                      })
+                    ) : (
+                      <p className="text-xs text-slate-500">
+                        No drafts yet. Send a prompt to save one.
+                      </p>
+                    )}
+                  </div>
+                </details>
+
+                <div className={`rounded-2xl border px-4 py-4 ${usageTone}`}>
+                  <div className="grid gap-4 sm:grid-cols-3">
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session tokens
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatTokenCount(sessionUsage.tokens)}
+                      </p>
                     </div>
-                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
-                      <div
-                        className={`h-full ${budgetFillTone}`}
-                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
-                      />
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Session cost
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">
+                        {formatUsageCost(sessionUsage.cost)}
+                      </p>
                     </div>
-                    {budgetMessage ? (
-                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
-                    ) : null}
+                    <div>
+                      <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
+                        Monthly total
+                      </p>
+                      <p className="mt-2 text-lg font-semibold text-white">{monthlyUsageLabel}</p>
+                      <p className="text-xs text-slate-500">
+                        {formatTokenCount(usageSummary.totalTokens)} tokens
+                      </p>
+                    </div>
                   </div>
-                ) : null}
-              </div>
+                  {budgetLimit > 0 ? (
+                    <div className="mt-4">
+                      <div className="flex items-center justify-between text-xs text-slate-400">
+                        <span>Budget usage</span>
+                        <span>
+                          {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
+                        </span>
+                      </div>
+                      <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
+                        <div
+                          className={`h-full ${budgetFillTone}`}
+                          style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
+                        />
+                      </div>
+                      {budgetMessage ? (
+                        <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
+                      ) : null}
+                    </div>
+                  ) : null}
+                </div>
 
-              <div className="flex items-center justify-between text-xs text-slate-400">
-                <span>
-                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
-                </span>
-                <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                <div className="flex items-center justify-between text-xs text-slate-400">
+                  <span>
+                    Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
+                  </span>
+                  <span>Token cost: {metrics.tokenCost ?? '--'}</span>
+                </div>
               </div>
             </div>
           </div>
         </div>
-      )}
+        ))}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Recreating file by overwriting and patching**
exec
/bin/zsh -lc 'git show HEAD:react/src/App.jsx > react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 77ms:

file update:

diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Reapplying App.jsx modifications carefully**
exec
/bin/zsh -lc 'head -n 20 react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 74ms:
import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
import html2canvas from 'html2canvas';
import ReactMarkdown from 'react-markdown';
import HistoryPanel from '../components/HistoryPanel.jsx';
import { ChartCard, ErrorCard } from '../components/cards';
import {
  applyTheme,
  getInitialThemePreference,
  getServerTheme,
  resolveTheme,
  THEME_STORAGE_KEY,
} from './theme.js';

const OPEN_STATE_KEY = 'agentwp-command-deck-open';
const DRAFT_HISTORY_KEY = 'agentwp-draft-history';
const MAX_DRAFT_HISTORY = 10;
const COMMAND_HISTORY_KEY = 'agentwp-command-history';
const COMMAND_FAVORITES_KEY = 'agentwp-command-favorites';
const COMMAND_USAGE_KEY = 'agentwp-command-usage';
const MAX_COMMAND_HISTORY = 50;
file update:

diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Applying import modification**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1,2 +1,3 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
apply_patch(auto_approved=true) exited 0 in 61ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..95b9b1e008681163ac40a42831154e7075bfbfcb
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..95b9b1e008681163ac40a42831154e7075bfbfcb
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Adding helper functions**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -352,2 +352,25 @@
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
apply_patch(auto_approved=true) exited 0 in 56ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..671d4c2f1177f5c9a8bbed9dfef504e9c97126dd
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..671d4c2f1177f5c9a8bbed9dfef504e9c97126dd
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Modifying App function signature**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -876,3 +876,3 @@
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
@@ -927,2 +927,6 @@
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
apply_patch(auto_approved=true) exited 0 in 59ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..0b41e0b70eb9f3cc7e8d169af2f5aeec30ac3ae0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..0b41e0b70eb9f3cc7e8d169af2f5aeec30ac3ae0
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating useLayoutEffect block**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -960,8 +960,7 @@
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
@@ -970,6 +969,6 @@
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
@@ -980,3 +979,3 @@
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
apply_patch(auto_approved=true) exited 0 in 70ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..8a73bf8c86437e2d179df155b46d0a48471b4271
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..8a73bf8c86437e2d179df155b46d0a48471b4271
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating openModal with getActiveElement**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1421,7 +1421,8 @@
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
apply_patch(auto_approved=true) exited 0 in 51ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..f719990b12b7b8baf865df08a0617b0d9888a1c8
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..f719990b12b7b8baf865df08a0617b0d9888a1c8
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating hotkey target check**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1701,3 +1701,4 @@
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
apply_patch(auto_approved=true) exited 0 in 59ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..497ac1dcd09bc49482faa67cdba1acccf5a01059
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..497ac1dcd09bc49482faa67cdba1acccf5a01059
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating focus trap to use getActiveElement safely**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1754,4 +1754,4 @@
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
apply_patch(auto_approved=true) exited 0 in 61ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..9311041f3261b8d1c75e9282b00ac6c1859c419c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..9311041f3261b8d1c75e9282b00ac6c1859c419c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating effect dependency array**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1777,3 +1777,3 @@
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
apply_patch(auto_approved=true) exited 0 in 64ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..22b1d40b52cd8ee04e9890723e0f02a7a79a05d2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..22b1d40b52cd8ee04e9890723e0f02a7a79a05d2
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Adding root class to div**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2304,3 +2304,3 @@
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
apply_patch(auto_approved=true) exited 0 in 65ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Refactoring modal rendering with conditional portal**
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Diagnosing patch application failure**
exec
/bin/zsh -lc "rg -n \"\\{isOpen\" -n react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 98ms:
2308:        aria-hidden={isOpen}
2425:      {isOpen && (
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Verifying target code block location**
exec
/bin/zsh -lc "sed -n '2418,2438p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 77ms:
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      {isOpen && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
          role="presentation"
          onMouseDown={(event) => {
            if (event.target === event.currentTarget) {
              closeModal();
            }
          }}
        >
          <div
            ref={modalRef}
            role="dialog"
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..a9f0094b7c13261281f1218d135716fabbcf981a
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Debugging patch failure**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2424,3 +2424,4 @@
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
apply_patch(auto_approved=true) exited 0 in 59ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..7bd8bb18e30428de5152a9e1243ff4c7648bf03e
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..7bd8bb18e30428de5152a9e1243ff4c7648bf03e
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Preparing to insert portalRoot argument**
exec
/bin/zsh -lc "sed -n '2800,2865p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:
                  <ChartCard
                    title="Sales trend"
                    subtitle="Daily revenue with previous period overlay"
                    metric={formatCurrencyValue(totalRevenue)}
                    trend={trendLabel}
                    theme={resolvedTheme}
                    type="line"
                    data={trendChartData}
                    options={trendChartOptions}
                    meta={
                      <>
                        <span>Revenue</span>
                        <span>{periodData.label}</span>
                      </>
                    }
                    table={trendTable}
                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
                    valueFormatter={formatCurrencyValue}
                    height={240}
                  />
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..7bd8bb18e30428de5152a9e1243ff4c7648bf03e
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking file end near line 2920**
exec
/bin/zsh -lc "sed -n '2920,2995p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
                      <span>
                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
                      </span>
                    </div>
                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
                      <div
                        className={`h-full ${budgetFillTone}`}
                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
                      />
                    </div>
                    {budgetMessage ? (
                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
                    ) : null}
                  </div>
                ) : null}
              </div>

              <div className="flex items-center justify-between text-xs text-slate-400">
                <span>
                  Latency: {metrics.latencyMs !== null ? `${metrics.latencyMs} ms` : '--'}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..7bd8bb18e30428de5152a9e1243ff4c7648bf03e
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating modal overlay closing syntax**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2944,4 +2944,6 @@
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
apply_patch(auto_approved=true) exited 0 in 88ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking createPortal syntax**
exec
/bin/zsh -lc "sed -n '2420,2440p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
            </div>
          </div>
        </section>
      </main>

      {isOpen && portalRoot
        ? createPortal(
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
          role="presentation"
          onMouseDown={(event) => {
            if (event.target === event.currentTarget) {
              closeModal();
            }
          }}
        >
          <div
            ref={modalRef}
            role="dialog"
            aria-modal="true"
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Reviewing JSX indentation and alignment**
exec
/bin/zsh -lc "sed -n '2915,2945p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
                </div>
                {budgetLimit > 0 ? (
                  <div className="mt-4">
                    <div className="flex items-center justify-between text-xs text-slate-400">
                      <span>Budget usage</span>
                      <span>
                        {budgetStatus.percent}% of {formatUsageCost(budgetLimit)}
                      </span>
                    </div>
                    <div className="mt-2 h-2 overflow-hidden rounded-full bg-slate-900/60">
                      <div
                        className={`h-full ${budgetFillTone}`}
                        style={{ width: `${Math.min(100, budgetStatus.percent)}%` }}
                      />
                    </div>
                    {budgetMessage ? (
                      <p className={`mt-3 text-xs ${budgetMessageTone}`}>{budgetMessage}</p>
                    ) : null}
                  </div>
                ) : null}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking for portalRoot usage**
exec
/bin/zsh -lc "sed -n '2945,2960p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
        </div>,
            portalRoot
          )
        : null}
    </div>
  );
}
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Reviewing indentation and code consistency**
exec
/bin/zsh -lc 'rg -n "createPortal" react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
2:import { createPortal } from 'react-dom';
2426:        ? createPortal(
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Verifying modal open behavior**
exec
/bin/zsh -lc 'rg -n "openModal" -n react/src/App.jsx | head -n 3' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
1421:  const openModal = useCallback(() => {
1710:        openModal();
1716:  }, [closeModal, isOpen, openModal]);
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

exec
/bin/zsh -lc "sed -n '1416,1432p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 65ms:
  const clearCommandHistory = useCallback(() => {
    setCommandHistory([]);
    setCommandUsage({});
  }, []);

  const openModal = useCallback(() => {
    const activeElement = getActiveElement(shadowRoot);
    if (activeElement) {
      lastActiveRef.current = activeElement;
    }
    setIsOpen(true);
  }, [shadowRoot]);

  const closeModal = useCallback(() => {
    abortActiveRequest();
    setIsOpen(false);
  }, [abortActiveRequest]);
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking for hotkey changes**
exec
/bin/zsh -lc "sed -n '1660,1695p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
    const previousOverflow = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = previousOverflow;
    };
  }, [isOpen]);

  useEffect(() => {
    if (!isOpen) {
      return undefined;
    }
    const focusTimer = window.setTimeout(() => {
      inputRef.current?.focus();
    }, 0);
    return () => window.clearTimeout(focusTimer);
  }, [isOpen]);

  useEffect(() => {
    if (isOpen) {
      return;
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

exec
/bin/zsh -lc "sed -n '1695,1725p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
      }
      if (event.repeat) {
        return;
      }
      if (event.key.toLowerCase() !== 'k') {
        return;
      }
      const target = getComposedTarget(event);
      if (event.defaultPrevented || isEditableTarget(target)) {
        return;
      }
      event.preventDefault();
      if (isOpen) {
        closeModal();
      } else {
        openModal();
      }
    };

    window.addEventListener('keydown', handleHotkey);
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking focus trap behavior**
exec
/bin/zsh -lc "sed -n '1718,1755p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
  useEffect(() => {
    const handleAdminTrigger = (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }
      const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
      if (!isTrigger) {
        return;
      }
      event.preventDefault();
      openModal();
    };

    document.addEventListener('click', handleAdminTrigger);
    return () => document.removeEventListener('click', handleAdminTrigger);
  }, [openModal]);

  useEffect(() => {
    if (!isOpen) {
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

exec
/bin/zsh -lc "sed -n '1755,1785p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
      const activeElement = getActiveElement(shadowRoot);
      if (!activeElement || !modalRef.current?.contains(activeElement)) {
        event.preventDefault();
        if (event.shiftKey) {
          last.focus();
        } else {
          first.focus();
        }
        return;
      }
      if (event.shiftKey) {
        if (activeElement === first) {
          event.preventDefault();
          last.focus();
        }
      } else if (activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    };
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Preparing CSS adjustments for shadow root**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -1,3 +1 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
apply_patch(auto_approved=true) exited 0 in 56ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..26dd6e83d571dead88fbc52c2fdd7f172aacd0ca
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,5 +1,3 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..26dd6e83d571dead88fbc52c2fdd7f172aacd0ca
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,5 +1,3 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating CSS selector and styles**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -4,4 +4,7 @@
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
apply_patch(auto_approved=true) exited 0 in 47ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..13962c4f5e4ba9fe409c2dae0b959d0781102a24
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..13962c4f5e4ba9fe409c2dae0b959d0781102a24
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Modifying CSS selector for theming**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -124,4 +124,3 @@
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
apply_patch(auto_approved=true) exited 0 in 70ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..2af1aeefc1976d66dfd9bbd8e8453cd51d5e85d6
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..2af1aeefc1976d66dfd9bbd8e8453cd51d5e85d6
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating CSS selector for theme dark mode**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -242,3 +242,3 @@
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
apply_patch(auto_approved=true) exited 0 in 61ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..f04addfd52214832a9db841ab5ea33ecc1f56729
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..f04addfd52214832a9db841ab5ea33ecc1f56729
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating media query selectors**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -361,3 +361,3 @@
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
@@ -372,4 +372,3 @@
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
apply_patch(auto_approved=true) exited 0 in 68ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..b2058371911a2449cba13f05d380a2da84fd5dd9
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..b2058371911a2449cba13f05d380a2da84fd5dd9
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Patching CSS selector for contrast preference**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -385,3 +385,3 @@
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
apply_patch(auto_approved=true) exited 0 in 68ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..a200d2c039552369ab322da71d6fcb83f8116278
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..a200d2c039552369ab322da71d6fcb83f8116278
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating theme transition selectors**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -397,4 +397,4 @@
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
@@ -404,4 +404,4 @@
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
apply_patch(auto_approved=true) exited 0 in 69ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..6c6bc6bb6f1cc14046cd58e02bcd8d76b194dad5
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,15 +395,15 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..6c6bc6bb6f1cc14046cd58e02bcd8d76b194dad5
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,15 +395,15 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Modifying CSS selector from body to .agentwp-app**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -410,6 +410,4 @@
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
apply_patch(auto_approved=true) exited 0 in 73ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..9251abcda546ab2831b54aea442d9289f25b5f26
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,23 +395,21 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..9251abcda546ab2831b54aea442d9289f25b5f26
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,23 +395,21 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Removing #root block**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/index.css
@@ -419,6 +419,2 @@
 
-#root {
-  min-height: 100vh;
-}
-
 .agentwp-markdown {
apply_patch(auto_approved=true) exited 0 in 107ms:
Success. Updated the following files:
M react/src/index.css
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Checking for leftover :root selectors**
exec
/bin/zsh -lc 'rg -n ":root" react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 54ms:

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };


thinking
**Updating Tailwind font configuration**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/tailwind.config.js
@@ -8,4 +8,11 @@
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
apply_patch(auto_approved=true) exited 0 in 48ms:
Success. Updated the following files:
M react/tailwind.config.js
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),

file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Updating root element in HTML**
exec
/bin/zsh -lc 'cat react/index.html' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 40ms:
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgentWP Dev UI</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
file update:
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Renaming div element**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/index.html
@@ -8,3 +8,3 @@
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
apply_patch(auto_approved=true) exited 0 in 62ms:
Success. Updated the following files:
M react/index.html
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),

file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Verifying React root element usage**
exec
/bin/zsh -lc "sed -n '1,200p' react/src/main.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import ErrorBoundary from '../components/ErrorBoundary.jsx';
import styles from './index.css?inline';
import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';

const getHostElement = () => {
  if (typeof document === 'undefined') {
    return null;
  }
  return document.getElementById('agentwp-root') || document.getElementById('root');
};

const ensureShadowNode = (shadowRoot, selector, createNode) => {
  const existing = shadowRoot.querySelector(selector);
  if (existing) {
    return existing;
  }
  const node = createNode();
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Confirming theme.js update**
exec
/bin/zsh -lc 'cat react/src/theme.js' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
const THEME_STORAGE_KEY = 'agentwp-theme-preference';
const VALID_THEMES = new Set(['light', 'dark']);

const normalizeTheme = (value) => (VALID_THEMES.has(value) ? value : null);

export const isValidTheme = (value) => VALID_THEMES.has(value);

export const getStoredTheme = () => {
  if (typeof window === 'undefined') {
    return null;
  }
  try {
    return normalizeTheme(window.localStorage.getItem(THEME_STORAGE_KEY));
  } catch (error) {
    return null;
  }
};

export const getServerTheme = () => {
  if (typeof window === 'undefined') {
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Updating react/src/index.css**
exec
/bin/zsh -lc 'head -n 40 react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
@tailwind base;
@tailwind components;
@tailwind utilities;

:host {
  color-scheme: light;
  display: block;
  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  line-height: 1.5;
  --awp-bg-primary: #f8fafc;
  --awp-bg-secondary: #f1f5f9;
  --awp-text-primary: #0f172a;
  --awp-text-secondary: #475569;
  --awp-accent: #0ea5e9;
  --awp-danger: #e11d48;
  --awp-success: #16a34a;
  --awp-border: rgba(148, 163, 184, 0.6);

  --awp-slate-950: 248 250 252;
  --awp-slate-900: 241 245 249;
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Preparing to check CSS details**
exec
/bin/zsh -lc 'rg -n "agentwp-app|awp-theme-transition|host" react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
5::host {
125::host([data-theme='dark']) {
243:  :host(:not([data-theme])) {
362:  :host {
373:  :host([data-theme='dark']) {
386:  :host(:not([data-theme])) {
398::host(.awp-theme-transition),
399::host(.awp-theme-transition) * {
405:  :host(.awp-theme-transition),
406:  :host(.awp-theme-transition) * {
411:.agentwp-app {
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Reviewing React component and style updates**
exec
/bin/zsh -lc "sed -n '2422,2435p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
        </section>
      </main>

      {isOpen && portalRoot
        ? createPortal(
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
          role="presentation"
          onMouseDown={(event) => {
            if (event.target === event.currentTarget) {
              closeModal();
            }
          }}
        >
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),



thinking
**Reviewing JSX indentation and portalRoot usage**
thinking
**Verifying final updates and lint status**
exec
/bin/zsh -lc 'rg -n "agentwp-app" react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:
2305:    <div className="agentwp-app min-h-screen text-slate-100">
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Checking CSS for portal cleanup**
exec
/bin/zsh -lc 'rg -n "body|#root" react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 58ms:
56:  --awp-body-bg: #f8fafc;
57:  --awp-body-bg-secondary: #e2e8f0;
58:  --awp-body-gradient-1: radial-gradient(circle at 12% 18%, rgba(14, 165, 233, 0.12), transparent 45%);
59:  --awp-body-gradient-2: radial-gradient(circle at 80% 10%, rgba(99, 102, 241, 0.1), transparent 35%);
60:  --awp-body-gradient-3: radial-gradient(circle at 20% 90%, rgba(16, 185, 129, 0.14), transparent 40%);
61:  --awp-body-gradient-4: linear-gradient(160deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
173:  --awp-body-bg: #05070c;
174:  --awp-body-bg-secondary: #0a1120;
175:  --awp-body-gradient-1: radial-gradient(circle at 12% 18%, rgba(56, 189, 248, 0.12), transparent 45%);
176:  --awp-body-gradient-2: radial-gradient(circle at 80% 10%, rgba(99, 102, 241, 0.12), transparent 35%);
177:  --awp-body-gradient-3: radial-gradient(circle at 20% 90%, rgba(14, 116, 144, 0.2), transparent 40%);
178:  --awp-body-gradient-4: linear-gradient(160deg, #05070c 0%, #0a1120 50%, #05070c 100%);
291:    --awp-body-bg: #05070c;
292:    --awp-body-bg-secondary: #0a1120;
293:    --awp-body-gradient-1: radial-gradient(circle at 12% 18%, rgba(56, 189, 248, 0.12), transparent 45%);
294:    --awp-body-gradient-2: radial-gradient(circle at 80% 10%, rgba(99, 102, 241, 0.12), transparent 35%);
295:    --awp-body-gradient-3: radial-gradient(circle at 20% 90%, rgba(14, 116, 144, 0.2), transparent 40%);
296:    --awp-body-gradient-4: linear-gradient(160deg, #05070c 0%, #0a1120 50%, #05070c 100%);
413:  background-color: var(--awp-body-bg);
414:  background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Reviewing React theme and portal updates**
exec
/bin/zsh -lc 'rg -n "portalRoot" react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 60ms:
877:export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
2425:      {isOpen && portalRoot
2946:            portalRoot
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Reviewing and confirming React theme and portal updates**
exec
/bin/zsh -lc 'git status -sb' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 85ms:
## main...origin/main
 M .t2/state.json
 M react/index.html
 M react/src/App.jsx
 M react/src/index.css
 M react/src/main.jsx
 M react/src/theme.js
 M react/tailwind.config.js
?? .logs/M04-05.gitcommit.txt
?? .plans/M04-06.md
?? .t2/handoff/M04-06.md
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Verifying React portal and CSS updates**
exec
/bin/zsh -lc 'rg -n "data-theme" react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
125::host([data-theme='dark']) {
243:  :host(:not([data-theme])) {
373:  :host([data-theme='dark']) {
386:  :host(:not([data-theme])) {
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Finalizing React portal and theme integration**

I'm reviewing many updates that ensure `createPortal` uses `portalRoot` correctly within the shadow DOM, that theming applies consistently via `themeRoot` and shadow root hosts, and that CSS uses `:host` selectors properly to avoid leaks. The changes also confirm that styles and modals are mounted inside the shadow root, with careful attention to indentation and stable references to elements like `portalRoot` and `themeRoot`. Everything looks aligned now for smooth portal rendering and theme application without global side effects.
exec
/bin/zsh -lc 'rg -n "getComposedTarget|getActiveElement" react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 49ms:
353:const getComposedTarget = (event) => {
366:const getActiveElement = (shadowRoot) => {
1422:    const activeElement = getActiveElement(shadowRoot);
1702:      const target = getComposedTarget(event);
1755:      const activeElement = getActiveElement(shadowRoot);
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Checking applyTheme usage in App**
exec
/bin/zsh -lc 'rg -n "applyTheme" react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 45ms:
8:  applyTheme,
973:    applyTheme(resolvedTheme, themeRoot);
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Verifying existence of themeRoot constant**
exec
/bin/zsh -lc 'rg -n "themeRoot" react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 63ms:
928:  const themeRoot =
961:    if (!themeRoot) {
965:      themeRoot.classList.add('awp-theme-transition');
970:        themeRoot.classList.remove('awp-theme-transition');
973:    applyTheme(resolvedTheme, themeRoot);
980:  }, [resolvedTheme, themeRoot]);
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Reviewing final integration and cleanup**
exec
/bin/zsh -lc "rg -n \"applyTheme\\(\" -S react/src" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
react/src/App.jsx:973:    applyTheme(resolvedTheme, themeRoot);
react/src/main.jsx:51:  applyTheme(resolvedTheme, hostElement);
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Reviewing CSS theme color-scheme settings**
exec
/bin/zsh -lc "sed -n '220,260p' react/src/index.css" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
  --awp-danger-strong-border: #f87171;
  --awp-danger-strong-hover: #dc2626;
  --awp-danger-strong-hover-border: #fca5a5;
  --awp-danger-strong-text: #ffffff;

  --awp-chart-primary: #38bdf8;
  --awp-chart-secondary: #a78bfa;
  --awp-chart-bar-primary: #38bdf8;
  --awp-chart-bar-secondary: #64748b;
  --awp-chart-doughnut-1: #38bdf8;
  --awp-chart-doughnut-2: #22c55e;
  --awp-chart-doughnut-3: #f59e0b;
  --awp-chart-doughnut-4: #f97316;
  --awp-chart-text: #e2e8f0;
  --awp-chart-muted: #94a3b8;
  --awp-chart-grid: rgba(148, 163, 184, 0.2);
  --awp-chart-tooltip-bg: #0f172a;
  --awp-chart-tooltip-border: rgba(148, 163, 184, 0.4);
  --awp-chart-tooltip-text: #e2e8f0;
  --awp-chart-canvas: #111827;
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),


thinking
**Summarizing React shadow DOM and theming changes**

I’m putting together a final overview of all the key updates made to integrate shadow DOM mounting, scoped CSS, and modal portal handling within the React app. This covers modifications in `main.jsx`, `App.jsx`, CSS, Tailwind config, and the root HTML, along with notes on how to verify and potential risks or follow-ups.
codex
Status: NEEDS-REVIEW

Implemented shadow-root mounting and scoped styling for the command deck, with the modal now portaled into the shadow root and theme/hotkey handling adapted for shadow DOM.
- `react/src/main.jsx`: attach to `#agentwp-root`, inject inline Tailwind CSS into the shadow root, and pass `shadowRoot`/`portalRoot`/`themeTarget` into the app.
- `react/src/App.jsx`: apply theme to the host, use composed-path targets for the hotkey guard, trap focus using the shadow-root active element, and portal the modal via `createPortal`.
- `react/src/index.css`: scope theme variables to `:host`, move base background to `.agentwp-app`, remove Google font import, and add a system font stack plus shadow-root theme-transition selectors.
- `react/tailwind.config.js`, `react/index.html`: update font stacks and dev root id to `agentwp-root`.

How to verify (exact commands):
- None (no automated verification commands provided).

Risks / follow-ups:
- Manual QA still needed across the listed themes and admin customization plugins.
- Confirm `#agentwp-root` is rendered on target admin pages so the shadow mount always occurs.
file update:
diff --git a/react/index.html b/react/index.html
index 619c471c3250960449a3c809b0b8f83612805bb0..67af36fee6919b3a366b47a09af51ea7f7850927
--- a/react/index.html
+++ b/react/index.html
@@ -6,7 +6,7 @@
     <title>AgentWP Dev UI</title>
   </head>
   <body>
-    <div id="root"></div>
+    <div id="agentwp-root"></div>
     <script type="module" src="/src/main.jsx"></script>
   </body>
 </html>
diff --git a/react/src/App.jsx b/react/src/App.jsx
index a8cc2f9dfc36d512940e6c19f79e4cffd19a9219..b6699ab469f24704bce63f5c1fb04aa3d33c2b00
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,5 @@
 import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
 import HistoryPanel from '../components/HistoryPanel.jsx';
@@ -349,6 +350,29 @@
   return Boolean(target.closest('[contenteditable="true"]'));
 };
 
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const getActiveElement = (shadowRoot) => {
+  if (shadowRoot && shadowRoot.activeElement) {
+    return shadowRoot.activeElement;
+  }
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.activeElement;
+};
+
 const getRestEndpoint = () => {
   if (typeof window === 'undefined') {
     return REST_PATH;
@@ -850,7 +874,7 @@
   );
 };
 
-export default function App() {
+export default function App({ shadowRoot = null, portalRoot = null, themeTarget = null }) {
   const [isOpen, setIsOpen] = useState(getInitialOpenState);
   const [prompt, setPrompt] = useState('');
   const [searchResults, setSearchResults] = useState(getEmptySearchResults);
@@ -901,6 +925,10 @@
     () => resolveTheme(themePreference, prefersDark),
     [prefersDark, themePreference]
   );
+  const themeRoot =
+    themeTarget ||
+    (shadowRoot ? shadowRoot.host : null) ||
+    (typeof document !== 'undefined' ? document.documentElement : null);
   const flatSuggestions = useMemo(() => {
     const items = [];
     SEARCH_TYPES.forEach((type) => {
@@ -930,27 +958,26 @@
   );
 
   useLayoutEffect(() => {
-    if (typeof document === 'undefined') {
+    if (!themeRoot) {
       return undefined;
     }
-    const root = document.documentElement;
     if (hasAppliedThemeRef.current) {
-      root.classList.add('awp-theme-transition');
+      themeRoot.classList.add('awp-theme-transition');
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
       themeTransitionRef.current = window.setTimeout(() => {
-        root.classList.remove('awp-theme-transition');
+        themeRoot.classList.remove('awp-theme-transition');
       }, THEME_TRANSITION_MS);
     }
-    applyTheme(resolvedTheme);
+    applyTheme(resolvedTheme, themeRoot);
     hasAppliedThemeRef.current = true;
     return () => {
       if (themeTransitionRef.current) {
         window.clearTimeout(themeTransitionRef.current);
       }
     };
-  }, [resolvedTheme]);
+  }, [resolvedTheme, themeRoot]);
 
   useEffect(() => {
     if (typeof window === 'undefined') {
@@ -1392,11 +1419,12 @@
   }, []);
 
   const openModal = useCallback(() => {
-    if (typeof document !== 'undefined') {
-      lastActiveRef.current = document.activeElement;
+    const activeElement = getActiveElement(shadowRoot);
+    if (activeElement) {
+      lastActiveRef.current = activeElement;
     }
     setIsOpen(true);
-  }, []);
+  }, [shadowRoot]);
 
   const closeModal = useCallback(() => {
     abortActiveRequest();
@@ -1671,7 +1699,8 @@
       if (event.key.toLowerCase() !== 'k') {
         return;
       }
-      if (event.defaultPrevented || isEditableTarget(event.target)) {
+      const target = getComposedTarget(event);
+      if (event.defaultPrevented || isEditableTarget(target)) {
         return;
       }
       event.preventDefault();
@@ -1723,8 +1752,8 @@
       }
       const first = focusable[0];
       const last = focusable[focusable.length - 1];
-      const activeElement = document.activeElement;
-      if (!modalRef.current?.contains(activeElement)) {
+      const activeElement = getActiveElement(shadowRoot);
+      if (!activeElement || !modalRef.current?.contains(activeElement)) {
         event.preventDefault();
         if (event.shiftKey) {
           last.focus();
@@ -1746,7 +1775,7 @@
 
     document.addEventListener('keydown', handleKeydown);
     return () => document.removeEventListener('keydown', handleKeydown);
-  }, [closeModal, isOpen]);
+  }, [closeModal, isOpen, shadowRoot]);
 
   useEffect(() => {
     return () => {
@@ -2273,7 +2302,7 @@
   const monthlyUsageLabel = usageLoading ? 'Updating...' : formatUsageCost(usageSummary.totalCostUsd);
 
   return (
-    <div className="min-h-screen text-slate-100">
+    <div className="agentwp-app min-h-screen text-slate-100">
       <main
         className="relative mx-auto flex min-h-screen max-w-5xl flex-col px-6 py-16 animate-fade-in motion-reduce:animate-none"
         aria-hidden={isOpen}
@@ -2393,7 +2422,8 @@
         </section>
       </main>
 
-      {isOpen && (
+      {isOpen && portalRoot
+        ? createPortal(
         <div
           className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 px-4 py-10 backdrop-blur-sm animate-fade-in motion-reduce:animate-none"
           role="presentation"
@@ -2912,8 +2942,10 @@
               </div>
             </div>
           </div>
-        </div>
-      )}
+        </div>,
+            portalRoot
+          )
+        : null}
     </div>
   );
 }
diff --git a/react/src/index.css b/react/src/index.css
index fbbf9b2259f50b2dc3ebe09929fc16e4067ade00..4eb8105ada3cff5c3a8d369dc805a91a37ef38cb
--- a/react/src/index.css
+++ b/react/src/index.css
@@ -1,11 +1,12 @@
-@import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
-
 @tailwind base;
 @tailwind components;
 @tailwind utilities;
 
-:root {
+:host {
   color-scheme: light;
+  display: block;
+  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
+  line-height: 1.5;
   --awp-bg-primary: #f8fafc;
   --awp-bg-secondary: #f1f5f9;
   --awp-text-primary: #0f172a;
@@ -121,8 +122,7 @@
   --awp-chart-canvas: #f1f5f9;
 }
 
-:root[data-theme='dark'],
-[data-theme='dark'] {
+:host([data-theme='dark']) {
   color-scheme: dark;
   --awp-bg-primary: #05070c;
   --awp-bg-secondary: #0a1120;
@@ -240,7 +240,7 @@
 }
 
 @media (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     color-scheme: dark;
     --awp-bg-primary: #05070c;
     --awp-bg-secondary: #0a1120;
@@ -359,7 +359,7 @@
 }
 
 @media (prefers-contrast: more) {
-  :root {
+  :host {
     --awp-text-primary: #0b1120;
     --awp-text-secondary: #1e293b;
     --awp-border: rgba(51, 65, 85, 0.75);
@@ -370,8 +370,7 @@
     --awp-chart-grid: rgba(51, 65, 85, 0.6);
   }
 
-  :root[data-theme='dark'],
-  [data-theme='dark'] {
+  :host([data-theme='dark']) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -384,7 +383,7 @@
 }
 
 @media (prefers-contrast: more) and (prefers-color-scheme: dark) {
-  :root:not([data-theme]) {
+  :host(:not([data-theme])) {
     --awp-text-primary: #f8fafc;
     --awp-text-secondary: #e2e8f0;
     --awp-border: rgba(226, 232, 240, 0.6);
@@ -396,32 +395,26 @@
   }
 }
 
-:root.awp-theme-transition,
-:root.awp-theme-transition * {
+:host(.awp-theme-transition),
+:host(.awp-theme-transition) * {
   transition: background-color 150ms ease, color 150ms ease, border-color 150ms ease,
     box-shadow 150ms ease, fill 150ms ease, stroke 150ms ease;
 }
 
 @media (prefers-reduced-motion: reduce) {
-  :root.awp-theme-transition,
-  :root.awp-theme-transition * {
+  :host(.awp-theme-transition),
+  :host(.awp-theme-transition) * {
     transition: none;
   }
 }
 
-body {
-  margin: 0;
+.agentwp-app {
   min-height: 100vh;
-  font-family: "Space Grotesk", "Manrope", system-ui, -apple-system, "Segoe UI", sans-serif;
   background-color: var(--awp-body-bg);
   background-image: var(--awp-body-gradient-1), var(--awp-body-gradient-2),
     var(--awp-body-gradient-3), var(--awp-body-gradient-4);
   background-attachment: fixed;
   color: var(--awp-text-primary);
-}
-
-#root {
-  min-height: 100vh;
 }
 
 .agentwp-markdown {
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 00ae35864c2926f7afe0e2f0c048b6960b2600ab..25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -2,17 +2,59 @@
 import ReactDOM from 'react-dom/client';
 import App from './App.jsx';
 import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import './index.css';
+import styles from './index.css?inline';
 import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
 
-const initialPreference = getInitialThemePreference();
-const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-applyTheme(resolvedTheme);
+const getHostElement = () => {
+  if (typeof document === 'undefined') {
+    return null;
+  }
+  return document.getElementById('agentwp-root') || document.getElementById('root');
+};
+
+const ensureShadowNode = (shadowRoot, selector, createNode) => {
+  const existing = shadowRoot.querySelector(selector);
+  if (existing) {
+    return existing;
+  }
+  const node = createNode();
+  shadowRoot.appendChild(node);
+  return node;
+};
+
+const mountShadowApp = (hostElement) => {
+  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
+  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
+    const style = document.createElement('style');
+    style.setAttribute('data-agentwp-shadow', 'true');
+    return style;
+  });
+  styleNode.textContent = styles;
+  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-shadow-root';
+    return container;
+  });
+  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
+    const container = document.createElement('div');
+    container.id = 'agentwp-portal-root';
+    return container;
+  });
+  return { shadowRoot, appRoot, portalRoot };
+};
+
+const hostElement = getHostElement();
+if (hostElement) {
+  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
+  const initialPreference = getInitialThemePreference();
+  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+  applyTheme(resolvedTheme, hostElement);
 
-ReactDOM.createRoot(document.getElementById('root')).render(
-  <React.StrictMode>
-    <ErrorBoundary>
-      <App />
-    </ErrorBoundary>
-  </React.StrictMode>
-);
+  ReactDOM.createRoot(appRoot).render(
+    <React.StrictMode>
+      <ErrorBoundary>
+        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+      </ErrorBoundary>
+    </React.StrictMode>
+  );
+}
diff --git a/react/src/theme.js b/react/src/theme.js
index 6674f56dc183a0a00f1e40c0d49b03247a135f30..16b34eda5ea85b5c93c290f8731b427d9d2d4b32
--- a/react/src/theme.js
+++ b/react/src/theme.js
@@ -50,11 +50,12 @@
   return systemTheme;
 };
 
-export const applyTheme = (theme) => {
-  if (typeof document === 'undefined') {
+export const applyTheme = (theme, target = null) => {
+  const root =
+    target || (typeof document !== 'undefined' ? document.documentElement : null);
+  if (!root) {
     return;
   }
-  const root = document.documentElement;
   root.dataset.theme = theme;
   root.style.colorScheme = theme;
 };
diff --git a/react/tailwind.config.js b/react/tailwind.config.js
index e0f50c246d02f488aa3e005fe25501576296ecae..18c7a543a7b5e1994db02828fc509db9743a0239
--- a/react/tailwind.config.js
+++ b/react/tailwind.config.js
@@ -6,8 +6,15 @@
   theme: {
     extend: {
       fontFamily: {
-        sans: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
-        display: ['"Space Grotesk"', '"Manrope"', 'system-ui', 'sans-serif'],
+        sans: ['system-ui', '-apple-system', '"Segoe UI"', '"Helvetica Neue"', 'Arial', 'sans-serif'],
+        display: [
+          'system-ui',
+          '-apple-system',
+          '"Segoe UI"',
+          '"Helvetica Neue"',
+          'Arial',
+          'sans-serif',
+        ],
       },
       colors: {
         white: withAlpha('--awp-white'),

tokens used
328,484
