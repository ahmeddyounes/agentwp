---

**Status: DONE**

## Summary of Changes

Created a standardized `ServiceResult` DTO and migrated three core services (refund, status, stock) to use it consistently.

### Files Created:
1. **`src/DTO/ServiceResult.php`** - New immutable value object for service results with:
   - Standard error codes (permission_denied, not_found, invalid_input, invalid_state, operation_failed, draft_expired, limit_exceeded)
   - Factory methods: `success()`, `failure()`, `permissionDenied()`, `notFound()`, `invalidInput()`, `invalidState()`, `draftExpired()`, `operationFailed()`
   - Two serialization methods: `toArray()` (new envelope format) and `toLegacyArray()` (backwards compatible)
   - Consistent structure: success, code, message, data, httpStatus

### Files Modified:
2. **`src/Services/OrderRefundService.php`** - Now returns ServiceResult
3. **`src/Services/OrderStatusService.php`** - Now returns ServiceResult
4. **`src/Services/ProductStockService.php`** - Now returns ServiceResult
5. **`src/Contracts/OrderRefundServiceInterface.php`** - Updated return types
6. **`src/Contracts/OrderStatusServiceInterface.php`** - Updated return types
7. **`src/Contracts/ProductStockServiceInterface.php`** - Updated return types
8. **`src/Intent/Handlers/OrderRefundHandler.php`** - Maps ServiceResult via `toLegacyArray()`
9. **`src/Intent/Handlers/OrderStatusHandler.php`** - Maps ServiceResult via `toLegacyArray()`
10. **`src/Intent/Handlers/ProductStockHandler.php`** - Maps ServiceResult via `toLegacyArray()`
11. **`tests/wp-env/mu-plugins/agentwp-test-tools.php`** - Updated to handle ServiceResult
12. **`tests/Unit/OrderRefundHandlerTest.php`** - Updated mock to return ServiceResult

## How to Verify

```bash
# Verify PHP syntax
php -l src/DTO/ServiceResult.php
php -l src/Services/OrderRefundService.php
php -l src/Services/OrderStatusService.php
php -l src/Services/ProductStockService.php

# Run unit tests
vendor/bin/phpunit

# Run PHPStan
vendor/bin/phpstan analyse src/DTO/ServiceResult.php src/Services/OrderRefundService.php src/Services/OrderStatusService.php src/Services/ProductStockService.php
```

All 344 tests pass, no PHPStan errors.

## Risks / Follow-ups

1. **Migration Path**: Other services not migrated yet should adopt `ServiceResult` incrementally
2. **API Envelope**: Currently using `toLegacyArray()` for backwards compatibility. Future work could switch to `toArray()` for a cleaner API envelope structure
3. **Error Codes**: Additional service-specific error codes may be needed as more services migrate
