---

## Status: DONE

## Summary of Changes

Created a new `ApiKeyStorage` service in `src/Security/ApiKeyStorage.php` that encapsulates all encrypt/decrypt/rotate/last4 operations for API keys. Refactored the following files to use the new service:

### New Files:
- **`src/Security/ApiKeyStorage.php`** - Dedicated service class with methods:
  - `store()` / `storePrimary()` / `storeDemo()` - Store encrypted API keys with last4
  - `retrieve()` / `retrievePrimary()` / `retrieveDemo()` - Retrieve and decrypt API keys
  - `delete()` / `deletePrimary()` / `deleteDemo()` - Delete stored keys
  - `rotate()` / `rotatePrimary()` / `rotateDemo()` - Re-encrypt with current salts
  - `getLast4()` / `getPrimaryLast4()` / `getDemoLast4()` - Get last 4 chars
  - `hasKey()` / `hasPrimaryKey()` / `hasDemoKey()` - Check if key exists
  - `extractLast4()` - Utility to extract last 4 characters

### Modified Files:
1. **`src/Providers/InfrastructureServiceProvider.php`** - Added registration for `Encryption` and `ApiKeyStorage` as singletons
2. **`src/Providers/CoreServiceProvider.php`** - Updated `SettingsManager` registration to optionally inject `ApiKeyStorage`
3. **`src/Rest/SettingsController.php`** - Removed direct `Encryption` instantiation, now uses `ApiKeyStorage` for all API key operations
4. **`src/Plugin/SettingsManager.php`** - Added optional `ApiKeyStorage` dependency, `getApiKey()`, `setApiKey()`, and `getDemoApiKey()` now use the service
5. **`src/Demo/Mode.php`** - Refactored to use `ApiKeyStorage` instead of direct `Encryption` instantiation
6. **`src/Demo/Resetter.php`** - Updated to use `ApiKeyStorage` with fallback for when container is unavailable

### Acceptance Criteria Met:
- ✅ No controller directly instantiates `Encryption` (only `InfrastructureServiceProvider` does)
- ✅ No controller manually manages last4 (delegated to `ApiKeyStorage`)
- ✅ `ApiKeyStorage` is wired via provider (registered in `InfrastructureServiceProvider`)

## How to Verify

```bash
# Run PHP syntax check
php -l src/Security/ApiKeyStorage.php

# Run unit tests
./vendor/bin/phpunit

# Run static analysis
./vendor/bin/phpstan analyse src/Security/ApiKeyStorage.php src/Rest/SettingsController.php src/Demo/Mode.php src/Plugin/SettingsManager.php --memory-limit=512M

# Verify no direct Encryption instantiation in controllers
grep -r "new Encryption()" src/ --include="*.php"
# Should only show: src/Providers/InfrastructureServiceProvider.php

# Verify Encryption import is only in provider
grep -r "use AgentWP\\\\Security\\\\Encryption" src/ --include="*.php"
# Should only show: src/Providers/InfrastructureServiceProvider.php
```

## Risks / Follow-ups

1. **Backward compatibility**: The `SettingsManager::setApiKey()` now encrypts the key before storing. If any code was passing pre-encrypted keys, it would double-encrypt. However, reviewing the codebase shows this method wasn't called anywhere, so risk is minimal.

2. **Container availability**: The `Demo/Mode`, `Demo/Resetter`, and `SettingsManager` have fallback behavior when the container/`ApiKeyStorage` is not available, ensuring they work during early bootstrap or in edge cases.

3. **No new tests added**: Consider adding unit tests for `ApiKeyStorage` to ensure encryption/decryption/rotation work correctly through the service abstraction.
