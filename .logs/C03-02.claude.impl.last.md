---

## Status: DONE

## Summary of changes

Refactored `SettingsController` to use container-resolved services instead of direct WordPress HTTP globals and `get_option` calls:

### New files created:
1. **`src/Contracts/OpenAIKeyValidatorInterface.php`** - Interface for OpenAI key validation
2. **`src/Infrastructure/OpenAIKeyValidator.php`** - Implementation using `HttpClientInterface` instead of `wp_remote_get`
3. **`tests/Unit/Infrastructure/OpenAIKeyValidatorTest.php`** - Unit tests for the validator

### Modified files:
1. **`src/Providers/InfrastructureServiceProvider.php`** - Registered `OpenAIKeyValidatorInterface` as a singleton bound to `OpenAIKeyValidator`
2. **`src/Rest/SettingsController.php`**:
   - Removed direct `wp_remote_get`/`vip_safe_wp_remote_get` calls
   - Removed the `validate_openai_api_key()` method
   - Added `getSettingsManager()` helper to resolve `SettingsManager` from container
   - Added `getOpenAIKeyValidator()` helper to resolve `OpenAIKeyValidatorInterface` from container
   - `read_settings()` now uses `SettingsManager::getAll()` instead of `get_option()`
   - `update_settings()` now uses `SettingsManager::update()` instead of `update_option()`
   - `update_api_key()` now uses the injected `OpenAIKeyValidatorInterface`

### Key improvements:
- Settings and key operations are now testable without WordPress HTTP globals
- `wp_remote_get` is no longer called directly in the controller
- Direct `new Encryption()` was already removed (ApiKeyStorage is container-resolved)
- Graceful fallbacks maintained when container services are unavailable

## How to verify

```bash
# Run the new validator tests
./vendor/bin/phpunit tests/Unit/Infrastructure/OpenAIKeyValidatorTest.php

# Run the full test suite
./vendor/bin/phpunit

# Check PHP syntax
php -l src/Contracts/OpenAIKeyValidatorInterface.php
php -l src/Infrastructure/OpenAIKeyValidator.php
php -l src/Rest/SettingsController.php
php -l src/Providers/InfrastructureServiceProvider.php
```

## Risks / follow-ups

1. **Graceful degradation**: The controller maintains fallback behavior when services are unavailable from the container (e.g., returns defaults from `SettingsManager::getDefaults()` if `SettingsManager` isn't resolved). This is intentional to prevent hard failures during edge cases.

2. **Validator skipping**: If `OpenAIKeyValidatorInterface` cannot be resolved from the container, API key validation is skipped (key will still be stored). This maintains backward compatibility but could be tightened if stricter validation is desired.

3. **Integration testing**: The unit tests cover the validator in isolation. Integration tests with the full WordPress REST API flow may be beneficial to verify end-to-end behavior.
