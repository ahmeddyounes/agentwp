---

## Status: DONE

## Summary of changes

Normalized `CustomerServiceInterface` and `CustomerService` to return `ServiceResult` instead of raw arrays, following the established pattern used by other services like `OrderStatusService`, `OrderRefundService`, etc.

### Files modified:

1. **`src/Contracts/CustomerServiceInterface.php`**
   - Added `use AgentWP\DTO\ServiceResult` import
   - Updated `handle()` method return type from `array` to `ServiceResult`

2. **`src/Services/CustomerService.php`**
   - Added `use AgentWP\DTO\ServiceResult` import
   - Updated `handle()` method to return `ServiceResult`
   - Changed error responses to use `ServiceResult::invalidInput()` for:
     - Missing WooCommerce: `ServiceResult::invalidInput('WooCommerce is required.')`
     - Missing identifier: `ServiceResult::invalidInput('Provide a customer ID or email.')`
   - Changed success response to use `ServiceResult::success()` with a descriptive message including the customer name/email

3. **`src/Intent/Handlers/CustomerLookupHandler.php`**
   - Updated `execute_tool()` to call `->toLegacyArray()` on the `ServiceResult` for backwards-compatible response format

4. **`tests/Unit/CustomerServiceTest.php`**
   - Updated existing test to work with `ServiceResult` instead of array
   - Added two new test cases for error handling:
     - `test_handle_returns_error_when_woocommerce_unavailable()`
     - `test_handle_returns_error_when_no_identifier_provided()`

5. **`tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php`**
   - Added `use AgentWP\DTO\ServiceResult` import
   - Updated mock to return `ServiceResult::success()` instead of raw array

## How to verify

```bash
# Run PHPStan on changed files
./vendor/bin/phpstan analyze --memory-limit=512M src/Contracts/CustomerServiceInterface.php src/Services/CustomerService.php src/Intent/Handlers/CustomerLookupHandler.php

# Run unit tests
./vendor/bin/phpunit tests/Unit/CustomerServiceTest.php
./vendor/bin/phpunit tests/Unit/Intent/Handlers/CustomerLookupHandlerTest.php

# Run all unit tests
./vendor/bin/phpunit tests/Unit/
```

## Risks / follow-ups

- **Low risk**: The `toLegacyArray()` method in `CustomerLookupHandler` maintains backwards compatibility with the existing tool execution format, so consumers should not notice any difference.
- **HTTP status codes**: Error responses now have proper HTTP status codes (400 for invalid input) mapped through `ServiceResult.httpStatus`, enabling uniform HTTP mapping across all services.
