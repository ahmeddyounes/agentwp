Status: DONE

Summary of changes
- Lazy-loaded the Command Deck app and ChartCard chunk, with Suspense fallbacks and a dedicated chart vendor chunk for on-demand loading (`react/src/main.jsx`, `react/components/cards/index.js`, `react/src/App.jsx`, `react/vite.config.js`).
- Tightened order query usage to return IDs, added result caps with truncation metadata, and introduced object-cache lookups for order summaries and product categories (`src/Handlers/OrderSearchHandler.php`, `src/Handlers/CustomerHandler.php`, `src/Intent/ContextBuilder.php`).
- Reduced OpenAI prompt payload size via pruning and cached tool schemas; analytics cache TTL aligned to 1 hour (`src/Handlers/EmailDraftHandler.php`, `src/AI/Functions/AbstractFunction.php`, `src/Handlers/AnalyticsHandler.php`).

How to verify
- No automated verification commands were provided.

Risks / follow-ups
- Customer metrics now sample up to 2000 orders; totals/ltv may be understated for very large customer histories.
- First Command Deck open now waits on async chunk load; confirm the 200ms open target in a production build.
- Analytics responses may be up to 1 hour stale due to the unified cache TTL.

OpenAI Codex v0.79.0 (research preview)
--------
workdir: /Users/ahmedyounis/Documents/Projects/agentwp
model: gpt-5.2-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019b9804-8fd4-7a21-b507-7ef5e9b0b633
--------
user
You are implementing task M05-04 in this git repository.

1) Read the spec: .plans/M05-04.md
2) Read handoff/context: .t2/handoff/M05-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

mcp startup: no servers

thinking
**Deciding how to read instructions**
exec
/bin/zsh -lc ls in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 32ms:
agentwp.php
assets
composer.json
docker
docker-compose.yml
docs
includes
languages
package.json
phpcs.xml
phpstan.neon
phpunit.xml.dist
playwright.config.cjs
react
README.md
scripts
SECURITY.md
setup.sh
src
tasks.csv

thinking
**Reviewing specification document**
exec
/bin/zsh -lc 'cat .plans/M05-04.md' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 65ms:
# M05-04 — Performance Optimization

Optimize for speed and efficiency: 1) PHP profiling using Query Monitor to identify slow queries. 2) Optimize WC_Order_Query usage: proper indexing hints, limit fields returned. 3) Implement query result caching: transients for analytics (1hr), object cache for repeated lookups. 4) Frontend bundle optimization: code splitting for chart library (load on demand), tree shaking, minification. 5) Lazy load Command Deck React app (don't load until first Cmd+K). 6) Asset loading: defer non-critical CSS, async JS. 7) Database query limits: cap results to prevent memory issues on large stores. 8) OpenAI request optimization: minimize prompt tokens, cache function schemas. Acceptance Criteria: Initial admin page load adds <100ms, Command Deck opens in <200ms, analytics queries return in <1s for 100k order stores, JS bundle <150KB gzipped.

thinking
**Preparing for handoff**
exec
/bin/zsh -lc 'cat .t2/handoff/M05-04.md' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
# Handoff: M05-04

Created: 2026-01-07T10:33:14.411701Z

Spec: .plans/M05-04.md

thinking
**Searching repository for relevant code**
exec
/bin/zsh -lc "rg -n \"Command Deck|cmd\\+k|cmdk|command deck|deck\" -S" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:
assets/agentwp-admin.js:649:							label: __('Command Deck Hotkey', 'agentwp'),
react/src/App.jsx:15:const OPEN_STATE_KEY = 'agentwp-command-deck-open';
react/src/App.jsx:27:  '[data-agentwp-command-deck]',
react/src/App.jsx:28:  '#agentwp-command-deck',
react/src/App.jsx:1086:      // Usage fetch failures should not block the command deck.
react/src/App.jsx:2315:            Command Deck: instant actions for your store.
react/src/App.jsx:2318:            Invoke the Command Deck with Cmd+K / Ctrl+K or the admin bar button. Responses render
react/src/App.jsx:2324:          <div className="rounded-2xl border border-deck-border bg-deck-surface/80 p-6 shadow-deck">
react/src/App.jsx:2335:              Open Command Deck
react/src/App.jsx:2345:          <div className="rounded-2xl border border-deck-border bg-deck-surface/60 p-6 text-sm text-slate-300 shadow-deck">
react/src/App.jsx:2346:            <h2 className="text-lg font-semibold text-white">Command Deck status</h2>
react/src/App.jsx:2356:          <div className="rounded-2xl border border-deck-border bg-deck-surface/70 p-6 shadow-deck">
react/src/App.jsx:2440:            aria-labelledby="agentwp-command-deck-title"
react/src/App.jsx:2441:            className="w-full max-w-[600px] rounded-3xl border border-deck-border bg-slate-900/90 shadow-deck backdrop-blur-xl animate-deck-in motion-reduce:animate-none"
react/src/App.jsx:2448:                <h2 id="agentwp-command-deck-title" className="text-lg font-semibold text-white">
react/src/App.jsx:2449:                  Command Deck
react/src/App.jsx:2467:                  aria-label="Close Command Deck"
react/src/App.jsx:2775:                      Visualize revenue trends and period performance inside the Command Deck.
tasks.csv:2:M00-01,"Technical Architecture Document","Create a comprehensive technical architecture document in Markdown format covering: 1) System overview diagram showing WordPress plugin structure, React frontend, PHP backend, and OpenAI API integration. 2) Database schema using only standard WooCommerce tables plus wp_options for settings (no custom tables). 3) REST API endpoint specification for /wp-json/agentwp/v1/* routes. 4) Security architecture for BYOK (Bring Your Own Key) with AES-256 encryption. 5) Data flow diagrams for the Draft-Confirm protocol. 6) Component hierarchy for React Command Deck. Save to /docs/ARCHITECTURE.md. Acceptance Criteria: Document covers all major subsystems, includes Mermaid diagrams, specifies all API endpoints with request/response schemas, and passes technical review."
tasks.csv:10:M01-06,"Command Deck Modal - Basic","Build the React modal interface (Command Deck) using React 18 and TailwindCSS: 1) Floating modal overlay with semi-transparent backdrop. 2) Trigger: global hotkey listener (Cmd+K Mac, Ctrl+K Windows), admin bar button click. 3) Visual style: Linear.app aesthetic, dark mode default, 600px max width, centered vertically. 4) Components: Omnibox (text input with placeholder 'Ask AgentWP anything...'), Stage (results area), Status Bar (latency + token cost). 5) Input handling: submit on Enter, close on Escape, focus trap within modal. 6) Loading state with skeleton animation. 7) Basic request/response flow to /agentwp/v1/intent endpoint. 8) Render markdown in responses using react-markdown. 9) Persist modal open state in session. Acceptance Criteria: Modal opens within 100ms of hotkey press, doesn't conflict with browser/OS shortcuts, closes cleanly without memory leaks, works across Chrome/Firefox/Safari/Edge, meets WCAG 2.1 AA accessibility."

thinking
**Searching for API and PHP components**
exec
/bin/zsh -lc 'rg -n "WC_Order_Query|Order_Query|wc_order_query" -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 81ms:
tasks.csv:12:M02-02,"Order Search and Retrieval","Implement natural language order search: 1) Create AgentWP\Handlers\OrderSearchHandler class. 2) OpenAI function schema: search_orders(query?: string, order_id?: int, email?: string, status?: string, date_range?: {start: string, end: string}, limit?: int). 3) Translate natural language to WC_Order_Query parameters: 'last order' → limit 1 + orderby date DESC, 'orders from john@...' → customer email filter, 'pending orders' → status filter. 4) Return simplified order objects: id, status, total, customer_name, customer_email, date_created, items_summary, shipping_address. 5) Cache recent queries in transients (1 hour TTL). 6) Support relative dates: 'yesterday', 'last week', 'this month'. Acceptance Criteria: 'Show me the last order' returns most recent order within 500ms, email search finds orders by billing/shipping email, date parsing handles common formats, cache reduces DB queries by 50%+ for repeated searches."
tasks.csv:32:M05-04,"Performance Optimization","Optimize for speed and efficiency: 1) PHP profiling using Query Monitor to identify slow queries. 2) Optimize WC_Order_Query usage: proper indexing hints, limit fields returned. 3) Implement query result caching: transients for analytics (1hr), object cache for repeated lookups. 4) Frontend bundle optimization: code splitting for chart library (load on demand), tree shaking, minification. 5) Lazy load Command Deck React app (don't load until first Cmd+K). 6) Asset loading: defer non-critical CSS, async JS. 7) Database query limits: cap results to prevent memory issues on large stores. 8) OpenAI request optimization: minimize prompt tokens, cache function schemas. Acceptance Criteria: Initial admin page load adds <100ms, Command Deck opens in <200ms, analytics queries return in <1s for 100k order stores, JS bundle <150KB gzipped."

thinking
**Considering src directory for analytics**
exec
/bin/zsh -lc 'rg -n "analytics|chart|revenue|orders" src includes react -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
src/Intent/IntentClassifier.php:34:			Intent::ANALYTICS_QUERY => $this->score_analytics( $text ),
src/Intent/IntentClassifier.php:134:	private function score_analytics( $text ) {
src/Intent/IntentClassifier.php:138:				'analytics',
src/Intent/IntentClassifier.php:141:				'revenue',
react/src/App.jsx:6:import { ChartCard, ErrorCard } from '../components/cards';
react/src/App.jsx:51:const SEARCH_TYPES = ['products', 'orders', 'customers'];
react/src/App.jsx:70:  orders: {
react/src/App.jsx:71:    label: 'Orders',
react/src/App.jsx:231:const buildRevenueSeries = (days, base, trend, variance, phase = 0) =>
react/src/App.jsx:247:const ANALYTICS_DATA = {
react/src/App.jsx:251:    current: buildRevenueSeries(7, 4200, 160, 420, 0.2),
react/src/App.jsx:252:    previous: buildRevenueSeries(7, 3900, 120, 360, 1.1),
react/src/App.jsx:254:      labels: ['Revenue', 'Shipping', 'Discounts', 'Returns'],
react/src/App.jsx:266:    current: buildRevenueSeries(30, 3800, 55, 520, 0.3),
react/src/App.jsx:267:    previous: buildRevenueSeries(30, 3600, 45, 480, 1.2),
react/src/App.jsx:269:      labels: ['Revenue', 'Shipping', 'Discounts', 'Returns'],
react/src/App.jsx:281:    current: buildRevenueSeries(90, 3500, 22, 620, 0.4),
react/src/App.jsx:282:    previous: buildRevenueSeries(90, 3300, 18, 560, 1.4),
react/src/App.jsx:284:      labels: ['Revenue', 'Shipping', 'Discounts', 'Returns'],
react/src/App.jsx:918:  const chartRef = useRef(null);

thinking
**Inspecting analytics handler**
exec
/bin/zsh -lc "sed -n '1,260p' src/Handlers/AnalyticsHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
<?php
/**
 * Handle sales analytics reports.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;
use AgentWP\Plugin;
use DateTimeImmutable;
use DateTimeZone;
use Exception;

class AnalyticsHandler {
	const CACHE_TTL_TODAY   = 300;
	const CACHE_TTL_DEFAULT = 3600;
	const TOP_LIMIT         = 5;

exec
/bin/zsh -lc "sed -n '260,620p' src/Handlers/AnalyticsHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
				{$parent_filter_sql}
				{$status_clause}
				AND lookup.product_id > 0
			GROUP BY lookup.product_id
			ORDER BY {$order_by} DESC
			LIMIT %d
		";

		$params[] = self::TOP_LIMIT;

		$rows = $wpdb->get_results( $wpdb->prepare( $sql, $params ), ARRAY_A );
		if ( empty( $rows ) ) {
			return array();
		}

		$results = array();
		foreach ( $rows as $row ) {
			$revenue = $this->normalize_amount( isset( $row['net_revenue'] ) ? $row['net_revenue'] : 0 );
			$results[] = array(
				'product_id' => absint( $row['product_id'] ),
exec
/bin/zsh -lc "sed -n '620,1000p' src/Handlers/AnalyticsHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 71ms:
			return (float) wc_format_decimal( $amount, $decimals );
		}

		return (float) round( $amount, $decimals );
	}

	/**
	 * @return int
	 */
	private function get_price_decimals() {
		if ( function_exists( 'wc_get_price_decimals' ) ) {
			return (int) wc_get_price_decimals();
		}

		return 2;
	}

	/**
	 * @param mixed $value Input.
	 * @return string

thinking
**Reviewing analytics query caching and limits**
exec
/bin/zsh -lc "sed -n '1,220p' src/Handlers/CustomerHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
<?php
/**
 * Handle customer profile requests.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;

class CustomerHandler {
	const RECENT_LIMIT = 5;
	const TOP_LIMIT    = 5;
	const ORDER_BATCH  = 200;

	/**
	 * Handle a customer profile request.
	 *
	 * @param array $args Request arguments.
exec
/bin/zsh -lc "sed -n '220,520p' src/Handlers/CustomerHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 65ms:
	private function build_customer_summary( array $normalized, array $recent_orders ) {
		$name  = '';
		$email = $normalized['email'];

		if ( $normalized['customer_id'] > 0 && function_exists( 'get_userdata' ) ) {
			$user = get_userdata( $normalized['customer_id'] );
			if ( $user ) {
				$first = isset( $user->first_name ) ? $user->first_name : '';
				$last  = isset( $user->last_name ) ? $user->last_name : '';
				$name  = trim( $first . ' ' . $last );
				if ( '' === $name && isset( $user->display_name ) ) {
					$name = (string) $user->display_name;
				}
				if ( '' === $email && isset( $user->user_email ) ) {
					$email = sanitize_email( $user->user_email );
				}
			}
		}

		if ( '' === $name && ! empty( $recent_orders ) && isset( $recent_orders[0]['customer_name'] ) ) {
exec
/bin/zsh -lc "sed -n '520,980p' src/Handlers/CustomerHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
	 * @param int|null $last_ts Last order timestamp.
	 * @return int|null
	 */
	private function calculate_days_since( $last_ts ) {
		if ( null === $last_ts ) {
			return null;
		}

		$now_ts  = $this->get_now_timestamp();
		$diff    = max( 0, $now_ts - $last_ts );
		$seconds = defined( 'DAY_IN_SECONDS' ) ? DAY_IN_SECONDS : 86400;

		return (int) floor( $diff / $seconds );
	}

	/**
	 * Simple 12-month projection based on orders per month and average order value.
	 *
	 * @param int      $total_orders Order count.
	 * @param float    $average_order_value Average order value.

thinking
**Evaluating order query limits**
exec
/bin/zsh -lc "sed -n '1,260p' src/Handlers/OrderSearchHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
<?php
/**
 * Handle order search requests.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;
use AgentWP\Plugin;
use DateTimeImmutable;
use DateTimeZone;
use Exception;

class OrderSearchHandler {
	const DEFAULT_LIMIT = 10;
	const CACHE_TTL     = 3600;

	/**
exec
/bin/zsh -lc "sed -n '260,620p' src/Handlers/OrderSearchHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 68ms:
			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
				continue;
			}
			$results[] = $this->format_order( $order );
		}

		return $results;
	}

	/**
	 * @param array $normalized Search params.
	 * @return array
	 */
	private function public_query_summary( array $normalized ) {
		return array(
			'order_id'   => $normalized['order_id'],
			'email'      => $normalized['email'],
			'status'     => $normalized['status'],
			'limit'      => $normalized['limit'],
			'date_range' => $normalized['date_range'],
exec
/bin/zsh -lc "sed -n '620,980p' src/Handlers/OrderSearchHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 72ms:
	 * @param DateTimeImmutable $start Start date.
	 * @param DateTimeImmutable $end End date.
	 * @return array
	 */
	private function format_date_range( DateTimeImmutable $start, DateTimeImmutable $end ) {
		return array(
			'start' => $start->format( 'Y-m-d H:i:s' ),
			'end'   => $end->format( 'Y-m-d H:i:s' ),
		);
	}

	/**
	 * @return DateTimeZone
	 */
	private function get_timezone() {
		if ( function_exists( 'wp_timezone' ) ) {
			return wp_timezone();
		}

		$timezone = '';

thinking
**Analyzing order query optimizations and caching**
exec
/bin/zsh -lc 'ls src/AI' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 75ms:
Functions
Model.php
OpenAIClient.php
Response.php
TokenCounter.php
exec
/bin/zsh -lc "sed -n '1,240p' src/AI/OpenAIClient.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
<?php
/**
 * OpenAI API client wrapper.
 *
 * @package AgentWP
 */

namespace AgentWP\AI;

use AgentWP\AI\Functions\FunctionSchema;
use AgentWP\Billing\UsageTracker;

class OpenAIClient {
	const API_BASE = 'https://api.openai.com/v1';

	/**
	 * @var string
	 */
	private $api_key;

exec
/bin/zsh -lc "sed -n '240,520p' src/AI/OpenAIClient.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
			$result = $this->send_request( $payload );
			$retry  = $result['retryable'];

			if ( $result['success'] || ! $retry || $attempt >= $this->max_retries ) {
				$errors = $result['error'];
				$error_code = isset( $result['error_code'] ) ? $result['error_code'] : '';
				$error_type = isset( $result['error_type'] ) ? $result['error_type'] : '';
				$retry_after = isset( $result['retry_after'] ) ? (int) $result['retry_after'] : 0;
				break;
			}

			$retry_after = $result['retry_after'];
			$this->sleep_with_backoff( $delay, $retry_after );
			$delay = min( $delay * 2, $this->max_delay );
			$attempt++;
		} while ( true );

		$result['retries']     = $attempt;
		$result['error']       = $errors;
		$result['error_code']  = $error_code;
exec
/bin/zsh -lc "sed -n '520,960p' src/AI/OpenAIClient.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:

			if ( isset( $delta['function_call'] ) && is_array( $delta['function_call'] ) ) {
				$tool_calls = $this->merge_tool_call_deltas(
					$tool_calls,
					array(
						array(
							'index'    => 0,
							'type'     => 'function',
							'function' => $delta['function_call'],
						),
					)
				);
			}
		}

		return array(
			'success'    => true,
			'error'      => '',
			'content'    => $content,
			'tool_calls' => array_values( $tool_calls ),

thinking
**Inspecting function schema location**
exec
/bin/zsh -lc "sed -n '1,240p' src/AI/Functions/FunctionSchema.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 53ms:
<?php
/**
 * Function schema interface.
 *
 * @package AgentWP
 */

namespace AgentWP\AI\Functions;

interface FunctionSchema {
	/**
	 * @return string
	 */
	public function get_name();

	/**
	 * @return string
	 */
	public function get_description();


thinking
**Checking function definitions in SearchOrders.php**
exec
/bin/zsh -lc "sed -n '1,200p' src/AI/Functions/SearchOrders.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 61ms:
<?php
/**
 * Function schema for order search.
 *
 * @package AgentWP
 */

namespace AgentWP\AI\Functions;

class SearchOrders extends AbstractFunction {
	public function get_name() {
		return 'search_orders';
	}

	public function get_description() {
		return 'Search for orders by query, ID, customer email, status, or date range.';
	}

	public function get_parameters() {
		return array(

thinking
**Contemplating term meaning**
exec
/bin/zsh -lc "sed -n '1,240p' src/AI/Functions/AbstractFunction.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 62ms:
<?php
/**
 * Base class for tool definitions.
 *
 * @package AgentWP
 */

namespace AgentWP\AI\Functions;

abstract class AbstractFunction implements FunctionSchema {
	/**
	 * @return array
	 */
	public function to_tool_definition() {
		return array(
			'type'     => 'function',
			'function' => array(
				'name'        => $this->get_name(),
				'description' => $this->get_description(),
				'parameters'  => $this->get_parameters(),
Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)

thinking
**Evaluating caching and code splitting strategies**
exec
/bin/zsh -lc "sed -n '1,220p' react/components/cards/ChartCard.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 63ms:
import { useEffect, useId, useMemo, useRef, useState } from 'react';
import {
  ArcElement,
  BarElement,
  CategoryScale,
  Chart as ChartJS,
  Filler,
  Legend,
  LineElement,
  LinearScale,
  PointElement,
  Tooltip,
} from 'chart.js';
import { Bar, Doughnut, Line } from 'react-chartjs-2';
import BaseCard from './BaseCard.jsx';

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
exec
/bin/zsh -lc "sed -n '220,520p' react/components/cards/ChartCard.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
            boxWidth: 8,
          },
        },
        tooltip: {
          backgroundColor: palette.tooltipBg,
          borderColor: palette.tooltipBorder,
          borderWidth: 1,
          titleColor: palette.tooltipText,
          bodyColor: palette.tooltipText,
          callbacks: tooltipCallbacks,
        },
      },
      scales: hasScales
        ? {
            x: {
              ticks: {
                color: palette.muted,
              },
              grid: {
                color: palette.grid,

thinking
**Planning dynamic import for ChartCard**
exec
/bin/zsh -lc 'cat react/package.json' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
{
  "name": "agentwp-react",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test": "jest --coverage"
  },
  "dependencies": {
    "chart.js": "^4.4.1",
    "html2canvas": "^1.4.1",
    "react": "^18.2.0",
    "react-chartjs-2": "^5.2.0",
    "react-dom": "^18.2.0",
    "react-markdown": "^9.0.1"
  },
  "devDependencies": {

thinking
**Planning lazy loading strategy**
exec
/bin/zsh -lc 'rg -n "agentwp-admin|enqueue|command deck|Command Deck|agentwp" src includes assets -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 84ms:
src/Billing/UsageTracker.php:16:	const TABLE          = 'agentwp_usage';
src/Billing/UsageTracker.php:18:	const VERSION_OPTION = 'agentwp_usage_version';
assets/agentwp-admin.css:1:.agentwp-admin {
assets/agentwp-admin.css:9:.agentwp-settings {
assets/agentwp-admin.css:13:.agentwp-settings__header {
assets/agentwp-admin.css:21:.agentwp-settings__actions {
assets/agentwp-admin.css:26:.agentwp-settings__grid {
assets/agentwp-admin.css:31:.agentwp-settings__full {
assets/agentwp-admin.css:35:.agentwp-settings__api-row {
assets/agentwp-admin.css:41:.agentwp-settings__api-action {
assets/agentwp-admin.css:46:.agentwp-settings__notice {
assets/agentwp-admin.css:50:.agentwp-settings__stats {
assets/agentwp-admin.css:55:.agentwp-settings__status-bar {
assets/agentwp-admin.css:66:.agentwp-settings__status-bar--warning {
assets/agentwp-admin.css:71:.agentwp-settings__status-bar--limit {
assets/agentwp-admin.css:76:.agentwp-settings__status-item {
assets/agentwp-admin.css:80:.agentwp-settings__status-label {
assets/agentwp-admin.css:88:.agentwp-settings__status-value {
assets/agentwp-admin.css:94:.agentwp-settings__status-sub {
assets/agentwp-admin.css:100:.agentwp-settings__stat {

thinking
**Inspecting plugin asset loading**
exec
/bin/zsh -lc "sed -n '1,260p' src/Plugin.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
<?php
/**
 * Core plugin bootstrap.
 *
 * @package AgentWP
 */

namespace AgentWP;

class Plugin {
	const OPTION_SETTINGS     = 'agentwp_settings';
	const OPTION_API_KEY      = 'agentwp_api_key';
	const OPTION_API_KEY_LAST4 = 'agentwp_api_key_last4';
	const OPTION_BUDGET_LIMIT = 'agentwp_budget_limit';
	const OPTION_DRAFT_TTL    = 'agentwp_draft_ttl_minutes';
	const OPTION_USAGE_STATS  = 'agentwp_usage_stats';
	const TRANSIENT_PREFIX    = 'agentwp_';

	/**
	 * @var Plugin|null
exec
/bin/zsh -lc "sed -n '260,620p' src/Plugin.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 66ms:
			$controller->register_routes();
		}

		if ( class_exists( 'AgentWP\\Rest\\HealthController' ) ) {
			$controller = new Rest\HealthController();
			$controller->register_routes();
		}

		if ( class_exists( 'AgentWP\\Rest\\SearchController' ) ) {
			$controller = new Rest\SearchController();
			$controller->register_routes();
		}

		if ( class_exists( 'AgentWP\\API\\HistoryController' ) ) {
			$controller = new API\HistoryController();
			$controller->register_routes();
		}

		if ( class_exists( 'AgentWP\\API\\ThemeController' ) ) {
			$controller = new API\ThemeController();

thinking
**Investigating plugin assets and React app**
exec
/bin/zsh -lc 'rg -n "agentwp-command-deck|command-deck|agentwp-root|agentwp" react/src -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 65ms:
react/src/theme.js:1:const THEME_STORAGE_KEY = 'agentwp-theme-preference';
react/src/theme.js:23:  return normalizeTheme(window.agentwpSettings?.theme);
react/src/main.jsx:12:  return document.getElementById('agentwp-root') || document.getElementById('root');
react/src/main.jsx:27:  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
react/src/main.jsx:29:    style.setAttribute('data-agentwp-shadow', 'true');
react/src/main.jsx:33:  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
react/src/main.jsx:35:    container.id = 'agentwp-shadow-root';
react/src/main.jsx:38:  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
react/src/main.jsx:40:    container.id = 'agentwp-portal-root';
react/src/index.css:411:.agentwp-app {
react/src/index.css:420:.agentwp-markdown {
react/src/index.css:426:.agentwp-markdown p {
react/src/index.css:430:.agentwp-markdown ul,
react/src/index.css:431:.agentwp-markdown ol {
react/src/index.css:435:.agentwp-markdown li {
react/src/index.css:439:.agentwp-markdown a {
react/src/index.css:444:.agentwp-markdown code {
react/src/index.css:452:.agentwp-markdown pre {
react/src/index.css:461:.agentwp-markdown pre code {
react/src/App.jsx:15:const OPEN_STATE_KEY = 'agentwp-command-deck-open';

thinking
**Planning lazy loading for Command Deck**
exec
/bin/zsh -lc 'ls assets' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 53ms:
agentwp-admin.css
agentwp-admin.js
index.php

thinking
**Investigating command deck location**
exec
/bin/zsh -lc 'rg -n "agentwp-app|command deck|command-deck|agentwp-root" src -S' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 55ms:


thinking
**Searching for plugin references**
exec
/bin/zsh -lc 'rg -n "agentwp-root|command-deck|deck" -S src includes' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 62ms:


thinking
**Inspecting React app integration**
exec
/bin/zsh -lc "sed -n '1,200p' assets/agentwp-admin.js" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 56ms:
(function () {
	'use strict';

	if (!window.wp || !wp.element || !wp.components || !wp.apiFetch) {
		return;
	}

	var apiFetch = wp.apiFetch;
	var config = window.agentwpSettings || {};

	if (config.nonce && apiFetch.createNonceMiddleware) {
		apiFetch.use(apiFetch.createNonceMiddleware(config.nonce));
	}

	if (config.root && apiFetch.createRootURLMiddleware) {
		apiFetch.use(apiFetch.createRootURLMiddleware(config.root));
	}

	var el = wp.element.createElement;
	var render = wp.element.render;

thinking
**Investigating command deck location**
exec
/bin/zsh -lc 'ls react' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
babel.config.cjs
components
index.html
jest.config.cjs
package.json
postcss.config.js
src
tailwind.config.js
tests
vite.config.js

thinking
**Investigating plugin integration and build process**
exec
/bin/zsh -lc "rg -n \"command deck|agentwp-root|agentwp-command-deck|cmd\\+k\" includes src -S" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 66ms:
src/Plugin.php:418:			'hotkey'            => 'Cmd+K / Ctrl+K',

thinking
**Evaluating asset loading and profiling options**
exec
/bin/zsh -lc "sed -n '1,200p' src/Intent/ContextBuilder.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
<?php
/**
 * Build enriched intent context.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

class ContextBuilder {
	/**
	 * Build context with store and user data.
	 *
	 * @param array $context Request context.
	 * @param array $metadata Request metadata.
	 * @return array
	 */
	public function build( array $context = array(), array $metadata = array() ) {
		return array(
			'request'       => $context,

thinking
**Evaluating performance optimizations for order queries**
exec
/bin/zsh -lc 'rg -n "system|prompt|messages|OpenAIClient|chat" src -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
src/Rest/IntentController.php:44:		$prompt = '';
src/Rest/IntentController.php:45:		if ( isset( $validation['prompt'] ) ) {
src/Rest/IntentController.php:46:			$prompt = (string) $validation['prompt'];
src/Rest/IntentController.php:49:		if ( '' === $prompt && isset( $validation['input'] ) ) {
src/Rest/IntentController.php:50:			$prompt = (string) $validation['input'];
src/Rest/IntentController.php:53:		$prompt = trim( $prompt );
src/Rest/IntentController.php:54:		if ( '' === $prompt ) {
src/Rest/IntentController.php:55:			return $this->response_error( 'agentwp_missing_prompt', __( 'Please provide a prompt.', 'agentwp' ), 400 );
src/Rest/IntentController.php:66:		$response = $engine->handle( $prompt, $context, $metadata );
src/Rest/IntentController.php:93:				'prompt'   => array(
src/Handlers/EmailDraftHandler.php:11:use AgentWP\AI\OpenAIClient;
src/Handlers/EmailDraftHandler.php:340:		$client   = new OpenAIClient(
src/Handlers/EmailDraftHandler.php:347:		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
src/Handlers/EmailDraftHandler.php:349:		$result = $client->chat( $messages, array() );
src/Handlers/EmailDraftHandler.php:473:	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
src/Handlers/EmailDraftHandler.php:477:		$summary      = $this->build_prompt_context( $context );
src/Handlers/EmailDraftHandler.php:479:		$system = sprintf(
src/Handlers/EmailDraftHandler.php:501:				'role'    => 'system',
src/Handlers/EmailDraftHandler.php:502:				'content' => $system,
src/Handlers/EmailDraftHandler.php:515:	private function build_prompt_context( array $context ) {

thinking
**Checking Intent Engine source**
exec
/bin/zsh -lc "sed -n '1,260p' src/Intent/Engine.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
<?php
/**
 * Intent engine for routing requests.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

use AgentWP\AI\Response;
use AgentWP\Intent\Handlers\AnalyticsQueryHandler;
use AgentWP\Intent\Handlers\CustomerLookupHandler;
use AgentWP\Intent\Handlers\EmailDraftHandler;
use AgentWP\Intent\Handlers\FallbackHandler;
use AgentWP\Intent\Handlers\OrderRefundHandler;
use AgentWP\Intent\Handlers\OrderSearchHandler;
use AgentWP\Intent\Handlers\OrderStatusHandler;
use AgentWP\Intent\Handlers\ProductStockHandler;

class Engine {

thinking
**Inspecting function registry**
exec
/bin/zsh -lc "sed -n '1,200p' src/Intent/FunctionRegistry.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
<?php
/**
 * OpenAI function registry for intent handlers.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

class FunctionRegistry {
	/**
	 * @var array<string, Handler>
	 */
	private $map = array();

	/**
	 * @param string  $function_name OpenAI function name.
	 * @param Handler $handler Handler instance.
	 * @return void
	 */

thinking
**Reviewing handler function usage**
exec
/bin/zsh -lc "sed -n '1,220p' src/Intent/Handlers/BaseHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
<?php
/**
 * Base handler for intent responses.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Intent\Handler;
use AgentWP\Intent\Intent;

abstract class BaseHandler implements Handler {
	/**
	 * @var string
	 */
	protected $intent;

	/**

thinking
**Inspecting OrderSearchHandler for OpenAI use**
exec
/bin/zsh -lc "sed -n '1,260p' src/Intent/Handlers/OrderSearchHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
<?php
/**
 * Handle order search intents.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Handlers\OrderSearchHandler as OrderSearchService;
use AgentWP\Intent\Intent;

class OrderSearchHandler extends BaseHandler {
	public function __construct() {
		parent::__construct( Intent::ORDER_SEARCH );
	}

	/**
	 * @param array $context Context data.

thinking
**Searching for OpenAIClient usage**
exec
/bin/zsh -lc 'rg -n "OpenAIClient" src -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 76ms:
src/Handlers/EmailDraftHandler.php:11:use AgentWP\AI\OpenAIClient;
src/Handlers/EmailDraftHandler.php:340:		$client   = new OpenAIClient(
src/AI/OpenAIClient.php:13:class OpenAIClient {

thinking
**Examining OpenAI usage in EmailDraftHandler**
exec
/bin/zsh -lc "sed -n '1,220p' src/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 70ms:
<?php
/**
 * Handle email draft preparation and editing.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Model;
use AgentWP\AI\OpenAIClient;
use AgentWP\AI\Response;
use AgentWP\Context\EmailContextBuilder;
use AgentWP\Intent\Intent;
use AgentWP\Plugin;
use AgentWP\Security\Encryption;

class EmailDraftHandler {
	const DRAFT_TYPE          = 'email_draft';
	const DEFAULT_TTL_MINUTES = 30;

thinking
**Navigating to build_prompt_messages area**
exec
/bin/zsh -lc "sed -n '300,620p' src/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
				'template_variables' => $template_variables,
				'expires_at'         => $expires_at,
			)
		);
	}

	/**
	 * @param array $context Order context.
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param string $custom_instructions Custom instructions.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
			return $draft;

thinking
**Reviewing prompt token use and function schema caching**
exec
/bin/zsh -lc "rg -n \"OpenAIClient|chat\\(\" src/Intent src/Handlers -S" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 84ms:
src/Handlers/EmailDraftHandler.php:11:use AgentWP\AI\OpenAIClient;
src/Handlers/EmailDraftHandler.php:340:		$client   = new OpenAIClient(
src/Handlers/EmailDraftHandler.php:349:		$result = $client->chat( $messages, array() );

thinking
**Analyzing order query optimization and caching strategies**

I'm exploring function schema caching for OpenAI usage and considering implementing static caches in relevant classes to avoid rebuilding schemas repeatedly. Also, I'm carefully reviewing WooCommerce order queries, thinking about limiting fields returned and capping order counts for performance on large stores. I’m weighing using `'return' => 'ids'` in queries combined with targeted order object fetching, plus possible indexing hints for database queries, to optimize analytics and customer-related handlers. There is a lot here to make order retrieval efficient without sacrificing accuracy or speed!
exec
/bin/zsh -lc "sed -n '380,520p' src/Search/Index.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
				'limit'  => $limit,
				'status' => array( 'publish', 'private' ),
				's'      => $query,
			);

			$products = wc_get_products( $args );
			if ( is_array( $products ) ) {
				foreach ( $products as $product ) {
					if ( ! $product || ! method_exists( $product, 'get_id' ) ) {
						continue;
					}
					$results[] = array(
						'type'           => 'products',
						'object_id'      => $product->get_id(),
						'primary_text'   => (string) $product->get_name(),
						'secondary_text' => (string) $product->get_sku(),
					);
					self::index_product( $product->get_id() );
				}
			}

thinking
**Planning caching and query limits**

I'm exploring how to implement caching for Search/Index lookups and repeated order retrievals, especially using WordPress object cache for order summaries to reduce redundant data fetches. I'll also add limits on order query sizes in CustomerHandler and OrderSearchHandler to prevent memory issues, capping them around 50 maximum. This seems to align well with the spec’s performance concerns.
exec
/bin/zsh -lc "sed -n '820,980p' src/Context/EmailContextBuilder.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:

		if ( is_array( $value ) ) {
			$list = $value;
		} else {
			$value = is_scalar( $value ) ? (string) $value : '';
			if ( '' === trim( $value ) ) {
				return array();
			}

			$list = preg_split( '/[\s,|]+/', $value );
		}

		$numbers = array();
		foreach ( $list as $entry ) {
			$entry = trim( (string) $entry );
			if ( '' === $entry ) {
				continue;
			}

			$numbers[ $entry ] = true;

thinking
**Searching for constant usage**
exec
/bin/zsh -lc 'rg -n "FALLBACK|ORDER|limit" src/Context/EmailContextBuilder.php' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 45ms:
13:	const FALLBACK_SPEND_CUTOFF  = 50;
183:		if ( 0.0 === $total_spent && $order_count > 0 && $order_count <= self::FALLBACK_SPEND_CUTOFF ) {
249:				'limit'    => self::RECENT_NOTES_LIMIT,
857:			'limit'    => 1,
895:			'limit'  => self::FALLBACK_SPEND_CUTOFF,

thinking
**Planning frontend bundle optimization and lazy loading**

I'm thinking about improving the frontend bundle by code splitting the chart library and lazy loading ChartCard with React.lazy and Suspense to reduce initial load. Also, I want to delay loading the Command Deck React app until triggered by a hotkey or button to optimize startup performance. I'll check main.jsx to adjust app mounting accordingly.
exec
/bin/zsh -lc "sed -n '1,200p' react/src/main.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 56ms:
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import ErrorBoundary from '../components/ErrorBoundary.jsx';
import styles from './index.css?inline';
import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';

const getHostElement = () => {
  if (typeof document === 'undefined') {
    return null;
  }
  return document.getElementById('agentwp-root') || document.getElementById('root');
};

const ensureShadowNode = (shadowRoot, selector, createNode) => {
  const existing = shadowRoot.querySelector(selector);
  if (existing) {
    return existing;
  }
  const node = createNode();

thinking
**Planning lazy loading of React app**
exec
/bin/zsh -lc "rg -n \"OPEN_STATE_KEY|hotkey|Cmd\\+K|Ctrl\\+K|keydown\" react/src/App.jsx -n" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 61ms:
15:const OPEN_STATE_KEY = 'agentwp-command-deck-open';
333:    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
1550:        window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
1552:        window.sessionStorage.removeItem(OPEN_STATE_KEY);
1714:    window.addEventListener('keydown', handleHotkey);
1715:    return () => window.removeEventListener('keydown', handleHotkey);
1776:    document.addEventListener('keydown', handleKeydown);
1777:    return () => document.removeEventListener('keydown', handleKeydown);
2318:            Invoke the Command Deck with Cmd+K / Ctrl+K or the admin bar button. Responses render
exec
/bin/zsh -lc "sed -n '1500,1760p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 43ms:
          signal: controller.signal,
        });

        const data = await response.json().catch(() => null);
        if (!response.ok || data?.success === false) {
          throw new Error(data?.error?.message || data?.message || 'Search unavailable.');
        }

        const payload = data?.data?.results || {};
        const nextResults = getEmptySearchResults();
        SEARCH_TYPES.forEach((type) => {
          nextResults[type] = Array.isArray(payload[type]) ? payload[type] : [];
        });

        setSearchResults(nextResults);
        setActiveSuggestionIndex(-1);
        setIsTypeaheadOpen(true);
      } catch (error) {
        if (error?.name === 'AbortError') {
          return;

thinking
**Evaluating app lazy-loading and session persistence**

I'm thinking through how to balance lazy-loading the app on the first hotkey with maintaining the open state saved in sessionStorage. I’m considering loading the app immediately on page load only if the session says it was open, even though that conflicts slightly with the "don't load until first Cmd+K" guideline. I want to keep performance in mind by deferring non-critical CSS and async JS loading, and I'll double-check build settings for minification and tree shaking to ensure efficient frontend bundling.
exec
/bin/zsh -lc 'cat react/vite.config.js' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 47ms:
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    host: true,
    port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
    strictPort: true,
  },
});

thinking
**Analyzing build config and async script loading**

I'm weighing Vite config tweaks to separate chart libraries into manual chunks for better bundling, considering dynamic imports but lacking builds to verify. For WordPress scripts, I'm exploring adding `async` or `defer` attributes via filters in the plugin PHP, mindful that `async` can break dependency order while `defer` maintains it. I’m considering setting `defer` on the admin script and possibly `async` on a new command deck script if introduced, though build assets are missing. Finally, I’m thinking about adding caching and order query limits in PHP handlers to improve repeated lookup efficiency and metadata querying, with plans to cap order ID counts and enforce limits.
exec
/bin/zsh -lc 'rg -n "wp_cache" src -S' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 47ms:


thinking
**Planning caching and optimization strategies**

I'm considering implementing object caching for order retrieval and summaries using WordPress's `wp_cache_get` and `wp_cache_set` with sensible TTLs to improve repeated lookups. I'll also explore caching function schemas in relevant classes and pruning empty context values to reduce prompt token usage. Additionally, I want to optimize database queries by limiting results, using efficient query parameters, and leveraging indexing hints. Lastly, I’m planning frontend performance improvements by code splitting chart libraries and lazy-loading the Command Deck React app, ensuring tests reflect these changes.
exec
/bin/zsh -lc "sed -n '1,120p' react/tests/App.test.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import App from '../src/App.jsx';

jest.mock('../components/cards', () => ({
  ChartCard: ({ title }) => <div data-testid="chart-card">{title}</div>,
  ErrorCard: ({ title }) => <div data-testid="error-card">{title}</div>,
}));

jest.mock('react-markdown', () => ({
  __esModule: true,
  default: ({ children }) => <div>{children}</div>,
}));

jest.mock('html2canvas', () => ({
  __esModule: true,
  default: jest.fn(() => Promise.resolve({})),
}));

describe('App', () => {

thinking
**Evaluating lazy loading ChartCard impact**
exec
/bin/zsh -lc 'cat react/components/cards/index.js' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
export { default as BaseCard } from './BaseCard.jsx';
export { default as DangerousActionCard } from './DangerousActionCard.jsx';
export { default as SuccessCard } from './SuccessCard.jsx';
export { default as ErrorCard } from './ErrorCard.jsx';
export { default as InfoCard } from './InfoCard.jsx';
export { default as ChartCard } from './ChartCard.jsx';
export { default as DataTableCard } from './DataTableCard.jsx';

thinking
**Planning React.lazy integration with Suspense**

I'm figuring out how to switch ChartCard to use React.lazy with Suspense for code-splitting in Vite. Since ChartCard appears multiple times in the analytics section, I'll likely wrap that entire block with Suspense and create a simple fallback component. I also need to verify how ChartCard relates to chart exporting and whether it's always rendered or can be lazy-loaded on demand.
exec
/bin/zsh -lc "sed -n '2700,2920p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 67ms:
                <div className="flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <p className="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">
                      Draft actions
                    </p>
                    <p className="text-sm text-slate-300">
                      Copy the latest draft or open it in your email client.
                    </p>
                  </div>
                  <div className="min-w-[200px]">
                    <label
                      htmlFor="agentwp-draft-subject"
                      className="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-500"
                    >
                      Email subject
                    </label>
                    <input
                      id="agentwp-draft-subject"
                      type="text"
                      value={draftSubject}

thinking
**Planning performance and caching improvements**

I'm mapping out how to lazily load ChartCard for better bundle size and exploring caching strategies across analytics and order handling to optimize repeated data access, limit queries to reduce memory use, and prune OpenAI prompts to cut token use—there’s a lot to balance here!
exec
/bin/zsh -lc "rg -n \"new .*Function|Functions\\\\\" src -S" in /Users/ahmedyounis/Documents/Projects/agentwp exited 2 in 51ms:
rg: regex parse error:
    (?:new .*Function|Functions\)
    ^
error: unclosed group

thinking
**Simplifying search terms**
exec
/bin/zsh -lc "rg -n \"Functions\\\\|get_sales_report|search_orders|prepare_refund|prepare_status_update\" src -S" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 58ms:
src/Handlers/RefundHandler.php:27:		return $this->prepare_refund( $args );
src/Handlers/RefundHandler.php:36:	public function prepare_refund( array $args ): Response {
src/AI/Functions/SearchOrders.php:12:		return 'search_orders';
src/AI/Functions/PrepareRefund.php:12:		return 'prepare_refund';
src/Handlers/OrderStatusHandler.php:32:		return $this->prepare_status_update( $args );
src/Handlers/OrderStatusHandler.php:41:	public function prepare_status_update( array $args ): Response {
src/Intent/Engine.php:176:			Intent::ORDER_SEARCH    => array( 'search_orders', 'select_orders' ),
src/Intent/Engine.php:177:			Intent::ORDER_REFUND    => array( 'prepare_refund', 'confirm_refund' ),
src/Intent/Engine.php:178:			Intent::ORDER_STATUS    => array( 'prepare_status_update', 'prepare_bulk_status_update', 'bulk_update' ),
src/AI/Functions/PrepareStatusUpdate.php:12:		return 'prepare_status_update';

thinking
**Planning caching and Query Monitor integration**
exec
/bin/zsh -lc 'rg -n "encode_json" -n src/Handlers/EmailDraftHandler.php' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 44ms:
489:			'Order context (JSON): ' . $this->encode_json( $summary ),
490:			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
1264:	private function encode_json( $value ) {
exec
/bin/zsh -lc "sed -n '1240,1320p' src/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 42ms:
		if ( function_exists( 'esc_html' ) ) {
			return esc_html( $value );
		}

		return htmlspecialchars( $value, ENT_QUOTES );
	}

	/**
	 * @param string $value Input value.
	 * @return string
	 */
	private function escape_url( $value ) {
		$value = is_string( $value ) ? $value : '';
		if ( function_exists( 'esc_url' ) ) {
			return esc_url( $value );
		}

		return htmlspecialchars( $value, ENT_QUOTES );
	}


thinking
**Designing function schema caching and lazy loading**

I'm thinking through caching function schemas using a static cache in AbstractFunction to optimize repeated calls without hurting subclasses with dynamic state. Also, I want to implement lazy loading for the Command Deck React app by dynamically importing modules at runtime, carefully handling default and named exports, and syncing open state with sessionStorage and admin triggers. This approach should keep initial load minimal while enabling smooth activation.
exec
/bin/zsh -lc "rg -n \"useState\\(|OPEN_STATE_KEY\" react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
15:const OPEN_STATE_KEY = 'agentwp-command-deck-open';
296:  const [prefersDark, setPrefersDark] = useState(() => {
333:    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
823:  const [status, setStatus] = useState('idle');
878:  const [isOpen, setIsOpen] = useState(getInitialOpenState);
879:  const [prompt, setPrompt] = useState('');
880:  const [searchResults, setSearchResults] = useState(getEmptySearchResults);
881:  const [isTypeaheadOpen, setIsTypeaheadOpen] = useState(false);
882:  const [isTypeaheadLoading, setIsTypeaheadLoading] = useState(false);
883:  const [activeSuggestionIndex, setActiveSuggestionIndex] = useState(-1);
884:  const [isPromptFocused, setIsPromptFocused] = useState(false);
885:  const [loading, setLoading] = useState(false);
886:  const [response, setResponse] = useState('');
887:  const [errorState, setErrorState] = useState(null);
888:  const [retryAttempt, setRetryAttempt] = useState(0);
889:  const [isOffline, setIsOffline] = useState(
892:  const [metrics, setMetrics] = useState({ latencyMs: null, tokenCost: null });
893:  const [usageSummary, setUsageSummary] = useState(DEFAULT_USAGE_SUMMARY);
894:  const [usageBaseline, setUsageBaseline] = useState(null);
895:  const [usageLoading, setUsageLoading] = useState(false);

thinking
**Checking for getInitialOpenState definition**
exec
/bin/zsh -lc "sed -n '300,360p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 76ms:
    return window.matchMedia('(prefers-color-scheme: dark)').matches;
  });

  useEffect(() => {
    if (!window.matchMedia) {
      return undefined;
    }
    const media = window.matchMedia('(prefers-color-scheme: dark)');
    const handleChange = (event) => {
      setPrefersDark(event.matches);
    };
    if (media.addEventListener) {
      media.addEventListener('change', handleChange);
    } else {
      media.addListener(handleChange);
    }
    return () => {
      if (media.removeEventListener) {
        media.removeEventListener('change', handleChange);
      } else {

thinking
**Designing lazy loading and event handling**
exec
/bin/zsh -lc "sed -n '220,300p' react/components/cards/cards.css" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
  font-size: 1.8rem;
  font-weight: 600;
}

.agentwp-card__trend {
  font-size: 0.85rem;
  padding: 0.15rem 0.5rem;
  border-radius: 999px;
  background: var(--card-accent-soft);
  color: var(--card-accent);
  font-weight: 600;
}

.agentwp-card__chart {
  background: var(--card-surface-muted);
  border-radius: 14px;
  padding: 0.75rem;
}

.agentwp-card__chart-meta {

thinking
**Considering fallback UI for charts**
exec
/bin/zsh -lc 'rg -n "isOpen" react/src/App.jsx | head' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
878:  const [isOpen, setIsOpen] = useState(getInitialOpenState);
1181:    if (!isOpen || typeof window === 'undefined') {
1195:  }, [checkHealth, isOpen]);
1549:      if (isOpen) {
1557:  }, [isOpen]);
1657:    if (!isOpen) {
1665:  }, [isOpen]);
1668:    if (!isOpen) {
1675:  }, [isOpen]);
1678:    if (isOpen) {

thinking
**Checking modal rendering and isOpen usage**
exec
/bin/zsh -lc 'rg -n "dialog" -n react/src/App.jsx' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
2438:            role="dialog"
exec
/bin/zsh -lc "sed -n '2280,2520p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 49ms:
  const trendLabel = `${revenueDelta >= 0 ? '+' : ''}${(revenueDelta * 100).toFixed(1)}% vs last period`;
  const chartBars = [72, 98, 84, 124, 96, 112, 78];
  const chartLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const usageTone =
    budgetStatus.level === 'limit'
      ? 'border-rose-500/70 bg-rose-500/10'
      : budgetStatus.level === 'warning'
        ? 'border-amber-400/70 bg-amber-400/10'
        : 'border-slate-800/80 bg-slate-950/40';
  const budgetFillTone =
    budgetStatus.level === 'limit'
      ? 'bg-rose-400'
      : budgetStatus.level === 'warning'
        ? 'bg-amber-400'
        : 'bg-emerald-400';
  const budgetMessage =
    budgetLimit && budgetStatus.level === 'limit'
      ? 'Monthly budget limit reached. Consider pausing drafts or raising the limit.'
      : budgetLimit && budgetStatus.level === 'warning'
        ? 'Approaching monthly budget limit. Usage is above 80%.'


thinking
**Planning caching and lazy loading improvements**

I’m mapping out caching strategies across multiple handlers to optimize performance and reduce redundant queries, including object cache for orders and product categories. I’m also designing React lazy loading for the ChartCard with a Suspense fallback of placeholder charts to improve user experience. Plus, I’m rewriting `main.jsx` to load the App dynamically on command deck activation, avoiding initial load costs. This involves careful handling of sessionStorage flags and import promises to ensure smooth mounting without redundant loads.
thinking
**Finalizing dynamic loading and cache setups**

I’m refining the dynamic loading logic for the command deck, ensuring proper event listener management, safe handling when the host element is missing, and React rendering with dynamic imports. Also planning to implement object caching in key handlers, update cache time-to-live, and optimize build chunking for chart libraries. Adjusting App.jsx to use Suspense fallback and confirming Jest mocks will work with the new lazy ChartCard.
exec
/bin/zsh -lc "sed -n '1,80p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
import { createPortal } from 'react-dom';
import html2canvas from 'html2canvas';
import ReactMarkdown from 'react-markdown';
import HistoryPanel from '../components/HistoryPanel.jsx';
import { ChartCard, ErrorCard } from '../components/cards';
import {
  applyTheme,
  getInitialThemePreference,
  getServerTheme,
  resolveTheme,
  THEME_STORAGE_KEY,
} from './theme.js';

const OPEN_STATE_KEY = 'agentwp-command-deck-open';
const DRAFT_HISTORY_KEY = 'agentwp-draft-history';
const MAX_DRAFT_HISTORY = 10;
const COMMAND_HISTORY_KEY = 'agentwp-command-history';
const COMMAND_FAVORITES_KEY = 'agentwp-command-favorites';
const COMMAND_USAGE_KEY = 'agentwp-command-usage';

thinking
**Preparing imports and patch setup**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/AnalyticsHandler.php
@@ -16,3 +16,3 @@
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
apply_patch(auto_approved=true) exited 0 in 25ms:
Success. Updated the following files:
M src/Handlers/AnalyticsHandler.php
file update:
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 

file update:
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 


thinking
**Updating AbstractFunction caching**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/AI/Functions/AbstractFunction.php
@@ -11,2 +11,7 @@
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
@@ -14,3 +19,8 @@
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
@@ -23,2 +33,6 @@
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
apply_patch(auto_approved=true) exited 0 in 31ms:
Success. Updated the following files:
M src/AI/Functions/AbstractFunction.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 


thinking
**Preparing OrderSearchHandler patch**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/OrderSearchHandler.php
@@ -18,2 +18,5 @@
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
@@ -85,2 +88,8 @@
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
@@ -214,2 +223,7 @@
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
@@ -226,2 +240,3 @@
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
@@ -252,4 +267,4 @@
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
@@ -258,6 +273,13 @@
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
@@ -287,2 +309,10 @@
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
@@ -291,3 +321,3 @@
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
@@ -301,2 +331,38 @@
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
apply_patch(auto_approved=true) exited 0 in 38ms:
Success. Updated the following files:
M src/Handlers/OrderSearchHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**


thinking
**Preparing to patch CustomerHandler**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/CustomerHandler.php
@@ -15,2 +15,5 @@
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
apply_patch(auto_approved=true) exited 0 in 46ms:
Success. Updated the following files:
M src/Handlers/CustomerHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..b09df1f6cc6f96ce198ce129cfe93144beda2434
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..b09df1f6cc6f96ce198ce129cfe93144beda2434
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**


thinking
**Updating handle to use array results**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/CustomerHandler.php
@@ -36,3 +36,4 @@
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
@@ -47,2 +48,5 @@
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
apply_patch(auto_approved=true) exited 0 in 43ms:
Success. Updated the following files:
M src/Handlers/CustomerHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..75e83c7034ea757830906f2fafa1627934cc0bb2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..75e83c7034ea757830906f2fafa1627934cc0bb2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**


thinking
**Updating collect_order_ids method**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/CustomerHandler.php
@@ -85,2 +85,4 @@
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
@@ -93,8 +95,11 @@
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
@@ -105,3 +110,5 @@
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
@@ -114,3 +121,11 @@
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
@@ -121,6 +136,10 @@
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
@@ -133,2 +152,4 @@
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
@@ -147,2 +168,8 @@
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
apply_patch(auto_approved=true) exited 0 in 57ms:
Success. Updated the following files:
M src/Handlers/CustomerHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..685b636123dd4e3bfd90047c5bbec0d2e16094e4
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..685b636123dd4e3bfd90047c5bbec0d2e16094e4
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**


thinking
**Adjusting code indentation and order logic**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/CustomerHandler.php
@@ -299,2 +299,3 @@
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
@@ -307,4 +308,4 @@
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
@@ -313,4 +314,5 @@
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
apply_patch(auto_approved=true) exited 0 in 43ms:
Success. Updated the following files:
M src/Handlers/CustomerHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..542cb2339ab1a9a1f7141fde8dfa68e1106da520
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..542cb2339ab1a9a1f7141fde8dfa68e1106da520
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**


thinking
**Enhancing product categories caching**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/CustomerHandler.php
@@ -486,2 +486,10 @@
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
@@ -500,2 +508,5 @@
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
apply_patch(auto_approved=true) exited 0 in 51ms:
Success. Updated the following files:
M src/Handlers/CustomerHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**


thinking
**Updating ContextBuilder return value**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Intent/ContextBuilder.php
@@ -61,2 +61,3 @@
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
@@ -69,4 +70,5 @@
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
apply_patch(auto_approved=true) exited 0 in 50ms:
Success. Updated the following files:
M src/Intent/ContextBuilder.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Modifying EmailDraftHandler to prune payloads**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/EmailDraftHandler.php
@@ -473,6 +473,7 @@
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
@@ -489,3 +490,3 @@
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
apply_patch(auto_approved=true) exited 0 in 61ms:
Success. Updated the following files:
M src/Handlers/EmailDraftHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..20c97e27b15b6771d93cb73aa59dd0613546494a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..20c97e27b15b6771d93cb73aa59dd0613546494a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Adding prune method after build_prompt_context**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/EmailDraftHandler.php
@@ -542,2 +542,37 @@
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
apply_patch(auto_approved=true) exited 0 in 68ms:
Success. Updated the following files:
M src/Handlers/EmailDraftHandler.php
file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Reviewing and updating handlers and components**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/components/cards/index.js
@@ -1 +1,3 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
@@ -5,3 +7,3 @@
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
apply_patch(auto_approved=true) exited 0 in 67ms:
Success. Updated the following files:
M react/components/cards/index.js
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Updating React import and adding Suspense fallback**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -1,2 +1,10 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
apply_patch(auto_approved=true) exited 0 in 74ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e60b6535dd4aa99adcf681d5c5e01f59eb187993
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e60b6535dd4aa99adcf681d5c5e01f59eb187993
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Planning fallback component insertion**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -61,2 +61,33 @@
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
apply_patch(auto_approved=true) exited 0 in 76ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..54bb811f6fcf647ddb62f766f6841f9193a1fc6b
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..54bb811f6fcf647ddb62f766f6841f9193a1fc6b
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Wrapping ChartCard with Suspense**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/App.jsx
@@ -2837,60 +2837,62 @@
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
apply_patch(auto_approved=true) exited 0 in 83ms:
Success. Updated the following files:
M react/src/App.jsx
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Preparing main.jsx lazy loading rewrite**
file update
D /Users/ahmedyounis/Documents/Projects/agentwp/react/src/main.jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import ErrorBoundary from '../components/ErrorBoundary.jsx';
import styles from './index.css?inline';
import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';

const getHostElement = () => {
  if (typeof document === 'undefined') {
    return null;
  }
  return document.getElementById('agentwp-root') || document.getElementById('root');
};

const ensureShadowNode = (shadowRoot, selector, createNode) => {
  const existing = shadowRoot.querySelector(selector);
  if (existing) {
    return existing;
  }
  const node = createNode();
  shadowRoot.appendChild(node);
  return node;
};

const mountShadowApp = (hostElement) => {
  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
    const style = document.createElement('style');
    style.setAttribute('data-agentwp-shadow', 'true');
    return style;
  });
  styleNode.textContent = styles;
  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
    const container = document.createElement('div');
    container.id = 'agentwp-shadow-root';
    return container;
  });
  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
    const container = document.createElement('div');
    container.id = 'agentwp-portal-root';
    return container;
  });
  return { shadowRoot, appRoot, portalRoot };
};

const hostElement = getHostElement();
if (hostElement) {
  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
  const initialPreference = getInitialThemePreference();
  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
  applyTheme(resolvedTheme, hostElement);

  ReactDOM.createRoot(appRoot).render(
    <React.StrictMode>
      <ErrorBoundary>
        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
      </ErrorBoundary>
    </React.StrictMode>
  );
}
apply_patch(auto_approved=true) exited 0 in 78ms:
Success. Updated the following files:
D react/src/main.jsx
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
deleted file mode 100644
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..0000000000000000000000000000000000000000
--- a/react/src/main.jsx
+++ /dev/null
@@ -1,60 +0,0 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
-
-const getHostElement = () => {
-  if (typeof document === 'undefined') {
-    return null;
-  }
-  return document.getElementById('agentwp-root') || document.getElementById('root');
-};
-
-const ensureShadowNode = (shadowRoot, selector, createNode) => {
-  const existing = shadowRoot.querySelector(selector);
-  if (existing) {
-    return existing;
-  }
-  const node = createNode();
-  shadowRoot.appendChild(node);
-  return node;
-};
-
-const mountShadowApp = (hostElement) => {
-  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
-  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
-    const style = document.createElement('style');
-    style.setAttribute('data-agentwp-shadow', 'true');
-    return style;
-  });
-  styleNode.textContent = styles;
-  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
-    const container = document.createElement('div');
-    container.id = 'agentwp-shadow-root';
-    return container;
-  });
-  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
-    const container = document.createElement('div');
-    container.id = 'agentwp-portal-root';
-    return container;
-  });
-  return { shadowRoot, appRoot, portalRoot };
-};
-
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
-
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
-}
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
deleted file mode 100644
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..0000000000000000000000000000000000000000
--- a/react/src/main.jsx
+++ /dev/null
@@ -1,60 +0,0 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
-
-const getHostElement = () => {
-  if (typeof document === 'undefined') {
-    return null;
-  }
-  return document.getElementById('agentwp-root') || document.getElementById('root');
-};
-
-const ensureShadowNode = (shadowRoot, selector, createNode) => {
-  const existing = shadowRoot.querySelector(selector);
-  if (existing) {
-    return existing;
-  }
-  const node = createNode();
-  shadowRoot.appendChild(node);
-  return node;
-};
-
-const mountShadowApp = (hostElement) => {
-  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
-  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
-    const style = document.createElement('style');
-    style.setAttribute('data-agentwp-shadow', 'true');
-    return style;
-  });
-  styleNode.textContent = styles;
-  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
-    const container = document.createElement('div');
-    container.id = 'agentwp-shadow-root';
-    return container;
-  });
-  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
-    const container = document.createElement('div');
-    container.id = 'agentwp-portal-root';
-    return container;
-  });
-  return { shadowRoot, appRoot, portalRoot };
-};
-
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
-
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
-}
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Adding new file with patch**
file update
A /Users/ahmedyounis/Documents/Projects/agentwp/react/src/main.jsx
const OPEN_STATE_KEY = 'agentwp-command-deck-open';
const ADMIN_TRIGGER_SELECTORS = [
  '#wp-admin-bar-agentwp',
  '[data-agentwp-command-deck]',
  '#agentwp-command-deck',
];

const getHostElement = () => {
  if (typeof document === 'undefined') {
    return null;
  }
  return document.getElementById('agentwp-root') || document.getElementById('root');
};

const ensureShadowNode = (shadowRoot, selector, createNode) => {
  const existing = shadowRoot.querySelector(selector);
  if (existing) {
    return existing;
  }
  const node = createNode();
  shadowRoot.appendChild(node);
  return node;
};

const mountShadowApp = (hostElement, styles) => {
  const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
  const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
    const style = document.createElement('style');
    style.setAttribute('data-agentwp-shadow', 'true');
    return style;
  });
  styleNode.textContent = styles;
  const appRoot = ensureShadowNode(shadowRoot, '#agentwp-shadow-root', () => {
    const container = document.createElement('div');
    container.id = 'agentwp-shadow-root';
    return container;
  });
  const portalRoot = ensureShadowNode(shadowRoot, '#agentwp-portal-root', () => {
    const container = document.createElement('div');
    container.id = 'agentwp-portal-root';
    return container;
  });
  return { shadowRoot, appRoot, portalRoot };
};

const isEditableTarget = (target) => {
  if (!(target instanceof HTMLElement)) {
    return false;
  }
  const tagName = target.tagName.toLowerCase();
  if (['input', 'textarea', 'select'].includes(tagName)) {
    return true;
  }
  if (target.isContentEditable) {
    return true;
  }
  return Boolean(target.closest('[contenteditable="true"]'));
};

const getComposedTarget = (event) => {
  if (!event) {
    return null;
  }
  if (typeof event.composedPath === 'function') {
    const path = event.composedPath();
    if (path && path.length > 0) {
      return path[0];
    }
  }
  return event.target;
};

const markOpenState = (isOpen) => {
  if (typeof window === 'undefined') {
    return;
  }
  try {
    if (isOpen) {
      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
    } else {
      window.sessionStorage.removeItem(OPEN_STATE_KEY);
    }
  } catch (error) {
    // Ignore storage failures (private mode, strict policies).
  }
};

const shouldAutoLoad = () => {
  if (typeof window === 'undefined') {
    return false;
  }
  try {
    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
  } catch (error) {
    return false;
  }
};

let appPromise = null;
let appLoaded = false;

const loadCommandDeck = async (openOnLoad = false) => {
  if (openOnLoad) {
    markOpenState(true);
  }

  if (appLoaded) {
    return null;
  }

  if (appPromise) {
    return appPromise;
  }

  const hostElement = getHostElement();
  if (!hostElement) {
    return null;
  }

  appPromise = (async () => {
    const [
      ReactModule,
      ReactDOM,
      AppModule,
      ErrorBoundaryModule,
      stylesModule,
      themeModule,
    ] = await Promise.all([
      import('react'),
      import('react-dom/client'),
      import('./App.jsx'),
      import('../components/ErrorBoundary.jsx'),
      import('./index.css?inline'),
      import('./theme.js'),
    ]);

    const { StrictMode } = ReactModule;
    const App = AppModule.default;
    const ErrorBoundary = ErrorBoundaryModule.default;
    const styles = stylesModule.default || '';
    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;

    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
    const initialPreference = getInitialThemePreference();
    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
    applyTheme(resolvedTheme, hostElement);

    ReactDOM.createRoot(appRoot).render(
      <StrictMode>
        <ErrorBoundary>
          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
        </ErrorBoundary>
      </StrictMode>
    );

    appLoaded = true;
    return null;
  })().finally(() => {
    appPromise = null;
  });

  return appPromise;
};

const handleHotkey = (event) => {
  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
    return;
  }
  if (event.key.toLowerCase() !== 'k') {
    return;
  }
  const target = getComposedTarget(event);
  if (event.defaultPrevented || isEditableTarget(target)) {
    return;
  }
  event.preventDefault();
  loadCommandDeck(true);
};

const handleAdminTrigger = (event) => {
  const target = event.target;
  if (!(target instanceof HTMLElement)) {
    return;
  }
  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
  if (!isTrigger) {
    return;
  }
  event.preventDefault();
  loadCommandDeck(true);
};

if (typeof window !== 'undefined' && typeof document !== 'undefined') {
  window.addEventListener('keydown', handleHotkey);
  document.addEventListener('click', handleAdminTrigger);

  if (shouldAutoLoad()) {
    loadCommandDeck(true);
  }
}
apply_patch(auto_approved=true) exited 0 in 88ms:
Success. Updated the following files:
A react/src/main.jsx
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..d2e128bd9bc9e6ec11a60a82ec97ce83509cc2e1
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,160 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+const handleAdminTrigger = (event) => {
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..d2e128bd9bc9e6ec11a60a82ec97ce83509cc2e1
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,160 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+const handleAdminTrigger = (event) => {
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Adjusting event handlers for app state**

I'm figuring out how to update hotkey and admin trigger handlers so that once the app is loaded, our handlers return early without preventing default, letting the app’s own listeners take over. For loading states, we’ll keep preventing default to avoid conflicts and unnecessary reloads. This should fix the issue where our early listener blocks app toggling after load. I'll modify main.jsx to implement these nuanced checks for appLoaded and appPromise.
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/src/main.jsx
@@ -165,2 +165,5 @@
 const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
   const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
@@ -182,2 +185,5 @@
 const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
   const target = event.target;
apply_patch(auto_approved=true) exited 0 in 86ms:
Success. Updated the following files:
M react/src/main.jsx
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Clarifying event handler flow and load conditions**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/react/vite.config.js
@@ -5,2 +5,11 @@
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
apply_patch(auto_approved=true) exited 0 in 87ms:
Success. Updated the following files:
M react/vite.config.js
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..c49c256fda24097bca7557a4101e6513ca551150
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Reviewing WooCommerce function checks**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Intent/ContextBuilder.php
@@ -52,3 +52,3 @@
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
apply_patch(auto_approved=true) exited 0 in 93ms:
Success. Updated the following files:
M src/Intent/ContextBuilder.php
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..2ca31519e88462c067ac7317422f2a009319cae2
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Improving function existence checks**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/CustomerHandler.php
@@ -290,3 +290,3 @@
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
apply_patch(auto_approved=true) exited 0 in 93ms:
Success. Updated the following files:
M src/Handlers/CustomerHandler.php
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)

thinking
**Reviewing caching, querying, and frontend optimizations**

I've checked caching strategies for order summaries and function schemas, confirmed query limits to avoid memory issues, and validated that query arguments like ordering and pagination behave correctly. I also ensured React components and bundling are updated for lazy loading and dynamic imports while confirming event handlers manage app state without conflicts. There’s careful consideration of caching keys, query truncation flags, and asset loading strategies to keep performance smooth and consistent.
exec
/bin/zsh -lc "sed -n '20,140p' src/Handlers/CustomerHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
	/**
	 * Handle a customer profile request.
	 *
	 * @param array $args Request arguments.
	 * @return Response
	 */
	public function handle( array $args ): Response {
		if ( ! function_exists( 'wc_get_orders' ) ) {
			return Response::error( 'WooCommerce is required to fetch customer profiles.', 400 );
		}

		$normalized = $this->normalize_args( $args );
		if ( 0 === $normalized['customer_id'] && '' === $normalized['email'] ) {
			return Response::error( 'Provide a customer ID or email address.', 400 );
		}

		$paid_statuses = $this->get_paid_statuses();
		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
		$order_ids     = $order_data['ids'];
		$metrics       = $this->build_metrics( $order_ids );
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Checking query_order_ids formatting**
exec
/bin/zsh -lc "sed -n '140,220p' src/Handlers/CustomerHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
		$limit = min( self::ORDER_BATCH, $remaining );
		if ( $limit <= 0 ) {
			$truncated = true;
			return $ids;
		}

		while ( true ) {
			$args = array_merge(
				$query_args,
				array(
					'limit'  => $limit,
					'paged'  => $page,
					'return' => 'ids',
					'orderby' => 'date',
					'order'   => 'DESC',
				)
			);

			$batch = wc_get_orders( $args );
			if ( ! is_array( $batch ) || empty( $batch ) ) {
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Adjusting method order and verifying syntax**
exec
/bin/zsh -lc "sed -n '1,120p' src/Handlers/OrderSearchHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 47ms:
<?php
/**
 * Handle order search requests.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;
use AgentWP\Plugin;
use DateTimeImmutable;
use DateTimeZone;
use Exception;

class OrderSearchHandler {
	const DEFAULT_LIMIT = 10;
	const CACHE_TTL     = 3600;
	const MAX_LIMIT     = 50;
	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Checking cache methods at bottom**
exec
/bin/zsh -lc "sed -n '230,380p' src/Handlers/OrderSearchHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 51ms:
			if ( $order ) {
				return array( $this->format_order( $order ) );
			}

			return array();
		}

		$query_args = array(
			'limit'   => $normalized['limit'],
			'orderby' => $normalized['orderby'],
			'order'   => $normalized['order'],
			'return'  => 'ids',
		);

		if ( '' !== $normalized['status'] ) {
			$query_args['status'] = $normalized['status'];
		}

		if ( is_array( $normalized['date_range'] ) ) {
			$query_args['date_created'] = $normalized['date_range']['start'] . '...' . $normalized['date_range']['end'];
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Updating app load handling and handlers**
exec
/bin/zsh -lc 'rg -n "cards.css" react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 61ms:

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Checking for CSS imports**
exec
/bin/zsh -lc 'head -n 20 react/src/index.css' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 33ms:
@tailwind base;
@tailwind components;
@tailwind utilities;

:host {
  color-scheme: light;
  display: block;
  font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
  line-height: 1.5;
  --awp-bg-primary: #f8fafc;
  --awp-bg-secondary: #f1f5f9;
  --awp-text-primary: #0f172a;
  --awp-text-secondary: #475569;
  --awp-accent: #0ea5e9;
  --awp-danger: #e11d48;
  --awp-success: #16a34a;
  --awp-border: rgba(148, 163, 184, 0.6);

  --awp-slate-950: 248 250 252;
  --awp-slate-900: 241 245 249;
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Investigating card CSS sources**
exec
/bin/zsh -lc 'rg -n "cards.css" react/components -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 36ms:
react/components/cards/BaseCard.jsx:2:import './cards.css';
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Analyzing BaseCard usage and CSS loading**
exec
/bin/zsh -lc 'rg -n "qm/|qm_" -S' in /Users/ahmedyounis/Documents/Projects/agentwp exited 1 in 56ms:

file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Reviewing code updates and integration details**

I'm weighing whether to add Query Monitor hooks for profiling but leaning toward just mentioning its compatibility since adding calls might be noisy. Meanwhile, I'm verifying recent React component updates with lazy loading and Suspense are consistent and ensuring PHP handlers handle caching and query limits correctly. There’s a lot going on with careful coordination between front-end lazy loading and back-end caching refinements—I'm curious if any unexpected edge cases might pop up.
exec
/bin/zsh -lc 'rg -n "<ChartCard|ChartCard" react/src react/components -S' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 69ms:
react/src/App.jsx:14:import { ChartCard, ErrorCard } from '../components/cards';
react/src/App.jsx:2840:                    <ChartCard
react/src/App.jsx:2860:                    <ChartCard
react/src/App.jsx:2878:                    <ChartCard
react/components/cards/index.js:8:export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
react/components/cards/ChartCard.jsx:132:export default function ChartCard({
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 


thinking
**Reviewing recent code updates and planning next steps**
exec
/bin/zsh -lc 'git status -sb' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 66ms:
## main...origin/main
 M .t2/state.json
 M react/components/cards/index.js
 M react/src/App.jsx
 M react/src/main.jsx
 M react/vite.config.js
 M src/AI/Functions/AbstractFunction.php
 M src/Handlers/AnalyticsHandler.php
 M src/Handlers/CustomerHandler.php
 M src/Handlers/EmailDraftHandler.php
 M src/Handlers/OrderSearchHandler.php
 M src/Intent/ContextBuilder.php
?? .logs/M05-03.gitcommit.txt
?? .plans/M05-04.md
?? .t2/handoff/M05-04.md
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 



thinking
**Reviewing multiple handler and React component updates**
thinking
**Summarizing key backend and React updates with verification notes**

I'll wrap up by outlining major changes including PHP caching improvements, React lazy loading with suspense, and prompt pruning optimizations. I’ll also note the impact on testing and verification steps since no automated commands were provided. This will help the user get a clear picture of what was done, risks involved, and what to look out for when verifying the updates.
codex
Status: DONE

Summary of changes
- Lazy-loaded the Command Deck app and ChartCard chunk, with Suspense fallbacks and a dedicated chart vendor chunk for on-demand loading (`react/src/main.jsx`, `react/components/cards/index.js`, `react/src/App.jsx`, `react/vite.config.js`).
- Tightened order query usage to return IDs, added result caps with truncation metadata, and introduced object-cache lookups for order summaries and product categories (`src/Handlers/OrderSearchHandler.php`, `src/Handlers/CustomerHandler.php`, `src/Intent/ContextBuilder.php`).
- Reduced OpenAI prompt payload size via pruning and cached tool schemas; analytics cache TTL aligned to 1 hour (`src/Handlers/EmailDraftHandler.php`, `src/AI/Functions/AbstractFunction.php`, `src/Handlers/AnalyticsHandler.php`).

How to verify
- No automated verification commands were provided.

Risks / follow-ups
- Customer metrics now sample up to 2000 orders; totals/ltv may be understated for very large customer histories.
- First Command Deck open now waits on async chunk load; confirm the 200ms open target in a production build.
- Analytics responses may be up to 1 hour stale due to the unified cache TTL.
file update:
diff --git a/react/components/cards/index.js b/react/components/cards/index.js
index 5680195396187616002d89e6624a13e9f633508d..58e5fec2b92f47445eac190b450a739aff0290cc
--- a/react/components/cards/index.js
+++ b/react/components/cards/index.js
@@ -1,7 +1,9 @@
+import React from 'react';
+
 export { default as BaseCard } from './BaseCard.jsx';
 export { default as DangerousActionCard } from './DangerousActionCard.jsx';
 export { default as SuccessCard } from './SuccessCard.jsx';
 export { default as ErrorCard } from './ErrorCard.jsx';
 export { default as InfoCard } from './InfoCard.jsx';
-export { default as ChartCard } from './ChartCard.jsx';
+export const ChartCard = React.lazy(() => import('./ChartCard.jsx'));
 export { default as DataTableCard } from './DataTableCard.jsx';
diff --git a/react/src/App.jsx b/react/src/App.jsx
index b6699ab469f24704bce63f5c1fb04aa3d33c2b00..e9776634bb2b15f82463154b78f0b35f4d8f782c
--- a/react/src/App.jsx
+++ b/react/src/App.jsx
@@ -1,4 +1,12 @@
-import { useCallback, useEffect, useLayoutEffect, useMemo, useRef, useState } from 'react';
+import {
+  Suspense,
+  useCallback,
+  useEffect,
+  useLayoutEffect,
+  useMemo,
+  useRef,
+  useState,
+} from 'react';
 import { createPortal } from 'react-dom';
 import html2canvas from 'html2canvas';
 import ReactMarkdown from 'react-markdown';
@@ -51,6 +59,37 @@
 const SEARCH_TYPES = ['products', 'orders', 'customers'];
 const THEME_TRANSITION_MS = 150;
 const OFFLINE_CACHE_LIMIT = 3;
+const CHART_FALLBACK_BARS = [36, 62, 48, 84, 56, 74];
+const ChartPlaceholderCard = ({ title }) => (
+  <div className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-4">
+    <div className="flex items-center justify-between gap-3">
+      <div>
+        <p className="text-sm font-semibold text-white">{title}</p>
+        <p className="text-xs text-slate-500">Loading chart...</p>
+      </div>
+      <div
+        className="h-8 w-20 rounded-full border border-slate-700/60 bg-slate-900/60"
+        aria-hidden="true"
+      />
+    </div>
+    <div className="mt-4 agentwp-card__chart-placeholder">
+      {CHART_FALLBACK_BARS.map((height, index) => (
+        <div
+          key={`${title}-${index}`}
+          className="agentwp-card__chart-bar"
+          style={{ height: `${height}px` }}
+        />
+      ))}
+    </div>
+  </div>
+);
+const ChartGridFallback = () => (
+  <div className="mt-4 grid gap-4">
+    <ChartPlaceholderCard title="Sales trend" />
+    <ChartPlaceholderCard title="Period comparison" />
+    <ChartPlaceholderCard title="Category breakdown" />
+  </div>
+);
 const TYPEAHEAD_CONFIG = {
   products: {
     label: 'Products',
@@ -2796,64 +2835,66 @@
                     </select>
                   </div>
                 </div>
-                <div className="mt-4 grid gap-4">
-                  <ChartCard
-                    title="Sales trend"
-                    subtitle="Daily revenue with previous period overlay"
-                    metric={formatCurrencyValue(totalRevenue)}
-                    trend={trendLabel}
-                    theme={resolvedTheme}
-                    type="line"
-                    data={trendChartData}
-                    options={trendChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={trendTable}
-                    exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={240}
-                  />
-                  <ChartCard
-                    title="Period comparison"
-                    subtitle="This period vs last period metrics"
-                    theme={resolvedTheme}
-                    type="bar"
-                    data={comparisonChartData}
-                    options={comparisonChartOptions}
-                    meta={
-                      <>
-                        <span>Totals</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={comparisonTable}
-                    exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={200}
-                  />
-                  <ChartCard
-                    title="Category breakdown"
-                    subtitle="Revenue by product category"
-                    theme={resolvedTheme}
-                    type="doughnut"
-                    data={categoryChartData}
-                    options={categoryChartOptions}
-                    meta={
-                      <>
-                        <span>Revenue mix</span>
-                        <span>{periodData.label}</span>
-                      </>
-                    }
-                    table={categoryTable}
-                    exportFilename={`agentwp-category-${selectedPeriod}.png`}
-                    valueFormatter={formatCurrencyValue}
-                    height={220}
-                  />
-                </div>
+                <Suspense fallback={<ChartGridFallback />}>
+                  <div className="mt-4 grid gap-4">
+                    <ChartCard
+                      title="Sales trend"
+                      subtitle="Daily revenue with previous period overlay"
+                      metric={formatCurrencyValue(totalRevenue)}
+                      trend={trendLabel}
+                      theme={resolvedTheme}
+                      type="line"
+                      data={trendChartData}
+                      options={trendChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={trendTable}
+                      exportFilename={`agentwp-sales-trend-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={240}
+                    />
+                    <ChartCard
+                      title="Period comparison"
+                      subtitle="This period vs last period metrics"
+                      theme={resolvedTheme}
+                      type="bar"
+                      data={comparisonChartData}
+                      options={comparisonChartOptions}
+                      meta={
+                        <>
+                          <span>Totals</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={comparisonTable}
+                      exportFilename={`agentwp-comparison-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={200}
+                    />
+                    <ChartCard
+                      title="Category breakdown"
+                      subtitle="Revenue by product category"
+                      theme={resolvedTheme}
+                      type="doughnut"
+                      data={categoryChartData}
+                      options={categoryChartOptions}
+                      meta={
+                        <>
+                          <span>Revenue mix</span>
+                          <span>{periodData.label}</span>
+                        </>
+                      }
+                      table={categoryTable}
+                      exportFilename={`agentwp-category-${selectedPeriod}.png`}
+                      valueFormatter={formatCurrencyValue}
+                      height={220}
+                    />
+                  </div>
+                </Suspense>
               </div>
 
               <details className="rounded-2xl border border-slate-800/80 bg-slate-950/40 px-4 py-3 text-sm text-slate-300">
diff --git a/react/src/main.jsx b/react/src/main.jsx
index 25fc4dbd31fec49364a34e7d9a6a3756c1f19b5e..7e51c6b5e0df6568519224e307aae9595ecf3360
--- a/react/src/main.jsx
+++ b/react/src/main.jsx
@@ -1,9 +1,9 @@
-import React from 'react';
-import ReactDOM from 'react-dom/client';
-import App from './App.jsx';
-import ErrorBoundary from '../components/ErrorBoundary.jsx';
-import styles from './index.css?inline';
-import { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } from './theme.js';
+const OPEN_STATE_KEY = 'agentwp-command-deck-open';
+const ADMIN_TRIGGER_SELECTORS = [
+  '#wp-admin-bar-agentwp',
+  '[data-agentwp-command-deck]',
+  '#agentwp-command-deck',
+];
 
 const getHostElement = () => {
   if (typeof document === 'undefined') {
@@ -22,7 +22,7 @@
   return node;
 };
 
-const mountShadowApp = (hostElement) => {
+const mountShadowApp = (hostElement, styles) => {
   const shadowRoot = hostElement.shadowRoot || hostElement.attachShadow({ mode: 'open' });
   const styleNode = ensureShadowNode(shadowRoot, 'style[data-agentwp-shadow]', () => {
     const style = document.createElement('style');
@@ -43,18 +43,166 @@
   return { shadowRoot, appRoot, portalRoot };
 };
 
-const hostElement = getHostElement();
-if (hostElement) {
-  const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement);
-  const initialPreference = getInitialThemePreference();
-  const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
-  applyTheme(resolvedTheme, hostElement);
+const isEditableTarget = (target) => {
+  if (!(target instanceof HTMLElement)) {
+    return false;
+  }
+  const tagName = target.tagName.toLowerCase();
+  if (['input', 'textarea', 'select'].includes(tagName)) {
+    return true;
+  }
+  if (target.isContentEditable) {
+    return true;
+  }
+  return Boolean(target.closest('[contenteditable="true"]'));
+};
+
+const getComposedTarget = (event) => {
+  if (!event) {
+    return null;
+  }
+  if (typeof event.composedPath === 'function') {
+    const path = event.composedPath();
+    if (path && path.length > 0) {
+      return path[0];
+    }
+  }
+  return event.target;
+};
+
+const markOpenState = (isOpen) => {
+  if (typeof window === 'undefined') {
+    return;
+  }
+  try {
+    if (isOpen) {
+      window.sessionStorage.setItem(OPEN_STATE_KEY, 'true');
+    } else {
+      window.sessionStorage.removeItem(OPEN_STATE_KEY);
+    }
+  } catch (error) {
+    // Ignore storage failures (private mode, strict policies).
+  }
+};
+
+const shouldAutoLoad = () => {
+  if (typeof window === 'undefined') {
+    return false;
+  }
+  try {
+    return window.sessionStorage.getItem(OPEN_STATE_KEY) === 'true';
+  } catch (error) {
+    return false;
+  }
+};
+
+let appPromise = null;
+let appLoaded = false;
+
+const loadCommandDeck = async (openOnLoad = false) => {
+  if (openOnLoad) {
+    markOpenState(true);
+  }
+
+  if (appLoaded) {
+    return null;
+  }
+
+  if (appPromise) {
+    return appPromise;
+  }
+
+  const hostElement = getHostElement();
+  if (!hostElement) {
+    return null;
+  }
+
+  appPromise = (async () => {
+    const [
+      ReactModule,
+      ReactDOM,
+      AppModule,
+      ErrorBoundaryModule,
+      stylesModule,
+      themeModule,
+    ] = await Promise.all([
+      import('react'),
+      import('react-dom/client'),
+      import('./App.jsx'),
+      import('../components/ErrorBoundary.jsx'),
+      import('./index.css?inline'),
+      import('./theme.js'),
+    ]);
+
+    const { StrictMode } = ReactModule;
+    const App = AppModule.default;
+    const ErrorBoundary = ErrorBoundaryModule.default;
+    const styles = stylesModule.default || '';
+    const { applyTheme, getInitialThemePreference, getSystemTheme, resolveTheme } = themeModule;
+
+    const { shadowRoot, appRoot, portalRoot } = mountShadowApp(hostElement, styles);
+    const initialPreference = getInitialThemePreference();
+    const resolvedTheme = resolveTheme(initialPreference, getSystemTheme() === 'dark');
+    applyTheme(resolvedTheme, hostElement);
+
+    ReactDOM.createRoot(appRoot).render(
+      <StrictMode>
+        <ErrorBoundary>
+          <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
+        </ErrorBoundary>
+      </StrictMode>
+    );
+
+    appLoaded = true;
+    return null;
+  })().finally(() => {
+    appPromise = null;
+  });
+
+  return appPromise;
+};
+
+const handleHotkey = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const isMac = typeof navigator !== 'undefined' && /Mac|iPod|iPhone|iPad/.test(navigator.platform);
+  const modifierPressed = isMac ? event.metaKey : event.ctrlKey;
+  if (!modifierPressed || event.shiftKey || event.altKey || event.repeat) {
+    return;
+  }
+  if (event.key.toLowerCase() !== 'k') {
+    return;
+  }
+  const target = getComposedTarget(event);
+  if (event.defaultPrevented || isEditableTarget(target)) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
+
+const handleAdminTrigger = (event) => {
+  if (appLoaded) {
+    return;
+  }
+  const target = event.target;
+  if (!(target instanceof HTMLElement)) {
+    return;
+  }
+  const isTrigger = ADMIN_TRIGGER_SELECTORS.some((selector) => target.closest(selector));
+  if (!isTrigger) {
+    return;
+  }
+  event.preventDefault();
+  loadCommandDeck(true);
+};
 
-  ReactDOM.createRoot(appRoot).render(
-    <React.StrictMode>
-      <ErrorBoundary>
-        <App shadowRoot={shadowRoot} portalRoot={portalRoot} themeTarget={hostElement} />
-      </ErrorBoundary>
-    </React.StrictMode>
-  );
+if (typeof window !== 'undefined' && typeof document !== 'undefined') {
+  window.addEventListener('keydown', handleHotkey);
+  document.addEventListener('click', handleAdminTrigger);
+
+  if (shouldAutoLoad()) {
+    loadCommandDeck(true);
+  }
 }
diff --git a/react/vite.config.js b/react/vite.config.js
index fcf445fdbc14aaca6ac471def3e929f981342e52..bda4ea7f9571e8ead6baee7e02c9b02aa63ddf98
--- a/react/vite.config.js
+++ b/react/vite.config.js
@@ -3,6 +3,15 @@
 
 export default defineConfig({
   plugins: [react()],
+  build: {
+    rollupOptions: {
+      output: {
+        manualChunks: {
+          charts: ['chart.js', 'react-chartjs-2'],
+        },
+      },
+    },
+  },
   server: {
     host: true,
     port: Number.parseInt(process.env.REACT_DEV_PORT || '5173', 10),
diff --git a/src/AI/Functions/AbstractFunction.php b/src/AI/Functions/AbstractFunction.php
index 4c8c89fc1187761b31ffe11ae5a054dbe9329a61..8877a48f28a4ae63089c930806cdd534525f8965
--- a/src/AI/Functions/AbstractFunction.php
+++ b/src/AI/Functions/AbstractFunction.php
@@ -9,10 +9,20 @@
 
 abstract class AbstractFunction implements FunctionSchema {
 	/**
+	 * @var array<string, array>
+	 */
+	private static $definition_cache = array();
+
+	/**
 	 * @return array
 	 */
 	public function to_tool_definition() {
-		return array(
+		$class_name = static::class;
+		if ( isset( self::$definition_cache[ $class_name ] ) ) {
+			return self::$definition_cache[ $class_name ];
+		}
+
+		$definition = array(
 			'type'     => 'function',
 			'function' => array(
 				'name'        => $this->get_name(),
@@ -21,5 +31,9 @@
 				'strict'      => true,
 			),
 		);
+
+		self::$definition_cache[ $class_name ] = $definition;
+
+		return $definition;
 	}
 }
diff --git a/src/Handlers/AnalyticsHandler.php b/src/Handlers/AnalyticsHandler.php
index 519c444a18d211e2877e80f354d12fb89edc40cb..35b37f7268cb6d42135ea215ae035f86ded15917
--- a/src/Handlers/AnalyticsHandler.php
+++ b/src/Handlers/AnalyticsHandler.php
@@ -14,7 +14,7 @@
 use Exception;
 
 class AnalyticsHandler {
-	const CACHE_TTL_TODAY   = 300;
+	const CACHE_TTL_TODAY   = 3600;
 	const CACHE_TTL_DEFAULT = 3600;
 	const TOP_LIMIT         = 5;
 
diff --git a/src/Handlers/CustomerHandler.php b/src/Handlers/CustomerHandler.php
index fb972f8b8b964729a341a13cfba62d8fcb3236ce..c02af6b780376cca26af836e933d98ede81f0954
--- a/src/Handlers/CustomerHandler.php
+++ b/src/Handlers/CustomerHandler.php
@@ -13,6 +13,9 @@
 	const RECENT_LIMIT = 5;
 	const TOP_LIMIT    = 5;
 	const ORDER_BATCH  = 200;
+	const MAX_ORDER_IDS = 2000;
+	const PRODUCT_CATEGORY_CACHE_GROUP = 'agentwp_product_categories';
+	const PRODUCT_CATEGORY_CACHE_TTL   = 3600;
 
 	/**
 	 * Handle a customer profile request.
@@ -31,7 +34,8 @@
 		}
 
 		$paid_statuses = $this->get_paid_statuses();
-		$order_ids     = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_data    = $this->collect_order_ids( $normalized, $paid_statuses );
+		$order_ids     = $order_data['ids'];
 		$metrics       = $this->build_metrics( $order_ids );
 		$recent_orders = $this->get_recent_orders( $normalized, $paid_statuses );
 
@@ -42,6 +46,9 @@
 				'health_thresholds' => $this->get_health_thresholds(),
 				'included_statuses' => $paid_statuses,
 				'recent_orders'     => $recent_orders,
+				'orders_truncated'  => $order_data['truncated'],
+				'orders_sampled'    => count( $order_ids ),
+				'orders_limit'      => self::MAX_ORDER_IDS,
 			)
 		);
 
@@ -76,6 +83,8 @@
 	 */
 	private function collect_order_ids( array $normalized, array $statuses ) {
 		$order_ids = array();
+		$truncated = false;
+		$remaining = self::MAX_ORDER_IDS;
 
 		if ( $normalized['customer_id'] > 0 ) {
 			$order_ids = array_merge(
@@ -84,19 +93,24 @@
 					array(
 						'customer' => $normalized['customer_id'],
 						'status'   => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
+			$remaining = max( 0, self::MAX_ORDER_IDS - count( $order_ids ) );
 		}
 
-		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] ) {
+		if ( '' !== $normalized['email'] && 0 === $normalized['customer_id'] && $remaining > 0 ) {
 			$order_ids = array_merge(
 				$order_ids,
 				$this->query_order_ids(
 					array(
 						'billing_email' => $normalized['email'],
 						'status'        => $statuses,
-					)
+					),
+					$remaining,
+					$truncated
 				)
 			);
 		}
@@ -105,17 +119,29 @@
 		$order_ids = array_filter( array_unique( $order_ids ) );
 		sort( $order_ids );
 
-		return $order_ids;
+		if ( count( $order_ids ) > self::MAX_ORDER_IDS ) {
+			$order_ids = array_slice( $order_ids, 0, self::MAX_ORDER_IDS );
+			$truncated = true;
+		}
+
+		return array(
+			'ids'       => $order_ids,
+			'truncated' => $truncated,
+		);
 	}
 
 	/**
 	 * @param array $query_args Query arguments.
 	 * @return array
 	 */
-	private function query_order_ids( array $query_args ) {
+	private function query_order_ids( array $query_args, $remaining, &$truncated ) {
 		$ids   = array();
 		$page  = 1;
-		$limit = self::ORDER_BATCH;
+		$limit = min( self::ORDER_BATCH, $remaining );
+		if ( $limit <= 0 ) {
+			$truncated = true;
+			return $ids;
+		}
 
 		while ( true ) {
 			$args = array_merge(
@@ -124,6 +150,8 @@
 					'limit'  => $limit,
 					'paged'  => $page,
 					'return' => 'ids',
+					'orderby' => 'date',
+					'order'   => 'DESC',
 				)
 			);
 
@@ -138,6 +166,12 @@
 				break;
 			}
 
+			if ( count( $ids ) >= $remaining ) {
+				$ids       = array_slice( $ids, 0, $remaining );
+				$truncated = true;
+				break;
+			}
+
 			$page++;
 		}
 
@@ -254,7 +288,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders( array $normalized, array $statuses ) {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -263,6 +297,7 @@
 			'orderby' => 'date',
 			'order'   => 'DESC',
 			'status'  => $statuses,
+			'return'  => 'ids',
 		);
 
 		if ( $normalized['customer_id'] > 0 ) {
@@ -271,14 +306,15 @@
 			$args['billing_email'] = $normalized['email'];
 		}
 
-		$orders = wc_get_orders( $args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$recent = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 
@@ -448,6 +484,14 @@
 			return $cache[ $product_id ];
 		}
 
+		if ( function_exists( 'wp_cache_get' ) ) {
+			$cached = wp_cache_get( $product_id, self::PRODUCT_CATEGORY_CACHE_GROUP );
+			if ( is_array( $cached ) ) {
+				$cache[ $product_id ] = $cached;
+				return $cached;
+			}
+		}
+
 		$categories = array();
 		if ( function_exists( 'wc_get_product_terms' ) ) {
 			$terms = wc_get_product_terms( $product_id, 'product_cat', array( 'fields' => 'all' ) );
@@ -462,6 +506,9 @@
 		}
 
 		$cache[ $product_id ] = $categories;
+		if ( function_exists( 'wp_cache_set' ) ) {
+			wp_cache_set( $product_id, $categories, self::PRODUCT_CATEGORY_CACHE_GROUP, self::PRODUCT_CATEGORY_CACHE_TTL );
+		}
 
 		return $categories;
 	}
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
index b5cc3eff545f6a701d756c77af84e071cbbb11f0..4108b4fee5a0f015fd6323e99926d8f236135d4a
--- a/src/Handlers/EmailDraftHandler.php
+++ b/src/Handlers/EmailDraftHandler.php
@@ -471,10 +471,11 @@
 	 * @return array
 	 */
 	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
-		$store_name   = $this->get_store_name();
-		$intent_notes = $this->get_intent_guidance( $intent, $context );
-		$tone_notes   = $this->get_tone_guidance( $tone );
-		$summary      = $this->build_prompt_context( $context );
+		$store_name    = $this->get_store_name();
+		$intent_notes  = $this->get_intent_guidance( $intent, $context );
+		$tone_notes    = $this->get_tone_guidance( $tone );
+		$summary       = $this->prune_prompt_payload( $this->build_prompt_context( $context ) );
+		$template_hint = $this->prune_prompt_payload( $template_variables );
 
 		$system = sprintf(
 			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
@@ -487,7 +488,7 @@
 			'Intent guidance: ' . $intent_notes,
 			'Tone guidance: ' . $tone_notes,
 			'Order context (JSON): ' . $this->encode_json( $summary ),
-			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+			'Template variables (JSON): ' . $this->encode_json( $template_hint ),
 		);
 
 		if ( '' !== $custom_instructions ) {
@@ -539,6 +540,41 @@
 	}
 
 	/**
+	 * Remove empty values to keep prompts compact.
+	 *
+	 * @param mixed $payload Input payload.
+	 * @return mixed
+	 */
+	private function prune_prompt_payload( $payload ) {
+		if ( ! is_array( $payload ) ) {
+			return $payload;
+		}
+
+		foreach ( $payload as $key => $value ) {
+			$filtered = $this->prune_prompt_payload( $value );
+
+			if ( is_array( $filtered ) && empty( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( is_string( $filtered ) && '' === trim( $filtered ) ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			if ( null === $filtered ) {
+				unset( $payload[ $key ] );
+				continue;
+			}
+
+			$payload[ $key ] = $filtered;
+		}
+
+		return $payload;
+	}
+
+	/**
 	 * @param array $context Order context.
 	 * @return array
 	 */
diff --git a/src/Handlers/OrderSearchHandler.php b/src/Handlers/OrderSearchHandler.php
index 58b215343d1dbb80aa39ab5cf2fb8ace45b9dc1e..b39eadfd9e5058e6aef7f079302b406f7cf657f5
--- a/src/Handlers/OrderSearchHandler.php
+++ b/src/Handlers/OrderSearchHandler.php
@@ -16,6 +16,9 @@
 class OrderSearchHandler {
 	const DEFAULT_LIMIT = 10;
 	const CACHE_TTL     = 3600;
+	const MAX_LIMIT     = 50;
+	const OBJECT_CACHE_GROUP = 'agentwp_order_search';
+	const OBJECT_CACHE_TTL   = 300;
 
 	/**
 	 * Handle an order search request.
@@ -83,6 +86,12 @@
 		if ( 0 === $normalized['limit'] ) {
 			$normalized['limit'] = self::DEFAULT_LIMIT;
 		}
+		if ( $normalized['limit'] > self::MAX_LIMIT ) {
+			$normalized['limit'] = self::MAX_LIMIT;
+		}
+		if ( $normalized['limit'] <= 0 ) {
+			$normalized['limit'] = self::DEFAULT_LIMIT;
+		}
 
 		if ( '' === $normalized['orderby'] ) {
 			$normalized['orderby'] = 'date';
@@ -212,6 +221,11 @@
 		}
 
 		if ( $normalized['order_id'] > 0 ) {
+			$cached = $this->read_order_cache( $normalized['order_id'] );
+			if ( $cached ) {
+				return array( $cached );
+			}
+
 			$order = wc_get_order( $normalized['order_id'] );
 			if ( $order ) {
 				return array( $this->format_order( $order ) );
@@ -224,6 +238,7 @@
 			'limit'   => $normalized['limit'],
 			'orderby' => $normalized['orderby'],
 			'order'   => $normalized['order'],
+			'return'  => 'ids',
 		);
 
 		if ( '' !== $normalized['status'] ) {
@@ -250,16 +265,23 @@
 			);
 		}
 
-		$orders = wc_get_orders( $query_args );
-		if ( ! is_array( $orders ) ) {
+		$order_ids = wc_get_orders( $query_args );
+		if ( ! is_array( $order_ids ) ) {
 			return array();
 		}
 
 		$results = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $order_ids as $order_id ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				$results[] = $cached;
 				continue;
 			}
+
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
+				continue;
+			}
 			$results[] = $this->format_order( $order );
 		}
 
@@ -285,11 +307,19 @@
 	 * @return array
 	 */
 	private function format_order( $order ) {
+		$order_id = $order && method_exists( $order, 'get_id' ) ? intval( $order->get_id() ) : 0;
+		if ( $order_id > 0 ) {
+			$cached = $this->read_order_cache( $order_id );
+			if ( $cached ) {
+				return $cached;
+			}
+		}
+
 		$date_created = method_exists( $order, 'get_date_created' ) ? $order->get_date_created() : null;
 		$email        = $this->get_customer_email( $order );
 		$customer     = $this->get_customer_name( $order );
 
-		return array(
+		$summary = array(
 			'id'               => intval( $order->get_id() ),
 			'status'           => sanitize_text_field( $order->get_status() ),
 			'total'            => $order->get_total(),
@@ -299,6 +329,42 @@
 			'items_summary'    => $this->format_items_summary( $order ),
 			'shipping_address' => $this->format_shipping_address( $order ),
 		);
+
+		if ( $order_id > 0 ) {
+			$this->write_order_cache( $order_id, $summary );
+		}
+
+		return $summary;
+	}
+
+	/**
+	 * @param int $order_id Order ID.
+	 * @return array|null
+	 */
+	private function read_order_cache( $order_id ) {
+		if ( ! function_exists( 'wp_cache_get' ) ) {
+			return null;
+		}
+
+		$cached = wp_cache_get( $order_id, self::OBJECT_CACHE_GROUP );
+		if ( ! is_array( $cached ) ) {
+			return null;
+		}
+
+		return $cached;
+	}
+
+	/**
+	 * @param int   $order_id Order ID.
+	 * @param array $summary Summary payload.
+	 * @return void
+	 */
+	private function write_order_cache( $order_id, array $summary ) {
+		if ( ! function_exists( 'wp_cache_set' ) ) {
+			return;
+		}
+
+		wp_cache_set( $order_id, $summary, self::OBJECT_CACHE_GROUP, self::OBJECT_CACHE_TTL );
 	}
 
 	/**
diff --git a/src/Intent/ContextBuilder.php b/src/Intent/ContextBuilder.php
index ecc257626521bba5456a9f0bafa409d6f0f9fd92..140b255d2291f70bc03af075bca69e3a15242eb3
--- a/src/Intent/ContextBuilder.php
+++ b/src/Intent/ContextBuilder.php
@@ -50,7 +50,7 @@
 	 * @return array
 	 */
 	private function get_recent_orders() {
-		if ( ! function_exists( 'wc_get_orders' ) ) {
+		if ( ! function_exists( 'wc_get_orders' ) || ! function_exists( 'wc_get_order' ) ) {
 			return array();
 		}
 
@@ -59,6 +59,7 @@
 				'limit'   => 5,
 				'orderby' => 'date',
 				'order'   => 'DESC',
+				'return'  => 'ids',
 			)
 		);
 
@@ -67,8 +68,9 @@
 		}
 
 		$summary = array();
-		foreach ( $orders as $order ) {
-			if ( ! is_object( $order ) || ! method_exists( $order, 'get_id' ) ) {
+		foreach ( $orders as $order_id ) {
+			$order = wc_get_order( $order_id );
+			if ( ! $order || ! method_exists( $order, 'get_id' ) ) {
 				continue;
 			}
 

tokens used
178,997
