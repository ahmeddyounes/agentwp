---

## Status: DONE

## Summary of Changes

Modified `src/Search/Index.php` to implement static hardening for the search architecture. The changes ensure the search index lifecycle is predictable and does not add unexpected overhead:

### 1. **Prevent duplicate hook registration** (lines 21-42)
   - Added `$hooks_registered` static flag to `init()` 
   - Hooks are now registered exactly once per request, preventing duplicate registrations if `init()` is called multiple times

### 2. **Prevent redundant table checks** (lines 77-131)
   - Added `$table_verified` static flag to `ensure_table()`
   - Option lookups and table existence checks now happen at most once per request
   - After verification, subsequent calls return immediately

### 3. **Removed redundant calls from `search()` method** (lines 133-168)
   - Removed the calls to `ensure_table()` and `maybe_backfill()` from within `search()`
   - Table creation and backfill are now handled exclusively by `init` hooks
   - Search operations no longer trigger unnecessary overhead on every request
   - The fallback to `search_source()` still works when backfill is incomplete

### 4. **Prevent redundant backfill runs** (lines 814-872)
   - Added `$backfill_ran` static flag to `maybe_backfill()`
   - Added early exit when all types are already backfilled
   - Backfill runs at most once per request in admin context only

### Key Architectural Decisions
- **Kept static class pattern**: The static class approach is appropriate for this stateless utility. No DI migration was needed.
- **Hooks well-scoped**: All hooks have defensive checks (e.g., `function_exists()` for WooCommerce functions, `is_admin()` for backfill)
- **Predictable lifecycle**: Table creation only happens on version mismatch or missing table; backfill only runs in admin context

## How to Verify

1. **PHP Syntax Check**:
   ```bash
   php -l src/Search/Index.php
   ```

2. **PHPCS Check**:
   ```bash
   ./vendor/bin/phpcs --standard=phpcs.xml src/Search/Index.php
   ```

3. **Manual Verification**:
   - Plugin activation should create the table once
   - Admin page loads should trigger backfill incrementally (until complete)
   - Search requests should not trigger table creation or backfill directly
   - Multiple calls to `Index::init()` in the same request should not duplicate hooks

## Risks / Follow-ups

1. **Edge case: REST API search before init hook runs** - If `Index::search()` is called before the WordPress `init` hook fires (rare), the table won't be ensured. This is acceptable since WordPress's REST API runs after `init`.

2. **No automated tests** - There are no existing unit tests for the Search Index class. Consider adding tests that verify:
   - `init()` registers hooks exactly once
   - `ensure_table()` doesn't do redundant work
   - `maybe_backfill()` respects the `is_admin()` check and doesn't run multiple times

3. **PHPStan** - Could not run PHPStan due to memory limits in the environment. Run it in CI/CD to verify type safety.
