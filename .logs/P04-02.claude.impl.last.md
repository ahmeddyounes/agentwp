---

## Status: DONE

## Summary of Changes

1. **`src/AI/OpenAIClient.php`**:
   - Added `UsageTrackerInterface` as an optional constructor parameter
   - Replaced static `UsageTracker::log_usage()` call with DI-based `$this->usage_tracker->logUsage()` 
   - Removed the import of `AgentWP\Billing\UsageTracker`

2. **`src/AI/AIClientFactory.php`**:
   - Added `UsageTrackerInterface` as a required constructor dependency
   - Updated the `create()` method to pass the usage tracker to `OpenAIClient`

3. **`src/Providers/InfrastructureServiceProvider.php`**:
   - Updated `registerAIClientFactory()` to inject `UsageTrackerInterface` into `AIClientFactory`

4. **`src/Providers/ServicesServiceProvider.php`**:
   - Removed duplicate `registerUsageTrackerService()` registration (was overwriting the one from `InfrastructureServiceProvider`)
   - Removed unused imports

5. **`src/Services/UsageTrackerService.php`**:
   - Deleted redundant file (duplicate of `UsageTrackerAdapter`)

6. **`tests/Unit/AI/AIClientFactoryTest.php`**:
   - Updated to provide mock `UsageTrackerInterface` to factory

## How to Verify

```bash
# Run all tests
./vendor/bin/phpunit

# Run specific affected tests
./vendor/bin/phpunit tests/Unit/AI/AIClientFactoryTest.php
./vendor/bin/phpunit tests/Unit/AI/OpenAIClientTest.php

# Lint the modified files
php -l src/AI/OpenAIClient.php
php -l src/AI/AIClientFactory.php
php -l src/Providers/InfrastructureServiceProvider.php
php -l src/Providers/ServicesServiceProvider.php
```

## Risks / Follow-ups

- **Low risk**: The changes maintain backward compatibility - `OpenAIClient` still works without a usage tracker (it's an optional parameter). Existing code instantiating `OpenAIClient` directly will continue to work but won't track usage unless the tracker is passed.
- **Consolidation**: Removed duplicate `UsageTrackerService` in favor of `UsageTrackerAdapter`, reducing code duplication.
- **Plugin bootstrap**: Static `UsageTracker::init()` and `UsageTracker::activate()` calls in `Plugin.php` remain as lifecycle hooks - these are appropriate at the bootstrap level.
