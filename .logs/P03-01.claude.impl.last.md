---

## Status: DONE

## Summary of Changes

Established `RestController::response_error()` as the **canonical error handling mechanism** for all REST controller callbacks, eliminating duplicated error formatting logic.

### Changes Made:

**1. `src/API/RestController.php` (lines 260-300):**
- Added docblock clarifying this is the canonical method for controller errors
- Now always includes `meta` key in error response (previously only when non-empty)
- Added `Retry-After` header support for rate-limited responses
- Consistent output format: `{success: false, data: [], error: {code, message, type, meta}}`

**2. `src/Plugin/ResponseFormatter.php`:**
- Added comprehensive docblock documenting the error handling strategy
- `formatRestResponse()` simplified: now just extracts error code for logging, doesn't re-format already-formatted responses (removed ~40 lines of duplicate formatting logic)
- `formatWpError()` updated: builds meta from all WP_Error data (excluding `status`), matching `response_error()` output format
- Clear separation of concerns:
  - `WP_Error` → Only from permission callbacks (WordPress requirement), transformed by ResponseFormatter
  - `WP_REST_Response` → From controller callbacks via `response_error()`, passed through unchanged

### Error Path Summary:
| Source | Error Type | Handled By |
|--------|-----------|------------|
| Permission callbacks | `WP_Error` | `ResponseFormatter::formatWpError()` |
| Controller callbacks | `WP_REST_Response` | `RestController::response_error()` (canonical) |

## How to Verify

```bash
# Run tests
composer phpunit

# Run static analysis  
composer phpstan

# Run code sniffer on modified files
composer phpcs -- src/Plugin/ResponseFormatter.php src/API/RestController.php
```

All 605 tests pass, PHPStan reports no errors, PHPCS reports no issues.

## Risks / Follow-ups

- **Low risk**: The `meta` field is now always present in error responses (even when empty). Clients should handle this gracefully, but it's a minor API change.
- **Follow-up consideration**: Could add integration tests specifically for error response format consistency between permission callback errors and controller callback errors.
