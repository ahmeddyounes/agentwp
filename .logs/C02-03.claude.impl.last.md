---

## Status: DONE

## Summary of Changes

Implemented `checkAndIncrement()` in `FakeRateLimiter` and added comprehensive unit tests for atomic behavior and fallback behavior with `retry_after` propagation.

### `tests/Fakes/FakeRateLimiter.php`
- Changed interface from `RateLimiterInterface` to `AtomicRateLimiterInterface`
- Added `checkAndIncrement()` method that atomically checks and increments the rate limit counter
  - Returns `true` if within limits (and increments counter)
  - Returns `false` if limit exceeded (does not increment)
  - Respects `enabled` flag (bypasses when disabled)
  - Handles window expiration properly

### `tests/Unit/API/FakeRateLimiterTest.php`
Added 14 new tests covering:
- **Atomic behavior tests:**
  - `test_check_and_increment_returns_true_when_within_limit`
  - `test_check_and_increment_increments_counter`
  - `test_check_and_increment_returns_false_when_limit_exceeded`
  - `test_check_and_increment_does_not_increment_when_at_limit`
  - `test_check_and_increment_bypassed_when_disabled`
  - `test_check_and_increment_resets_after_window_expires`

- **Retry-after propagation tests:**
  - `test_retry_after_returns_remaining_window_time`
  - `test_retry_after_returns_at_least_one_second`
  - `test_retry_after_consistent_with_check_and_increment_failure`

- **429 behavior tests:**
  - `test_429_scenario_with_retry_after`
  - `test_atomic_check_and_increment_429_scenario`

- **Fallback behavior tests:**
  - `test_fallback_path_check_then_increment`
  - `test_fallback_path_retry_after_on_limit_exceeded`
  - `test_atomic_and_fallback_produce_consistent_retry_after`

## How to Verify

```bash
# Run FakeRateLimiter tests
php vendor/bin/phpunit tests/Unit/API/FakeRateLimiterTest.php --testdox

# Run all rate limiter tests
php vendor/bin/phpunit --filter "RateLimiter" --testdox

# Check PHP syntax
php -l tests/Fakes/FakeRateLimiter.php
php -l tests/Unit/API/FakeRateLimiterTest.php
```

## Risks / Follow-ups

1. **Backward Compatibility**: `FakeRateLimiter` now implements `AtomicRateLimiterInterface` (which extends `RateLimiterInterface`), so it's compatible with code expecting either interface.

2. **Test Coverage**: All 47 rate limiter tests pass (28 in FakeRateLimiterTest, 18 in RateLimiterTest, 1 architecture boundary test).
