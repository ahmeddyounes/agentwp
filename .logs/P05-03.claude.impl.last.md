---

## Status: DONE

### Summary of Changes

Implemented option migrations and cleanup via the upgrader with full multisite support:

1. **`src/Plugin/Upgrader.php`** - Added upgrade infrastructure:
   - **`upgrade_to_0_1_1()`** - First upgrade step that initializes memory options (`agentwp_memory_limit`, `agentwp_memory_ttl`) for existing installations upgrading from 0.1.0. Uses idempotent logic (checks if option exists before adding).
   - **`run_network_upgrades()`** - New public method for network admins to trigger upgrades across all sites in a multisite network immediately, rather than waiting for each site to be visited.
   - Modified `get_upgrade_steps()` to register the 0.1.1 upgrade step.

2. **`tests/Unit/Plugin/UpgraderTest.php`** - Extended existing tests:
   - Added tests for the 0.1.1 upgrade step existence and structure
   - Added tests for pending step detection with 0.1.1
   - Added tests for `run_network_upgrades()` method

3. **`tests/Unit/Plugin/UpgraderMigrationTest.php`** - New test file:
   - Tests upgrade step structure validation
   - Tests all upgrade step methods are private and static
   - Tests SettingsManager constants for memory options
   - Tests pending step detection for version ranges

### How to Verify

```bash
# Run upgrader-specific tests
./vendor/bin/phpunit tests/Unit/Plugin/UpgraderTest.php tests/Unit/Plugin/UpgraderMigrationTest.php --no-coverage

# Run full test suite
./vendor/bin/phpunit --no-coverage

# Verify upgrade step detection
# Upgrading from 0.1.0 should include 0.1.1 step
# Upgrading from 0.1.1 should skip 0.1.1 step
```

### Risks / Follow-ups

1. **Version Bump Required**: The current plugin version is `0.1.0` and the upgrade step is for `0.1.1`. For the upgrade to trigger, the plugin version must be bumped to `0.1.1` or higher in `agentwp.php:19`.

2. **Future Migrations**: The pattern is now established for adding future upgrade steps. Simply add new entries to `get_upgrade_steps()` and implement corresponding private static methods.

3. **Multisite Testing**: The `run_network_upgrades()` method should be tested in an actual multisite environment to verify `switch_to_blog()` behavior.

4. **No Deprecated Option Cleanup**: The existing options marked in `uninstall.php` (`agentwp_usage_version`, `agentwp_search_index_version`, etc.) are actively used by their respective components (`UsageTracker`, `Search\Index`). No cleanup migration was needed as these are not truly deprecated.
