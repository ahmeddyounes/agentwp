Implemented a new email drafting handler that builds OpenAI prompts from order context, generates HTML + plain-text drafts with template variable replacement, and stores them for retrieval/editing in transients (`src/Handlers/EmailDraftHandler.php`).

**Status**
- DONE

**Summary of changes**
- Added `src/Handlers/EmailDraftHandler.php` with AI + fallback draft generation, EmailContextBuilder-driven prompts, placeholder cleanup, and 30‑minute transient storage/retrieval/edit flows.

**How to verify (exact commands)**
- None provided.

**Risks / follow-ups**
- OpenAI requests and WooCommerce data paths were not exercised locally; validate with a real order and API key to confirm tone variance and tracking/product mentions.

Next steps (optional):
1) Provide an order ID + API key so I can outline a manual smoke test for draft/create/update retrieval flows.

OpenAI Codex v0.77.0 (research preview)
--------
workdir: /Users/ahmedyounis/Documents/Projects/agentwp
model: gpt-5.2-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019b96d6-d5ec-7421-9c6a-06e613f32c21
--------
user
You are implementing task M03-02 in this git repository.

1) Read the spec: .plans/M03-02.md
2) Read handoff/context: .t2/handoff/M03-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

mcp startup: no servers

thinking
**Preparing to search with ripgrep**
exec
/bin/zsh -lc ls in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 41ms:
agentwp.php
assets
composer.json
docker
docker-compose.yml
docs
includes
languages
react
README.md
scripts
setup.sh
src
tasks.csv
uninstall.php

thinking
**Preparing to read specification**
exec
/bin/zsh -lc 'cat .plans/M03-02.md' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
# M03-02 — AI Email Drafting Engine

Implement AI-powered email draft generation: 1) Create AgentWP\Handlers\EmailDraftHandler class. 2) OpenAI function schema: draft_email(order_id: int, intent: string, tone: 'professional'|'friendly'|'apologetic', custom_instructions?: string). 3) Intent types: shipping_update, refund_confirmation, order_issue, general_inquiry, review_request. 4) Build dynamic prompts incorporating EmailContextBuilder output. 5) Response includes: subject_line, email_body (HTML with simple formatting), plain_text_version. 6) Store drafts in transient with 30-minute expiry, allow retrieval/editing. 7) Support template variables: {{customer_name}}, {{order_id}}, {{tracking_url}}, etc. Acceptance Criteria: Generated emails are contextually relevant (mention specific products, tracking info), tone clearly different between options, drafts valid HTML, no placeholder text like '[TRACKING URL]' when data available.

thinking
**Reviewing handoff**
exec
/bin/zsh -lc 'cat .t2/handoff/M03-02.md' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 39ms:
# Handoff: M03-02

Created: 2026-01-06T20:55:24.660466Z

Spec: .plans/M03-02.md


## 2026-01-06T21:01:08.745567Z — codex — impl

Command:
```
codex exec --color never --full-auto --output-last-message /Users/ahmedyounis/Documents/Projects/agentwp/.logs/M03-02.codex.impl.last.md -
```

Return code: 1

Agent final message (file: M03-02.codex.impl.last.md):




thinking
**Searching for relevant classes**
exec
/bin/zsh -lc 'rg -n "EmailDraft|EmailContext|ContextBuilder|Draft" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
src/Intent/ContextBuilder.php:10:class ContextBuilder {
src/Handlers/RefundHandler.php:126:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:145:			return Response::error( 'Draft type mismatch for refund confirmation.', 400 );
src/Handlers/RefundHandler.php:385:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:422:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:423:	 * @param array  $draft Draft payload.
src/Handlers/RefundHandler.php:436:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:453:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:503:	 * @param string $draft_id Draft ID.
src/Handlers/RefundHandler.php:530:	 * @param array $payload Draft payload.
src/Intent/Handlers/EmailDraftHandler.php:13:class EmailDraftHandler extends BaseHandler {
src/AI/Functions/ConfirmRefund.php:27:					'description' => 'Draft refund identifier to confirm.',
src/Intent/Intent.php:77:				'label'   => 'Draft a customer email',
src/Intent/Intent.php:78:				'example' => 'Draft an apology email for order 1452.',
src/Intent/Engine.php:13:use AgentWP\Intent\Handlers\EmailDraftHandler;
src/Intent/Engine.php:27:	 * @var ContextBuilder
src/Intent/Engine.php:54:	 * @param ContextBuilder|null $context_builder Optional context builder.
src/Intent/Engine.php:61:		ContextBuilder $context_builder = null,
src/Intent/Engine.php:66:		$this->context_builder = $context_builder ? $context_builder : new ContextBuilder();
src/Intent/Engine.php:134:			new EmailDraftHandler(),

thinking
**Checking existing email draft handlers**
exec
/bin/zsh -lc "sed -n '1,220p' src/Intent/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 51ms:
<?php
/**
 * Handle email draft intents.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Intent\Intent;

class EmailDraftHandler extends BaseHandler {
	public function __construct() {
		parent::__construct( Intent::EMAIL_DRAFT );
	}

	/**
	 * @param array $context Context data.
	 * @return Response

thinking
**Inspecting existing handlers**
exec
/bin/zsh -lc "sed -n '1,240p' src/Handlers/OrderStatusHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 42ms:
<?php
/**
 * Handle order status draft preparation and confirmation.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;
use AgentWP\Plugin;

class OrderStatusHandler {
	const DRAFT_TYPE = 'status_update';
	const MAX_BULK   = 50;

	/**
	 * Handle order status requests.
	 *
	 * @param array $args Request args.

thinking
**Searching for draft storage definition**
exec
/bin/zsh -lc 'rg -n "function store_draft|generate_draft_id|get_draft_ttl" -n src/Handlers' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 35ms:
src/Handlers/RefundHandler.php:96:		$draft_id   = $this->generate_draft_id();
src/Handlers/RefundHandler.php:97:		$ttl        = $this->get_draft_ttl_seconds();
src/Handlers/RefundHandler.php:376:	private function generate_draft_id() {
src/Handlers/RefundHandler.php:395:	private function get_draft_ttl_seconds() {
src/Handlers/RefundHandler.php:427:	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
src/Handlers/OrderStatusHandler.php:95:		$draft_id   = $this->generate_draft_id();
src/Handlers/OrderStatusHandler.php:96:		$ttl        = $this->get_draft_ttl_seconds();
src/Handlers/OrderStatusHandler.php:215:		$draft_id   = $this->generate_draft_id();
src/Handlers/OrderStatusHandler.php:216:		$ttl        = $this->get_draft_ttl_seconds();
src/Handlers/OrderStatusHandler.php:578:	private function generate_draft_id() {
src/Handlers/OrderStatusHandler.php:597:	private function get_draft_ttl_seconds() {
src/Handlers/OrderStatusHandler.php:629:	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
src/Handlers/StockHandler.php:134:		$draft_id   = $this->generate_draft_id();
src/Handlers/StockHandler.php:135:		$ttl        = $this->get_draft_ttl_seconds();
src/Handlers/StockHandler.php:487:	private function generate_draft_id() {
src/Handlers/StockHandler.php:506:	private function get_draft_ttl_seconds() {
src/Handlers/StockHandler.php:538:	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {

thinking
**Inspecting EmailContextBuilder**
exec
/bin/zsh -lc "sed -n '1,220p' src/Context/EmailContextBuilder.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
<?php
/**
 * Build email drafting context for orders.
 *
 * @package AgentWP
 */

namespace AgentWP\Context;

class EmailContextBuilder {
	const RECENT_NOTES_LIMIT     = 5;
	const DELAYED_SHIPPING_DAYS  = 3;
	const FALLBACK_SPEND_CUTOFF  = 50;

	/**
	 * Build email drafting context for a specific order.
	 *
	 * @param int $order_id Order ID.
	 * @return array
	 */

thinking
**Continuing tracking tasks**
exec
/bin/zsh -lc "sed -n '220,520p' src/Context/EmailContextBuilder.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 38ms:
	}

	/**
	 * @param object $order Order instance.
	 * @return array
	 */
	private function get_payment_context( $order ) {
		$method    = method_exists( $order, 'get_payment_method_title' ) ? $order->get_payment_method_title() : '';
		$method_id = method_exists( $order, 'get_payment_method' ) ? $order->get_payment_method() : '';

		return array(
			'method'      => sanitize_text_field( $method ),
			'method_id'   => sanitize_text_field( $method_id ),
			'card_last4'  => $this->get_card_last4( $order ),
		);
	}

	/**
	 * @param int $order_id Order ID.
	 * @return array

thinking
**Inspecting EmailContextBuilder and AI DraftEmail**
exec
/bin/zsh -lc "sed -n '1,200p' src/AI/Functions/DraftEmail.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
<?php
/**
 * Function schema for drafting emails.
 *
 * @package AgentWP
 */

namespace AgentWP\AI\Functions;

class DraftEmail extends AbstractFunction {
	public function get_name() {
		return 'draft_email';
	}

	public function get_description() {
		return 'Draft a customer email for a given order and intent.';
	}

	public function get_parameters() {
		return array(

thinking
**Checking for existing EmailDraftHandler**
exec
/bin/zsh -lc 'rg -n "EmailDraftHandler" src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 53ms:
src/Intent/Handlers/EmailDraftHandler.php:13:class EmailDraftHandler extends BaseHandler {
src/Intent/Engine.php:13:use AgentWP\Intent\Handlers\EmailDraftHandler;
src/Intent/Engine.php:134:			new EmailDraftHandler(),

thinking
**Searching for handler usage**
exec
/bin/zsh -lc 'rg -n "RefundHandler|OrderStatusHandler|StockHandler" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 56ms:
src/Handlers/RefundHandler.php:13:class RefundHandler {
src/Handlers/OrderStatusHandler.php:13:class OrderStatusHandler {
src/Handlers/StockHandler.php:13:class StockHandler {
src/Intent/Handlers/OrderRefundHandler.php:13:class OrderRefundHandler extends BaseHandler {
src/Intent/Handlers/ProductStockHandler.php:11:use AgentWP\Handlers\StockHandler;
src/Intent/Handlers/ProductStockHandler.php:14:class ProductStockHandler extends BaseHandler {
src/Intent/Handlers/ProductStockHandler.php:32:		$search = new StockHandler();
src/Intent/Handlers/OrderStatusHandler.php:13:class OrderStatusHandler extends BaseHandler {
src/Intent/Engine.php:15:use AgentWP\Intent\Handlers\OrderRefundHandler;
src/Intent/Engine.php:17:use AgentWP\Intent\Handlers\OrderStatusHandler;
src/Intent/Engine.php:18:use AgentWP\Intent\Handlers\ProductStockHandler;
src/Intent/Engine.php:131:			new OrderRefundHandler(),
src/Intent/Engine.php:132:			new OrderStatusHandler(),
src/Intent/Engine.php:133:			new ProductStockHandler(),

thinking
**Inspecting OrderRefundHandler**
exec
/bin/zsh -lc "sed -n '1,200p' src/Intent/Handlers/OrderRefundHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
<?php
/**
 * Handle order refund intents.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Intent\Intent;

class OrderRefundHandler extends BaseHandler {
	public function __construct() {
		parent::__construct( Intent::ORDER_REFUND );
	}

	/**
	 * @param array $context Context data.
	 * @return Response

thinking
**Examining handler structure and searching for email drafts**
exec
/bin/zsh -lc 'rg -n "draft_email|DraftEmail" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
src/AI/Functions/DraftEmail.php:10:class DraftEmail extends AbstractFunction {
src/AI/Functions/DraftEmail.php:12:		return 'draft_email';
src/Intent/Engine.php:180:			Intent::EMAIL_DRAFT     => array( 'draft_email' ),

thinking
**Inspecting Engine component**
exec
/bin/zsh -lc "sed -n '1,240p' src/Intent/Engine.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
<?php
/**
 * Intent engine for routing requests.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

use AgentWP\AI\Response;
use AgentWP\Intent\Handlers\AnalyticsQueryHandler;
use AgentWP\Intent\Handlers\CustomerLookupHandler;
use AgentWP\Intent\Handlers\EmailDraftHandler;
use AgentWP\Intent\Handlers\FallbackHandler;
use AgentWP\Intent\Handlers\OrderRefundHandler;
use AgentWP\Intent\Handlers\OrderSearchHandler;
use AgentWP\Intent\Handlers\OrderStatusHandler;
use AgentWP\Intent\Handlers\ProductStockHandler;

class Engine {

thinking
**Inspecting FunctionRegistry structure**
exec
/bin/zsh -lc "sed -n '1,200p' src/Intent/FunctionRegistry.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
<?php
/**
 * OpenAI function registry for intent handlers.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

class FunctionRegistry {
	/**
	 * @var array<string, Handler>
	 */
	private $map = array();

	/**
	 * @param string  $function_name OpenAI function name.
	 * @param Handler $handler Handler instance.
	 * @return void
	 */

thinking
**Examining function implementation in Intent handler**
exec
/bin/zsh -lc "sed -n '1,200p' src/Intent/Handler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 34ms:
<?php
/**
 * Intent handler contract.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

use AgentWP\AI\Response;

interface Handler {
	/**
	 * @param string $intent Intent identifier.
	 * @return bool
	 */
	public function canHandle( string $intent ): bool;

	/**
	 * @param array $context Enriched request context.

thinking
**Investigating function call handling**
exec
/bin/zsh -lc 'rg -n "function_calls|function_call|functions" src/AI src/Intent includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 56ms:
src/Intent/Engine.php:72:		$this->register_default_functions();
src/Intent/Engine.php:94:		$enriched['function_suggestions'] = $this->function_registry->get_functions_for_intent( $enriched['intent'] );
src/Intent/Engine.php:174:	private function register_default_functions() {
src/Intent/Engine.php:185:		foreach ( $mapping as $intent => $functions ) {
src/Intent/Engine.php:191:			foreach ( $functions as $function_name ) {
src/Intent/FunctionRegistry.php:47:	public function get_functions_for_intent( $intent ) {
src/AI/OpenAIClient.php:91:	 * @param array $functions Tool definitions or FunctionSchema instances.
src/AI/OpenAIClient.php:94:	public function chat( array $messages, array $functions ) {
src/AI/OpenAIClient.php:99:		$tools = $this->normalize_tools( $functions );
src/AI/OpenAIClient.php:293:	 * @param array $functions Function definitions.
src/AI/OpenAIClient.php:296:	private function normalize_tools( array $functions ) {
src/AI/OpenAIClient.php:299:		foreach ( $functions as $function ) {
src/AI/OpenAIClient.php:402:		if ( empty( $tool_calls ) && isset( $message['function_call'] ) && is_array( $message['function_call'] ) ) {
src/AI/OpenAIClient.php:407:					'function' => $message['function_call'],
src/AI/OpenAIClient.php:480:			if ( isset( $delta['function_call'] ) && is_array( $delta['function_call'] ) ) {
src/AI/OpenAIClient.php:487:							'function' => $delta['function_call'],

thinking
**Searching for function_call handlers**
exec
/bin/zsh -lc 'rg -n "tool_calls|function_call" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
src/AI/OpenAIClient.php:167:				'tool_calls' => $parsed['tool_calls'],
src/AI/OpenAIClient.php:389:				'tool_calls' => array(),
src/AI/OpenAIClient.php:400:		$tool_calls = isset( $message['tool_calls'] ) && is_array( $message['tool_calls'] ) ? $message['tool_calls'] : array();
src/AI/OpenAIClient.php:402:		if ( empty( $tool_calls ) && isset( $message['function_call'] ) && is_array( $message['function_call'] ) ) {
src/AI/OpenAIClient.php:403:			$tool_calls = array(
src/AI/OpenAIClient.php:407:					'function' => $message['function_call'],
src/AI/OpenAIClient.php:416:			'tool_calls' => $tool_calls,
src/AI/OpenAIClient.php:430:		$tool_calls = array();
src/AI/OpenAIClient.php:476:			if ( isset( $delta['tool_calls'] ) && is_array( $delta['tool_calls'] ) ) {
src/AI/OpenAIClient.php:477:				$tool_calls = $this->merge_tool_call_deltas( $tool_calls, $delta['tool_calls'] );
src/AI/OpenAIClient.php:480:			if ( isset( $delta['function_call'] ) && is_array( $delta['function_call'] ) ) {
src/AI/OpenAIClient.php:481:				$tool_calls = $this->merge_tool_call_deltas(
src/AI/OpenAIClient.php:482:					$tool_calls,
src/AI/OpenAIClient.php:487:							'function' => $delta['function_call'],
src/AI/OpenAIClient.php:498:			'tool_calls' => array_values( $tool_calls ),
src/AI/OpenAIClient.php:506:	 * @param array $tool_calls Existing tool calls.
src/AI/OpenAIClient.php:510:	private function merge_tool_call_deltas( array $tool_calls, array $deltas ) {
src/AI/OpenAIClient.php:514:			if ( ! isset( $tool_calls[ $index ] ) ) {
src/AI/OpenAIClient.php:515:				$tool_calls[ $index ] = array(
src/AI/OpenAIClient.php:526:				$tool_calls[ $index ]['id'] = $delta['id'];

thinking
**Searching for function registry usage**
exec
/bin/zsh -lc "rg -n \"function_registry|get_handler\\(\" src" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:
src/Intent/FunctionRegistry.php:34:	public function get_handler( $function_name ) {
src/Intent/Engine.php:39:	private $function_registry;
src/Intent/Engine.php:53:	 * @param FunctionRegistry|null $function_registry Optional registry.
src/Intent/Engine.php:60:		FunctionRegistry $function_registry = null,
src/Intent/Engine.php:68:		$this->function_registry = $function_registry ? $function_registry : new FunctionRegistry();
src/Intent/Engine.php:94:		$enriched['function_suggestions'] = $this->function_registry->get_functions_for_intent( $enriched['intent'] );
src/Intent/Engine.php:114:	public function get_function_registry() {
src/Intent/Engine.php:115:		return $this->function_registry;
src/Intent/Engine.php:192:				$this->function_registry->register( $function_name, $handler );

thinking
**Searching for tool call handlers**
exec
/bin/zsh -lc 'rg -n "tool call|tool_call|function call|function_call" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
src/AI/OpenAIClient.php:167:				'tool_calls' => $parsed['tool_calls'],
src/AI/OpenAIClient.php:389:				'tool_calls' => array(),
src/AI/OpenAIClient.php:400:		$tool_calls = isset( $message['tool_calls'] ) && is_array( $message['tool_calls'] ) ? $message['tool_calls'] : array();
src/AI/OpenAIClient.php:402:		if ( empty( $tool_calls ) && isset( $message['function_call'] ) && is_array( $message['function_call'] ) ) {
src/AI/OpenAIClient.php:403:			$tool_calls = array(
src/AI/OpenAIClient.php:407:					'function' => $message['function_call'],
src/AI/OpenAIClient.php:416:			'tool_calls' => $tool_calls,
src/AI/OpenAIClient.php:430:		$tool_calls = array();
src/AI/OpenAIClient.php:476:			if ( isset( $delta['tool_calls'] ) && is_array( $delta['tool_calls'] ) ) {
src/AI/OpenAIClient.php:477:				$tool_calls = $this->merge_tool_call_deltas( $tool_calls, $delta['tool_calls'] );
src/AI/OpenAIClient.php:480:			if ( isset( $delta['function_call'] ) && is_array( $delta['function_call'] ) ) {
src/AI/OpenAIClient.php:481:				$tool_calls = $this->merge_tool_call_deltas(
src/AI/OpenAIClient.php:482:					$tool_calls,
src/AI/OpenAIClient.php:487:							'function' => $delta['function_call'],
src/AI/OpenAIClient.php:498:			'tool_calls' => array_values( $tool_calls ),
src/AI/OpenAIClient.php:506:	 * @param array $tool_calls Existing tool calls.
src/AI/OpenAIClient.php:510:	private function merge_tool_call_deltas( array $tool_calls, array $deltas ) {
src/AI/OpenAIClient.php:514:			if ( ! isset( $tool_calls[ $index ] ) ) {
src/AI/OpenAIClient.php:515:				$tool_calls[ $index ] = array(
src/AI/OpenAIClient.php:526:				$tool_calls[ $index ]['id'] = $delta['id'];

thinking
**Searching for tool calls and AI components**
exec
/bin/zsh -lc 'ls src/AI' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 44ms:
Functions
Model.php
OpenAIClient.php
Response.php
TokenCounter.php

thinking
**Searching for function calls in PHP controllers**
exec
/bin/zsh -lc 'rg -n "prepare_refund|prepare_status_update|prepare_stock_update|draft_email" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
src/Handlers/RefundHandler.php:27:		return $this->prepare_refund( $args );
src/Handlers/RefundHandler.php:36:	public function prepare_refund( array $args ): Response {
src/Handlers/OrderStatusHandler.php:32:		return $this->prepare_status_update( $args );
src/Handlers/OrderStatusHandler.php:41:	public function prepare_status_update( array $args ): Response {
src/Handlers/StockHandler.php:32:		return $this->prepare_stock_update( $args );
src/Handlers/StockHandler.php:73:	public function prepare_stock_update( array $args ): Response {
src/AI/Functions/PrepareRefund.php:12:		return 'prepare_refund';
src/AI/Functions/DraftEmail.php:12:		return 'draft_email';
src/AI/Functions/PrepareStatusUpdate.php:12:		return 'prepare_status_update';
src/AI/Functions/PrepareStockUpdate.php:12:		return 'prepare_stock_update';
src/Intent/Engine.php:177:			Intent::ORDER_REFUND    => array( 'prepare_refund', 'confirm_refund' ),
src/Intent/Engine.php:178:			Intent::ORDER_STATUS    => array( 'prepare_status_update', 'prepare_bulk_status_update', 'bulk_update' ),
src/Intent/Engine.php:179:			Intent::PRODUCT_STOCK   => array( 'prepare_stock_update', 'search_product' ),
src/Intent/Engine.php:180:			Intent::EMAIL_DRAFT     => array( 'draft_email' ),

thinking
**Searching for handler invocations**
exec
/bin/zsh -lc 'rg -n "FunctionRegistry|tool_calls|function_suggestions|function name" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 37ms:
src/Intent/Handlers/BaseHandler.php:62:		if ( isset( $context['function_suggestions'] ) ) {
src/Intent/Handlers/BaseHandler.php:63:			$payload['function_suggestions'] = $context['function_suggestions'];
src/Intent/FunctionRegistry.php:10:class FunctionRegistry {
src/Intent/FunctionRegistry.php:17:	 * @param string  $function_name OpenAI function name.
src/Intent/FunctionRegistry.php:31:	 * @param string $function_name OpenAI function name.
src/AI/OpenAIClient.php:167:				'tool_calls' => $parsed['tool_calls'],
src/AI/OpenAIClient.php:389:				'tool_calls' => array(),
src/AI/OpenAIClient.php:400:		$tool_calls = isset( $message['tool_calls'] ) && is_array( $message['tool_calls'] ) ? $message['tool_calls'] : array();
src/AI/OpenAIClient.php:402:		if ( empty( $tool_calls ) && isset( $message['function_call'] ) && is_array( $message['function_call'] ) ) {
src/AI/OpenAIClient.php:403:			$tool_calls = array(
src/AI/OpenAIClient.php:416:			'tool_calls' => $tool_calls,
src/AI/OpenAIClient.php:430:		$tool_calls = array();
src/AI/OpenAIClient.php:476:			if ( isset( $delta['tool_calls'] ) && is_array( $delta['tool_calls'] ) ) {
src/AI/OpenAIClient.php:477:				$tool_calls = $this->merge_tool_call_deltas( $tool_calls, $delta['tool_calls'] );
src/AI/OpenAIClient.php:481:				$tool_calls = $this->merge_tool_call_deltas(
src/AI/OpenAIClient.php:482:					$tool_calls,
src/AI/OpenAIClient.php:498:			'tool_calls' => array_values( $tool_calls ),
src/AI/OpenAIClient.php:506:	 * @param array $tool_calls Existing tool calls.
src/AI/OpenAIClient.php:510:	private function merge_tool_call_deltas( array $tool_calls, array $deltas ) {
src/AI/OpenAIClient.php:514:			if ( ! isset( $tool_calls[ $index ] ) ) {

thinking
**Checking BaseHandler**
exec
/bin/zsh -lc "sed -n '1,160p' src/Intent/Handlers/BaseHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 40ms:
<?php
/**
 * Base handler for intent responses.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Intent\Handler;
use AgentWP\Intent\Intent;

abstract class BaseHandler implements Handler {
	/**
	 * @var string
	 */
	protected $intent;

	/**

thinking
**Identifying handler distinctions and routing**
exec
/bin/zsh -lc 'rg -n "prepare_refund|confirm_refund|prepare_stock_update|prepare_status_update|draft_email" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
src/Handlers/RefundHandler.php:24:			return $this->confirm_refund( $args['draft_id'] );
src/Handlers/RefundHandler.php:27:		return $this->prepare_refund( $args );
src/Handlers/RefundHandler.php:36:	public function prepare_refund( array $args ): Response {
src/Handlers/RefundHandler.php:129:	public function confirm_refund( $draft_id ): Response {
src/Handlers/OrderStatusHandler.php:32:		return $this->prepare_status_update( $args );
src/Handlers/OrderStatusHandler.php:41:	public function prepare_status_update( array $args ): Response {
src/Handlers/StockHandler.php:32:		return $this->prepare_stock_update( $args );
src/Handlers/StockHandler.php:73:	public function prepare_stock_update( array $args ): Response {
src/AI/Functions/PrepareRefund.php:12:		return 'prepare_refund';
src/AI/Functions/ConfirmRefund.php:12:		return 'confirm_refund';
src/AI/Functions/DraftEmail.php:12:		return 'draft_email';
src/AI/Functions/PrepareStatusUpdate.php:12:		return 'prepare_status_update';
src/AI/Functions/PrepareStockUpdate.php:12:		return 'prepare_stock_update';
src/Intent/Engine.php:177:			Intent::ORDER_REFUND    => array( 'prepare_refund', 'confirm_refund' ),
src/Intent/Engine.php:178:			Intent::ORDER_STATUS    => array( 'prepare_status_update', 'prepare_bulk_status_update', 'bulk_update' ),
src/Intent/Engine.php:179:			Intent::PRODUCT_STOCK   => array( 'prepare_stock_update', 'search_product' ),
src/Intent/Engine.php:180:			Intent::EMAIL_DRAFT     => array( 'draft_email' ),

thinking
**Searching for RefundHandler usage**
exec
/bin/zsh -lc 'rg -n "RefundHandler|OrderStatusHandler|StockHandler" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 56ms:
src/Handlers/StockHandler.php:13:class StockHandler {
src/Handlers/RefundHandler.php:13:class RefundHandler {
src/Handlers/OrderStatusHandler.php:13:class OrderStatusHandler {
src/Intent/Handlers/OrderRefundHandler.php:13:class OrderRefundHandler extends BaseHandler {
src/Intent/Handlers/ProductStockHandler.php:11:use AgentWP\Handlers\StockHandler;
src/Intent/Handlers/ProductStockHandler.php:14:class ProductStockHandler extends BaseHandler {
src/Intent/Handlers/ProductStockHandler.php:32:		$search = new StockHandler();
src/Intent/Handlers/OrderStatusHandler.php:13:class OrderStatusHandler extends BaseHandler {
src/Intent/Engine.php:15:use AgentWP\Intent\Handlers\OrderRefundHandler;
src/Intent/Engine.php:17:use AgentWP\Intent\Handlers\OrderStatusHandler;
src/Intent/Engine.php:18:use AgentWP\Intent\Handlers\ProductStockHandler;
src/Intent/Engine.php:131:			new OrderRefundHandler(),
src/Intent/Engine.php:132:			new OrderStatusHandler(),
src/Intent/Engine.php:133:			new ProductStockHandler(),

thinking
**Examining ProductStockHandler usage**
exec
/bin/zsh -lc "sed -n '1,180p' src/Intent/Handlers/ProductStockHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 49ms:
<?php
/**
 * Handle product stock intents.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Handlers\StockHandler;
use AgentWP\Intent\Intent;

class ProductStockHandler extends BaseHandler {
	public function __construct() {
		parent::__construct( Intent::PRODUCT_STOCK );
	}

	/**
	 * @param array $context Context data.

thinking
**Checking StockHandler for search functionality**
exec
/bin/zsh -lc 'rg -n "search_product" -n src/Handlers/StockHandler.php' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 47ms:
25:			return $this->search_products( $args );
41:	public function search_products( array $args ): Response {
exec
/bin/zsh -lc "sed -n '1,200p' src/Handlers/StockHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 28ms:
<?php
/**
 * Handle product stock searches and updates.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;
use AgentWP\Plugin;

class StockHandler {
	const DRAFT_TYPE    = 'stock_update';
	const DEFAULT_LIMIT = 10;

	/**
	 * Handle stock-related requests.
	 *
	 * @param array $args Request args.

thinking
**Aligning EmailDraftHandler with StockHandler**
exec
/bin/zsh -lc "sed -n '1,220p' src/Handlers/RefundHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 53ms:
<?php
/**
 * Handle refund draft preparation and confirmation.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Response;
use AgentWP\Plugin;

class RefundHandler {
	const DRAFT_TYPE = 'refund';

	/**
	 * Handle refund-related requests.
	 *
	 * @param array $args Request args.
	 * @return Response

thinking
**Exploring draft storage and retrieval**
exec
/bin/zsh -lc 'rg -n "load_draft|update_draft|edit" src/Handlers' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 37ms:
src/Handlers/RefundHandler.php:139:		$draft = $this->load_draft( $draft_id );
src/Handlers/RefundHandler.php:439:	private function load_draft( $draft_id ) {
src/Handlers/OrderStatusHandler.php:258:		$draft = $this->load_draft( $draft_id );
src/Handlers/OrderStatusHandler.php:641:	private function load_draft( $draft_id ) {
src/Handlers/StockHandler.php:177:		$draft = $this->load_draft( $draft_id );
src/Handlers/StockHandler.php:550:	private function load_draft( $draft_id ) {

thinking
**Searching for draft_id usage**
exec
/bin/zsh -lc 'rg -n "draft_id" src includes' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 59ms:
src/Handlers/RefundHandler.php:23:		if ( isset( $args['draft_id'] ) ) {
src/Handlers/RefundHandler.php:24:			return $this->confirm_refund( $args['draft_id'] );
src/Handlers/RefundHandler.php:96:		$draft_id   = $this->generate_draft_id();
src/Handlers/RefundHandler.php:100:			$draft_id,
src/Handlers/RefundHandler.php:102:				'id'         => $draft_id,
src/Handlers/RefundHandler.php:116:				'draft_id'   => $draft_id,
src/Handlers/RefundHandler.php:126:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:129:	public function confirm_refund( $draft_id ): Response {
src/Handlers/RefundHandler.php:134:		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
src/Handlers/RefundHandler.php:135:		if ( '' === $draft_id ) {
src/Handlers/RefundHandler.php:139:		$draft = $this->load_draft( $draft_id );
src/Handlers/RefundHandler.php:201:		$this->delete_draft( $draft_id );
src/Handlers/RefundHandler.php:202:		$this->add_audit_note( $order, $draft_id, $refund_amount, $reason, ! empty( $restocked ) );
src/Handlers/RefundHandler.php:208:				'draft_id'               => $draft_id,
src/Handlers/RefundHandler.php:376:	private function generate_draft_id() {
src/Handlers/RefundHandler.php:385:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:388:	private function build_draft_key( $draft_id ) {
src/Handlers/RefundHandler.php:389:		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
src/Handlers/RefundHandler.php:422:	 * @param string $draft_id Draft identifier.
src/Handlers/RefundHandler.php:427:	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {

thinking
**Planning email draft handler implementation**
exec
/bin/zsh -lc 'ls src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
AI
API
Context
Handlers
index.php
Intent
Plugin.php
Rest
Security

thinking
**Exploring potential directory**
exec
/bin/zsh -lc 'ls src/Rest' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 55ms:
HealthController.php
IntentController.php
SettingsController.php

thinking
**Checking IntentController**
exec
/bin/zsh -lc "sed -n '1,260p' src/Rest/IntentController.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
<?php
/**
 * Intent REST controller.
 *
 * @package AgentWP
 */

namespace AgentWP\Rest;

use AgentWP\API\RestController;
use AgentWP\Intent\Engine;
use WP_REST_Server;

class IntentController extends RestController {
	/**
	 * Register REST routes.
	 *
	 * @return void
	 */
	public function register_routes() {

thinking
**Examining API endpoints**
exec
/bin/zsh -lc 'rg -n "function" src/Rest src/API src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 58ms:
src/Rest/HealthController.php:19:	public function register_routes() {
src/Rest/HealthController.php:37:	public function get_health( $request ) {
src/Rest/HealthController.php:19:	public function register_routes() {
src/Rest/HealthController.php:37:	public function get_health( $request ) {
src/API/RestController.php:21:	public function __construct() {
src/API/RestController.php:31:	public function permissions_check( $request ) {
src/API/RestController.php:56:	protected function validate_request( $request, array $schema, $source = 'json' ) {
src/API/RestController.php:77:	protected function response_success( $data, $status = 200 ) {
src/API/RestController.php:100:	protected function response_error( $code, $message, $status = 400 ) {
src/API/RestController.php:125:	public static function check_rate_limit( $request ) {
src/API/RestController.php:180:	public static function log_request( $request, $status, $error_code = '' ) {
src/Rest/SettingsController.php:23:	public function register_routes() {
src/Rest/SettingsController.php:68:	public function get_settings( $request ) {
src/Rest/SettingsController.php:91:	public function update_settings( $request ) {
src/Rest/SettingsController.php:118:	public function update_api_key( $request ) {
src/Rest/SettingsController.php:173:	public function get_usage( $request ) {
src/Rest/SettingsController.php:207:	private function read_settings() {
src/Rest/SettingsController.php:221:	private function apply_settings_updates( array $settings, array $payload ) {
src/Rest/SettingsController.php:271:	private function validate_openai_api_key( $api_key ) {
src/Rest/SettingsController.php:301:	private function encrypt_api_key( $api_key ) {

thinking
**Investigating function call handling in React**
exec
/bin/zsh -lc 'rg -n "draft_email|prepare_refund|function_suggestions|tool_calls" react src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 62ms:
src/Handlers/RefundHandler.php:27:		return $this->prepare_refund( $args );
src/Handlers/RefundHandler.php:36:	public function prepare_refund( array $args ): Response {
src/AI/Functions/PrepareRefund.php:12:		return 'prepare_refund';
src/AI/Functions/DraftEmail.php:12:		return 'draft_email';
src/AI/OpenAIClient.php:167:				'tool_calls' => $parsed['tool_calls'],
src/AI/OpenAIClient.php:389:				'tool_calls' => array(),
src/AI/OpenAIClient.php:400:		$tool_calls = isset( $message['tool_calls'] ) && is_array( $message['tool_calls'] ) ? $message['tool_calls'] : array();
src/AI/OpenAIClient.php:402:		if ( empty( $tool_calls ) && isset( $message['function_call'] ) && is_array( $message['function_call'] ) ) {
src/AI/OpenAIClient.php:403:			$tool_calls = array(
src/AI/OpenAIClient.php:416:			'tool_calls' => $tool_calls,
src/AI/OpenAIClient.php:430:		$tool_calls = array();
src/AI/OpenAIClient.php:476:			if ( isset( $delta['tool_calls'] ) && is_array( $delta['tool_calls'] ) ) {
src/AI/OpenAIClient.php:477:				$tool_calls = $this->merge_tool_call_deltas( $tool_calls, $delta['tool_calls'] );
src/AI/OpenAIClient.php:481:				$tool_calls = $this->merge_tool_call_deltas(
src/AI/OpenAIClient.php:482:					$tool_calls,
src/AI/OpenAIClient.php:498:			'tool_calls' => array_values( $tool_calls ),
src/AI/OpenAIClient.php:506:	 * @param array $tool_calls Existing tool calls.
src/AI/OpenAIClient.php:510:	private function merge_tool_call_deltas( array $tool_calls, array $deltas ) {
src/AI/OpenAIClient.php:514:			if ( ! isset( $tool_calls[ $index ] ) ) {
src/AI/OpenAIClient.php:515:				$tool_calls[ $index ] = array(

thinking
**Analyzing email draft handler requirements**
exec
/bin/zsh -lc 'rg -n "OpenAIClient" src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
src/AI/OpenAIClient.php:12:class OpenAIClient {

thinking
**Searching for AI-related components**
exec
/bin/zsh -lc 'rg -n "OpenAI|Model::|TokenCounter" src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 58ms:
src/Rest/SettingsController.php:266:	 * Validate API key against OpenAI.
src/Rest/SettingsController.php:284:			return new WP_Error( 'agentwp_openai_unreachable', __( 'OpenAI API is unreachable.', 'agentwp' ) );
src/Rest/SettingsController.php:289:			return new WP_Error( 'agentwp_openai_invalid', __( 'OpenAI rejected the API key.', 'agentwp' ) );
src/AI/TokenCounter.php:10:class TokenCounter {
src/AI/TokenCounter.php:25:		$model = Model::normalize( $model );
src/AI/TokenCounter.php:32:	 * Count tokens for messages using OpenAI chat heuristics.
src/AI/TokenCounter.php:39:		$model = Model::normalize( $model );
src/AI/TokenCounter.php:95:		$model = Model::normalize( $model );
src/AI/TokenCounter.php:111:		$model = Model::normalize( $model );
src/AI/OpenAIClient.php:3: * OpenAI API client wrapper.
src/AI/OpenAIClient.php:12:class OpenAIClient {
src/AI/OpenAIClient.php:41:	 * @var TokenCounter
src/AI/OpenAIClient.php:66:	 * @param string $api_key OpenAI API key.
src/AI/OpenAIClient.php:70:	public function __construct( $api_key, $model = Model::GPT_4O_MINI, array $options = array() ) {
src/AI/OpenAIClient.php:72:		$this->model         = Model::normalize( $model );
src/AI/OpenAIClient.php:76:		$this->token_counter = isset( $options['token_counter'] ) && $options['token_counter'] instanceof TokenCounter
src/AI/OpenAIClient.php:78:			: new TokenCounter();
src/AI/OpenAIClient.php:96:			return Response::error( 'Missing OpenAI API key.', 401 );
src/AI/OpenAIClient.php:175:	 * Validate an OpenAI API key.
src/AI/OpenAIClient.php:274:			$error = 'OpenAI API request failed.';

thinking
**Analyzing AI integration and OpenAIClient usage**

I'm noticing OpenAIClient isn't used elsewhere, which suggests the plugin defines AI-related functions but relies on external AI integration for actual generation. The spec implies dynamic, context-aware email draft generation, possibly with template-based logic since network calls are restricted here. I want to check the SettingsController to see how the OpenAI API key is stored to understand how OpenAIClient might be configured for remote calls in environments where the plugin runs fully.
exec
/bin/zsh -lc 'rg -n "openai" src/Plugin.php src/Rest/SettingsController.php src/API src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 58ms:
src/Rest/SettingsController.php:144:		$validation = $this->validate_openai_api_key( $api_key );
src/Rest/SettingsController.php:271:	private function validate_openai_api_key( $api_key ) {
src/Rest/SettingsController.php:273:			'https://api.openai.com/v1/models',
src/Rest/SettingsController.php:284:			return new WP_Error( 'agentwp_openai_unreachable', __( 'OpenAI API is unreachable.', 'agentwp' ) );
src/Rest/SettingsController.php:289:			return new WP_Error( 'agentwp_openai_invalid', __( 'OpenAI rejected the API key.', 'agentwp' ) );
src/Rest/SettingsController.php:144:		$validation = $this->validate_openai_api_key( $api_key );
src/Rest/SettingsController.php:271:	private function validate_openai_api_key( $api_key ) {
src/Rest/SettingsController.php:273:			'https://api.openai.com/v1/models',
src/Rest/SettingsController.php:284:			return new WP_Error( 'agentwp_openai_unreachable', __( 'OpenAI API is unreachable.', 'agentwp' ) );
src/Rest/SettingsController.php:289:			return new WP_Error( 'agentwp_openai_invalid', __( 'OpenAI rejected the API key.', 'agentwp' ) );
src/AI/OpenAIClient.php:13:	const API_BASE = 'https://api.openai.com/v1';
src/AI/OpenAIClient.php:159:			'usage_source'  => $usage_fallback ? 'tiktoken' : 'openai',

thinking
**Checking SettingsController for API key retrieval**
exec
/bin/zsh -lc "sed -n '1,240p' src/Rest/SettingsController.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
<?php
/**
 * Settings REST controller.
 *
 * @package AgentWP
 */

namespace AgentWP\Rest;

use AgentWP\API\RestController;
use AgentWP\Plugin;
use AgentWP\Security\Encryption;
use WP_Error;
use WP_REST_Server;

class SettingsController extends RestController {

	/**
	 * Register REST routes.
	 *

thinking
**Aligning draft TTL with settings**
exec
/bin/zsh -lc "sed -n '1,200p' src/Plugin.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
<?php
/**
 * Core plugin bootstrap.
 *
 * @package AgentWP
 */

namespace AgentWP;

class Plugin {
	const OPTION_SETTINGS     = 'agentwp_settings';
	const OPTION_API_KEY      = 'agentwp_api_key';
	const OPTION_API_KEY_LAST4 = 'agentwp_api_key_last4';
	const OPTION_BUDGET_LIMIT = 'agentwp_budget_limit';
	const OPTION_DRAFT_TTL    = 'agentwp_draft_ttl_minutes';
	const OPTION_USAGE_STATS  = 'agentwp_usage_stats';
	const TRANSIENT_PREFIX    = 'agentwp_';

	/**
	 * @var Plugin|null

thinking
**Verifying draft TTL usage across handlers**
exec
/bin/zsh -lc "sed -n '368,430p' src/Handlers/RefundHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 53ms:
		}

		return ! $gateway->supports( 'refunds' );
	}

	/**
	 * @return string
	 */
	private function generate_draft_id() {
		if ( function_exists( 'wp_generate_uuid4' ) ) {
			return wp_generate_uuid4();
		}

		return uniqid( 'draft_', true );
	}

	/**
	 * @param string $draft_id Draft identifier.
	 * @return string
	 */

thinking
**Defining email draft TTL defaults**
exec
/bin/zsh -lc 'ls src/API' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
RestController.php

thinking
**Analyzing handler integration possibilities**
exec
/bin/zsh -lc "sed -n '1,120p' src/Intent/Handlers/OrderStatusHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
<?php
/**
 * Handle order status intents.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent\Handlers;

use AgentWP\AI\Response;
use AgentWP\Intent\Intent;

class OrderStatusHandler extends BaseHandler {
	public function __construct() {
		parent::__construct( Intent::ORDER_STATUS );
	}

	/**
	 * @param array $context Context data.
	 * @return Response

thinking
**Evaluating email draft handling approach**
exec
/bin/zsh -lc 'rg -n "intent|openai|function|tool" react' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
react/src/App.jsx:10:const REST_PATH = '/agentwp/v1/intent';
react/src/App.jsx:64:  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {
react/src/App.jsx:79:export default function App() {
react/src/App.jsx:151:    if (lastActive && typeof lastActive.focus === 'function') {
react/components/cards/ErrorCard.jsx:18:export default function ErrorCard({
react/components/cards/DangerousActionCard.jsx:18:export default function DangerousActionCard({
react/components/cards/InfoCard.jsx:18:export default function InfoCard({
react/components/cards/DataTableCard.jsx:29:export default function DataTableCard({
react/components/cards/SuccessCard.jsx:18:export default function SuccessCard({
react/components/cards/ChartCard.jsx:18:export default function ChartCard({
react/components/cards/BaseCard.jsx:4:export default function BaseCard({

thinking
**Inspecting React app endpoints**
exec
/bin/zsh -lc "sed -n '1,240p' react/src/App.jsx" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
import { useCallback, useEffect, useRef, useState } from 'react';
import ReactMarkdown from 'react-markdown';

const OPEN_STATE_KEY = 'agentwp-command-deck-open';
const ADMIN_TRIGGER_SELECTORS = [
  '#wp-admin-bar-agentwp',
  '[data-agentwp-command-deck]',
  '#agentwp-command-deck',
];
const REST_PATH = '/agentwp/v1/intent';
const FOCUSABLE_SELECTORS = [
  'a[href]',
  'button:not([disabled])',
  'textarea:not([disabled])',
  'input:not([disabled])',
  'select:not([disabled])',
  '[tabindex]:not([tabindex="-1"])',
];

const getInitialOpenState = () => {

thinking
**Planning AI email draft handler**

I’m thinking through implementing an AI-powered email draft handler that integrates with EmailContextBuilder for dynamic prompts. The spec hints at calling OpenAI’s chat with messages and function schemas, so I’ll check the OpenAIClient interface next and follow coding patterns to ensure smooth WordPress compatibility.
exec
/bin/zsh -lc "sed -n '1,260p' src/AI/OpenAIClient.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
<?php
/**
 * OpenAI API client wrapper.
 *
 * @package AgentWP
 */

namespace AgentWP\AI;

use AgentWP\AI\Functions\FunctionSchema;

class OpenAIClient {
	const API_BASE = 'https://api.openai.com/v1';

	/**
	 * @var string
	 */
	private $api_key;

	/**

thinking
**Investigating encryption and key retrieval**
exec
/bin/zsh -lc 'rg -n "decrypt|Encryption" src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 57ms:
src/Rest/SettingsController.php:12:use AgentWP\Security\Encryption;
src/Rest/SettingsController.php:302:		$encryption = new Encryption();
src/Rest/SettingsController.php:323:		$encryption = new Encryption();
src/Security/Encryption.php:3: * Encryption helper for API keys.
src/Security/Encryption.php:10:class Encryption {
src/Security/Encryption.php:67:	public function decrypt( string $ciphertext ): string {
src/Security/Encryption.php:72:		if ( ! function_exists( 'openssl_decrypt' ) ) {
src/Security/Encryption.php:85:				$plaintext = openssl_decrypt( $payload['ciphertext'], self::CIPHER, $key, OPENSSL_RAW_DATA, $payload['iv'] );
src/Security/Encryption.php:103:			$plaintext = openssl_decrypt(
src/Security/Encryption.php:153:		$plaintext = $this->decrypt( $ciphertext );

thinking
**Searching for decrypt usage**
exec
/bin/zsh -lc 'rg -n "OPTION_API_KEY|api key" src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
src/Rest/SettingsController.php:72:		$last4    = get_option( Plugin::OPTION_API_KEY_LAST4, '' );
src/Rest/SettingsController.php:73:		$has_key  = ! empty( $last4 ) || ! empty( get_option( Plugin::OPTION_API_KEY ) );
src/Rest/SettingsController.php:129:			delete_option( Plugin::OPTION_API_KEY );
src/Rest/SettingsController.php:130:			delete_option( Plugin::OPTION_API_KEY_LAST4 );
src/Rest/SettingsController.php:154:		update_option( Plugin::OPTION_API_KEY, $encrypted, false );
src/Rest/SettingsController.php:157:		update_option( Plugin::OPTION_API_KEY_LAST4, $last4, false );
src/Rest/SettingsController.php:318:		$stored = get_option( Plugin::OPTION_API_KEY, '' );
src/Rest/SettingsController.php:330:		update_option( Plugin::OPTION_API_KEY, $rotated, false );
src/Plugin.php:12:	const OPTION_API_KEY      = 'agentwp_api_key';
src/Plugin.php:13:	const OPTION_API_KEY_LAST4 = 'agentwp_api_key_last4';
src/Plugin.php:55:		add_option( self::OPTION_API_KEY, '', '', false );
src/Plugin.php:56:		add_option( self::OPTION_API_KEY_LAST4, '', '', false );

thinking
**Planning API key handling**
exec
/bin/zsh -lc "sed -n '1,220p' src/Security/Encryption.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
<?php
/**
 * Encryption helper for API keys.
 *
 * @package AgentWP
 */

namespace AgentWP\Security;

class Encryption {
	const VERSION = 'awp1';
	const DELIMITER = ':';
	const CIPHER = 'aes-256-ctr';
	const LEGACY_CIPHER = 'aes-256-gcm';
	const LEGACY_NONCE_LENGTH = 12;
	const LEGACY_TAG_LENGTH = 16;

	/**
	 * Encrypt plaintext.
	 *

thinking
**Designing AI-powered email drafts**

I’m mapping out how to build the EmailDraftHandler class that retrieves and decrypts the API key, dynamically constructs AI prompts using EmailContextBuilder, supports various email intent types and tones, and handles template variables by substituting actual data when available. I’m balancing the need to call the OpenAI API with robust fallback templating, draft storage with editing capabilities, and parsing JSON responses, all while working within the existing handler patterns and keeping in mind network restrictions in this environment.
exec
/bin/zsh -lc 'rg -n "budget|usage" src' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
src/Rest/SettingsController.php:53:			'/usage',
src/Rest/SettingsController.php:56:				'callback'            => array( $this, 'get_usage' ),
src/Rest/SettingsController.php:168:	 * Get usage statistics.
src/Rest/SettingsController.php:173:	public function get_usage( $request ) {
src/Rest/SettingsController.php:174:		$validation = $this->validate_request( $request, $this->get_usage_schema(), 'query' );
src/Rest/SettingsController.php:183:			return $this->response_error( 'agentwp_invalid_period', __( 'Invalid usage period.', 'agentwp' ), 400 );
src/Rest/SettingsController.php:186:		$defaults = Plugin::get_default_usage_stats();
src/Rest/SettingsController.php:187:		$usage    = get_option( Plugin::OPTION_USAGE_STATS, array() );
src/Rest/SettingsController.php:188:		$usage    = is_array( $usage ) ? $usage : array();
src/Rest/SettingsController.php:189:		$usage    = wp_parse_args( $usage, $defaults );
src/Rest/SettingsController.php:191:		$usage['last_sync'] = gmdate( 'c' );
src/Rest/SettingsController.php:192:		update_option( Plugin::OPTION_USAGE_STATS, $usage, false );
src/Rest/SettingsController.php:197:				'usage'  => $usage,
src/Rest/SettingsController.php:229:		if ( isset( $payload['budget_limit'] ) ) {
src/Rest/SettingsController.php:230:			$budget_limit = floatval( $payload['budget_limit'] );
src/Rest/SettingsController.php:231:			if ( $budget_limit >= 0 ) {
src/Rest/SettingsController.php:232:				$settings['budget_limit'] = $budget_limit;
src/Rest/SettingsController.php:347:				'budget_limit'      => array(
src/Rest/SettingsController.php:387:	 * Schema for usage query params.
src/Rest/SettingsController.php:391:	private function get_usage_schema() {

thinking
**Assessing EmailDraftHandler integration**
exec
/bin/zsh -lc "sed -n '1,200p' src/Intent/ContextBuilder.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 51ms:
<?php
/**
 * Build enriched intent context.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

class ContextBuilder {
	/**
	 * Build context with store and user data.
	 *
	 * @param array $context Request context.
	 * @param array $metadata Request metadata.
	 * @return array
	 */
	public function build( array $context = array(), array $metadata = array() ) {
		return array(
			'request'       => $context,

thinking
**Checking context data for email templates**
exec
/bin/zsh -lc "sed -n '1,160p' src/Intent/Intent.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 48ms:
<?php
/**
 * Intent categories.
 *
 * @package AgentWP
 */

namespace AgentWP\Intent;

class Intent {
	const ORDER_SEARCH    = 'ORDER_SEARCH';
	const ORDER_REFUND    = 'ORDER_REFUND';
	const ORDER_STATUS    = 'ORDER_STATUS';
	const PRODUCT_STOCK   = 'PRODUCT_STOCK';
	const EMAIL_DRAFT     = 'EMAIL_DRAFT';
	const ANALYTICS_QUERY = 'ANALYTICS_QUERY';
	const CUSTOMER_LOOKUP = 'CUSTOMER_LOOKUP';
	const UNKNOWN         = 'UNKNOWN';

	/**

thinking
**Designing EmailDraftHandler functionality**
exec
/bin/zsh -lc "sed -n '1,160p' src/AI/Response.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 46ms:
<?php
/**
 * OpenAI response wrapper.
 *
 * @package AgentWP
 */

namespace AgentWP\AI;

class Response {
	/**
	 * @var bool
	 */
	private $success;

	/**
	 * @var int
	 */
	private $status;


thinking
**Designing new EmailDraftHandler**

I'm planning to create an EmailDraftHandler in src/Handlers that generates customer emails by calling OpenAI or using a fallback template. I'll also build dynamic prompts using EmailContextBuilder output to craft system and user messages with instructions, context, and template variables. To handle OpenAI’s JSON responses, I'll implement robust extraction and sanitization, including replacing placeholders with real data. I'll keep an eye on HTML validity and tone clarity, and consider fallback options when model output is incomplete. Finally, I'll check autoload setup to integrate the new handler smoothly.
exec
/bin/zsh -lc 'cat composer.json' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 52ms:
{
  "name": "agentwp/agentwp",
  "description": "AgentWP WordPress plugin.",
  "type": "wordpress-plugin",
  "license": "GPL-2.0-or-later",
  "autoload": {
    "psr-4": {
      "AgentWP\\": "src/"
    }
  },
  "require": {
    "php": ">=7.4",
    "yethee/tiktoken": "^0.1.2"
  }
}


thinking
**Outlining EmailDraftHandler implementation**
thinking
**Defining HTML normalization and text conversion**

I’m designing helper methods to normalize and sanitize email HTML—wrapping plain text in paragraphs, restricting allowed tags, and converting HTML to clean plain text—while also planning to replace placeholders with actual values to keep everything consistent and safe for email output.
exec
/bin/zsh -lc "sed -n '1,160p' src/AI/Model.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 48ms:
<?php
/**
 * OpenAI model abstraction.
 *
 * @package AgentWP
 */

namespace AgentWP\AI;

class Model {
	const GPT_4O = 'gpt-4o';
	const GPT_4O_MINI = 'gpt-4o-mini';

	/**
	 * List supported models.
	 *
	 * @return string[]
	 */
	public static function all() {
		return array(


thinking
**Outlining EmailDraftHandler implementation**

I’m laying out a detailed plan for building the new EmailDraftHandler class to generate, retrieve, update, and manage AI-powered email drafts. There’s a lot to cover—from prompt construction and parsing AI output to template variable substitution and draft storage—so I’m working through requirements, methods, and integration considerations before coding.
thinking
**Designing dynamic email content helpers and templates**

I’m defining helper methods to build tone-specific greetings, signatures, item lists, tracking info, and subject templates for various intents. These will assemble HTML and plain-text email sections with graceful handling of missing data, integrate template variable substitution, and ensure final drafts are normalized and sanitized before storage or returning.
file update
A /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/EmailDraftHandler.php
<?php
/**
 * Handle email draft preparation and editing.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Model;
use AgentWP\AI\OpenAIClient;
use AgentWP\AI\Response;
use AgentWP\Context\EmailContextBuilder;
use AgentWP\Plugin;
use AgentWP\Security\Encryption;

class EmailDraftHandler {
	const DRAFT_TYPE          = 'email_draft';
	const DEFAULT_TTL_MINUTES = 30;

	/**
	 * @var EmailContextBuilder
	 */
	private $context_builder;

	/**
	 * @param EmailContextBuilder|null $context_builder Optional context builder.
	 */
	public function __construct( EmailContextBuilder $context_builder = null ) {
		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
	}

	/**
	 * Handle email draft requests.
	 *
	 * @param array $args Request args.
	 * @return Response
	 */
	public function handle( array $args ): Response {
		if ( isset( $args['draft_id'] ) ) {
			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
			if ( '' === $draft_id ) {
				return Response::error( 'Missing email draft ID.', 400 );
			}

			if ( $this->has_update_payload( $args ) ) {
				return $this->update_draft( $draft_id, $args );
			}

			return $this->get_draft( $draft_id );
		}

		return $this->draft_email( $args );
	}

	/**
	 * Draft a new email.
	 *
	 * @param array $args Draft args.
	 * @return Response
	 */
	public function draft_email( array $args ): Response {
		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
		if ( 0 === $order_id ) {
			return Response::error( 'Missing order ID for email draft.', 400 );
		}

		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
		if ( '' === $intent ) {
			return Response::error( 'Missing or invalid email intent.', 400 );
		}

		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
		if ( '' === $tone ) {
			return Response::error( 'Missing or invalid email tone.', 400 );
		}

		$custom_instructions = isset( $args['custom_instructions'] )
			? $this->sanitize_instructions( $args['custom_instructions'] )
			: '';

		$context = $this->context_builder->build( $order_id );
		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
			$status = 'Order not found.' === $context['error'] ? 404 : 400;
			return Response::error( $context['error'], $status );
		}

		$template_variables  = $this->build_template_variables( $context );
		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );

		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
			return Response::error( 'Unable to generate email draft.', 500 );
		}

		$draft_id   = $this->generate_draft_id();
		$ttl        = $this->get_draft_ttl_seconds();
		$expires_at = gmdate( 'c', time() + $ttl );

		$draft_payload = array(
			'order_id'           => $order_id,
			'intent'             => $intent,
			'tone'               => $tone,
			'custom_instructions' => $custom_instructions,
			'subject_line'       => $draft['subject_line'],
			'email_body'         => $draft['email_body'],
			'plain_text_version' => $draft['plain_text_version'],
			'template_variables' => $template_variables,
		);

		$stored = $this->store_draft(
			$draft_id,
			array(
				'id'         => $draft_id,
				'type'       => self::DRAFT_TYPE,
				'payload'    => $draft_payload,
				'expires_at' => $expires_at,
			),
			$ttl
		);

		if ( ! $stored ) {
			return Response::error( 'Unable to store email draft.', 500 );
		}

		return Response::success(
			array(
				'draft_id'           => $draft_id,
				'draft'              => $draft_payload,
				'subject_line'       => $draft_payload['subject_line'],
				'email_body'         => $draft_payload['email_body'],
				'plain_text_version' => $draft_payload['plain_text_version'],
				'template_variables' => $template_variables,
				'expires_at'         => $expires_at,
			)
		);
	}

	/**
	 * Retrieve a stored draft.
	 *
	 * @param string $draft_id Draft identifier.
	 * @return Response
	 */
	public function get_draft( $draft_id ): Response {
		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
		if ( '' === $draft_id ) {
			return Response::error( 'Missing email draft ID.', 400 );
		}

		$draft = $this->load_draft( $draft_id );
		if ( null === $draft ) {
			return Response::error( 'Email draft not found or expired.', 404 );
		}

		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
			return Response::error( 'Draft type mismatch for email draft.', 400 );
		}

		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;

		return Response::success(
			array(
				'draft_id'           => $draft_id,
				'draft'              => $payload,
				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
			)
		);
	}

	/**
	 * Update a stored draft.
	 *
	 * @param string $draft_id Draft identifier.
	 * @param array  $args Update payload.
	 * @return Response
	 */
	public function update_draft( $draft_id, array $args ): Response {
		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
		if ( '' === $draft_id ) {
			return Response::error( 'Missing email draft ID.', 400 );
		}

		$draft = $this->load_draft( $draft_id );
		if ( null === $draft ) {
			return Response::error( 'Email draft not found or expired.', 404 );
		}

		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
			return Response::error( 'Draft type mismatch for email draft update.', 400 );
		}

		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
		$updates = array();

		if ( isset( $args['subject_line'] ) ) {
			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
		}

		if ( isset( $args['email_body'] ) ) {
			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
		}

		if ( isset( $args['plain_text_version'] ) ) {
			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
		}

		if ( isset( $args['tone'] ) ) {
			$updates['tone'] = $this->normalize_tone( $args['tone'] );
		}

		if ( isset( $args['intent'] ) ) {
			$updates['intent'] = $this->normalize_intent( $args['intent'] );
		}

		if ( isset( $args['custom_instructions'] ) ) {
			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
		}

		if ( empty( $updates ) ) {
			return Response::success(
				array(
					'draft_id'           => $draft_id,
					'draft'              => $payload,
					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
				)
			);
		}

		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
			? $payload['template_variables']
			: array();

		$payload = array_merge( $payload, $updates );

		if ( isset( $payload['subject_line'] ) ) {
			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
		}

		if ( isset( $payload['email_body'] ) ) {
			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
		}

		if ( isset( $payload['plain_text_version'] ) ) {
			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
		}

		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
			$payload['plain_text_version'] = $this->build_plain_text_from_html(
				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
			);
		}

		$ttl        = $this->get_draft_ttl_seconds();
		$expires_at = gmdate( 'c', time() + $ttl );

		$stored = $this->store_draft(
			$draft_id,
			array(
				'id'         => $draft_id,
				'type'       => self::DRAFT_TYPE,
				'payload'    => $payload,
				'expires_at' => $expires_at,
			),
			$ttl
		);

		if ( ! $stored ) {
			return Response::error( 'Unable to update email draft.', 500 );
		}

		return Response::success(
			array(
				'updated'            => true,
				'draft_id'           => $draft_id,
				'draft'              => $payload,
				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
				'template_variables' => $template_variables,
				'expires_at'         => $expires_at,
			)
		);
	}

	/**
	 * @param array $context Order context.
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param string $custom_instructions Custom instructions.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
			return $draft;
		}

		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
	}

	/**
	 * @param array $context Order context.
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param string $custom_instructions Custom instructions.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
		$api_key = $this->get_api_key();
		if ( '' === $api_key ) {
			return array();
		}

		$model    = $this->get_model();
		$client   = new OpenAIClient( $api_key, $model );
		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );

		$result = $client->chat( $messages, array() );
		if ( ! $result->is_success() ) {
			return array();
		}

		$data    = $result->get_data();
		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
		$parsed  = $this->parse_json_response( $content );

		if ( empty( $parsed ) ) {
			return array();
		}

		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );

		$subject = $this->sanitize_subject( $subject );
		$body    = $this->sanitize_body( $body );
		$plain   = $this->sanitize_plain_text( $plain );

		$subject = $this->apply_template_variables( $subject, $template_variables );
		$subject = $this->replace_known_placeholders( $subject, $template_variables );
		$body    = $this->apply_template_variables( $body, $template_variables );
		$body    = $this->replace_known_placeholders( $body, $template_variables );

		$body = $this->normalize_email_html( $body );
		$body = $this->sanitize_email_html( $body );

		if ( '' === trim( $plain ) ) {
			$plain = $this->build_plain_text_from_html( $body );
		}

		$plain = $this->apply_template_variables( $plain, $template_variables );
		$plain = $this->replace_known_placeholders( $plain, $template_variables );

		return array(
			'subject_line'       => $subject,
			'email_body'         => $body,
			'plain_text_version' => $plain,
		);
	}

	/**
	 * @param array $context Order context.
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param string $custom_instructions Custom instructions.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
		$subject = $this->build_subject_from_template( $intent, $tone );
		$subject = $this->apply_template_variables( $subject, $template_variables );

		$body_parts  = array();
		$text_parts  = array();
		$greeting    = $this->build_greeting( $tone, $template_variables );
		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
		$items_block = $this->build_items_block( $context );
		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
		$issue_block = $this->build_issue_block( $intent, $tone, $context );
		$closing     = $this->build_closing( $tone, $template_variables );

		if ( '' !== $greeting['html'] ) {
			$body_parts[] = $greeting['html'];
			$text_parts[] = $greeting['text'];
		}

		if ( '' !== $intro['html'] ) {
			$body_parts[] = $intro['html'];
			$text_parts[] = $intro['text'];
		}

		if ( '' !== $issue_block['html'] ) {
			$body_parts[] = $issue_block['html'];
			$text_parts[] = $issue_block['text'];
		}

		if ( '' !== $items_block['html'] ) {
			$body_parts[] = $items_block['html'];
			$text_parts[] = $items_block['text'];
		}

		if ( '' !== $tracking['html'] ) {
			$body_parts[] = $tracking['html'];
			$text_parts[] = $tracking['text'];
		}

		if ( '' !== $custom_instructions ) {
			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
			$text_parts[] = $custom_instructions;
		}

		if ( '' !== $closing['html'] ) {
			$body_parts[] = $closing['html'];
			$text_parts[] = $closing['text'];
		}

		$email_body = implode( "\n", $body_parts );
		$email_body = $this->apply_template_variables( $email_body, $template_variables );
		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
		$email_body = $this->normalize_email_html( $email_body );
		$email_body = $this->sanitize_email_html( $email_body );

		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );

		return array(
			'subject_line'       => $subject,
			'email_body'         => $email_body,
			'plain_text_version' => $plain_text,
		);
	}

	/**
	 * @param array $context Order context.
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param string $custom_instructions Custom instructions.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
		$store_name   = $this->get_store_name();
		$intent_notes = $this->get_intent_guidance( $intent, $context );
		$tone_notes   = $this->get_tone_guidance( $tone );
		$summary      = $this->build_prompt_context( $context );

		$system = sprintf(
			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
			$store_name
		);

		$user = array(
			'Intent: ' . $intent,
			'Tone: ' . $tone,
			'Intent guidance: ' . $intent_notes,
			'Tone guidance: ' . $tone_notes,
			'Order context (JSON): ' . $this->encode_json( $summary ),
			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
		);

		if ( '' !== $custom_instructions ) {
			$user[] = 'Custom instructions: ' . $custom_instructions;
		}

		$user[] = 'Output only JSON with the requested keys.';

		return array(
			array(
				'role'    => 'system',
				'content' => $system,
			),
			array(
				'role'    => 'user',
				'content' => implode( "\n", $user ),
			),
		);
	}

	/**
	 * @param array $context Order context.
	 * @return array
	 */
	private function build_prompt_context( array $context ) {
		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();

		return array(
			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
			'order'    => array(
				'status'     => isset( $order['status'] ) ? $order['status'] : '',
				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
			),
			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
			'shipping' => array(
				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
			),
			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
			'issues'   => $issues,
			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
		);
	}

	/**
	 * @param array $context Order context.
	 * @return array
	 */
	private function build_template_variables( array $context ) {
		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();

		$items_summary = $this->build_items_summary( $order );

		return array(
			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
			'{{item_list}}'        => $items_summary['summary'],
			'{{item_count}}'       => $items_summary['count'],
			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
			'{{store_name}}'       => $this->get_store_name(),
			'{{support_email}}'    => $this->get_support_email(),
		);
	}

	/**
	 * @param array $args Input payload.
	 * @return bool
	 */
	private function has_update_payload( array $args ) {
		return isset( $args['subject_line'] )
			|| isset( $args['email_body'] )
			|| isset( $args['plain_text_version'] )
			|| isset( $args['tone'] )
			|| isset( $args['intent'] )
			|| isset( $args['custom_instructions'] );
	}

	/**
	 * @param mixed $intent Input intent.
	 * @return string
	 */
	private function normalize_intent( $intent ) {
		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );

		return in_array( $intent, $valid, true ) ? $intent : '';
	}

	/**
	 * @param mixed $tone Input tone.
	 * @return string
	 */
	private function normalize_tone( $tone ) {
		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
		$valid = array( 'professional', 'friendly', 'apologetic' );

		return in_array( $tone, $valid, true ) ? $tone : '';
	}

	/**
	 * @param mixed $value Input.
	 * @return string
	 */
	private function sanitize_instructions( $value ) {
		$value = is_string( $value ) ? $value : '';

		if ( function_exists( 'sanitize_textarea_field' ) ) {
			return sanitize_textarea_field( wp_unslash( $value ) );
		}

		return sanitize_text_field( wp_unslash( $value ) );
	}

	/**
	 * @param mixed $value Input.
	 * @return string
	 */
	private function sanitize_subject( $value ) {
		$value = is_string( $value ) ? $value : '';
		return sanitize_text_field( wp_unslash( $value ) );
	}

	/**
	 * @param mixed $value Input.
	 * @return string
	 */
	private function sanitize_body( $value ) {
		$value = is_string( $value ) ? $value : '';
		return wp_unslash( $value );
	}

	/**
	 * @param mixed $value Input.
	 * @return string
	 */
	private function sanitize_plain_text( $value ) {
		$value = is_string( $value ) ? $value : '';
		return sanitize_textarea_field( wp_unslash( $value ) );
	}

	/**
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @return string
	 */
	private function build_subject_from_template( $intent, $tone ) {
		$templates = array(
			'shipping_update' => array(
				'professional' => 'Shipping update for order #{{order_id}}',
				'friendly'     => 'Your order #{{order_id}} is on the way!',
				'apologetic'   => 'Update on your order #{{order_id}}',
			),
			'refund_confirmation' => array(
				'professional' => 'Refund confirmation for order #{{order_id}}',
				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
				'apologetic'   => 'Refund update for order #{{order_id}}',
			),
			'order_issue' => array(
				'professional' => 'Update regarding order #{{order_id}}',
				'friendly'     => 'Quick update on order #{{order_id}}',
				'apologetic'   => 'We are sorry about order #{{order_id}}',
			),
			'general_inquiry' => array(
				'professional' => 'Following up on order #{{order_id}}',
				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
				'apologetic'   => 'Update on your request for order #{{order_id}}',
			),
			'review_request' => array(
				'professional' => 'How was your order #{{order_id}}?',
				'friendly'     => 'We would love your feedback on order #{{order_id}}',
				'apologetic'   => 'Thank you for your order #{{order_id}}',
			),
		);

		if ( isset( $templates[ $intent ][ $tone ] ) ) {
			return $templates[ $intent ][ $tone ];
		}

		return 'Update on order #{{order_id}}';
	}

	/**
	 * @param string $tone Email tone.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function build_greeting( $tone, array $template_variables ) {
		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
		$name = '' !== $name ? $name : 'there';

		$greeting = 'Hello';
		if ( 'friendly' === $tone ) {
			$greeting = 'Hi';
		} elseif ( 'apologetic' === $tone ) {
			$greeting = 'Hi';
		}

		$line = sprintf( '%s %s,', $greeting, $name );

		return array(
			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
			'text' => $line,
		);
	}

	/**
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param array $context Order context.
	 * @return array
	 */
	private function build_intro_sentence( $intent, $tone, array $context ) {
		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';

		$message = '';
		switch ( $intent ) {
			case 'shipping_update':
				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
				break;
			case 'refund_confirmation':
				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
				if ( 'apologetic' === $tone ) {
					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
				}
				break;
			case 'order_issue':
				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
				if ( 'apologetic' === $tone ) {
					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
				}
				break;
			case 'general_inquiry':
				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
				break;
			case 'review_request':
				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
				break;
			default:
				$message = sprintf( 'Here is an update on order #%s.', $order_id );
		}

		return array(
			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
			'text' => $message,
		);
	}

	/**
	 * @param array $context Order context.
	 * @return array
	 */
	private function build_items_block( array $context ) {
		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();

		$lines = array();
		foreach ( $items as $item ) {
			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
				continue;
			}

			$line = $item['name'];
			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
				$line .= ' (x' . intval( $item['quantity'] ) . ')';
			}

			$lines[] = $line;
		}

		if ( empty( $lines ) ) {
			return array(
				'html' => '',
				'text' => '',
			);
		}

		$max_lines = 4;
		if ( count( $lines ) > $max_lines ) {
			$lines = array_slice( $lines, 0, $max_lines );
			$lines[] = 'and more';
		}

		if ( count( $lines ) > 1 ) {
			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
			$text = "Items:\n- " . implode( "\n- ", $lines );
		} else {
			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
			$text = 'Item: ' . $lines[0] . '.';
		}

		return array(
			'html' => $html,
			'text' => $text,
		);
	}

	/**
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param array $context Order context.
	 * @return array
	 */
	private function build_tracking_block( $intent, $tone, array $context ) {
		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
			return array(
				'html' => '',
				'text' => '',
			);
		}

		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';

		if ( '' === $url && '' === $number && '' === $estimated ) {
			$message = 'We will share tracking details as soon as they are available.';
			if ( 'apologetic' === $tone ) {
				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
			}

			return array(
				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
				'text' => $message,
			);
		}

		$lines = array();
		if ( '' !== $number ) {
			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
		}

		if ( '' !== $estimated ) {
			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
		}

		$html = '';
		if ( '' !== $url ) {
			$link_label = 'Track your package';
			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
		}

		if ( ! empty( $lines ) ) {
			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
			$html       = '' !== $html ? $html . $html_lines : $html_lines;
		}

		$text = implode( "\n", $lines );
		if ( '' !== $url ) {
			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
		}

		return array(
			'html' => $html,
			'text' => $text,
		);
	}

	/**
	 * @param string $intent Email intent.
	 * @param string $tone Email tone.
	 * @param array $context Order context.
	 * @return array
	 */
	private function build_issue_block( $intent, $tone, array $context ) {
		if ( 'order_issue' !== $intent ) {
			return array(
				'html' => '',
				'text' => '',
			);
		}

		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
		$lines  = array();

		if ( ! empty( $issues['payment_failed'] ) ) {
			$lines[] = 'We were unable to process the payment on file.';
		}

		if ( ! empty( $issues['delayed_shipping'] ) ) {
			$lines[] = 'Shipping is taking longer than expected.';
		}

		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
			$item_names = array();
			foreach ( $issues['backordered_items'] as $item ) {
				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
					$item_names[] = $item['name'];
				}
			}

			if ( ! empty( $item_names ) ) {
				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
			}
		}

		if ( empty( $lines ) ) {
			$lines[] = 'We are reviewing the issue and will follow up shortly.';
		}

		if ( 'apologetic' === $tone ) {
			array_unshift( $lines, 'We are sorry for the inconvenience.' );
		}

		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
		$text = implode( "\n", $lines );

		return array(
			'html' => $html,
			'text' => $text,
		);
	}

	/**
	 * @param string $tone Email tone.
	 * @param array $template_variables Template variables.
	 * @return array
	 */
	private function build_closing( $tone, array $template_variables ) {
		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();

		$line = 'Thanks';
		if ( 'friendly' === $tone ) {
			$line = 'Thanks so much';
		} elseif ( 'apologetic' === $tone ) {
			$line = 'Thanks for your patience';
		}

		$closing = sprintf( '%s, %s Support', $line, $store_name );

		return array(
			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
			'text' => $closing,
		);
	}

	/**
	 * @param string $intent Email intent.
	 * @param array $context Order context.
	 * @return string
	 */
	private function get_intent_guidance( $intent, array $context ) {
		switch ( $intent ) {
			case 'shipping_update':
				return 'Share tracking information and estimated delivery. Mention the items when possible.';
			case 'refund_confirmation':
				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
			case 'order_issue':
				return 'Address the issue with empathy and describe the next steps.';
			case 'general_inquiry':
				return 'Provide a helpful status update and ask if there is anything else needed.';
			case 'review_request':
				return 'Invite the customer to leave a review and include an appreciative tone.';
			default:
				return 'Provide a helpful customer update.';
		}
	}

	/**
	 * @param string $tone Email tone.
	 * @return string
	 */
	private function get_tone_guidance( $tone ) {
		switch ( $tone ) {
			case 'friendly':
				return 'Warm, upbeat, and conversational.';
			case 'apologetic':
				return 'Empathetic and apologetic while remaining confident.';
			default:
				return 'Professional, concise, and helpful.';
		}
	}

	/**
	 * @param array $order Order context.
	 * @return array
	 */
	private function build_items_summary( array $order ) {
		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
		$names = array();

		foreach ( $items as $item ) {
			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
				continue;
			}

			$name = $item['name'];
			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
				$name .= ' (x' . intval( $item['quantity'] ) . ')';
			}

			$names[] = $name;
		}

		return array(
			'summary' => implode( ', ', $names ),
			'count'   => count( $names ),
		);
	}

	/**
	 * @param array $shipping Shipping context.
	 * @return string
	 */
	private function get_primary_shipping_method( array $shipping ) {
		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
			return '';
		}

		$method = $shipping['methods'][0];
		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
			return $method['method_title'];
		}

		return '';
	}

	/**
	 * @return string
	 */
	private function get_store_name() {
		if ( function_exists( 'get_bloginfo' ) ) {
			$name = get_bloginfo( 'name' );
			if ( '' !== $name ) {
				return $name;
			}
		}

		if ( function_exists( 'get_option' ) ) {
			$name = (string) get_option( 'blogname' );
			if ( '' !== $name ) {
				return $name;
			}
		}

		return 'our store';
	}

	/**
	 * @return string
	 */
	private function get_support_email() {
		if ( function_exists( 'get_option' ) ) {
			$email = (string) get_option( 'admin_email' );
			if ( '' !== $email ) {
				return $email;
			}
		}

		return '';
	}

	/**
	 * @param mixed $value Input.
	 * @return string
	 */
	private function format_currency( $value ) {
		if ( '' === $value || null === $value ) {
			return '';
		}

		if ( function_exists( 'wc_price' ) ) {
			return wp_strip_all_tags( wc_price( $value ) );
		}

		return (string) $value;
	}

	/**
	 * @param string $text Input.
	 * @param array $variables Template variables.
	 * @return string
	 */
	private function apply_template_variables( $text, array $variables ) {
		$text = is_string( $text ) ? $text : '';
		if ( '' === $text || empty( $variables ) ) {
			return $text;
		}

		$replace = array();
		foreach ( $variables as $key => $value ) {
			$value = is_scalar( $value ) ? (string) $value : '';
			if ( '' === $value ) {
				continue;
			}

			$replace[ $key ] = $value;
		}

		if ( empty( $replace ) ) {
			return $text;
		}

		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
	}

	/**
	 * @param string $text Input.
	 * @param array $variables Template variables.
	 * @return string
	 */
	private function replace_known_placeholders( $text, array $variables ) {
		$text = is_string( $text ) ? $text : '';
		if ( '' === $text ) {
			return $text;
		}

		$replacements = array(
			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
		);

		foreach ( $replacements as $placeholder => $value ) {
			if ( '' === $value ) {
				unset( $replacements[ $placeholder ] );
			}
		}

		if ( empty( $replacements ) ) {
			return $text;
		}

		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
	}

	/**
	 * @param string $html Input HTML.
	 * @return string
	 */
	private function normalize_email_html( $html ) {
		$html = is_string( $html ) ? trim( $html ) : '';
		if ( '' === $html ) {
			return '';
		}

		if ( ! $this->looks_like_html( $html ) ) {
			$parts = preg_split( "/\r?\n\r?\n/", $html );
			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
			$parts = array_filter( $parts );

			if ( empty( $parts ) ) {
				return '';
			}

			$wrapped = array();
			foreach ( $parts as $part ) {
				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
			}

			return implode( "\n", $wrapped );
		}

		return $html;
	}

	/**
	 * @param string $html Input HTML.
	 * @return string
	 */
	private function sanitize_email_html( $html ) {
		$html = is_string( $html ) ? $html : '';

		if ( function_exists( 'wp_kses' ) ) {
			$allowed = array(
				'p'      => array(),
				'br'     => array(),
				'strong' => array(),
				'em'     => array(),
				'ul'     => array(),
				'ol'     => array(),
				'li'     => array(),
				'a'      => array(
					'href'   => true,
					'title'  => true,
					'target' => true,
					'rel'    => true,
				),
			);

			return wp_kses( $html, $allowed );
		}

		return $html;
	}

	/**
	 * @param string $html Input HTML.
	 * @return string
	 */
	private function build_plain_text_from_html( $html ) {
		$html = is_string( $html ) ? $html : '';
		if ( '' === $html ) {
			return '';
		}

		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
		$text = strip_tags( $text );
		$text = html_entity_decode( $text, ENT_QUOTES );
		$text = preg_replace( "/\n{3,}/", "\n\n", $text );

		return trim( $text );
	}

	/**
	 * @param string $text Input.
	 * @return bool
	 */
	private function looks_like_html( $text ) {
		return (bool) preg_match( '/<[^>]+>/', $text );
	}

	/**
	 * @param string $value Input value.
	 * @return string
	 */
	private function escape_html( $value ) {
		$value = is_string( $value ) ? $value : '';
		if ( function_exists( 'esc_html' ) ) {
			return esc_html( $value );
		}

		return htmlspecialchars( $value, ENT_QUOTES );
	}

	/**
	 * @param string $value Input value.
	 * @return string
	 */
	private function escape_url( $value ) {
		$value = is_string( $value ) ? $value : '';
		if ( function_exists( 'esc_url' ) ) {
			return esc_url( $value );
		}

		return htmlspecialchars( $value, ENT_QUOTES );
	}

	/**
	 * @param mixed $value Input.
	 * @return string
	 */
	private function encode_json( $value ) {
		if ( function_exists( 'wp_json_encode' ) ) {
			return wp_json_encode( $value );
		}

		return json_encode( $value );
	}

	/**
	 * @param string $content Response content.
	 * @return array
	 */
	private function parse_json_response( $content ) {
		$content = is_string( $content ) ? trim( $content ) : '';
		if ( '' === $content ) {
			return array();
		}

		$decoded = json_decode( $content, true );
		if ( is_array( $decoded ) ) {
			return $decoded;
		}

		$start = strpos( $content, '{' );
		$end   = strrpos( $content, '}' );
		if ( false === $start || false === $end || $end <= $start ) {
			return array();
		}

		$snippet = substr( $content, $start, $end - $start + 1 );
		$decoded = json_decode( $snippet, true );

		return is_array( $decoded ) ? $decoded : array();
	}

	/**
	 * @return string
	 */
	private function get_api_key() {
		if ( ! function_exists( 'get_option' ) ) {
			return '';
		}

		$stored = get_option( Plugin::OPTION_API_KEY, '' );
		$stored = is_string( $stored ) ? $stored : '';
		if ( '' === $stored ) {
			return '';
		}

		$encryption = new Encryption();
		$decrypted  = $encryption->decrypt( $stored );

		if ( '' !== $decrypted ) {
			return $decrypted;
		}

		return $encryption->isEncrypted( $stored ) ? '' : $stored;
	}

	/**
	 * @return string
	 */
	private function get_model() {
		$model = '';

		if ( function_exists( 'get_option' ) ) {
			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
				$model = (string) $settings['model'];
			}
		}

		return Model::normalize( $model );
	}

	/**
	 * @return string
	 */
	private function generate_draft_id() {
		if ( function_exists( 'wp_generate_uuid4' ) ) {
			return wp_generate_uuid4();
		}

		return uniqid( 'draft_', true );
	}

	/**
	 * @param string $draft_id Draft identifier.
	 * @return string
	 */
	private function build_draft_key( $draft_id ) {
		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
	}

	/**
	 * @return int
	 */
	private function get_draft_ttl_seconds() {
		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;

		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
	}

	/**
	 * @param string $draft_id Draft identifier.
	 * @param array  $draft Draft payload.
	 * @param int    $ttl_seconds Expiration seconds.
	 * @return bool
	 */
	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
		if ( ! function_exists( 'set_transient' ) ) {
			return false;
		}

		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
	}

	/**
	 * @param string $draft_id Draft identifier.
	 * @return array|null
	 */
	private function load_draft( $draft_id ) {
		if ( ! function_exists( 'get_transient' ) ) {
			return null;
		}

		$draft = get_transient( $this->build_draft_key( $draft_id ) );

		return is_array( $draft ) ? $draft : null;
	}
}
apply_patch(auto_approved=true) exited 0 in 64ms:
Success. Updated the following files:
A src/Handlers/EmailDraftHandler.php
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..6ce692aba29529841cd68651edc176958d2b429e
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1375 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$updates['tone'] = $this->normalize_tone( $args['tone'] );
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$updates['intent'] = $this->normalize_intent( $args['intent'] );
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}

file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..6ce692aba29529841cd68651edc176958d2b429e
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1375 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$updates['tone'] = $this->normalize_tone( $args['tone'] );
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$updates['intent'] = $this->normalize_intent( $args['intent'] );
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}


thinking
**Reviewing new file for function usage**
exec
/bin/zsh -lc "sed -n '1,240p' src/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 51ms:
<?php
/**
 * Handle email draft preparation and editing.
 *
 * @package AgentWP
 */

namespace AgentWP\Handlers;

use AgentWP\AI\Model;
use AgentWP\AI\OpenAIClient;
use AgentWP\AI\Response;
use AgentWP\Context\EmailContextBuilder;
use AgentWP\Plugin;
use AgentWP\Security\Encryption;

class EmailDraftHandler {
	const DRAFT_TYPE          = 'email_draft';
	const DEFAULT_TTL_MINUTES = 30;

file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..6ce692aba29529841cd68651edc176958d2b429e
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1375 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$updates['tone'] = $this->normalize_tone( $args['tone'] );
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$updates['intent'] = $this->normalize_intent( $args['intent'] );
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}


thinking
**Continuing to review code near line**
exec
/bin/zsh -lc "sed -n '240,480p' src/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 50ms:
			: array();

		$payload = array_merge( $payload, $updates );

		if ( isset( $payload['subject_line'] ) ) {
			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
		}

		if ( isset( $payload['email_body'] ) ) {
			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
		}

		if ( isset( $payload['plain_text_version'] ) ) {
			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
		}
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..6ce692aba29529841cd68651edc176958d2b429e
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1375 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$updates['tone'] = $this->normalize_tone( $args['tone'] );
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$updates['intent'] = $this->normalize_intent( $args['intent'] );
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}


thinking
**Continuing to review content**
exec
/bin/zsh -lc "sed -n '480,960p' src/Handlers/EmailDraftHandler.php" in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 44ms:
		}

		$user[] = 'Output only JSON with the requested keys.';

		return array(
			array(
				'role'    => 'system',
				'content' => $system,
			),
			array(
				'role'    => 'user',
				'content' => implode( "\n", $user ),
			),
		);
	}

	/**
	 * @param array $context Order context.
	 * @return array
	 */
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..6ce692aba29529841cd68651edc176958d2b429e
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1375 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$updates['tone'] = $this->normalize_tone( $args['tone'] );
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$updates['intent'] = $this->normalize_intent( $args['intent'] );
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}

Reconnecting... 1/5

thinking
**Reviewing potential issues and improvements**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/EmailDraftHandler.php
@@ -212,3 +212,7 @@
 		if ( isset( $args['tone'] ) ) {
-			$updates['tone'] = $this->normalize_tone( $args['tone'] );
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
 		}
@@ -216,3 +220,7 @@
 		if ( isset( $args['intent'] ) ) {
-			$updates['intent'] = $this->normalize_intent( $args['intent'] );
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
 		}
apply_patch(auto_approved=true) exited 0 in 36ms:
Success. Updated the following files:
M src/Handlers/EmailDraftHandler.php
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..ec36cfaa6771ff9a9a9f2c7fa89d5c287a849918
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1383 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}

file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..ec36cfaa6771ff9a9a9f2c7fa89d5c287a849918
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1383 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_textarea_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}


thinking
**Updating sanitize_plain_text with fallback**
file update
M /Users/ahmedyounis/Documents/Projects/agentwp/src/Handlers/EmailDraftHandler.php
@@ -639,3 +639,7 @@
 		$value = is_string( $value ) ? $value : '';
-		return sanitize_textarea_field( wp_unslash( $value ) );
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
 	}
@@ -1208,3 +1212,3 @@
 		$text = strip_tags( $text );
-		$text = html_entity_decode( $text, ENT_QUOTES );
+		$text = html_entity_decode( $text, ENT_QUOTES, 'UTF-8' );
 		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
apply_patch(auto_approved=true) exited 0 in 33ms:
Success. Updated the following files:
M src/Handlers/EmailDraftHandler.php
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..9fb5b76413274aa15e402cff2fc40954bd4d7aa3
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1387 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES, 'UTF-8' );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}

file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..9fb5b76413274aa15e402cff2fc40954bd4d7aa3
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1387 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES, 'UTF-8' );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}


thinking
**Evaluating email draft handling details**

I’m carefully reviewing potential issues and improvements around email draft generation, sanitization, template variable handling, and compliance with specs to ensure the new EmailDraftHandler fits well within the WordPress plugin environment and meets functional expectations.
exec
/bin/zsh -lc 'git status --short' in /Users/ahmedyounis/Documents/Projects/agentwp succeeded in 54ms:
 M .t2/state.json
?? .logs/M03-01.gitcommit.txt
?? .logs/M03-02.codex.impl.last.md
?? .logs/M03-02.codex.impl.raw.txt
?? .plans/M03-02.md
?? .t2/handoff/M03-02.md
?? src/Handlers/EmailDraftHandler.php
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..9fb5b76413274aa15e402cff2fc40954bd4d7aa3
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1387 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES, 'UTF-8' );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}


thinking
**Preparing final summary and response structure**

I'll compose a clear final message that leads with a brief explanation of the new email draft handler, then includes distinct sections for status, summary of changes, verification commands (not provided), and risks or follow-ups, following the user's formatting instructions.
codex
Implemented a new email drafting handler that builds OpenAI prompts from order context, generates HTML + plain-text drafts with template variable replacement, and stores them for retrieval/editing in transients (`src/Handlers/EmailDraftHandler.php`).

**Status**
- DONE

**Summary of changes**
- Added `src/Handlers/EmailDraftHandler.php` with AI + fallback draft generation, EmailContextBuilder-driven prompts, placeholder cleanup, and 30‑minute transient storage/retrieval/edit flows.

**How to verify (exact commands)**
- None provided.

**Risks / follow-ups**
- OpenAI requests and WooCommerce data paths were not exercised locally; validate with a real order and API key to confirm tone variance and tracking/product mentions.

Next steps (optional):
1) Provide an order ID + API key so I can outline a manual smoke test for draft/create/update retrieval flows.
file update:
diff --git a/src/Handlers/EmailDraftHandler.php b/src/Handlers/EmailDraftHandler.php
new file mode 100644
index 0000000000000000000000000000000000000000..9fb5b76413274aa15e402cff2fc40954bd4d7aa3
--- /dev/null
+++ b/src/Handlers/EmailDraftHandler.php
@@ -0,0 +1,1387 @@
+<?php
+/**
+ * Handle email draft preparation and editing.
+ *
+ * @package AgentWP
+ */
+
+namespace AgentWP\Handlers;
+
+use AgentWP\AI\Model;
+use AgentWP\AI\OpenAIClient;
+use AgentWP\AI\Response;
+use AgentWP\Context\EmailContextBuilder;
+use AgentWP\Plugin;
+use AgentWP\Security\Encryption;
+
+class EmailDraftHandler {
+	const DRAFT_TYPE          = 'email_draft';
+	const DEFAULT_TTL_MINUTES = 30;
+
+	/**
+	 * @var EmailContextBuilder
+	 */
+	private $context_builder;
+
+	/**
+	 * @param EmailContextBuilder|null $context_builder Optional context builder.
+	 */
+	public function __construct( EmailContextBuilder $context_builder = null ) {
+		$this->context_builder = $context_builder ? $context_builder : new EmailContextBuilder();
+	}
+
+	/**
+	 * Handle email draft requests.
+	 *
+	 * @param array $args Request args.
+	 * @return Response
+	 */
+	public function handle( array $args ): Response {
+		if ( isset( $args['draft_id'] ) ) {
+			$draft_id = is_string( $args['draft_id'] ) ? trim( $args['draft_id'] ) : '';
+			if ( '' === $draft_id ) {
+				return Response::error( 'Missing email draft ID.', 400 );
+			}
+
+			if ( $this->has_update_payload( $args ) ) {
+				return $this->update_draft( $draft_id, $args );
+			}
+
+			return $this->get_draft( $draft_id );
+		}
+
+		return $this->draft_email( $args );
+	}
+
+	/**
+	 * Draft a new email.
+	 *
+	 * @param array $args Draft args.
+	 * @return Response
+	 */
+	public function draft_email( array $args ): Response {
+		$order_id = isset( $args['order_id'] ) ? absint( $args['order_id'] ) : 0;
+		if ( 0 === $order_id ) {
+			return Response::error( 'Missing order ID for email draft.', 400 );
+		}
+
+		$intent = isset( $args['intent'] ) ? $this->normalize_intent( $args['intent'] ) : '';
+		if ( '' === $intent ) {
+			return Response::error( 'Missing or invalid email intent.', 400 );
+		}
+
+		$tone = isset( $args['tone'] ) ? $this->normalize_tone( $args['tone'] ) : '';
+		if ( '' === $tone ) {
+			return Response::error( 'Missing or invalid email tone.', 400 );
+		}
+
+		$custom_instructions = isset( $args['custom_instructions'] )
+			? $this->sanitize_instructions( $args['custom_instructions'] )
+			: '';
+
+		$context = $this->context_builder->build( $order_id );
+		if ( isset( $context['error'] ) && '' !== $context['error'] ) {
+			$status = 'Order not found.' === $context['error'] ? 404 : 400;
+			return Response::error( $context['error'], $status );
+		}
+
+		$template_variables  = $this->build_template_variables( $context );
+		$custom_instructions = $this->apply_template_variables( $custom_instructions, $template_variables );
+
+		$draft = $this->generate_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( empty( $draft['subject_line'] ) || empty( $draft['email_body'] ) ) {
+			return Response::error( 'Unable to generate email draft.', 500 );
+		}
+
+		$draft_id   = $this->generate_draft_id();
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$draft_payload = array(
+			'order_id'           => $order_id,
+			'intent'             => $intent,
+			'tone'               => $tone,
+			'custom_instructions' => $custom_instructions,
+			'subject_line'       => $draft['subject_line'],
+			'email_body'         => $draft['email_body'],
+			'plain_text_version' => $draft['plain_text_version'],
+			'template_variables' => $template_variables,
+		);
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $draft_payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to store email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $draft_payload,
+				'subject_line'       => $draft_payload['subject_line'],
+				'email_body'         => $draft_payload['email_body'],
+				'plain_text_version' => $draft_payload['plain_text_version'],
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * Retrieve a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @return Response
+	 */
+	public function get_draft( $draft_id ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+
+		return Response::success(
+			array(
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+				'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+			)
+		);
+	}
+
+	/**
+	 * Update a stored draft.
+	 *
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $args Update payload.
+	 * @return Response
+	 */
+	public function update_draft( $draft_id, array $args ): Response {
+		$draft_id = is_string( $draft_id ) ? trim( $draft_id ) : '';
+		if ( '' === $draft_id ) {
+			return Response::error( 'Missing email draft ID.', 400 );
+		}
+
+		$draft = $this->load_draft( $draft_id );
+		if ( null === $draft ) {
+			return Response::error( 'Email draft not found or expired.', 404 );
+		}
+
+		if ( isset( $draft['type'] ) && self::DRAFT_TYPE !== $draft['type'] ) {
+			return Response::error( 'Draft type mismatch for email draft update.', 400 );
+		}
+
+		$payload = isset( $draft['payload'] ) && is_array( $draft['payload'] ) ? $draft['payload'] : $draft;
+		$updates = array();
+
+		if ( isset( $args['subject_line'] ) ) {
+			$updates['subject_line'] = $this->sanitize_subject( $args['subject_line'] );
+		}
+
+		if ( isset( $args['email_body'] ) ) {
+			$updates['email_body'] = $this->sanitize_body( $args['email_body'] );
+		}
+
+		if ( isset( $args['plain_text_version'] ) ) {
+			$updates['plain_text_version'] = $this->sanitize_plain_text( $args['plain_text_version'] );
+		}
+
+		if ( isset( $args['tone'] ) ) {
+			$normalized = $this->normalize_tone( $args['tone'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid tone for email draft update.', 400 );
+			}
+			$updates['tone'] = $normalized;
+		}
+
+		if ( isset( $args['intent'] ) ) {
+			$normalized = $this->normalize_intent( $args['intent'] );
+			if ( '' === $normalized ) {
+				return Response::error( 'Invalid intent for email draft update.', 400 );
+			}
+			$updates['intent'] = $normalized;
+		}
+
+		if ( isset( $args['custom_instructions'] ) ) {
+			$updates['custom_instructions'] = $this->sanitize_instructions( $args['custom_instructions'] );
+		}
+
+		if ( empty( $updates ) ) {
+			return Response::success(
+				array(
+					'draft_id'           => $draft_id,
+					'draft'              => $payload,
+					'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+					'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+					'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+					'template_variables' => isset( $payload['template_variables'] ) ? $payload['template_variables'] : array(),
+					'expires_at'         => isset( $draft['expires_at'] ) ? $draft['expires_at'] : '',
+				)
+			);
+		}
+
+		$template_variables = isset( $payload['template_variables'] ) && is_array( $payload['template_variables'] )
+			? $payload['template_variables']
+			: array();
+
+		$payload = array_merge( $payload, $updates );
+
+		if ( isset( $payload['subject_line'] ) ) {
+			$payload['subject_line'] = $this->apply_template_variables( $payload['subject_line'], $template_variables );
+			$payload['subject_line'] = $this->replace_known_placeholders( $payload['subject_line'], $template_variables );
+		}
+
+		if ( isset( $payload['email_body'] ) ) {
+			$payload['email_body'] = $this->apply_template_variables( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->replace_known_placeholders( $payload['email_body'], $template_variables );
+			$payload['email_body'] = $this->normalize_email_html( $payload['email_body'] );
+			$payload['email_body'] = $this->sanitize_email_html( $payload['email_body'] );
+		}
+
+		if ( isset( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->apply_template_variables( $payload['plain_text_version'], $template_variables );
+			$payload['plain_text_version'] = $this->replace_known_placeholders( $payload['plain_text_version'], $template_variables );
+		}
+
+		if ( ! isset( $payload['plain_text_version'] ) || '' === trim( $payload['plain_text_version'] ) ) {
+			$payload['plain_text_version'] = $this->build_plain_text_from_html(
+				isset( $payload['email_body'] ) ? $payload['email_body'] : ''
+			);
+		}
+
+		$ttl        = $this->get_draft_ttl_seconds();
+		$expires_at = gmdate( 'c', time() + $ttl );
+
+		$stored = $this->store_draft(
+			$draft_id,
+			array(
+				'id'         => $draft_id,
+				'type'       => self::DRAFT_TYPE,
+				'payload'    => $payload,
+				'expires_at' => $expires_at,
+			),
+			$ttl
+		);
+
+		if ( ! $stored ) {
+			return Response::error( 'Unable to update email draft.', 500 );
+		}
+
+		return Response::success(
+			array(
+				'updated'            => true,
+				'draft_id'           => $draft_id,
+				'draft'              => $payload,
+				'subject_line'       => isset( $payload['subject_line'] ) ? $payload['subject_line'] : '',
+				'email_body'         => isset( $payload['email_body'] ) ? $payload['email_body'] : '',
+				'plain_text_version' => isset( $payload['plain_text_version'] ) ? $payload['plain_text_version'] : '',
+				'template_variables' => $template_variables,
+				'expires_at'         => $expires_at,
+			)
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$draft = $this->generate_draft_with_ai( $context, $intent, $tone, $custom_instructions, $template_variables );
+		if ( ! empty( $draft['subject_line'] ) && ! empty( $draft['email_body'] ) ) {
+			return $draft;
+		}
+
+		return $this->generate_fallback_draft( $context, $intent, $tone, $custom_instructions, $template_variables );
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_draft_with_ai( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$api_key = $this->get_api_key();
+		if ( '' === $api_key ) {
+			return array();
+		}
+
+		$model    = $this->get_model();
+		$client   = new OpenAIClient( $api_key, $model );
+		$messages = $this->build_prompt_messages( $context, $intent, $tone, $custom_instructions, $template_variables );
+
+		$result = $client->chat( $messages, array() );
+		if ( ! $result->is_success() ) {
+			return array();
+		}
+
+		$data    = $result->get_data();
+		$content = isset( $data['content'] ) ? (string) $data['content'] : '';
+		$parsed  = $this->parse_json_response( $content );
+
+		if ( empty( $parsed ) ) {
+			return array();
+		}
+
+		$subject = isset( $parsed['subject_line'] ) ? $parsed['subject_line'] : ( $parsed['subject'] ?? '' );
+		$body    = isset( $parsed['email_body'] ) ? $parsed['email_body'] : ( $parsed['body'] ?? '' );
+		$plain   = isset( $parsed['plain_text_version'] ) ? $parsed['plain_text_version'] : ( $parsed['plain_text'] ?? '' );
+
+		$subject = $this->sanitize_subject( $subject );
+		$body    = $this->sanitize_body( $body );
+		$plain   = $this->sanitize_plain_text( $plain );
+
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+		$subject = $this->replace_known_placeholders( $subject, $template_variables );
+		$body    = $this->apply_template_variables( $body, $template_variables );
+		$body    = $this->replace_known_placeholders( $body, $template_variables );
+
+		$body = $this->normalize_email_html( $body );
+		$body = $this->sanitize_email_html( $body );
+
+		if ( '' === trim( $plain ) ) {
+			$plain = $this->build_plain_text_from_html( $body );
+		}
+
+		$plain = $this->apply_template_variables( $plain, $template_variables );
+		$plain = $this->replace_known_placeholders( $plain, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $body,
+			'plain_text_version' => $plain,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function generate_fallback_draft( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$subject = $this->build_subject_from_template( $intent, $tone );
+		$subject = $this->apply_template_variables( $subject, $template_variables );
+
+		$body_parts  = array();
+		$text_parts  = array();
+		$greeting    = $this->build_greeting( $tone, $template_variables );
+		$intro       = $this->build_intro_sentence( $intent, $tone, $context );
+		$items_block = $this->build_items_block( $context );
+		$tracking    = $this->build_tracking_block( $intent, $tone, $context );
+		$issue_block = $this->build_issue_block( $intent, $tone, $context );
+		$closing     = $this->build_closing( $tone, $template_variables );
+
+		if ( '' !== $greeting['html'] ) {
+			$body_parts[] = $greeting['html'];
+			$text_parts[] = $greeting['text'];
+		}
+
+		if ( '' !== $intro['html'] ) {
+			$body_parts[] = $intro['html'];
+			$text_parts[] = $intro['text'];
+		}
+
+		if ( '' !== $issue_block['html'] ) {
+			$body_parts[] = $issue_block['html'];
+			$text_parts[] = $issue_block['text'];
+		}
+
+		if ( '' !== $items_block['html'] ) {
+			$body_parts[] = $items_block['html'];
+			$text_parts[] = $items_block['text'];
+		}
+
+		if ( '' !== $tracking['html'] ) {
+			$body_parts[] = $tracking['html'];
+			$text_parts[] = $tracking['text'];
+		}
+
+		if ( '' !== $custom_instructions ) {
+			$body_parts[] = '<p>' . $this->escape_html( $custom_instructions ) . '</p>';
+			$text_parts[] = $custom_instructions;
+		}
+
+		if ( '' !== $closing['html'] ) {
+			$body_parts[] = $closing['html'];
+			$text_parts[] = $closing['text'];
+		}
+
+		$email_body = implode( "\n", $body_parts );
+		$email_body = $this->apply_template_variables( $email_body, $template_variables );
+		$email_body = $this->replace_known_placeholders( $email_body, $template_variables );
+		$email_body = $this->normalize_email_html( $email_body );
+		$email_body = $this->sanitize_email_html( $email_body );
+
+		$plain_text = implode( "\n\n", array_filter( $text_parts ) );
+		$plain_text = $this->apply_template_variables( $plain_text, $template_variables );
+		$plain_text = $this->replace_known_placeholders( $plain_text, $template_variables );
+
+		return array(
+			'subject_line'       => $subject,
+			'email_body'         => $email_body,
+			'plain_text_version' => $plain_text,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param string $custom_instructions Custom instructions.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_prompt_messages( array $context, $intent, $tone, $custom_instructions, array $template_variables ) {
+		$store_name   = $this->get_store_name();
+		$intent_notes = $this->get_intent_guidance( $intent, $context );
+		$tone_notes   = $this->get_tone_guidance( $tone );
+		$summary      = $this->build_prompt_context( $context );
+
+		$system = sprintf(
+			'You are a customer support assistant for %s. Draft a customer email response. Return JSON with keys subject_line, email_body, plain_text_version. The email_body must be valid HTML using simple tags like <p>, <ul>, <li>, <strong>, and <a>. Mention specific products and tracking details when available. Avoid placeholder text when data exists.',
+			$store_name
+		);
+
+		$user = array(
+			'Intent: ' . $intent,
+			'Tone: ' . $tone,
+			'Intent guidance: ' . $intent_notes,
+			'Tone guidance: ' . $tone_notes,
+			'Order context (JSON): ' . $this->encode_json( $summary ),
+			'Template variables (JSON): ' . $this->encode_json( $template_variables ),
+		);
+
+		if ( '' !== $custom_instructions ) {
+			$user[] = 'Custom instructions: ' . $custom_instructions;
+		}
+
+		$user[] = 'Output only JSON with the requested keys.';
+
+		return array(
+			array(
+				'role'    => 'system',
+				'content' => $system,
+			),
+			array(
+				'role'    => 'user',
+				'content' => implode( "\n", $user ),
+			),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_prompt_context( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+
+		return array(
+			'order_id' => isset( $context['order_id'] ) ? $context['order_id'] : 0,
+			'order'    => array(
+				'status'     => isset( $order['status'] ) ? $order['status'] : '',
+				'items'      => isset( $order['items'] ) ? $order['items'] : array(),
+				'item_count' => isset( $order['item_count'] ) ? $order['item_count'] : 0,
+				'totals'     => isset( $order['totals'] ) ? $order['totals'] : array(),
+				'dates'      => isset( $order['dates'] ) ? $order['dates'] : array(),
+			),
+			'customer' => isset( $context['customer'] ) ? $context['customer'] : array(),
+			'shipping' => array(
+				'tracking'           => isset( $shipping['tracking'] ) ? $shipping['tracking'] : array(),
+				'methods'            => isset( $shipping['methods'] ) ? $shipping['methods'] : array(),
+				'estimated_delivery' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			),
+			'payment'  => isset( $context['payment'] ) ? $context['payment'] : array(),
+			'issues'   => $issues,
+			'notes'    => isset( $context['notes'] ) ? $context['notes'] : array(),
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_template_variables( array $context ) {
+		$order   = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$customer = isset( $context['customer'] ) && is_array( $context['customer'] ) ? $context['customer'] : array();
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$payment  = isset( $context['payment'] ) && is_array( $context['payment'] ) ? $context['payment'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+
+		$items_summary = $this->build_items_summary( $order );
+
+		return array(
+			'{{customer_name}}'    => isset( $customer['name'] ) ? $customer['name'] : '',
+			'{{customer_email}}'   => isset( $customer['email'] ) ? $customer['email'] : '',
+			'{{order_id}}'         => isset( $context['order_id'] ) ? (string) $context['order_id'] : '',
+			'{{order_status}}'     => isset( $order['status'] ) ? $order['status'] : '',
+			'{{order_total}}'      => $this->format_currency( isset( $order['totals']['total'] ) ? $order['totals']['total'] : '' ),
+			'{{order_date}}'       => isset( $order['dates']['created'] ) ? $order['dates']['created'] : '',
+			'{{item_list}}'        => $items_summary['summary'],
+			'{{item_count}}'       => $items_summary['count'],
+			'{{tracking_url}}'     => isset( $tracking['url'] ) ? $tracking['url'] : '',
+			'{{tracking_number}}'  => isset( $tracking['number'] ) ? $tracking['number'] : '',
+			'{{tracking_provider}}' => isset( $tracking['provider'] ) ? $tracking['provider'] : '',
+			'{{estimated_delivery}}' => isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '',
+			'{{shipping_method}}'  => $this->get_primary_shipping_method( $shipping ),
+			'{{payment_method}}'   => isset( $payment['method'] ) ? $payment['method'] : '',
+			'{{store_name}}'       => $this->get_store_name(),
+			'{{support_email}}'    => $this->get_support_email(),
+		);
+	}
+
+	/**
+	 * @param array $args Input payload.
+	 * @return bool
+	 */
+	private function has_update_payload( array $args ) {
+		return isset( $args['subject_line'] )
+			|| isset( $args['email_body'] )
+			|| isset( $args['plain_text_version'] )
+			|| isset( $args['tone'] )
+			|| isset( $args['intent'] )
+			|| isset( $args['custom_instructions'] );
+	}
+
+	/**
+	 * @param mixed $intent Input intent.
+	 * @return string
+	 */
+	private function normalize_intent( $intent ) {
+		$intent = is_string( $intent ) ? strtolower( trim( $intent ) ) : '';
+		$valid  = array( 'shipping_update', 'refund_confirmation', 'order_issue', 'general_inquiry', 'review_request' );
+
+		return in_array( $intent, $valid, true ) ? $intent : '';
+	}
+
+	/**
+	 * @param mixed $tone Input tone.
+	 * @return string
+	 */
+	private function normalize_tone( $tone ) {
+		$tone  = is_string( $tone ) ? strtolower( trim( $tone ) ) : '';
+		$valid = array( 'professional', 'friendly', 'apologetic' );
+
+		return in_array( $tone, $valid, true ) ? $tone : '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_instructions( $value ) {
+		$value = is_string( $value ) ? $value : '';
+
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_subject( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_body( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		return wp_unslash( $value );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function sanitize_plain_text( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'sanitize_textarea_field' ) ) {
+			return sanitize_textarea_field( wp_unslash( $value ) );
+		}
+
+		return sanitize_text_field( wp_unslash( $value ) );
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function build_subject_from_template( $intent, $tone ) {
+		$templates = array(
+			'shipping_update' => array(
+				'professional' => 'Shipping update for order #{{order_id}}',
+				'friendly'     => 'Your order #{{order_id}} is on the way!',
+				'apologetic'   => 'Update on your order #{{order_id}}',
+			),
+			'refund_confirmation' => array(
+				'professional' => 'Refund confirmation for order #{{order_id}}',
+				'friendly'     => 'Your refund for order #{{order_id}} is on its way',
+				'apologetic'   => 'Refund update for order #{{order_id}}',
+			),
+			'order_issue' => array(
+				'professional' => 'Update regarding order #{{order_id}}',
+				'friendly'     => 'Quick update on order #{{order_id}}',
+				'apologetic'   => 'We are sorry about order #{{order_id}}',
+			),
+			'general_inquiry' => array(
+				'professional' => 'Following up on order #{{order_id}}',
+				'friendly'     => 'Thanks for reaching out about order #{{order_id}}',
+				'apologetic'   => 'Update on your request for order #{{order_id}}',
+			),
+			'review_request' => array(
+				'professional' => 'How was your order #{{order_id}}?',
+				'friendly'     => 'We would love your feedback on order #{{order_id}}',
+				'apologetic'   => 'Thank you for your order #{{order_id}}',
+			),
+		);
+
+		if ( isset( $templates[ $intent ][ $tone ] ) ) {
+			return $templates[ $intent ][ $tone ];
+		}
+
+		return 'Update on order #{{order_id}}';
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_greeting( $tone, array $template_variables ) {
+		$name = isset( $template_variables['{{customer_name}}'] ) ? $template_variables['{{customer_name}}'] : '';
+		$name = '' !== $name ? $name : 'there';
+
+		$greeting = 'Hello';
+		if ( 'friendly' === $tone ) {
+			$greeting = 'Hi';
+		} elseif ( 'apologetic' === $tone ) {
+			$greeting = 'Hi';
+		}
+
+		$line = sprintf( '%s %s,', $greeting, $name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $line ) . '</p>',
+			'text' => $line,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_intro_sentence( $intent, $tone, array $context ) {
+		$order_id = isset( $context['order_id'] ) ? $context['order_id'] : '';
+		$order_id = '' !== $order_id ? $order_id : '{{order_id}}';
+
+		$message = '';
+		switch ( $intent ) {
+			case 'shipping_update':
+				$message = sprintf( 'Here is the latest shipping update for order #%s.', $order_id );
+				break;
+			case 'refund_confirmation':
+				$message = sprintf( 'Your refund for order #%s has been initiated.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the trouble. Your refund for order #%s has been initiated.', $order_id );
+				}
+				break;
+			case 'order_issue':
+				$message = sprintf( 'We are looking into the issue with order #%s and wanted to update you.', $order_id );
+				if ( 'apologetic' === $tone ) {
+					$message = sprintf( 'We are sorry for the issue with order #%s. Here is where we are right now.', $order_id );
+				}
+				break;
+			case 'general_inquiry':
+				$message = sprintf( 'Thanks for reaching out about order #%s. Here is what we have so far.', $order_id );
+				break;
+			case 'review_request':
+				$message = sprintf( 'We hope you are enjoying your order #%s.', $order_id );
+				break;
+			default:
+				$message = sprintf( 'Here is an update on order #%s.', $order_id );
+		}
+
+		return array(
+			'html' => '' !== $message ? '<p>' . $this->escape_html( $message ) . '</p>' : '',
+			'text' => $message,
+		);
+	}
+
+	/**
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_items_block( array $context ) {
+		$order = isset( $context['order'] ) && is_array( $context['order'] ) ? $context['order'] : array();
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+
+		$lines = array();
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$line = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$line .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$lines[] = $line;
+		}
+
+		if ( empty( $lines ) ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$max_lines = 4;
+		if ( count( $lines ) > $max_lines ) {
+			$lines = array_slice( $lines, 0, $max_lines );
+			$lines[] = 'and more';
+		}
+
+		if ( count( $lines ) > 1 ) {
+			$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$text = "Items:\n- " . implode( "\n- ", $lines );
+		} else {
+			$html = '<p>Item: ' . $this->escape_html( $lines[0] ) . '.</p>';
+			$text = 'Item: ' . $lines[0] . '.';
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_tracking_block( $intent, $tone, array $context ) {
+		if ( 'refund_confirmation' === $intent || 'review_request' === $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$shipping = isset( $context['shipping'] ) && is_array( $context['shipping'] ) ? $context['shipping'] : array();
+		$tracking = isset( $shipping['tracking'] ) && is_array( $shipping['tracking'] ) ? $shipping['tracking'] : array();
+		$url      = isset( $tracking['url'] ) ? $tracking['url'] : '';
+		$number   = isset( $tracking['number'] ) ? $tracking['number'] : '';
+		$provider = isset( $tracking['provider'] ) ? $tracking['provider'] : '';
+		$estimated = isset( $shipping['estimated_delivery'] ) ? $shipping['estimated_delivery'] : '';
+
+		if ( '' === $url && '' === $number && '' === $estimated ) {
+			$message = 'We will share tracking details as soon as they are available.';
+			if ( 'apologetic' === $tone ) {
+				$message = 'We will share tracking details as soon as they are available. Thank you for your patience.';
+			}
+
+			return array(
+				'html' => '<p>' . $this->escape_html( $message ) . '</p>',
+				'text' => $message,
+			);
+		}
+
+		$lines = array();
+		if ( '' !== $number ) {
+			$lines[] = '' !== $provider ? sprintf( 'Tracking number (%s): %s', $provider, $number ) : sprintf( 'Tracking number: %s', $number );
+		}
+
+		if ( '' !== $estimated ) {
+			$lines[] = sprintf( 'Estimated delivery: %s', $estimated );
+		}
+
+		$html = '';
+		if ( '' !== $url ) {
+			$link_label = 'Track your package';
+			$html       = '<p><a href="' . $this->escape_url( $url ) . '">' . $this->escape_html( $link_label ) . '</a></p>';
+		}
+
+		if ( ! empty( $lines ) ) {
+			$html_lines = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+			$html       = '' !== $html ? $html . $html_lines : $html_lines;
+		}
+
+		$text = implode( "\n", $lines );
+		if ( '' !== $url ) {
+			$text = ( '' !== $text ? $text . "\n" : '' ) . 'Tracking link: ' . $url;
+		}
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param string $tone Email tone.
+	 * @param array $context Order context.
+	 * @return array
+	 */
+	private function build_issue_block( $intent, $tone, array $context ) {
+		if ( 'order_issue' !== $intent ) {
+			return array(
+				'html' => '',
+				'text' => '',
+			);
+		}
+
+		$issues = isset( $context['issues'] ) && is_array( $context['issues'] ) ? $context['issues'] : array();
+		$lines  = array();
+
+		if ( ! empty( $issues['payment_failed'] ) ) {
+			$lines[] = 'We were unable to process the payment on file.';
+		}
+
+		if ( ! empty( $issues['delayed_shipping'] ) ) {
+			$lines[] = 'Shipping is taking longer than expected.';
+		}
+
+		if ( ! empty( $issues['backordered_items'] ) && is_array( $issues['backordered_items'] ) ) {
+			$item_names = array();
+			foreach ( $issues['backordered_items'] as $item ) {
+				if ( isset( $item['name'] ) && '' !== $item['name'] ) {
+					$item_names[] = $item['name'];
+				}
+			}
+
+			if ( ! empty( $item_names ) ) {
+				$lines[] = 'Backordered items: ' . implode( ', ', $item_names ) . '.';
+			}
+		}
+
+		if ( empty( $lines ) ) {
+			$lines[] = 'We are reviewing the issue and will follow up shortly.';
+		}
+
+		if ( 'apologetic' === $tone ) {
+			array_unshift( $lines, 'We are sorry for the inconvenience.' );
+		}
+
+		$html = '<ul><li>' . implode( '</li><li>', array_map( array( $this, 'escape_html' ), $lines ) ) . '</li></ul>';
+		$text = implode( "\n", $lines );
+
+		return array(
+			'html' => $html,
+			'text' => $text,
+		);
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @param array $template_variables Template variables.
+	 * @return array
+	 */
+	private function build_closing( $tone, array $template_variables ) {
+		$store_name = isset( $template_variables['{{store_name}}'] ) ? $template_variables['{{store_name}}'] : $this->get_store_name();
+
+		$line = 'Thanks';
+		if ( 'friendly' === $tone ) {
+			$line = 'Thanks so much';
+		} elseif ( 'apologetic' === $tone ) {
+			$line = 'Thanks for your patience';
+		}
+
+		$closing = sprintf( '%s, %s Support', $line, $store_name );
+
+		return array(
+			'html' => '<p>' . $this->escape_html( $closing ) . '</p>',
+			'text' => $closing,
+		);
+	}
+
+	/**
+	 * @param string $intent Email intent.
+	 * @param array $context Order context.
+	 * @return string
+	 */
+	private function get_intent_guidance( $intent, array $context ) {
+		switch ( $intent ) {
+			case 'shipping_update':
+				return 'Share tracking information and estimated delivery. Mention the items when possible.';
+			case 'refund_confirmation':
+				return 'Confirm the refund and explain next steps. Be clear but avoid guessing refund amounts.';
+			case 'order_issue':
+				return 'Address the issue with empathy and describe the next steps.';
+			case 'general_inquiry':
+				return 'Provide a helpful status update and ask if there is anything else needed.';
+			case 'review_request':
+				return 'Invite the customer to leave a review and include an appreciative tone.';
+			default:
+				return 'Provide a helpful customer update.';
+		}
+	}
+
+	/**
+	 * @param string $tone Email tone.
+	 * @return string
+	 */
+	private function get_tone_guidance( $tone ) {
+		switch ( $tone ) {
+			case 'friendly':
+				return 'Warm, upbeat, and conversational.';
+			case 'apologetic':
+				return 'Empathetic and apologetic while remaining confident.';
+			default:
+				return 'Professional, concise, and helpful.';
+		}
+	}
+
+	/**
+	 * @param array $order Order context.
+	 * @return array
+	 */
+	private function build_items_summary( array $order ) {
+		$items = isset( $order['items'] ) && is_array( $order['items'] ) ? $order['items'] : array();
+		$names = array();
+
+		foreach ( $items as $item ) {
+			if ( ! is_array( $item ) || empty( $item['name'] ) ) {
+				continue;
+			}
+
+			$name = $item['name'];
+			if ( isset( $item['quantity'] ) && (int) $item['quantity'] > 1 ) {
+				$name .= ' (x' . intval( $item['quantity'] ) . ')';
+			}
+
+			$names[] = $name;
+		}
+
+		return array(
+			'summary' => implode( ', ', $names ),
+			'count'   => count( $names ),
+		);
+	}
+
+	/**
+	 * @param array $shipping Shipping context.
+	 * @return string
+	 */
+	private function get_primary_shipping_method( array $shipping ) {
+		if ( empty( $shipping['methods'] ) || ! is_array( $shipping['methods'] ) ) {
+			return '';
+		}
+
+		$method = $shipping['methods'][0];
+		if ( is_array( $method ) && ! empty( $method['method_title'] ) ) {
+			return $method['method_title'];
+		}
+
+		return '';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_store_name() {
+		if ( function_exists( 'get_bloginfo' ) ) {
+			$name = get_bloginfo( 'name' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		if ( function_exists( 'get_option' ) ) {
+			$name = (string) get_option( 'blogname' );
+			if ( '' !== $name ) {
+				return $name;
+			}
+		}
+
+		return 'our store';
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_support_email() {
+		if ( function_exists( 'get_option' ) ) {
+			$email = (string) get_option( 'admin_email' );
+			if ( '' !== $email ) {
+				return $email;
+			}
+		}
+
+		return '';
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function format_currency( $value ) {
+		if ( '' === $value || null === $value ) {
+			return '';
+		}
+
+		if ( function_exists( 'wc_price' ) ) {
+			return wp_strip_all_tags( wc_price( $value ) );
+		}
+
+		return (string) $value;
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function apply_template_variables( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text || empty( $variables ) ) {
+			return $text;
+		}
+
+		$replace = array();
+		foreach ( $variables as $key => $value ) {
+			$value = is_scalar( $value ) ? (string) $value : '';
+			if ( '' === $value ) {
+				continue;
+			}
+
+			$replace[ $key ] = $value;
+		}
+
+		if ( empty( $replace ) ) {
+			return $text;
+		}
+
+		return str_replace( array_keys( $replace ), array_values( $replace ), $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @param array $variables Template variables.
+	 * @return string
+	 */
+	private function replace_known_placeholders( $text, array $variables ) {
+		$text = is_string( $text ) ? $text : '';
+		if ( '' === $text ) {
+			return $text;
+		}
+
+		$replacements = array(
+			'[TRACKING URL]'   => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING LINK]'  => isset( $variables['{{tracking_url}}'] ) ? $variables['{{tracking_url}}'] : '',
+			'[TRACKING NUMBER]' => isset( $variables['{{tracking_number}}'] ) ? $variables['{{tracking_number}}'] : '',
+			'[ORDER ID]'       => isset( $variables['{{order_id}}'] ) ? $variables['{{order_id}}'] : '',
+			'[CUSTOMER NAME]'  => isset( $variables['{{customer_name}}'] ) ? $variables['{{customer_name}}'] : '',
+			'[STORE NAME]'     => isset( $variables['{{store_name}}'] ) ? $variables['{{store_name}}'] : '',
+		);
+
+		foreach ( $replacements as $placeholder => $value ) {
+			if ( '' === $value ) {
+				unset( $replacements[ $placeholder ] );
+			}
+		}
+
+		if ( empty( $replacements ) ) {
+			return $text;
+		}
+
+		return str_ireplace( array_keys( $replacements ), array_values( $replacements ), $text );
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function normalize_email_html( $html ) {
+		$html = is_string( $html ) ? trim( $html ) : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		if ( ! $this->looks_like_html( $html ) ) {
+			$parts = preg_split( "/\r?\n\r?\n/", $html );
+			$parts = array_map( 'trim', is_array( $parts ) ? $parts : array( $html ) );
+			$parts = array_filter( $parts );
+
+			if ( empty( $parts ) ) {
+				return '';
+			}
+
+			$wrapped = array();
+			foreach ( $parts as $part ) {
+				$wrapped[] = '<p>' . $this->escape_html( $part ) . '</p>';
+			}
+
+			return implode( "\n", $wrapped );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function sanitize_email_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+
+		if ( function_exists( 'wp_kses' ) ) {
+			$allowed = array(
+				'p'      => array(),
+				'br'     => array(),
+				'strong' => array(),
+				'em'     => array(),
+				'ul'     => array(),
+				'ol'     => array(),
+				'li'     => array(),
+				'a'      => array(
+					'href'   => true,
+					'title'  => true,
+					'target' => true,
+					'rel'    => true,
+				),
+			);
+
+			return wp_kses( $html, $allowed );
+		}
+
+		return $html;
+	}
+
+	/**
+	 * @param string $html Input HTML.
+	 * @return string
+	 */
+	private function build_plain_text_from_html( $html ) {
+		$html = is_string( $html ) ? $html : '';
+		if ( '' === $html ) {
+			return '';
+		}
+
+		$text = preg_replace( '/<\s*br\s*\/?>/i', "\n", $html );
+		$text = preg_replace( '/<\/\s*p\s*>/i', "\n\n", $text );
+		$text = preg_replace( '/<\/\s*li\s*>/i', "\n", $text );
+		$text = strip_tags( $text );
+		$text = html_entity_decode( $text, ENT_QUOTES, 'UTF-8' );
+		$text = preg_replace( "/\n{3,}/", "\n\n", $text );
+
+		return trim( $text );
+	}
+
+	/**
+	 * @param string $text Input.
+	 * @return bool
+	 */
+	private function looks_like_html( $text ) {
+		return (bool) preg_match( '/<[^>]+>/', $text );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_html( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_html' ) ) {
+			return esc_html( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param string $value Input value.
+	 * @return string
+	 */
+	private function escape_url( $value ) {
+		$value = is_string( $value ) ? $value : '';
+		if ( function_exists( 'esc_url' ) ) {
+			return esc_url( $value );
+		}
+
+		return htmlspecialchars( $value, ENT_QUOTES );
+	}
+
+	/**
+	 * @param mixed $value Input.
+	 * @return string
+	 */
+	private function encode_json( $value ) {
+		if ( function_exists( 'wp_json_encode' ) ) {
+			return wp_json_encode( $value );
+		}
+
+		return json_encode( $value );
+	}
+
+	/**
+	 * @param string $content Response content.
+	 * @return array
+	 */
+	private function parse_json_response( $content ) {
+		$content = is_string( $content ) ? trim( $content ) : '';
+		if ( '' === $content ) {
+			return array();
+		}
+
+		$decoded = json_decode( $content, true );
+		if ( is_array( $decoded ) ) {
+			return $decoded;
+		}
+
+		$start = strpos( $content, '{' );
+		$end   = strrpos( $content, '}' );
+		if ( false === $start || false === $end || $end <= $start ) {
+			return array();
+		}
+
+		$snippet = substr( $content, $start, $end - $start + 1 );
+		$decoded = json_decode( $snippet, true );
+
+		return is_array( $decoded ) ? $decoded : array();
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_api_key() {
+		if ( ! function_exists( 'get_option' ) ) {
+			return '';
+		}
+
+		$stored = get_option( Plugin::OPTION_API_KEY, '' );
+		$stored = is_string( $stored ) ? $stored : '';
+		if ( '' === $stored ) {
+			return '';
+		}
+
+		$encryption = new Encryption();
+		$decrypted  = $encryption->decrypt( $stored );
+
+		if ( '' !== $decrypted ) {
+			return $decrypted;
+		}
+
+		return $encryption->isEncrypted( $stored ) ? '' : $stored;
+	}
+
+	/**
+	 * @return string
+	 */
+	private function get_model() {
+		$model = '';
+
+		if ( function_exists( 'get_option' ) ) {
+			$settings = get_option( Plugin::OPTION_SETTINGS, array() );
+			if ( is_array( $settings ) && isset( $settings['model'] ) ) {
+				$model = (string) $settings['model'];
+			}
+		}
+
+		return Model::normalize( $model );
+	}
+
+	/**
+	 * @return string
+	 */
+	private function generate_draft_id() {
+		if ( function_exists( 'wp_generate_uuid4' ) ) {
+			return wp_generate_uuid4();
+		}
+
+		return uniqid( 'draft_', true );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return string
+	 */
+	private function build_draft_key( $draft_id ) {
+		return Plugin::TRANSIENT_PREFIX . 'draft_' . $draft_id;
+	}
+
+	/**
+	 * @return int
+	 */
+	private function get_draft_ttl_seconds() {
+		$minute_seconds = defined( 'MINUTE_IN_SECONDS' ) ? MINUTE_IN_SECONDS : 60;
+
+		return self::DEFAULT_TTL_MINUTES * $minute_seconds;
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @param array  $draft Draft payload.
+	 * @param int    $ttl_seconds Expiration seconds.
+	 * @return bool
+	 */
+	private function store_draft( $draft_id, array $draft, $ttl_seconds ) {
+		if ( ! function_exists( 'set_transient' ) ) {
+			return false;
+		}
+
+		return set_transient( $this->build_draft_key( $draft_id ), $draft, $ttl_seconds );
+	}
+
+	/**
+	 * @param string $draft_id Draft identifier.
+	 * @return array|null
+	 */
+	private function load_draft( $draft_id ) {
+		if ( ! function_exists( 'get_transient' ) ) {
+			return null;
+		}
+
+		$draft = get_transient( $this->build_draft_key( $draft_id ) );
+
+		return is_array( $draft ) ? $draft : null;
+	}
+}

tokens used
152,540
